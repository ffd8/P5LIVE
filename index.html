<!DOCTYPE html>
<html>
<head>
	<title>P5LIVE</title>
	<meta charset="utf-8">
	<meta name="description" content="P5LIVE - p5.js collaborate live-coding vj environment!">
	<meta name="author" content="teddavis.org">

	<link rel="icon" type="image/png" href="includes/icons/icon.png">
	<link rel="apple-touch-icon" href="includes/icons/apple-touch-icon.png">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-mobile-web-app-title" content="P5LIVE">
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1">

	<!-- Facebook -->
	<meta property="og:url" content="https://teddavis.org/p5live">
	<meta property="og:type" content="website">
	<meta property="og:title" content="P5LIVE">
	<meta property="og:description" content="p5.js collaborate live-coding vj environment!">
	<meta property="og:image" content="https://teddavis.org/p5live/includes/social/p5live.png">

	<!-- Twitter -->
	<meta name="twitter:card" content="summary">
	<meta name="twitter:site" content="P5LIVE">
	<meta name="twitter:creator" content="teddavis.org">
	<meta name="twitter:title" content="P5LIVE">
	<meta name="twitter:description" content="p5.js collaborate live-coding vj environment!">
	<meta name="twitter:image" content="https://teddavis.org/p5live/includes/social/p5live.png">

	<!-- Style -->
	<link rel="stylesheet" type="text/css" media="all" href="style.css?34">
</head>
<body>
	<div id="p5-drop"> </div>
	<div id="loader">
		<div id="loader-msg">
			P5LIVE
			<div id="loader-sub">loading...</div>
		</div>
		<div class="lds-dual-ring"></div>
		<div id="loader-bg"> </div>
	</div>

	<div id="p5-editor">
		<pre id="p5-code" autofocus class="p5-ta"></pre>
		<textarea id="p5-console"></textarea>
	</div>

	<iframe id="p5-frame" sandbox="allow-same-origin allow-scripts allow-downloads allow-pointer-lock" srcdoc="" ></iframe>
	<div id="p5-frame-cover"></div>

	<div id="refholder">
		<div id="ref-bg"></div>
		<div id="ref"></div>
		<div id="ref-close" onclick="closeRef();">X</div>
	</div>

	<div id="notify"></div>

	<div id="menu" class="panel">
		<div class="menu-bg"></div>
		<div id="menu-switch" onclick="menuToggle();">X</div>
		<div id="panel-menu" class="menu-sections">

			<div class="menu-section" id="menu-section-p5live">
				<div class="menu-section-bg"></div>
				<div class="menu-header">P5LIVE<span id="menu-p5live-version" class="counters"></span></div>
				<div class="menu-sketches-buttons" id="p5live-buttons">
					<button class="menu-button tippy" onclick="loadAbout();this.blur();" data-title="About">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-help-circle"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12" y2="17"></line></svg>
					</button>
					<button class="menu-button tippy" onclick="showSettings();this.blur();" data-title="Settings">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
					</button>
					<button class="menu-button tippy" onclick="showRef();this.blur();" data-title="p5.js Reference">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-book-open"><path class="st0" d="M2,3h6c2.2,0,4,1.8,4,4v14c0-1.7-1.3-3-3-3H2V3z"/><path class="st0" d="M22,3h-6c-2.2,0-4,1.8-4,4v14c0-1.7,1.3-3,3-3h7V3z"/><path class="st0" d="M12,23.5"/><path class="st0" d="M8.6,10.8H5"/><path class="st0" d="M8.6,14.6H5"/><path class="st0" d="M8.6,7.1H5"/><path class="st0" d="M18.8,10.8h-3.6"/><path class="st0" d="M18.8,14.6h-3.6"/><path class="st0" d="M18.8,7.1h-3.6"/></svg>
					</button>
					<button class="menu-button tippy" onclick="popStream(true);this.blur();" data-title="Visuals-only Popup">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-monitor"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
					</button>
					<button class="menu-button tippy" onclick="savePNG();this.blur();" data-title="Export Snapshot<br>PNG [+ CODE]">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-camera"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
					</button>
					<button class="menu-button tippy" onclick="saveHTML();this.blur();" data-title="Export HTML">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
					</button>

				</div>
			</div>

			<div class="menu-section" id="menu-section-cocode">
				<div class="menu-section-bg"></div>
				<div class="menu-header" id="menu-cocode-header">COCODING<span id="menu-cocode-counter" class="counters"></span><span id="menu-cocode-sync" class="counters" style="display:none;"> – <span id="menu-cocode-sync-up" class="sync">⇡</span><span id="menu-cocode-sync-down" class="sync">⇣</span></span></div>
				<div class="menu-sketches-buttons" id="cocoding-buttons-active" style="display:none;">
					<button class="menu-button tippy cocoding-active" onclick="cocodingInit();" data-title="Stop COCODING">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-power"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></svg>
					</button>
					<button class="menu-button tippy" onclick="cloneSketchCOCODING();this.blur();" data-title="Clone Sketch">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
					</button>
					<button class="menu-button tippy" id="syncdata-button" onclick="syncdataWindow(this);this.blur();" data-title="SyncData">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-radio"><circle cx="12" cy="12" r="2"></circle><path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"></path></svg>
					</button>
					<button class="menu-button tippy admin-lock" id="cocode-lockdown" onclick="toggleLockdown()" data-title="Toggle Lockdown">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-unlock"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V5a4 5 1 0 1 6.9-1"></path></svg>
					</button>
					<button class="menu-button tippy admin-lock" id="cocode-sync" onclick="toggleSync()" data-title="Broadcast mouseX/Y + frameCount" disabled>
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-cast"><path d="M2 16.1A5 5 0 0 1 5.9 20M2 12.05A9 9 0 0 1 9.95 20M2 8V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6"></path><line x1="2" y1="20" x2="2" y2="20"></line></svg>
					</button>
				</div>
				<div class="menu-sketches-buttons" id="cocoding-buttons-inactive">
					<button class="menu-button tippy cocoding-inactive" id="menu-cocoding" onclick="cocodingInit();" data-title="Start COCODING!">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-share-2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
					</button>
				</div>
				<div id="menu-cocode-sketches-holder" class="menu-sketches-holder" style="display:none;" onmouseenter="showUsers();" onmouseleave="hideUsers();">
					<div id="menu-cocode-sketches" class="menu-sketches"></div>
				</div>
				<div id="menu-cocode-chat-holder" class="" style="display:none;" onmouseleave="chatBlur();">
					<div class="menu-cocode-chat-title"></div>
					<div id="menu-cocode-chat-dialog" class="menu-cocode-chat menu-sketches-holder" onclick="document.getElementById('chat-input').focus();">

					</div>
					<input id="chat-input" type="text" name="chat-input" placeholder="Chat..." onfocus="this.selectionStart = this.selectionEnd = this.value.length;">
				</div>
			</div>

			<div class="menu-section" id="menu-section-sketches">
				<div class="menu-section-bg"></div>
				<div id="menu-sketches-header" onclick="sketchesCounter();" class="menu-header">SKETCHES<span id="menu-sketches-counter" class="counters"></span></div>
				<div class="menu-sketches-buttons">
					<button class="menu-button tippy" onclick="loadDefault();" data-title="New Sketch">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-plus"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
					</button>
					<button class="menu-button tippy" onclick="cloneSketch();" data-title="Clone Sketch">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
					</button>
					<button class="menu-button tippy" onclick="addFolder();" data-title="New Folder">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder-plus"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>
					</button>
					<input id="file-input" type="file" name="name" multiple style="display: none;" onchange="importSketches(this.files);" onclick="this.value=null;" />
					<button class="menu-button tippy" onclick="importSketchesDialog();" data-title="Import Sketches">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-upload"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
					</button>
					<button class="menu-button tippy" onclick="exportSketches();" data-title="Export All Sketches">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
					</button>
				</div>

				<div id="menu-sketches-filter-clear" class="tippy-left" data-title="Filter Sketches<br>(separate words for an <i>and</i> search)" onclick="filterSketchesClear(true)"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div>
				<input type="text" class="tippy-left" data-title="Filter Sketches<br>(separate words for an <i>and</i> search)" name="" placeholder="Filter..." id="menu-sketches-filter" onkeyup="filterSketches()">

				<div id="menu-sketches-holder" class="menu-sketches-holder">
					<div id="menu-sketches" class="menu-sketches"></div>
				</div>
			</div>



		</div>

		<div id="panel-settings" class="menu-sections">

			<div class="menu-section">
				<div class="menu-section-bg"></div>
				<div class="menu-header">P5LIVE</div>
				<div class="menu-sketches-buttons" id="p5live-buttons">
					<button class="menu-button tippy invisible" disabled onclick="loadAbout();" data-title="About P5LIVE">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-help-circle"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12" y2="17"></line></svg>
					</button>
					<button class="menu-button tippy" onclick="hideSettings();" data-title="Hide Settings">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
					</button>
					<button class="menu-button tippy invisible" disabled onclick="showRef();" data-title="p5.js Referenc">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-book-open"><path class="st0" d="M2,3h6c2.2,0,4,1.8,4,4v14c0-1.7-1.3-3-3-3H2V3z"/><path class="st0" d="M22,3h-6c-2.2,0-4,1.8-4,4v14c0-1.7,1.3-3,3-3h7V3z"/><path class="st0" d="M12,23.5"/><path class="st0" d="M8.6,10.8H5"/><path class="st0" d="M8.6,14.6H5"/><path class="st0" d="M8.6,7.1H5"/><path class="st0" d="M18.8,10.8h-3.6"/><path class="st0" d="M18.8,14.6h-3.6"/><path class="st0" d="M18.8,7.1h-3.6"/></svg>
					</button>
					<button class="menu-button tippy invisible" disabled onclick="savePNG();" data-title="Export Snapshot<br>PNG [+ CODE]">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-camera"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
					</button>
					<button class="menu-button tippy invisible" disabled onclick="saveHTML();" data-title="Export HTML">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
					</button>

				</div>
			</div>

			<div class="menu-section">
				<div class="menu-section-bg"></div>
				<div class="menu-header">SETTINGS</div>
				<div class="menu-sketches-buttons">
					<button class="menu-button tippy" onclick="resetP5();" data-title="Reset P5LIVE">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-slash"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>
					</button>
					<button class="menu-button tippy" onclick="resetSettings();" data-title="Reset Settings">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
					</button>
					<input id="file-input-settings" type="file" name="name" style="display: none;" multiple onchange="importSettings(this.files);" onclick="this.value=null;" />
					<button class="menu-button tippy" onclick="importSettingsDialog();" data-title="Import Settings">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-upload"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
					</button>
					<button class="menu-button tippy" onclick="exportSettings();" data-title="Export Settings">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
					</button>
				</div>
				<div class="menu-settings menu-contents">
					<div>
						<div class="tippy-left" data-title="Set Audio Inputs " style="display:none;">
							<div class="select">
								<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg><select id="audioSource" class="av-select"></select>
							</div>

							<div class="select" style="display:none;">
								<label for="audioOutput">Audio out: </label><select id="audioOutput" class="av-select"></select>
							</div>

							<div class="select" style="display:none;">
								<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-video"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg><select id="videoSource" class="av-select"></select>
							</div>
						</div>
						<div class="tippy-left" style="cursor:help;float:left;" data-title="Auto-compile code on keyup" onclick="autoCompileToggle();">
						<input type="checkbox" id="settings-autocompile" name="settings-autocompile" value="settings-autocompile">
						Live Coding</div> 
							<select id="settings-compiletimer" style="" class="tippy" data-title="Delay from keyUp to compile" onchange="compileTimerChange();">
									<option value="250">250ms</option>
									<option value="500">500ms</option>
									<option value="1000">1000ms</option>
									<option value="2000">2000ms</option>
							</select>
					</div>
					<div class="tippy-left" style="cursor:help;" data-title="noLoop() if window loses focus<br>(save computer resources)" onclick="ecoRenderToggle();">
						<input type="checkbox" id="settings-ecorender" name="settings-ecorender" value="settings-ecorender">
						Eco Render
					</div>
					<div class="tippy-left" style="cursor:help;" data-title="Display cursor <br>(when editor is hidden)" onclick="cursorToggle();">
						<input type="checkbox" id="settings-canvascursor" name="settings-canvascursor" value="settings-canvascursor">
						Cursor
					</div>
					<div class="tippy-left" style="cursor:help;" data-title="Display console messages" onclick="consoleToggle();">
						<input type="checkbox" id="settings-console" name="settings-console" value="settings-console">
						Console
					</div>
					<div class="tippy-left" style="cursor:help;" data-title="Display Menu-Tab <br>If unchecked, must use shortcut" onclick="menutabToggle();">
						<input type="checkbox" id="settings-menutab" name="settings-menutab" value="settings-menutab">
						Menu Tab
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Include sketch code with Snapshot" onclick="exportcodeToggle();">
						<input type="checkbox" id="settings-exportcode" name="settings-exportcode" value="settings-exportcode"> Snapshot Code
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Display code line numbers" onclick="linenumbersToggle();">
						<input type="checkbox" id="settings-linenumbers" name="settings-linenumbers" value="settings-linenumbers"> Line Numbers
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Automatic Autocomplete<br>If disabled (suggested), trigger with <div class='shortcut'>CTRL + SPACE</div>" onclick="autocompleteToggle();">
						<input type="checkbox" id="settings-autocomplete" name="settings-autocomplete" value="settings-autocomplete"> Auto Autocomplete
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Editor locked onmousedragged, <br>prevents errors in displaced code" onclick="lockDragToggle();">
						<input type="checkbox" id="settings-lockdrag" name="settings-lockdrag" value="settings-lockdrag"> Lock Code on Drag
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Pass any keypress from editor to p5 canvas" onclick="passEditorKeysToggle();">
						<input type="checkbox" id="settings-passeditorkeys" name="settings-passeditorkeys" value="settings-passeditorkeys"> Pass-Thru KeyPress
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Display Notifications" onclick="notifyToggle();">
						<input type="checkbox" id="settings-notifytoggle" name="settings-notifytoggle" value="settings-notifytoggle"> Notifications
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Display Tooltips" onclick="tippyToggle();">
						<input type="checkbox" id="settings-tippytoggle" name="settings-tippytoggle" value="settings-tippytoggle"> Tooltips
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Warn if P5LIVE opened multiple times<br>(leads to sketches out of sync)" onclick="multitabToggle();">
						<input type="checkbox" id="settings-mutitabtoggle" name="settings-mutitabtoggle" value="settings-mutitabtoggle"> Multi-P5LIVE Warning
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Add _YYYYMMDD_HHMMSS to filenames?" onclick="timestampToggle();">
						<input type="checkbox" id="settings-timestamptoggle" name="settings-timestamptoggle" value="settings-timestamptoggle"> Timestamp Exports
					</div>

					<div class="tippy-left" style="display:none;cursor:help;" data-title="Add extra libs to your sketches, will be added on each compile">
						<span>Libs:</span>
						<input type="text" id="settings-libs" name="settings-libs" placeholder="CSV, of, libs">
					</div>
					<div class="tippy-left" style="cursor:help;" data-title="Editor font-size">
						Code Size:  <input type="" name="menu-settings-fontsize" id="menu-settings-fontsize" value="15" onkeyup="fontSizeAdjust(this.value);"> pt
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Color behind lines of code">
						Code Background: <input type="checkbox" id="settings-usebg" name="settings-usebg" value="settings-usebg" onchange="themeBGactiveToggle();">
						<div id="pickr" class="pickr"></div>
					</div>
					<div class="tippy-left" style="cursor:help;" data-title="Set editor theme">
						Theme:
						<select id="menu-settings-theme" onchange="setTheme(this.selectedIndex);">
							<option value="ace/theme/gob">Green on Black</option>
							<option value="ace/theme/ambiance">Ambiance</option>
							<option value="ace/theme/cobalt">Cobalt</option>
							<option value="ace/theme/pastel_on_dark">Pastel on dark</option>
							<option value="ace/theme/twilight">Twilight</option>
						</select>
					</div>

				<h2>SHORTCUTS</h2>
					<div id="menu-shortcuts-holder">

					</div>
				</div>
			</div>



		</div>
	</div>
<textarea style="display:none;" id="p5-template">
function setup() {
	createCanvas(windowWidth, windowHeight);

}

function draw() {

}</textarea>
<textarea style="display:none;" id="p5-custom">
/* CUSTOM FUNCTIONS FOR P5LIVE */
// keep fullscreen if window resized
function windowResized() {
	resizeCanvas(windowWidth, windowHeight);
}

// custom ease function
function ease(iVal, oVal, eVal){
	return oVal += (iVal - oVal) * eVal;
}

// processing compatibility
function println(msg){
	print(msg);
}
</textarea>

	<!-- Script Styles -->
	<link rel="stylesheet" href="includes/js/pickr/nano.min.css"/>
	<link rel="stylesheet" href="includes/js/vex/css/vex.css" />
	<link rel="stylesheet" href="includes/js/vex/css/vex-theme-plain.css" />
	<link rel="stylesheet" href="includes/js/highlight/a11y-dark.css" />

	<!-- Scripts -->
	<script src="includes/js/src-noconflict/ace.js?7" type="text/javascript" charset="utf-8"></script>
	<script src="includes/js/src-noconflict/ext-language_tools.js?7" type="text/javascript" charset="utf-8"></script>
	<script src="includes/js/Sortable.js"></script>
	<script src="includes/js/beautify.js"></script>
	<script src="includes/js/pickr/pickr.min.js"></script>
	<script src="includes/js/popper.min.js"></script>
	<script src="includes/js/tippy.all.js"></script>
	<script src="includes/js/marked.min.js"></script>
	<script src='includes/js/download.js'></script>
	<script src="includes/js/vex/js/vex.combined.min.js"></script>
	<script src="includes/js/dropzone.js"></script>
	<script src="includes/js/mousetrap/mousetrap.min.js"></script>
	<script src="includes/js/mousetrap/mousetrap-record.js"></script>
	<script src="includes/js/mousetrap/mousetrap-pause.min.js"></script>
	<script src="includes/js/highlight/highlight.pack.js"></script>
	<script src="includes/js/name_generator.js"></script>

	<script src="includes/js/socket.io.js"></script>
	<script src="includes/js/rga.js"></script>

	<script type="text/javascript">
		'use strict'

		/* INIT */
		let currentRevision = 36;
		let developBranch = false;

		// resetP5(); // manual reset

		function resetP5(){
			if(settings.cocoding.active){
				settingsCocodingWarning();
				return false;
			}

			vex.dialog.confirm({
				unsafeMessage: 'Completely reset P5LIVE?<br><i>All sketches will be removed.</i>',
				callback: function (value) {
					if (value) {
						localStorage.clear();
						location.reload();
					}
				},
				afterOpen: function(){
					vexSmall(this.rootEl);
				}
			})
		}

		// settings
		let initSettings = {
			'version':'1.3.2',
			'revision':currentRevision,
			'welcome':true,
			'fontSize':15,
			'autoCompile':true,
			'compileTimer':500,
			'ecoRender': true,
			'canvasCursor': true,
			'console': true,
			'fullscreenMode':false,
			'fileName': '',
			'linenumbers': false,
			'autocomplete': false,
			'lockcode':true,
			'passEditorKeys':false,
			'menuMode': true,
			'menutab':true,
			'exportCode':true,
			'notifyToggle':true,
			'tippyToggle':true,
			'multitabToggle':true,
			'timestampToggle':true,
			'debugMode': false,
			'editMode':true,
			'safeMode': false,
			'shortcuts':{
				'softcompile':{
					'name':'Soft-Compile'
					,'key':'ctrl+enter'
					,'callback':'recompile()'
				}
				,'hardcompile':{
					'name':'Hard-Compile'
					,'key':'ctrl+shift+enter'
					,'callback':'recompile(true)'
				}
				,'editor':{
					'name':'Editor Toggle'
					,'key':'ctrl+e'
					,'callback':'editorToggle()'
				}
				,'menu':{
					'name':'Menu Toggle'
					,'key':'ctrl+m'
					,'callback':'menuToggle()'
				}
				,'settings':{
					'name':'Settings Toggle'
					,'key':'ctrl+,'
					,'callback':'showSettings(true)'
				}
				,'cursor':{
					'name':'Cursor Toggle'
					,'key':'ctrl+c'
					,'callback':'cursorToggle()'
				}
				,'references':{
					'name':'References Toggle'
					,'key':'ctrl+r'
					,'callback':'toggleRef()'
				}
				,'autocompile':{
					'name':'Live-Coding Toggle'
					,'key':'ctrl+a'
					,'callback':'autoCompileToggle()'
				}
				,'newsketch':{
					'name':'New Sketch'
					,'key':'ctrl+n'
					,'callback':'loadDefault()'
				}
				,'tidy':{
					'name':'Tidy Code'
					,'key':'ctrl+t'
					,'callback':'tidyCode(editor)'
				}
				,'codecomment':{
					'name':'Comment Code'
					,'key':'meta+/'
					,'init': 'editor.commands.bindKey(settings.shortcuts["codecomment"].key, "togglecomment")'
				}
				,'fontbigger':{
					'name':'Increase Fontsize'
					,'key':'ctrl+='
					,'callback':'fontSizeAdjust(parseFloat(settings.fontSize) + 0.25)'
				}
				,'fontsmaller':{
					'name':'Decrease Fontsize'
					,'key':'ctrl+-'
					,'callback':'fontSizeAdjust(parseFloat(settings.fontSize) - 0.25)'
				}
				,'pause':{
					'name':'Pause'
					,'key':'ctrl+p'
					,'callback':'pauseSketch()'
				}
				,'snapshot':{
					'name':'Export Snapshot'
					,'key':'ctrl+s'
					,'callback':'savePNG()'
				}
				,'import':{
					'name':'Import Sketch'
					,'key':'ctrl+o'
					,'callback':'importSketchesDialog()'
				}
				,'instagram':{
					'name':'Instagram Window'
					,'key':'ctrl+i'
					,'callback':'pop720()'
				}
				,'jump':{
					'name':'Quick Sketch Jump'
					,'key':'ctrl' // modifier for 1-0
					,'init':'setupJumpSketches(settings.shortcuts["jump"].key)'
					,'tippy':'Then combine w/ 1, 2,...0 to jump thru sketches'
				}


			},
			'sketches': [],
			'statscount': 0,
			'syncdata': {
				'sketches': [],
				'code': '',
				'active': false,
				'libs' : [],
				'cursor': {row:0, column:0},
				'console': [],
				'namespace': '',
				'cocodeadded':false
			},
			'cocoding': {'active':false, 'timestamp':null, 'nick':'', 'namespace':'', 'lockdown':false, 'level':'', 'token':0, 'sync':false, 'request':false, 'writemode':false, 'color':'#00aa00', 'cursor':{'row':0, 'column':0}, 'msgID':-1, 'hasAdmin':false},
			'scripts': ['includes/p5/p5.min.js', 'includes/p5/addons/p5.sound.min.js'],
			'theme': 'ace/theme/gob',
			'themeBG': '#011F2F',
			'themeBGactive': true,
			'refresh':true
		}

		// init variabless
		let p5editor = document.getElementById('p5-editor'),
		p5code = document.getElementById('p5-code'),
		p5console = document.getElementById('p5-console'),
		p5custom = document.getElementById('p5-custom'),
		p5template = document.getElementById('p5-template').value,
		p5frame = document.getElementById('p5-frame'),
		p5frameCover = document.getElementById('p5-frame-cover'),
		p5f = p5frame.contentWindow,
		p5script = document.getElementById('holdscript'),
		menuCocode = document.getElementById('menu-section-cocode'),
		menuSectionP5live = document.getElementById('menu-section-p5live'),
		menuSectionSketches = document.getElementById('menu-section-sketches'),
		menuCocodeCounter = document.getElementById('menu-cocode-counter'),
		menuCocodeSync = document.getElementById('menu-cocode-sync'),
		menuCocodeUp = document.getElementById('menu-cocode-sync-up'),
		menuCocodeDown = document.getElementById('menu-cocode-sync-down'),
		// syncdataBtn = document.getElementById('syncdata-button'),
		menuCocodeSketches = document.getElementById('menu-cocode-sketches'),
		menuCocodeHolder = document.getElementById('menu-cocode-sketches-holder'),
		menuCocodeChatHolder = document.getElementById('menu-cocode-chat-holder'),
		menuCocodeChatInput = document.getElementById('chat-input'),
		menuCocodeChatDialog = document.getElementById('menu-cocode-chat-dialog'),
		sketchesHolder = document.getElementById('menu-sketches-holder'),
		menuSketches = document.getElementById('menu-sketches'),
		menuSketchesFilter = document.getElementById('menu-sketches-filter'),
		menuSketchesCounter = document.getElementById('menu-sketches-counter'),
		settingsFontsize = document.getElementById('menu-settings-fontsize'),
		settingsAutoMode = document.getElementById('settings-autocompile'),
		settingsEcoMode = document.getElementById('settings-ecorender'),
		settingsCanvasCursor = document.getElementById('settings-canvascursor'),
		settingsConsole = document.getElementById('settings-console'),
		settingsMenutab = document.getElementById('settings-menutab'),
		settingsLinenumbers = document.getElementById('settings-linenumbers'),
		settingsAutocomplete = document.getElementById('settings-autocomplete'),
		settingsExportcode = document.getElementById('settings-exportcode'),
		settingsLockDrag = document.getElementById('settings-lockdrag'),
		settingsPassEditorKeys = document.getElementById('settings-passeditorkeys'),
		settingsNotify = document.getElementById('settings-notifytoggle'),
		settingsTippy = document.getElementById('settings-tippytoggle'),
		settingsMultitab = document.getElementById('settings-mutitabtoggle'),
		settingsTimestamp = document.getElementById('settings-timestamptoggle'),
		settingsBGactive = document.getElementById('settings-usebg'),
		settingsCompileTimer = document.getElementById('settings-compiletimer'),
		settingsShortcuts = document.getElementById('menu-shortcuts-holder'),
		refHolder = document.getElementById('refholder'),
		ref = document.getElementById('ref'),
		menuPanel = document.getElementById('menu'),
		panelMenu = document.getElementById('panel-menu'),
		panelSettings = document.getElementById('panel-settings'),
		menuSwitch = document.getElementById('menu-switch'),
		menuTheme = document.getElementById('menu-settings-theme'),
		menuCocoding = document.getElementById('menu-cocode-header'),
		loader = document.getElementById('loader'),
		loaderSub = document.getElementById('loader-sub'),
		notify = document.getElementById('notify'),
		shortcutRecording = false, p5Remote = false,
		menuVisible = false, refVisible = false, settingsVisible = false,
		settings = getSettings(),
		validCode = true, sketchesFirstTime = true,
		sketchLoaded = false, forceRecompile = false,
		pLen = 0, paused = false,
		markerID = [], errorTimer, consoleTimer, consoleVisible = false, braketError,
		snippets, cocode, editorId, p5frameTemplate, p5htmlTemplate,
		p5vars = {'frameCount':0, 'mouseX':0, 'mouseY':0}, newBG = '',
		refList = [], downloadedRef = false, refScroll = 0, refSearch = '',
		chars = 'abcdefghijklmnopqrstuvwxyz0123456789', // ABCDEFGHIJKLMNOPQRSTUVWXYZ
		showNotify = false, navMouseOver = false,
		curPos, curPositions = [], updateCursor, showCursors = false, notifyTimer,
		demosLocked = true, autoCompleteExport = false,
		syncdataEditor, syncdataPresets = [],
		cocodingFirstTime = false, cocodingShowMic = false,
		cocodingRecompile = false,
		p5pop, p5popStream, p5popActive = false
		;

		// force off
		settings.debugMode = false;

		// init editor
		let Range = ace.require('ace/range').Range;
		let langTools = ace.require('ace/ext/language_tools');
		let editor = ace.edit('p5-code');
		editor.setTheme(settings.theme);
		editor.session.setMode('ace/mode/javascript');
		editor.setOptions({
			showPrintMargin: false,
			animatedScroll: false,
			displayIndentGuides: false,
			useWorker: true,
			showLineNumbers: false,
			showGutter: false,
			tabSize: 4, useSoftTabs: false,
			enableBasicAutocompletion: true,
			enableSnippets: true
		});

		function loadAutoComplete(){
			// propose trimmed list/script to https://github.com/processing/p5.js/issues/3666
			let tempPath = 'includes/p5/P5L_autocomplete.json?' + makeid(5);
			let request = new XMLHttpRequest();
			request.open('GET', tempPath, true);
			request.send();
			request.addEventListener('load', function(){
				let acOBJ = JSON.parse(request.responseText);
				let acList = [];
				let curFunction = '';

				// cycle through auto complete list
				acOBJ.code.forEach(function (ac){

					// if method/function
					if(ac.t == 'm'){
						// add once without params for easy adding
						if(ac.n != curFunction){
							acList.push({'cap':ac.n + '()', 'snip':ac.n + '()'});
							curFunction = ac.n;
						}

						// add w/ params using tab feature
						let acParamsTab = []
						for(let i=0; i < ac.p.length; i++){
							acParamsTab.push('${'+(i+1)+':'+ac.p[i]+'}');
						}
						let acParamsListTab = ac.n + '(' +acParamsTab.join(', ')+ ')';
						let acParamsList = ac.n + '(' +ac.p.join(', ')+ ')';
						acList.push({'cap':acParamsList, 'snip':acParamsListTab});
					}else{
						// add constants/misc
						acList.push({'cap':ac.n, 'snip':ac.n});
					}
				});

				// create custom completer
				var completer = {
					getCompletions: function(editor, session, pos, prefix, callback) {
						var text = editor.getValue(); if (prefix.length === 0) { callback(null, []); return }
						var completions = [];
						for(let wl of acList){
							completions.push({caption: wl.cap, snippet: wl.snip, meta: 'p5', score:1});
						}
						callback(null, completions);
					}
				}

				// add list to auto completer
				langTools.addCompleter(completer);
			});
		}

		p5editor.style.visibility = 'visible';

		// ICONS!
		let iconBookmark = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-bookmark"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>';

		let iconCheckSquare = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check-square"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>';

		let iconEye = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-eye"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>';

		let iconFolderEmpty = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>';

		let iconFolderCollapse = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder-minus"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="9" y1="14" x2="15" y2="14"></line></svg>';

		let iconFolderExpand = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder-plus"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>';

		let iconFileLines = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>';

		let iconGift = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-gift"><polyline points="20 12 20 22 4 22 4 12"></polyline><rect x="2" y="7" width="20" height="5"></rect><line x1="12" y1="22" x2="12" y2="7"></line><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path></svg>';

		let iconSettings = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>';

		let iconMaximize = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-maximize"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>';

		let iconMoreVertical = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-more-vertical"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>';

		let iconMoreHorizontal = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-more-horizontal"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>';

		let iconRadio = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-radio"><circle cx="12" cy="12" r="2"></circle><path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"></path></svg>';

		let iconRename = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class=" feather-small feather-edit-3"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>';

		let iconRefresh = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>';

		let iconExport = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-small feather-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>';

		let iconRemove = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-small feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>';

		let iconCopy ='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';

		let iconUnlock = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-unlock"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V5a4 5 1 0 1 6.9-1"></path></svg>';

		let iconLock = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ff0000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-lock"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>';

		let iconMicOff = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic-off"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>';

		let iconMic = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>';

		let iconEdit = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>';

		let iconToggleLeft = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-toggle-left"><rect x="1" y="5" width="22" height="14" rx="7" ry="7"></rect><circle cx="8" cy="12" r="3"></circle></svg>';

		let iconToggleRight = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-toggle-right"><rect x="1" y="5" width="22" height="14" rx="7" ry="7"></rect><circle cx="16" cy="12" r="3"></circle></svg>';

		let iconScreencast = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-radio"><circle cx="12" cy="12" r="2"></circle><path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"></path></svg>';

		let iconPlay = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';

		let iconPower = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-power"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></svg>';

		let iconXCircle = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x-circle"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';

		let iconCheckCircle = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';

		let iconShield = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-shield"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>';

		let iconUser = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>';

		let iconUsers = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-users"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>';

		let iconUserCheck = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user-check"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline></svg>';

		let iconAlignLeft = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-align-left"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>';

		let iconFilter = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-filter"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>';

		let iconX = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';



		// code-line color picker
		function loadColorPicker(){
			let defaultColor = settings.themeBG;
			if(defaultColor.includes('#')){
				defaultColor = defaultColor.substring(1);
			}
			let pickr = Pickr.create({
				el: '.pickr',
				theme: 'nano', // or 'monolith', or 'nano'
				default: defaultColor,

				components: {
					preview: true,
					opacity: true,
					hue: true,

					interaction: {
						input: true,
						cancel:false,
						save: true
					},
				},

				// rename buttons
				strings: {
					save: 'Set', // Default for save button
					cancel: 'Close' // Default for cancel button
				}
			});

			pickr.on('init', (color, instance) => {
				setBG(defaultColor);
			}).on('change', (color, instance) => {
				setBG(color.toHEXA().join(''));
			}).on('save', (color, instance) => {
				instance.hide();
			}).on('cancel', instance => {
				instance.hide();
			});
		}


		let options = {
			group: {name: 'sketches'},
			animation: 0,
			filter:'.sortable-placeholder, .demo',
			emptyInsertThreshold: 0,
			dragClass: 'sortable-drag',
			ghostClass: 'sortable-ghost',
			draggable: ['li', 'ul'],
			swapInvert:true,
			store: {
				set: function (sortable) {
					getOrder();
				}
			}
		}

		function vexSmall(elm){
			elm.classList.add('vex-small');
			// let elements = document.getElementsByClassName('vex');
			// for (let i in elements) {
			// 	if (elements.hasOwnProperty(i)) {
			// 		elements[i].classList.add('vex-small')// += ' vex-small';
			// 	}
			// }
		}

		let includeScripts = [{
			'local':'includes/p5/p5.min.js',
			'remote':'https://cdn.jsdelivr.net/npm/p5@1.0.0/lib/p5.min.js'
		}, {
			'local':'includes/p5/addons/p5.sound.min.js',
			'remote':'https://cdn.jsdelivr.net/npm/p5@1.0.0/lib/addons/p5.sound.min.js'
		}];



		// markers for COCODING
		// built upon: https://stackoverflow.com/a/24812641/10885535
		let marker = {}
		marker.cursors = []
		marker.update = function(html, markerLayer, session, config) {
			let start = config.firstRow, end = config.lastRow;
			let cursors = this.cursors
			for (let i = 0; i < cursors.length; i++) {
				let pos = this.cursors[i];
				if (pos.row < start) {
					continue;
				} else if (pos.row > end) {
					break;
				} else {
					// compute cursor position on screen
					// this code is based on ace/layer/marker.js
					let screenPos = session.documentToScreenPosition(pos.row, pos.column)
					let height = config.lineHeight;
					let width = config.characterWidth;
					let top = markerLayer.$getTop(screenPos.row, config);
					let left = markerLayer.$padding + screenPos.column * width;

					// update if exists + rebuild on textsize change
					let elm = document.getElementById('cursor_'+pos.id);
					if(elm != undefined){
						elm.parentNode.removeChild(elm);
					}

					// can add any html here
					let el = document.createElement('div');
					el.id = 'cursor_'+pos.id;
					el.className = 'cursor';
					el.style.position = 'absolute';
					el.style.height = height + 'px';
					el.style.width = width + 'px';
					el.style.top = top + 'px';
					el.style.left = left + 'px';
					if(pos.id != settings.cocoding.nick){
						el.style.borderLeft = '3px solid ' + pos.color;
					}else{
						let cursorSelf = document.getElementsByClassName('ace_cursor')[0];
						cursorSelf.style.borderColor = pos.color;
						el.style.left = (left+3) + 'px';
					}
					el.style.zIndex = 9999999;
					el.style.color = '#000';
					el.style.cursor = 'help';
					if(!showCursors){
						el.style.display = 'none';
					}
					el.innerHTML = '<div class="cursor-label" style="background:'+pos.color+';top:-8pt;">'+pos.id+'</div>';
					p5editor.appendChild(el);
				}
			}
		}
		marker.redraw = function() {
			this.session._signal('changeFrontMarker');
		}
		marker.session = editor.session;
		marker.session.addDynamicMarker(marker, true);


		class CocodeApp{
			constructor(namespace) {
				this.initialized = false;
				this.socket = '';
				this.namespace = namespace;
				if(!p5Remote){
					this.socket = io('/' + this.namespace, { transports: ['websocket'],secure: true, query : {nick : settings.cocoding.nick}}); // io('http://localhost:5000/' + this.namespace);
				}else{
					if(developBranch){
						this.socket = io('https://cocoding.p5live.org/' + this.namespace, { transports: ['websocket'], secure: true, query : {nick : settings.cocoding.nick} });
					}else{
						this.socket = io('https://cocoding.p5live.org/' + this.namespace, { transports: ['websocket'], secure: true, query : {nick : settings.cocoding.nick} });
					}
				}
				this.rgaConnect();
				this.users = {};
				editor.setWrapBehavioursEnabled(false);
				// editor.getSession().on('change', function(delta){
				// 	curPos = delta.start;
				// 	curPositions.push(delta.start);
				// 	checkErrors();
				// });

				this.updateColor();
				this.token();

				this.socket.on('init', () => {
					syncDown();
					setTimeout(function(){editor.setValue(p5template, 1);}, 100);
				});

				this.socket.on('syncSettings', (data)=>{
					syncDown();
					let settingsUpdate = JSON.parse(data);
					settings.cocoding.lockdown = settingsUpdate.lockdown;
					settings.cocoding.sync = settingsUpdate.sync;
					settings.cocoding.hasAdmin = settingsUpdate.hasAdmin;
					updateSettings();

					//lockdown
					if(settings.cocoding.lockdown){
						editor.setReadOnly(true);
						if(settings.cocoding.level == 'admin' || settings.cocoding.writemode){
							editor.setReadOnly(false);
						}
					}else{
						editor.setReadOnly(false);
					}
					updateToggleLockdown();

					if(settings.cocoding.sync){
						if(settingsUpdate.fc > 0){
							p5f.frameCount = settingsUpdate.fc;
						}
					}
					updateToggleSync();
					// let settingsSync = document.getElementById('cocode-sync');
					// toggleButtonActive(settingsSync, settings.cocoding.sync);

				});

				this.socket.on('cocodeReady', () =>{
					syncDown();
					if(!this.initialized){
						document.getElementById('cocoding-buttons-inactive').innerHTML = document.getElementById('cocoding-buttons-active').innerHTML;
						document.getElementById('cocoding-buttons-active').innerHTML = '';
						loadTippy();
						this.initialized = true;
					}
				});

				this.socket.on('full', () =>{
					syncDown();
					vex.dialog.alert({
						message:'Sorry COCODING is full at the moment.',
						callback: function(){cocodingExit(loadLatest());}
					})
				});

				this.socket.on('checkAdmin', (checkStatus)=>{
					if(checkStatus){
						settings.cocoding.token = checkStatus;
						updateSettings();
						this.token();
					}
				});

				this.socket.on('setLevel', (statusMode)=>{
					syncDown();
					settings.cocoding.level = statusMode;
					updateSettings();
					let adminDivs = document.getElementsByClassName('admin-lock');
					if(statusMode != 'admin'){
						for(let i=0; i<adminDivs.length; i++){
							adminDivs[i].setAttribute('disabled', 'disabled');
						}
					}else{
						for(let i=0; i<adminDivs.length; i++){
							adminDivs[i].removeAttribute('disabled')
						}
					}
				});

				this.socket.on('dispatchSyncEvent', (evData)=>{
					syncDown();
					let ev = JSON.parse(evData);
					let copy;
					if(ev.mode == 'keyboard'){
						copy = new KeyboardEvent(ev.type, ev.options);
					}else if(ev.mode == 'mouse'){
						copy = new MouseEvent(ev.type, ev.options);
					}
					p5f.dispatchEvent(copy);
					p5f.frameCount = ev.fc;
				});

				this.socket.on('recompile', (force)=>{
					syncDown();
					buildSketch(force); //
					updateBackground();
				});

				this.socket.on('rename', (nick)=>{
					syncDown();
					settings.cocoding.nick = nick;
					updateSettings();
				});

				this.socket.on('codeReplaceRequest', (data)=>{
					syncDown();
					vex.dialog.confirm({
						unsafeMessage:'Replace code request<br><hr><div class="code-replace-header">User </div>' + data.userID + '<br><div class="code-replace-header">SketchName</div>' + data.sketchName + '<br><div class="code-replace-header">SketchCode</div> <textarea id="code-replace-textarea" class="code-replace-textarea">' + data.sketchCode + '</textarea>',
						callback: function (value) {
							if (value) {
								let checkedCode = document.getElementById('code-replace-textarea').value;
								cocode.codeReplace({'code':checkedCode});
								// editor.setValue(checkedCode, 1);
								// window.setTimeout(function(){cocode.recompile()}, 300);
								// window.setTimeout(function(){recompile(true)}, 400);
							}else{
								cocode.codeReplaceReject(data);
							}
						}
					})
				});

				this.socket.on('codeReplaceReject', (data)=>{
					syncDown();
					vex.dialog.alert({
						message:'Request denied.',
						callback: function(){}
					})
				});

				this.socket.on('codeReplaceBusy', ()=>{
					syncDown();
					vex.dialog.alert({
						message:'Busy with another request, try later.',
						callback: function(){}
					})
				});

				this.socket.on('requestReject', ()=>{
					syncDown();
					settings.cocoding.request = false;
					updateSettings();
				});

				this.socket.on('codeReplace', (data)=>{
					syncDown();
					RGA.AceEditorRGA.prototype.destroy;
					RGA.AceEditorRGA._lastText = data.code;
					if(settings.cocoding.level == 'admin'){
						editor.setValue('', 1);
						window.setTimeout(function(){editor.setValue(data.code, 1);}, 300);
					}
					window.setTimeout(function(){cocode.recompile()}, 400);
					window.setTimeout(function(){recompile(true)}, 500);
				});

				this.socket.on('toggleEdit', (writeMode)=>{
					syncDown();
					if(writeMode){
						settings.cocoding.writemode = true;
						settings.cocoding.request = false;
						document.getElementById('syncdata-button').removeAttribute('disabled');
						updateSettings();
						editor.setReadOnly(false);
					}else{
						settings.cocoding.writemode = false;
						document.getElementById('syncdata-button').setAttribute('disabled', 'disabled');
						updateSettings();
						editor.setReadOnly(true);
					}
				});

				this.socket.on('syncCursors', (usersRaw) => {
					syncDown();
					this.syncCursors(usersRaw);
				});

				this.socket.on('syncData', (obj)=>{
					syncDown();
					if(sketchLoaded){
						p5f.parseData(obj);
					}
				});

				this.socket.on('addChat', (obj)=>{
					syncDown();
					this.addChat(obj, true);
				});

				this.socket.on('syncChat', (obj)=>{
					syncDown();
					this.parseChat(obj);
				});

				this.socket.on('clearPendingChat', ()=>{
					let pendingChats = document.getElementsByClassName('pending-chat');
					for(let pc of pendingChats){
						pc.remove();
					}
				});

				this.socket.on('syncUsers', (usersRaw) => {
					syncDown();
					this.users = JSON.parse(usersRaw);
					let users = [];
					for (let key in this.users) {
						users.push(this.users[key])
					};

					// sort by request or writemode
					if(settings.cocoding.level == 'admin'){
						users.sort(function(userA,userB){return userA.level-userB.level || userA.request-userB.request || userA.writemode-userB.writemode}).reverse();
					}else{
						users.reverse();
					}

					menuCocodeSketches.innerHTML = '';
					let activeSelf = '';
					let usersHTML = '';
					let usersSelf;
					menuCocodeCounter.innerHTML = users.length;
					for (let i=0; i < users.length; i++) {
						if(users[i].nick != settings.cocoding.nick){
							let userNav = '';
							if(settings.cocoding.lockdown){
								if(settings.cocoding.level == 'admin'){
									if(users[i].writemode){
										userNav = '<a class=" tippy" onclick="cocode.toggleEdit(\''+users[i].nick+'\')" data-title="Toggle EditMode">'+iconToggleRight+'</a>';
									}else{
										userNav = '<a class=" tippy" onclick="cocode.toggleEdit(\''+users[i].nick+'\')" data-title="Toggle EditMode">'+iconToggleLeft+'</a>';
									}
								}
							}

							let active = '';
							let marq = '';
							let writeClass = '';
							let userIcon = iconUsers;
							if(settings.cocoding.lockdown){
								if(users[i].request){
									writeClass = ' write-req ';
								}else if(users[i].writemode || users[i].level == 'admin'){
									writeClass = ' write-access ';
								}
							}
							if(users[i].level == 'admin'){
								userIcon = iconShield;
							}

							if(users[i].nick.length > 10){marq = 'marq';}
							if(users[i].status == 'blur'){
								active = 'style="opacity:.5;"';
							}

							let userNavIconsCount = 1;
							let userNavIcons = '<div class="cocoding-nav">';
							if(users[i].usesyncdata && (!settings.cocoding.lockdown || users[i].writemode)){
								userNavIcons += '<div class="cocoding-sketch-button user-radio-toggle">';
									userNavIcons += '<div class="cocoding-sketch-button-user">'+userIcon+'</div>';
									userNavIcons += '<div class="cocoding-sketch-button-radio">'+iconRadio+'</div>';
								userNavIcons += '</div>';
							}else{
								userNavIcons += '<div class="cocoding-sketch-button">'+userIcon+'</div>';
							}

							if(cocodingShowMic){
								userNavIconsCount++;
								if(1==1){
									userNavIcons += '<div class="cocoding-sketch-button">'+iconMicOff+'</div>';
								}else{
									userNavIcons += '<div class="cocoding-sketch-button">'+iconMic+'</div>';
								}
							}

							if(settings.cocoding.lockdown){
									userNavIcons += '<div class="cocoding-sketch-button">'+userNav+'</div>';
							}
							userNavIcons += '</div>';

							let ccNameStyle = {};
							ccNameStyle.width = 'calc(100% - '+(userNavIconsCount*20)+'px)';


							let singleUserHTML = '<li id="user-'+users[i].nick+'" style="background:'+users[i].color+';" class="item-sketch menu-sketch-holder '+writeClass+'"><div class="menu-sketch"><div class="cocoding-name '+marq+'" style="width:'+ccNameStyle.width+'; left:'+ccNameStyle.left+';" onclick="cocode.scrollCursor('+users[i].cursor.row+','+users[i].cursor.column+');">' +users[i].nick+'</div>'+userNavIcons+'</div></li>';

							if(users[i].level == 'admin'){
								usersHTML = singleUserHTML + usersHTML;
							}else{
								usersHTML += singleUserHTML;
							}

						}else{
							usersSelf = users[i];
							if(usersSelf.status == 'blur'){
								activeSelf = 'style="opacity:.5;"';
							}
						}
					}
						let selfNav = '';
						let userIcon = iconUser;


						let writeClass = '';
						if(settings.cocoding.lockdown && settings.cocoding.level != 'admin'){
							if(usersSelf.request){
								writeClass = ' write-req ';
							}else if(settings.cocoding.writemode){
								writeClass = ' write-access ';
							}
						}

						if(settings.cocoding.level == 'admin'){
							userIcon = iconShield;
						}

						let marq = '';
						if(settings.cocoding.nick.length > 10){marq = 'marq';}

						let userNavIconsCount = 1;
						let userNavIcons = '<div class="cocoding-nav">';
						if(settings.syncdata.active && (!settings.cocoding.lockdown || settings.cocoding.writemode)){
							userNavIcons += '<div class="cocoding-sketch-button user-radio-toggle">';
								userNavIcons += '<div class="cocoding-sketch-button-user">'+iconRadio+'</div>';
								userNavIcons += '<div class="cocoding-sketch-button-radio">'+userIcon+'</div>';
							userNavIcons += '</div>';
						}else{
							userNavIcons += '<div class="cocoding-sketch-button">'+userIcon+'</div>';
						}

						if(cocodingShowMic){
							userNavIconsCount++;
							if(1==1){
								userNavIcons += '<div class="cocoding-sketch-button">'+iconMicOff+'</div>';
							}else{
								userNavIcons += '<div class="cocoding-sketch-button">'+iconMic+'</div>';
							}
						}

						if(settings.cocoding.level == 'user' && settings.cocoding.lockdown){
							let userEditIcon = iconEdit;
							let userEditRequest = 'onclick="cocode.editRequest(\''+settings.cocoding.nick+'\')"';
							let userEditTippy = 'Request Edit';
							if(settings.cocoding.writemode){
								userEditIcon = iconCheckSquare
								userEditRequest = '';
								userEditTippy = 'You can Edit!';
							}
							if(writeClass == ' write-req '){
								userEditTippy = 'Request Pending...';
							}
							userNavIcons += '<div class="cocoding-sketch-button tippy" id="request-'+settings.cocoding.nick+'" '+userEditRequest+' data-title="'+userEditTippy+'">'+userEditIcon+'</div>';
						}

						userNavIcons += '</div>';

						let ccNameStyle = {};
						ccNameStyle.width = 'calc(100% - '+(userNavIconsCount*20)+'px)';

						menuCocodeSketches.innerHTML = '<li id="cocodingself" style="background:'+settings.cocoding.color+';" class="item-sketch menu-sketch-holder '+writeClass+'" '+activeSelf+' >'+selfNav+'<div class="menu-sketch cocoding-user"><div class="cocoding-name '+marq+' tippy" data-title="Set Color + Nickname" style="width:'+ccNameStyle.width+';" onclick="cocode.rename();">' +settings.cocoding.nick+'</div>'+userNavIcons+'</div></li>' + usersHTML;
						loadTippy();
						this.syncCursors(usersRaw);
					});
				}

			rgaConnect(){
				syncUp();
				RGA.AceEditorRGA.setup(editor, this.socket);
			}

			userBG(newVal){
				document.getElementById('cocodingself').style.background = newVal;
			}

			rename(mode){
				// incase no admin is present, offer it
				let renameAdmin = '';
				if(!settings.cocoding.hasAdmin){
					renameAdmin = '<span id="cocoding-rename-admin" class="tippy" data-title="Claim Admin" onclick="cocode.checkAdmin();" style="cursor:pointer;width:25px;">'+iconShield+'</span>'; //
				}

				vex.dialog.open({
					input:[
					'<div id="cocoding-rename-color" class="cocoding-rename-input"><label for="color">Color</label><br>',
					'<input id="cocodingcolor" name="pickr" type="text" autocomplete="off" readonly class="cocode-pickr" style="cursor:pointer;width:50px"></div>',
					'<div id="cocoding-rename-nick" class="cocoding-rename-input"><label for="nick">Nickname</label>'+renameAdmin+'<br>',
					'<input id="cocodingnick" name="nick" type="text" value="' + settings.cocoding.nick + '"></div>',
					'<br><br>',



					].join(''),
					callback: function (data) {
						if(data){
							//console.log(data);
							if(data.nick != settings.cocoding.nick){
								let newName = data.nick.replace(/["']/g, '');
								if(newName.trim() != '' && newName != settings.cocoding.nick){
									settings.cocoding.nick = newName;
									cocode.login();
									updateSettings();
								}
							}
							if(data.pickr != undefined && data.pickr != settings.cocoding.color){
								settings.cocoding.color = data.pickr;
								cocode.userBG(data.pickr);
								cocode.updateColor();
								updateSettings();
							}else{
								//settings.cocoding.color = data.pickr;
							}

						}
					},
					afterOpen: function(){
						loadTippy();
						vexSmall(this.rootEl);
						document.getElementById('cocodingcolor').style.background = settings.cocoding.color;
						let defaultColor = '00aa00';

						if(settings.cocoding.color != null){
							defaultColor = settings.cocoding.color;
						}
						//document.querySelectorAll('.ace_cursor')[0].style.background = defaultColor;
						const pickr2 = Pickr.create({
							el: '#cocodingcolor',
							useAsButton: true,
							theme: 'nano',
							default: defaultColor,

							components: {
								preview: true,
								opacity: false,
								hue: true,

								// Input / output Options
								interaction: {
									input: true,
									save: false,
									cancel:true
								},
							},

							// rename buttons
							strings: {
								cancel: 'Close', // Default for cancel button
								save: 'Set', // Default for save button

							}
						});

						if(mode == 1){
							pickr2.show();
						}else{
							setTimeout(function(){document.getElementById('cocodingnick').select();}, 100);
						}

						pickr2.on('change', (color, instance) => {
							document.getElementById('cocodingcolor').value = '#' + color.toHEXA().join('');
							document.getElementById('cocodingcolor').style.background = '#' + color.toHEXA().join('');
							document.getElementById('cocodingcolor').style.color = '#' + color.toHEXA().join('');
						}).on('save', (color, instance) => {

							// instance.hide();
						}).on('cancel', instance => {
							instance.hide();
						})
					}
				})
			}

			login(){
				syncUp();
				this.socket.emit('login', settings.cocoding.nick);
			}

			updateColor(){
				syncUp();
				// first time cocoder = random color
				if(settings.cocoding.color != null && settings.cocoding.color == '#00aa00'){
					settings.cocoding.color = '#'+Math.floor(Math.random()*16777215).toString(16);
				}
				updateSettings();
				this.socket.emit('updateColor', settings.cocoding.color);
			}

			token(){
				syncUp();
				this.socket.emit('token', settings.cocoding.token);
			}

			checkAdmin(){
				syncUp();
				this.socket.emit('checkAdmin');
			}

			lockdown(lockdownMode){
				syncUp();
				this.socket.emit('lockdown', lockdownMode)
			}

			codeReplaceRequest(userID, sketchName, sketchCode){
				let reqData = {'userID':userID, 'sketchName':sketchName, 'sketchCode':sketchCode}
				syncUp();
				this.socket.emit('codeReplaceRequest', reqData);
			}

			codeReplaceReject(data){
				syncUp();
				this.socket.emit('codeReplaceReject', data);
			}

			codeReplace(data){
				syncUp();
				this.socket.emit('codeReplace', data);
			}

			editRequest(userID){
				settings.cocoding.request = !settings.cocoding.request;
				updateSettings();

				let reqData = {'userID':userID, 'mode':settings.cocoding.request}
				syncUp();
				this.socket.emit('editRequest', reqData);
			}

			toggleEdit(userID){
				syncUp();
				this.socket.emit('toggleEdit', {'userID':userID});
			}

			requestReject(userID){
				syncUp();
				this.socket.emit('rejectRequest', {'userID':userID});
			}

			dispatchSyncEvent(evMode, evType, evOpts){
				let ev = {'mode':evMode, 'type':evType, 'options':evOpts, 'fc':p5f.frameCount};
				syncUp();
				this.socket.emit('dispatchSyncEvent', ev);
			}

			recompile(force){
				syncUp();
				this.socket.emit('recompile', force);
			}

			sync(syncMode){
				syncUp();
				this.socket.emit('sync', {'mode':syncMode, 'fc':p5f.frameCount});
			}

			cursorPos(pos){
				syncUp();
				this.socket.emit('cursor', pos);
			}

			parseChat(chatObj){
				menuCocodeChatDialog.innerHTML = '';
				for(let chatItem of chatObj){
					cocode.addChat(chatItem);
				}
			}

			addChat(msg){
				let msgID = '', pendingChat = '';
				let pendingMsg = document.getElementById(msg.msgID);
				let notifyChat = false;
				if(msg.type && msg.type == 'pending'){
					msgID = 'id="'+msg.msgID+'"';
					pendingChat = 'pending-chat';
				}else if(msg.type && msg.type == 'clear'){
					if(pendingMsg != undefined){
						pendingMsg.remove();
						return false;
					}
				}else{
					if(pendingMsg != undefined){
						pendingMsg.remove();
						notifyChat = true;
					}
				}

				// check if at bottom of chat
				let autoScroll = false;
				if(menuCocodeChatDialog.scrollHeight - menuCocodeChatDialog.scrollTop < 200){
					autoScroll = true;
				}

				let msgHTML = '<div class="chat-item" '+msgID+'>';
					msgHTML += '<div class="chatmsg '+pendingChat+'">';
					let marq = '';
					if(msg.nick.length > 9){marq = 'longname marq';}
					msgHTML += '<div class="chatname '+marq+'" style="background:'+msg.color+';">'+msg.nick+'</div>&nbsp;';
					msgHTML += '<span class="chattext ">'+linkify(msg.text)+'</span>';
					msgHTML += '</div>';
					msgHTML += '</div>';
					menuCocodeChatDialog.innerHTML += msgHTML;

					// only auto scroll if at bottom, otherwise small offset for feedback
					if(autoScroll){
						menuCocodeChatDialog.scrollTop = menuCocodeChatDialog.scrollHeight;
					}else{
						menuCocodeChatDialog.scrollTop += 10;
					}

					// check if settings.. + if menu hidden...
					if(settings.notifyToggle && (menuPanel.style.marginRight == '-250px' || panelSettings.style.display == 'block') && notifyChat){
						let notifyHTML = '';
						notifyHTML += '<div class="chatname '+marq+'" style="background:'+msg.color+';">'+msg.nick+'</div>&nbsp;';
						notifyHTML += '<br><span class="chattext ">'+linkify(msg.text)+'</span>';

						notifyMsg(notifyHTML);
					}
			}

			scrollCursor(userRow, userColumn){
				editor.renderer.scrollCursorIntoView({row: userRow, column: userColumn}, 0.5);
			}

			syncCursors(usersRaw){
				this.users = JSON.parse(usersRaw);
					marker.cursors = [];

					let elements = document.getElementsByClassName('cursor');
					while(elements.length > 0){
						elements[0].parentNode.removeChild(elements[0]);
					}

					for (let key in this.users) {
						marker.cursors.push({row:this.users[key].cursor.row, column:this.users[key].cursor.column, color:this.users[key].color, id:this.users[key].nick});
					};
					marker.redraw();
			}
		};

		// cocode extras

		function linkify(text) {
			var urlRegex =/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
			return text.replace(urlRegex, function(url) {
				return '<a href="' + url + '" target="_blank">' + url + '</a>';
			});
		}

		function showUsers(){
			let cursorSel = document.getElementsByClassName('cursor');
			for(let i=0; i < cursorSel.length; i++){
				cursorSel[i].style.display = 'block';
			}
			showCursors = true;
		}

		function hideUsers(){
			let cursorSel = document.getElementsByClassName('cursor');
			for(let i=0; i < cursorSel.length; i++){
				cursorSel[i].style.display = 'none';
			}
			showCursors = false;
		}

		let syncUpTimer;
		function syncUp(){
			clearTimeout(syncUpTimer);
			menuCocodeUp.style.opacity = 1;
			syncUpTimer = window.setTimeout(function(){
				menuCocodeUp.style.opacity = .25;
			}, 200);

		}

		let syncDownTimer;
		function syncDown(){
			clearTimeout(syncDownTimer);
			menuCocodeDown.style.opacity = 1;
			syncDownTimer = window.setTimeout(function(){
				menuCocodeDown.style.opacity = .25;
			}, 200);

		}



		/* FANCY EDITOR FUNCTIONS */

		editor.getSession().selection.on('changeCursor', function(){
			//console.log(editor.getCursorPosition());
			curPos = editor.getCursorPosition();

			// sync cursors in COCODING
			if(settings.cocoding.active && cocode != null){
				updateCursor = window.setTimeout(function(){cocode.cursorPos(curPos);}, 200);
			}
			// curPositions.push(editor.getCursorPosition());
		})

		editor.getSession().on('change', function(delta){
			curPos = delta.start;
			curPositions.push(delta.start);
			checkErrors();

		});

		// check for errors
		editor.getSession().on('changeAnnotation', function(){
			let annot = editor.getSession().getAnnotations();

			// extra debug info (too raw.. but nice to have better p5.js specific debugging in console)
			// for (var key in annot) {
			// 	if (annot.hasOwnProperty(key))
			// 	console.log(annot[key].text + "on line " + " " + annot[key].row);
			// }

			validCode = true;
			for(let i=0; i < annot.length; i++){
				if(annot[i].type === 'error'){
					addMarker(annot[i].row);
					validCode = false;
				}
			}
			if(validCode){
				removeMarkers();
			}
		});

		function addMarker(n){
			let elementPos = markerID.map(function(x) {return x.line; }).indexOf(n);
			if (elementPos === -1) {
				markerID.push({'line':n, 'id':editor.session.addMarker(new Range(n, 0, n, 7000), 'myMarker', 'fullLine')});
			}
		}

		function removeMarkers(){
			for(let i=0; i < markerID.length; i++){
				editor.session.removeMarker(markerID[i].id);
			}
			markerID = [];
		}

		// set editor BG
		editor.renderer.on('afterRender', function(){
			adjustLines();
		});

		function adjustLines(){
			let pcode = p5editor.getElementsByClassName('ace_line');
			for(let i=0; i < pcode.length; i++){
				let pitem = pcode[i];
				let pcontents = pitem.innerHTML;
				if(settings.themeBGactive){
					pitem.innerHTML = '<span class="ace_line_bg" style="background:' + settings.themeBG + '">' + pcontents + '</span>';
				}
			}
		}



		/* CMD-KEYS (removing key conflicts, replaced below w/o conflict) */
		editor.commands.removeCommands([
			'backspace' // ctrl + h
			,'gotoright' // ctrl + f
			,'golineup' // ctrl + p mac
			,'golinedown' // ctrl + n
			,'gotolinestart' // ctrl + a
			,'gotolineend' // ctrl + e
			,'jumptomatching' // ctrl + p windows
			,'splitline' // ctrl + o (totally removed)
			,'transposeletters' // ctrl + t (totally removed)
			]);

		// replace backspace w/o ctrl + h
		editor.commands.addCommand({
			name: 'backspace',
			bindKey: { win: 'Shift-Backspace|Backspace', mac: 'Ctrl-Backspace|Shift-Backspace|Backspace' },
			exec: function(e) { e.remove('left') },
			multiSelectAction: 'forEach',
			scrollIntoView: 'cursor'
		});

		// replace gotoright w/o ctrl + f
		editor.commands.addCommand({
			name: 'gotoright',
			bindKey: { win: 'Right', mac: 'Right' },
			exec: function(e,t) { e.navigateRight(t.times) },
			multiSelectAction: 'forEach',
			scrollIntoView: 'cursor',
			readOnly:!0
		});

		// replace golineup w/o ctrl + p
		editor.commands.addCommand({
			name: 'golineup',
			bindKey: { win: 'Up', mac: 'Up' },
			exec: function(e,t) { e.navigateUp(t.times) },
			multiSelectAction: 'forEach',
			scrollIntoView: 'cursor',
			readOnly:!0
		});

		// replace golinedown w/o ctrl + n
		editor.commands.addCommand({
			name: 'golinedown',
			bindKey: { win: 'Down', mac: 'Down' },
			exec: function(e,t) { e.navigateDown(t.times) },
			multiSelectAction: 'forEach',
			scrollIntoView: 'cursor',
			readOnly:!0
		});

		// replace gotolinestart w/o ctrl + a
		editor.commands.addCommand({
			name: "gotolinestart",
			description: "Go to line start",
			bindKey: { win: 'Alt-Left|Home', mac: 'Command-Left|Home' },
			exec: function(editor) { editor.navigateLineStart(); },
			multiSelectAction: "forEach",
			scrollIntoView: "cursor",
			readOnly: true
		});

		// replace gotolineend w/o ctrl + e
		editor.commands.addCommand({
			name: "gotolineend",
			description: "Go to line end",
			bindKey: { win: 'Alt-Right|End', mac: 'Command-Right|End' },
			exec: function(editor) { editor.navigateLineEnd(); },
			multiSelectAction: "forEach",
			scrollIntoView: "cursor",
			readOnly: true
		});

		// replace jumptomatching w/o ctrl + p
		editor.commands.addCommand({
			name: "jumptomatching",
			description: "Jump to matching",
			bindKey: { win: 'Ctrl-\\', mac: 'Command-\\' },
			exec: function(editor) { editor.jumpToMatching(); },
			multiSelectAction: "forEach",
			scrollIntoView: "animate",
			readOnly: true
		});

		// beautify!
		let beautifyOptions = {
			'indent_size': '1',
			'indent_char': '\t',
			'max_preserve_newlines': '5',
			'preserve_newlines': true,
			'keep_array_indentation': false,
			'break_chained_methods': false,
			'indent_scripts': 'normal',
			'brace_style': 'collapse',
			'space_before_conditional': false,
			'unescape_strings': false,
			'jslint_happy': false,
			'end_with_newline': false,
			'wrap_line_length': '0',
			'indent_inner_html': false,
			'comma_first': false,
			'e4x': false
		}

		// fix german keyboard binding for /
		// editor.commands.bindKey("cmd-shift-7", "togglecomment")
		// editor.commands.bindKey("ctrl-shift-7", "togglecomment")

		/* DEBUG EDITOR COMMANDS + STORAGE */

		// list ace editor commands
		function listCommands(){
			let cmds = editor.commands.commands;
			let k = [];
			for (let cmd in cmds){
				k.push(cmd.name + ' = ' + cmd.bindKey);
			}
		}

		// check storageKeys
		function getKeys(){
			let k = [];
			for (let key in localStorage){
				k.push(key);
			}
		}

		if(settings.debugMode){
			listCommands();
			getKeys();
		}



		/* p5 iframe communication */

		// mark error line
		window.document.addEventListener('p5Status', handleEvent, false)
		function handleEvent(e) {
			if(e.detail.lineNumber != undefined){
				let errorLine = parseInt(e.detail.lineNumber)-1;
				addMarker(errorLine);
			}else{
				removeMarkers()
			}
			// sketchloaded
			if(e.detail.status){
				// p5f.frameCount = p5vars.frameCount;
				// p5f.mouseX = p5vars.mouseX;
				// p5f.mouseY = p5vars.mouseY;

				// p5f.setup(); // better than clear/background, reinit w/ updated vars
				//p5varsReset();

				sketchLoaded = true;
				popStream();
				syncdataParse(); // promise for syncdata if active
				if(sketchLoaded && cocodingRecompile && settings.cocoding.level == 'admin'){
					cocode.recompile(true);
					cocodingRecompile = false;
				}
			}else{
				sketchLoaded = false;
				// set timer for refreshing if error
			}
		}



		/* SETTINGS */

		// init settings
		loadSettings();


		// get settings from localstorage
		function getSettings(){
			let tempSettings = initSettings;
			if(localStorage.hasOwnProperty('settings')){
				tempSettings = JSON.parse(localStorage.getItem('settings'));
			}
			return tempSettings;
		}

		// react to settings once gathered
		function loadSettings(){
			// check online or offline
			if(window.location.hostname.includes('teddavis.org')){
				p5Remote = true;
			}else{
				p5Remote = false;
				document.title = 'P5LIVE – OFFLINE';
			}

			// make sure all settings are there
			let settingsChanged = false;
			Object.keys(initSettings).forEach(function(k){
				if(!settings.hasOwnProperty(k)){
					settings[k] = initSettings[k];
					settingsChanged = true;
				}else if(typeof initSettings[k] === 'object'){
					Object.keys(initSettings[k]).forEach(function(kk){
						if(!settings[k].hasOwnProperty(kk)){
							settings[k][kk] = initSettings[k][kk];
							settingsChanged = true;
						}
					});
				}
				if(settingsChanged){
					settings.refresh = true;
				}
			});
			updateSettings();

			if(settings.revision == undefined || settings.revision < currentRevision){
				settings.revision = currentRevision;
				settings.version = initSettings.version;
				settings.fileName = 'new';
				settings.welcome = true;
				settings.refresh = true;
				updateSettings();
			}

			document.getElementById('menu-p5live-version').innerHTML = settings.version;
			loaderSub.innerHTML = 'settings...';
			fontSizeUpdate();
			autoCompileUpdate();
			compileTimerUpdate();
			menuToggleUpdate();
			ecoRenderUpdate();
			cursorToggleUpdate();
			consoleToggleUpdate();
			menutabToggleUpdate();
			autocompleteUpdate();
			linenumbersUpdate();
			lockDragUpdate();
			exportcodeUpdate();
			notifyToggleUpdate();
			tippyToggleUpdate();
			multitabToggleUpdate();
			timestampToggleUpdate();
			passEditorKeysUpdate();
			loadTheme();
			themeBGactiveToggleUpdate();
			loaderSub.innerHTML = 'templates...';
			loadSketchTemplate();
			loadHTMLTemplate();
			loaderSub.innerHTML = 'snippets...';
			loadSnippets();
			loaderSub.innerHTML = 'SyncData presets...';
			syncDataPresetLoad();
			loaderSub.innerHTML = 'autocomplete...';
			loadAutoComplete();
			loadColorPicker();
			vex.defaultOptions.className = 'vex-theme-plain'
			legacySettings(); // update sketches from 1.0.2
			if(settings.cocoding != undefined){
				settings.cocoding.active = false;
			}else{
				// settings = initSettings;
				// updateSettings();
				// window.setTimeout(function(){location.reload(true);}, 300);
			}
			settings.safeMode = false;
			updateSketches();
			filterSketches();

			if(settings.refresh){
				refreshDemos();
				settings.refresh = false;
				updateSettings();
			}

			settings.editMode = true;
			if(getParam('edit') != undefined && getParam('edit') == 0){
				settings.editMode = false;
				editor.setReadOnly(true);
				p5editor.style.display = 'none';
				menuPanel.style.display = 'none';
				settings.welcome = false;
				updateSettings();
			}else{
				loaderSub.innerHTML = 'shortcuts...';
				updateShortcuts();
			}

			if(getParam('cc') != undefined){
				loaderSub.innerHTML = 'cocoding...';
				if(getParam('cc').length != 5){
					cocodingExit(loadLatest());
					return false;
				}
				let ccSpace = getParam('cc');
				if(settings.cocoding.token != hashCode(ccSpace)){
					cocodingReset();
				}
				settings.cocoding.active = true;
				menuCocodeSync.style.display = 'inline';
				if(settings.cocoding.timestamp == null){
					settings.cocoding.timestamp = timeStamp();
				}
				menuCocode.style.display = 'block';
				settings.fileName = ccSpace;
				settings.cocoding.namespace = settings.fileName;
				if(settings.cocoding.nick == undefined || settings.cocoding.nick == ''){
					settings.cocoding.nick = generateName();//makeid(6);
					cocodingFirstTime = true;
				}
				updateSketches();
				cocoding();
			}else if(window.location.hash){
				if(window.location.hash.substring(1) === 'new'){
					loadDefault();
				}else if(window.location.hash.substring(1).toLowerCase() === 'bug'){
					loadBug();
				}else{ // else if(window.location.hash.indexOf('ref') != -1)
					loaderSub.innerHTML = 'loading references...';
					loadRef();
					loadSketch(settings.fileName);
				}
			}else{
				cocodingReset();
				loadSketch(settings.fileName);
			}

			if(settings.welcome){
				loadAbout();
				if(!settings.cocoding.active){
					loadDefault();
				}
				menuToggle(true);
				settings.welcome = false;
				updateSettings();
			}
			resizeSketchesHolder();
			hideLoader();

			// test multiple open
			// inspiration: https://stackoverflow.com/a/43291970/10885535
			if(settings.multitabToggle){
				localStorage.openpages = Date.now();
				var onLocalStorageEvent = function(e){
					if(e.key == "openpages"){
						// Listen if anybody else opening the same page!
						localStorage.page_available = Date.now();
					}
					if(e.key == "page_available"){
						vex.dialog.alert({
							unsafeMessage:'<span class="pulse">Warning:</span> <br>'+document.title+' open in multiple tabs!<br>Close all but one to avoid data loss.',
							afterOpen: function(){
								vexSmall(this.rootEl);
							}
						});
					}
				};
				window.addEventListener('storage', onLocalStorageEvent, false);
			}
		}

		function getParam(paramSearch){
			let params = document.location.search.substring(1).split('&');
			for(let i=0; i<params.length; i++){
				let keyVal = params[i].split('=');
				if(keyVal[0] == paramSearch){
					return keyVal[1];
				}
			}
		}



		/*	SKETCHES TASKS	*/
		// set settings to localstorage
		function updateSettings(){
			localStorage.setItem('settings', JSON.stringify(settings));
			if(settings.debugMode){console.log(getSettings());}
		}

		function showSettings(show){
			if(show){
				if(refVisible){
					closeRef();
				}

				if(settingsVisible){
					hideSettings();
					menuToggle(false);
				}else{
					settingsVisible = true;
					menuToggle(true);
				}

			}
			panelSettings.style.display = 'block';
			panelMenu.style.display = 'none';
			settingsVisible = true;
		}

		function hideSettings(){
			panelSettings.style.display = 'none';
			panelMenu.style.display = 'block';
			settingsVisible = false;
		}

		function resizeSketchesHolder(){
			let sectionHeader = menuSectionSketches.offsetHeight - sketchesHolder.offsetHeight;
			let sectionHeight = menuSectionP5live.offsetHeight + menuCocode.offsetHeight;
			sketchesHolder.style.height = Math.floor(window.innerHeight - sectionHeight - sectionHeader*2)-5 + 'px';
		}

		window.onresize = resizeSketchesHolder;

		function resetSettings(){
			if(settings.cocoding.active){
				settingsCocodingWarning();
				return false;
			}
			vex.dialog.confirm({
				unsafeMessage: 'Reset to default settings?<br>Sketches will be left untouched.',
				callback: function (value) {
					if (value) {
						Object.keys(initSettings).forEach(function(k){
							if(k != 'sketches' && k != 'welcome'){
								settings[k] = initSettings[k];
							}
						});
						updateSettings();
						loadSettings();
					}
				}
			})
		}

		function settingsCocodingWarning(){
			vex.dialog.alert({
				unsafeMessage:'Exit COCODING to change settings.',
				afterOpen: function(){
					vexSmall(this.rootEl);
				}
			});
		}

		function exportSettings(){
			let jsonExport = {};
			jsonExport.doctype = 'P5L_SETTINGS';
			jsonExport.date = timeStamp();
			jsonExport.settings = {}
			Object.keys(settings).forEach(function(k){
				if(k != 'sketches'){
					jsonExport.settings[k] = settings[k];
				}
			});

			exportJSON(jsonExport, 'P5L_SETTINGS'+timeStampFile()+'.json');
		}

		function importSettings(data){
			if(settings.cocoding.active){
				settingsCocodingWarning();
				return false;
			}

			for(let i=0; i < data.length; i++){
				let reader = new FileReader();
				reader.onload = function(data) {
					let tSettings = JSON.parse(data.target.result);
					let jsonObjList = JSON.parse(data.target.result);
					if(tSettings.hasOwnProperty('doctype') && tSettings.doctype == 'P5L_SETTINGS'){
						let warnImport = 'Replace settings with imported file?';
						if(tSettings.revision < initSettings.revision){
							warnImport += '<br>Imported settings are from an earlier version of P5LIVE, hopefully this will work...';
						}

						// first confirm importing of settings
						vex.dialog.confirm({
							unsafeMessage:warnImport,
							callback: function(value){
								if(value){
									Object.keys(tSettings.settings).forEach(function(k){
										if(settings.hasOwnProperty(k)){
											settings[k] = tSettings.settings[k];
										}
									});
									updateSettings();
									loadSettings();
								}
							}
						})
					}else{
						vex.dialog.alert({
							message:'Oops, select a P5L_SETTINGS file.'
						})
					}
				}
				reader.readAsText(data[i]);
			}
		}

		function updateShortcuts(){
			updateSettings();
			shortcutRecording = false;
			Mousetrap.reset();
			Mousetrap.unpause();

			let shortcutsList = '';
			Object.keys(settings.shortcuts).forEach(function(sc, cc){
				let shortcut = settings.shortcuts[sc];

				if(shortcut.init != undefined){
					eval(shortcut.init);
				}else{
					Mousetrap.bind(shortcut.key, function(){
						if(settings.notifyToggle){
							showNotify = true;
						}
						eval(shortcut.callback);
						return false;
					}).stopCallback = function(e, element, combo) {};
				}

				let shortcutTippy = 'Click to modify shortcut';
				if(shortcut.tippy != undefined){
					shortcutTippy += '<br>'+shortcut.tippy;
				}

				shortcutsList +='<div class="shortcut-item tippy-left" data-title="' + shortcutTippy + '" onclick="recordShortcut(this, \''+sc+'\')">' + shortcut.name + ' <div class="shortcut-keys" ><span id="shortcut-' + sc + '" class="shortcut-input">' + parseShortcut(shortcut.key) + '</span></div></div>';
			});
			settingsShortcuts.innerHTML = shortcutsList;
			loadTippy();
		}

		function parseShortcut(txt){
			let scParts = txt.split('+');
			for(let i=0; i<scParts.length;i++){
				switch(scParts[i].toLowerCase()){
					case 'meta':
						scParts[i] = '<span class="shortcut-key">⌘</span>'
					break;
					case 'ctrl':
						scParts[i] = '<span class="shortcut-key">CTRL</span>'
					break;
					default:
						scParts[i] = '<span class="shortcut-key">' + scParts[i].toUpperCase() + '</span>';
					break;
				}
			}
			return scParts.join('+');
		}

		function recordShortcut(elm, sc){
			if(shortcutRecording){
				updateShortcuts();
			}else{
				elm.classList.add('shortcut-ani');
				Mousetrap.pause();
				let shortcut = settings.shortcuts[sc];
				shortcutRecording = true;
				Mousetrap.record(function(sequence) {
					let repeatShortcut = false;
					Object.keys(settings.shortcuts).forEach(function(ssc){
						let sshortcut = settings.shortcuts[ssc];
						if(sequence.join(' ') == sshortcut.key){
							repeatShortcut = true;
						}else if(sequence.join(' ') == shortcut.key){
							repeatShortcut = false;
						}
					});
					if(!repeatShortcut && shortcutRecording){
						shortcut.key = sequence.join(' ');
					}
					updateShortcuts();
				});
			}
		}

		// setup quickjump shortcuts
		function setupJumpSketches(key){
			let keyBindings = [];
			for(let i=0; i < 10;i++){
				keyBindings.push(key+'+'+i);
			}
			Mousetrap.bind(keyBindings, function(e) {
				jumpSketches(e.key);
			});
		}

		// quick jump
		function jumpSketches(kc){
			let keySketch = kc - 1;
			if(keySketch == -1){keySketch = 9;}
			loadSketch(listSketches(settings.sketches)[keySketch]);
		}

		// bug
		function loadBug(){
			settings.safeMode = true;
			let bugName = settings.fileName;
			updateSettings();
			loadDefault();
			inspectItem(bugName)
		}

		// set sketches list to localstorage
		function updateSketches(){
			updateSettings();
			initSortable();
		}

		// search laundry list of sketches
		// inspired by: https://www.w3schools.com/howto/howto_js_filter_lists.asp
		function filterSketches(){
			let demosFolder = document.getElementById('demofolder');
			let filterClear = document.getElementById('menu-sketches-filter-clear');
			let filter = menuSketchesFilter.value.toLowerCase().split(' ');
			let filterItems = menuSketches.getElementsByClassName('drag-item');

			// remove empty while adding another word
			filter = filter.filter(Boolean);

			// remove filter from all
			for(let fi of filterItems){
				fi.classList.remove('filter');
				fi.classList.remove('filter-match');
			}

			// if chars typed
			if(filter != ''){
				// scroll back to top
				sketchesHolder.scrollTop = 0;

				for (let fi of filterItems) {

					// if item's name filtered
					let filterItemName = fi.getAttribute('data-id');

					// match separated words ***
					if ( filter.some((val) => filterItemName.toLowerCase().indexOf(val) !== -1)){
					// if (filterItemName.toLowerCase().indexOf(filter) > -1) {

						// add to filter items
						fi.classList.add('filter');

						// if item folder, filter-reveal all children
						if(fi.getAttribute('data-type') == 'folder'){
							fi.getElementsByClassName('menu-folder-svg')[0].innerHTML = iconFolderEmpty;
							let fiKids = fi.getElementsByClassName('drag-item');
							for(let fik of fiKids){
								fik.classList.add('filter');
								if(fik.getAttribute('data-type') == 'folder'){
									fik.getElementsByClassName('menu-folder-svg')[0].innerHTML = iconFolderEmpty;
								}
							}
						}

						// if item within folder, filter-reveal all parents
						let folderParents = getParentFolders(fi);
						for(let fp of folderParents){
							fp.classList.add('filter');
							fp.getElementsByClassName('menu-folder-svg')[0].innerHTML = iconFolderEmpty;
						}
					} else {
						// else hide item
						fi.style.display = 'none';
					}
				}

				// show all filtered ietms, mark matches
				let getFilters = menuSketches.getElementsByClassName('filter');
				for(let gf of getFilters){
					gf.style.display = 'block';
					let filterItemName = gf.getAttribute('data-id');

					// match separated words ***
					if (filterItemName != undefined && filter.some((val) => filterItemName.toLowerCase().indexOf(val) !== -1)){
					// if (filterItemName != undefined && filterItemName.toLowerCase().indexOf(filter) !== -1){
						gf.classList.add('filter-match');
					}
				}

				// hide demos (unless modifying)
				// if(demosFolder != undefined && demosLocked){
				// 	demosFolder.style.display = 'none';
				// }

				// change filter icon based on state
				filterClear.innerHTML = iconX;
			}else{
				// show all if filter empty
				for (let fi of filterItems) {
					fi.style.display = '';
				}
				// if(demosFolder != undefined){
				// 	demosFolder.style.display = '';
				// }
				filterClear.innerHTML = iconFilter;
				initSortable();
			}
		}

		function getParentFolders(elem) {
			var parents = [];
			while(elem.parentNode && elem.parentNode.nodeName.toLowerCase() == 'ul') {
				elem = elem.parentNode;
				parents.push(elem);
			}
			return parents;
		}

		// clear filter
		function filterSketchesClear(forceFocus){
			if(menuSketchesFilter.value == ''){
				if(forceFocus){
					menuSketchesFilter.focus();
				}
			}else{
				menuSketchesFilter.value = '';
				filterSketches();
			}
			sketchScrollIntoView(true);
		}

		// padding version numbers of sketch
		function pad(num, size) {
			let s = '0000' + num;
			return s.substr(s.length-size);
		}

		// use sketch versions instead of timestamp
		function versionCheck(sketchName, importObj){
			let tempName = sketchName;
			let forkScores = tempName.split('_');
			if(forkScores.length > 0){
				let forkVersion = forkScores[forkScores.length-1];
				if(!isNaN(forkVersion) && forkVersion.length == 3){
					forkScores[forkScores.length-1] = pad(parseInt(forkVersion)+1, 3);
				}else{
					forkScores.push('001');
				}
			}
			tempName = forkScores.join('_');

			// check entire sketches for dup version name
			if(importObj !== undefined){
				while(searchSketches(tempName, settings.sketches) || searchSketches(tempName, importObj)){
					tempName = versionCheck(tempName, importObj);
				}
			}else{
				while(searchSketches(tempName, settings.sketches)){
					tempName = versionCheck(tempName);
				}
			}

				return tempName;
		}

		// save sketch as...
		function cloneSketch(){
			if(settings.cocoding.active){
				cloneSketchCOCODING();
				return false;
			}
			let forkName = versionCheck(settings.fileName);
			let tc = timeDate();

			let checkDemo = document.querySelectorAll('[data-id="'+settings.fileName+'"]')[0].classList.contains('demo');
			let checkDir = searchJSON(settings.sketches, 'name', settings.fileName)[0];
			settings.fileName = forkName;
			updateSettings();



			if(checkDir != undefined && checkDir.parent != undefined && checkDir.parent != 'demos' && !checkDemo || !demosLocked){
				let useDir = searchJSON(settings.sketches, 'name', checkDir.parent)[0];
				useDir.contents.unshift({'type':'sketch', 'name':forkName, 'mod':tc});
				useDir.toggle = 'expand';
			}else{
				settings.sketches.unshift({'type':'sketch', 'name':settings.fileName, 'mod':tc});
			}

			updateSketches();
			localStorage[settings.fileName] = editor.getValue();
			editor.focus();
			editor.session.off('change', cloneSketch);
			sketchScrollIntoView(true);
		}

		function cloneSketchCOCODING(){
			let tc = timeDate();
			let forkSession = 'cc_'+settings.cocoding.namespace+'_'+settings.cocoding.timestamp;
			if(searchJSON(settings.sketches, 'name', forkSession).length == 0){
				addFolder(forkSession);
			}
			// let forkName = forkSession+'_'+timeStamp();
			let forkName = versionCheck(settings.fileName);

			settings.fileName = forkName;
			updateSettings();
			let forkObj = searchJSON(settings.sketches, 'name', forkSession)[0];
			forkObj.contents.unshift({'type':'sketch', 'name':forkName, 'mod':tc});
			forkObj.toggle = 'expand';
			updateSketches();
			localStorage[forkName] = editor.getValue();
		}

		// load sketch
		function loadSketch(sketch, lineNum){
			if(settings.cocoding.active){

				vex.dialog.confirm({
					message: 'Exit COCODING?',
					callback: function (value) {
						if (value) {
							cocodingExit(sketch);

						}
					},
					afterOpen: function(){
						vexSmall(this.rootEl);
					}
				})

				// *** launch once better RGA solution for complete text replace is found
				/*
				if(settings.cocoding.level == 'admin'){
					vex.dialog.confirm({
						unsafeMessage:'Replace code with<br><hr><div class="code-replace-header">SketchName</div>'+sketch+'<br><div class="code-replace-header">SketchCode</div> <textarea id="code-replace-textarea" class="code-replace-textarea">'+localStorage[sketch]+'</textarea>',
						callback: function (value) {
							if (value) {
								let checkedCode = document.getElementById('code-replace-textarea').value;
								cocode.codeReplace({'code':checkedCode});
								//cocode.codeReplace({'code':localStorage[sketch]});
								// editor.setValue(localStorage[sketch], 1);
								// window.setTimeout(function(){cocode.recompile()}, 300);
								// window.setTimeout(function(){recompile(true)}, 400);
							}
						}
					})
				}else{
					if(settings.cocoding.writemode || !settings.cocoding.lockdown){
						vex.dialog.confirm({
							unsafeMessage: 'Request to replace code with:\n' + sketch,
							callback: function (value) {
								if (value) {
									cocode.codeReplaceRequest(settings.cocoding.nick, sketch, localStorage[sketch]);
								}
							}
						})
					}else{
						vex.dialog.alert({
							message:"Editor is locked, request to edit.",
							callback: function(){}
						})
					}
				}
				*/
			}else {
				if(localStorage.hasOwnProperty(sketch)){
					editor.getSession().off('change', cloneSketch);
					// auto expand folder (incase of short-cut selection)
					recursiveFolderExpand(settings.sketches, sketch, '');
					settings.fileName = sketch;
					editor.setValue(localStorage[settings.fileName], 1);

					pLen = editor.getValue().length;
					updateSketches();

					p5varsReset();

					// restart undo to prevent overwrite selected sketch
					editor.getSession().setUndoManager(new ace.UndoManager());
					editor.focus();
					let lineCount = editor.session.getLines(0, editor.session.getLength()).length;
					if(lineNum != undefined && lineCount >= lineNum){
						editor.gotoLine(lineNum, 1, false);
					}

					let checkDemo = searchJSON(settings.sketches, 'name', 'demos');//listSketches(settings.sketches.demo);
					if(searchSketches(settings.fileName, checkDemo) && demosLocked){
						if(settings.fileName == 'new'){
							// window.location.hash = '#'; // *** removed for conflict w/ #bug + refs...
						}
						editor.getSession().on('change', cloneSketch);
					}

				}else if(!localStorage.hasOwnProperty(sketch) && searchSketches(sketch, settings.sketches)){

					vex.dialog.confirm({
						message:'Sketch code missing, remove from list?',
						callback: function(value){
							if(value){
								removeItemProcess(sketch);
							}
						}
					})
				}else{
					// start new sketch
					if(listSketches(settings.sketches).length > 0){
						settings.fileName = loadLatest();
						updateSettings();
						loadSketch(settings.fileName);
					}else{
						loadDefault();
					}
				}
			}
		}

		function loadSketchTemplate(){
			let tempPath = 'includes/templates/p5live_sketch.html?' + makeid(5);;
			let request = new XMLHttpRequest();
			request.open('GET', tempPath, true);
			request.send();
			request.addEventListener('load', function(){
				let el = document.createElement('html');
				el.innerHTML = request.responseText;
				p5frameTemplate = el;
			});
		}

		// load top sketch
		function loadLatest(){
			return listSketches(settings.sketches)[0];
		}

		// pause sketch on demand
		function pauseSketch(){
			if(sketchLoaded){
				paused = !paused;
				if(paused){
					p5f.noLoop();
					if(showNotify){
						notifyMsg('Paused');
					}
				}else{
					p5f.loop();
					if(showNotify){
						notifyMsg('Resumed');
					}
				}
			}
		}

		function searchSketches(sketchName, obj){
			let sketchesFlat = JSON.stringify(obj);
			if( sketchesFlat.indexOf('"' + sketchName + '"') > -1 ) {
				return true;
			}else{
				return false;
			}
		}

		function searchJSON(obj, key, value, out, dir) {
			if(out == undefined){
				out = [];
			}
			if(Array.isArray(obj)){
				obj.forEach(function(o){
					if(o[key] == value){
						if(dir != undefined){
							o.parent = dir;
						}
						out.push(o);
					}else

					if(o.contents){
						searchJSON(o.contents, key, value, out, o.name);
					}
				});
			}

			return out;
		}



		/* IMPORT/EXPORT SKETCHES */

		function exportJSON(jsonData, jsonFilename){
			const filename = jsonFilename;
			const jsonStr = JSON.stringify(jsonData, undefined, 2);

			let element = document.createElement('a');
			element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(jsonStr));
			element.setAttribute('download', filename);

			element.style.display = 'none';
			document.body.appendChild(element);

			element.click();

			document.body.removeChild(element);
		}

		// export single sketch to JSON
		function exportSketch(sketch){
			let tempSketches = {};
			tempSketches.version = settings.version;
			tempSketches.revision = settings.revision;
			tempSketches.count = {sketches:1, folders:0};
			tempSketches.structure = [];

			let sketchDetails = searchJSON(settings.sketches, 'name', sketch)[0];
			if(localStorage.hasOwnProperty(sketch)){
				sketchDetails.code = localStorage.getItem(sketch);
				tempSketches.structure.push(sketchDetails);
				exportJSON(tempSketches, 'P5L_' + sketch + timeStampFile(sketchDetails.mod) + '.json');
			}else{
				alertMsg('Sketch code missing...');
			}
		}

		// export all/folder[s] w/ sketches to JSON
		function exportSketches(folder){
			let tempSketches = {}, objCopy, tempType;
			tempSketches.version = settings.version;
			tempSketches.revision = settings.revision;

			if(folder !== undefined){
				let folderObj = searchJSON(settings.sketches, 'name', folder);
				objCopy = JSON.parse(JSON.stringify(folderObj));
				tempType = 'FOLDER_'+ folder+'';
			}else{
				objCopy = JSON.parse(JSON.stringify(settings.sketches));
				tempType = 'SKETCHES';
			}
			if(!demosLocked && folder === 'demos'){
				tempSketches.structure = exportAddCode(objCopy, true);
			}else{
				tempSketches.structure = exportAddCode(objCopy);
			}

			// remove demos
			if(demosLocked){
				tempSketches.structure = tempSketches.structure.filter(function( obj ) {
					return obj.name !== 'demos';
				});
			}

			let folderCount = findValues(tempSketches.structure, 'type', 'folder', 'name').length;
			tempSketches.count = {sketches:listSketches(tempSketches.structure).length, folders:folderCount};
			exportJSON(tempSketches, 'P5L_' + tempType + timeStampFile() + '.json');
		}

		function exportPurgeDemos(obj){
			let objPurge = [];

			return obj;
		}

		function exportAddCode(objStructure, allowDemos) { // obj
			for (let k in objStructure) {
				let ric = objStructure[k];

				if(ric.type == 'sketch'){
					if(localStorage.hasOwnProperty(ric.name)){
						ric.code = localStorage.getItem(ric.name);
					}
				}

				// if folder, recurse deeper
				if(ric.type == 'folder' && (ric.name != 'demos') || allowDemos){
					ric.contents = exportAddCode(ric.contents, allowDemos);
				}
			};
			return objStructure;
		}


		function listSketches(obj){
			return findValues(obj, 'type', 'sketch', 'name');
		}

		function findValues(obj, key, filter, saveKey){
			return findValuesHelper(obj, key, filter, saveKey, []);
		}

		function findValuesHelper(obj, key, filter, saveKey, list) {
			if (!obj) return list;
			if (obj instanceof Array) {
				for (let i in obj) {
					list = list.concat(findValuesHelper(obj[i], key, filter, saveKey, []));
				}
				return list;
			}
			if (obj[key] && obj[key] == filter) list.push(obj[saveKey]);

			if ((typeof obj == 'object') && (obj !== null) ){
				let children = Object.keys(obj);
				if (children.length > 0){
					for (let i = 0; i < children.length; i++ ){
						list = list.concat(findValuesHelper(obj[children[i]], key, filter, saveKey, []));
					}
				}
			}
			return list;
		}


		// DRAG + DROP
		let divDrop = document.getElementById('p5-drop');
		let myDropzone = new Dropzone(document.body, {
			autoProcessQueue: false,
			url: '/data', // unused but needed for URL expectation
			acceptedFiles:'.json',
			clickable:false,
			init: function() {
				this.on('addedfile', function(file, responseText) {
					importSketches(myDropzone.files);
					divDrop.style.display = 'none';
					myDropzone.files = []; // clear list
				});
				this.on('dragenter', function(file, responseText) {
					// console.log(event.dataTransfer.dropEffect)
					if(event.dataTransfer.dropEffect != 'move' && !document.hasFocus()){
						divDrop.style.display = 'block';
					}
				});
				this.on('dragleave', function(file, responseText) {
					divDrop.style.display = 'none';
				});
				this.on('drop', function(file, responseText) {
					divDrop.style.display = 'none';
				});
				this.on('dragover', function(file, responseText) {
					// event.preventDefault();
					// console.log(event.dataTransfer.dropEffect);
					if(event.dataTransfer.dropEffect != 'move' && !document.hasFocus()){
						divDrop.style.display = 'block';
					}
				});
				this.on('error', function(file, responseText) {
					vex.dialog.alert({
						unsafeMessage:'Error importing. <br>Only P5LIVE exports are accepted.',
					})
					myDropzone.files = []; // clear list
				});
			},
		});

		function importSettingsDialog(){
			document.getElementById('file-input-settings').click();
		}

		function importSketchesDialog(){
			document.getElementById('file-input').click();
		}

		// import sketches from JSON
		function importSketches(data){
			for(let i=0; i < data.length; i++){
				let reader = new FileReader();
				reader.onload = function(data) {
					let jsonObj = JSON.parse(data.target.result);
					let jsonObjList = JSON.parse(data.target.result);
					if(jsonObj.hasOwnProperty('structure')){
						let jsonStructureSorted = jsonObj.structure.reverse();

						if(demosLocked){
							jsonStructureSorted = jsonStructureSorted.filter(function( obj ) {
								return obj.name !== 'demos';
							});
							if(jsonStructureSorted.length === 0){
								return false;
							}
						}

						let jsonStructureNormal = jsonObjList.structure;
						let count, importData;
						if(!legacyImport(jsonObj)){
							if(jsonObj.count.sketches === 1){
								importSketchesParser(jsonStructureSorted);
								return;
							}
							count = jsonObj.count.sketches + jsonObj.count.folders;
							importData = 'Import the following ('+count+') items?<br>';
						}else{
							count = (JSON.stringify(jsonObjList.structure).match(/name/g) || []).length;
							if(searchJSON(jsonObjList.structure, 'name', 'demos').length > 0){
								count -= searchJSON(settings.sketches, 'name', 'demos')[0].contents.length;
							}
							importData = 'Import the following ('+count+') items?<br>';
						}

						let importDupFound = false;
						for (let key in jsonStructureNormal) {
							if(searchSketches(jsonStructureNormal[key].name, settings.sketches) && jsonStructureNormal[key].name.toLowerCase() != 'demos'){
								importDupFound = true;
							}
						}
						if(importDupFound){
							importData += '<span style="font-size:10pt;"><span class="importdump-dup">Duplicates</span> given a unique _timestamp</span><br>';
						}
						importData += '<div id="importdump">';
						importData += recursiveImportCheck(jsonStructureNormal, '', '');
						importData += '</div>';
						// *** add checkbox to ignore duplicates on import...

						// first confirm importing of whole structure/sketches
						vex.dialog.confirm({
							unsafeMessage:importData,
							callback: function(value){
								if(value){
									loaderSub.innerHTML = 'importing sketches...';
									showLoader();
									if(legacyImport(jsonObj)){
										let legacyDemos = ["new", "P5LIVE_meta", "P5LIVE_COCODING_meta", "bwEllipse", "easeFunction", "sinStrings", "wanderingWorm", "audioAnalysis", "webgl_primatives", "webgl_sphereBox", "slidersGrid", "textToPoints", "basel.codes", "this is a really long name", "osc_setup", "midi_setup"];
										jsonStructureSorted.forEach(function(jsonItem){
											if(jsonItem.mod === undefined){
												jsonItem.mod = timeDate();
											}
											if(jsonItem.type == 'folder' && (jsonItem.name.toLowerCase() != 'demos' || searchJSON(settings.sketches, 'name', 'demos').length == 0)){
												// foreach folder/sketch check duplicates and give unique names

												// each base folder
												if(searchSketches(jsonItem.name, settings.sketches)){
													jsonItem.name += '_'+ timeStamp(); //versionCheck(jsonItem.name);
												}

												// each recursive sketch/folder within
													recursiveNamecheck(jsonItem.contents, jsonObj.sketches);

												// add structure to top of sketches list
												settings.sketches.unshift({'type':'folder', 'name':jsonItem.name, 'mod':jsonItem.mod, 'toggle':jsonItem.toggle, 'contents':jsonItem.contents});

											}else if(jsonItem.type == 'sketch'){

												if(legacyDemos.indexOf(jsonItem.name) == -1){
													settings.sketches.unshift({'type':'sketch', 'name':jsonItem.name, 'mod':jsonItem.mod});
												}
											}
										})
										updateSettings();
										initSortable();
										//updateSketches();

										// import structure as folder..
										parseSketches(jsonObj, legacyDemos);
									}else{
										// new importer from r34
										importSketchesParser(jsonStructureSorted);
									}
									hideLoader();
								}

							}
						})
					}else{
						// import single sketch w/o confirm dialog
						if(legacyImport(jsonObj)){
							checkDupSketches(jsonObj, 'sketchName');
							parseSketches(jsonObj);
						}
					}
				}
				reader.readAsText(data[i]);
			}
		}

		function legacyImport(obj){
			if(obj.revision === undefined || obj.revision < 34){
				return true;
			}else{
				return false;
			}
		}

		function importSketchesParser(importObj){
			if(demosLocked){
				importObj = importObj.filter(function( obj ) {
					return obj.name !== 'demos';
				});
			}

			recursiveImportDup(importObj, importObj);
			importObj.forEach(function(jsonItem){
				if(jsonItem.type == 'folder'){
					settings.sketches.unshift({'type':'folder', 'name':jsonItem.name, 'mod':jsonItem.mod, 'toggle':jsonItem.toggle, 'contents':jsonItem.contents});
				}else if(jsonItem.type == 'sketch'){
					settings.sketches.unshift({'type':'sketch', 'name':jsonItem.name, 'mod':jsonItem.mod});
				}
			});
			updateSettings();
			initSortable();
			recursiveImportCode(importObj);
		}

		function recursiveNames(obj, outputData){
			if(outputData === undefined){
				outputData = [];
			}
			for (let k in obj) {
				let ric = obj[k];

				// grab all names
				if(ric.type == 'sketch'){
					outputData.push(ric.name);
				}

				// if folder, go deeper
				if(ric.type == 'folder'){
					outputData.push(ric.name);
					recursiveNames(ric.contents, outputData);
				}
			};
			return outputData;
		}

		function recursiveImportDup(obj, objHold){
			for (let k in obj) {
				let allNames = recursiveNames(objHold);
				let ric = obj[k];

				if(searchSketches(ric.name, settings.sketches)){
					ric.name = versionCheck(ric.name, allNames);
				}

				// if folder, go deeper
				if(ric.type == 'folder'){
					recursiveImportDup(ric.contents, obj);
				}
			};
		}

		function recursiveImportCode(obj){
			for (let k in obj) {
				let ric = obj[k];

				// if sketch, add to localStorage
				if(ric.type == 'sketch'){
					localStorage.setItem(ric.name, ric.code);
				}

				// if folder, go deeper
				if(ric.type == 'folder'){
					recursiveImportCode(ric.contents);
				}
			};
		}


		function recursiveImportCheck(objStructure, level, outputData) {
			for (let k in objStructure) {
				let ric = objStructure[k];
				let ricDup = '';

				if(searchSketches(ric.name, settings.sketches)){
					ricDup = 'class="importdump-dup"';
					// ric.name += '_'+ timeStamp(); // versionCheck(rnc.name);
				}

				// if sketch, update sketches name too
				if(objStructure[k].type == 'sketch'){
					outputData += level + iconFileLines +'<span '+ricDup+'>'+ ric.name + '</span><br>';
				}

				// if folder, recurse deeper
				if(ric.type == 'folder' && ric.name != 'demos'){
					outputData += level + iconFolderEmpty +'<span '+ricDup+'>'+ ric.name + '</span><br>';
					outputData = recursiveImportCheck(ric.contents, '&nbsp;&nbsp;'+level, outputData);
				}
			};
			return outputData;
		}

		// recursively check for duplicate names when importing ( < r34) or removing
		function recursiveNamecheck(objStructure, objSketches) { // obj
			for (let k in objStructure) {
				let rnc = objStructure[k];
				let rncDup = false;
				let rncPName = rnc.name;

				// if duplicate, give unique name
				if(searchSketches(rnc.name, settings.sketches)){ // && rnc.type == 'sketch'
					rnc.name += '_'+ timeStamp(); // versionCheck(rnc.name);
					fixNamecheck(objSketches, rncPName, rnc.name);
				}

				// if folder, recurse deeper
				if(rnc.type == 'folder'){
					recursiveNamecheck(rnc.contents, objSketches);
				}
			};
		}

		// fix any duplicate names
		function fixNamecheck(obj, oldName, newName){
			for (let i = 0; i < obj.length; i++) {
				if (obj[i]['sketchName'] === oldName) {
					obj[i]['sketchName'] = newName;
				}
			}
		}

		// fix any duplicates on single file imports
		function checkDupSketches(obj, keyName){
			let jsonSketches = obj.sketches;
			for(let i=0; i < jsonSketches.length; i++){
				if(searchSketches(jsonSketches[i][keyName], settings.sketches)){
					jsonSketches[i][keyName] = versionCheck(jsonSketches[i][keyName]);
				}
			}
		}

		// recursively check folder containing sketch
		function recursiveFolderExpand(objStructure, sketch, curFolder) { // obj
			for (let key in objStructure) {
				// sketch, update sketches name too
				if(objStructure[key].type == 'sketch' && objStructure[key].name == sketch){
					if(curFolder!= '' && curFolder.toggle != 'expand'){
						curFolder.toggle = 'expand';
						initSortable();
					}
				}

				// if folder, recurse deeper
				if(objStructure[key].type == 'folder'){
					recursiveFolderExpand(objStructure[key].contents, sketch, objStructure[key]);
				}
			};
		}

		// load demos
		function loadDemos(){
			let demosPath = 'includes/demos/P5L_demos.json?' + makeid(5);
			let request = new XMLHttpRequest();
			request.open('GET', demosPath, true);
			request.send();
			request.addEventListener('load', function(){
				if(searchSketches('demos', settings.sketches)){
					removeItemProcess('demos');
				}
				let jsonObj = JSON.parse(request.responseText);
				let jsonItem = jsonObj.structure[0];

				settings.sketches.push({'type':'folder', 'name':jsonItem.name, 'mod':jsonItem.mod, 'toggle':jsonItem.toggle, 'contents':jsonItem.contents});

				updateSettings();
				initSortable();
				recursiveImportCode(jsonObj.structure);

				if(settings.fileName == 'new'){
					loadDefault();
				}
			});
		}

		function refreshDemos(){
			window.setTimeout(function(){
				if(searchSketches('demos', settings.sketches)){
					removeItemProcess('demos');
				}
				window.setTimeout(function(){loadDemos();}, 100);
			}, 200);
		}

		function parseSketches(jsonObj, legacyDemos){
			let jsonSketches = jsonObj.sketches.reverse();
			for(let i=0; i < jsonSketches.length; i++){
				let sketchName = jsonSketches[i].sketchName;
				let sketchCode = jsonSketches[i].sketchCode;
				localStorage.setItem(sketchName, sketchCode);

				// add to settings if doesn't exist
				if(!searchSketches(sketchName, settings.sketches)) {
					if(jsonSketches[i].mod === undefined){
						jsonSketches[i].mod = timeDate();
					}
					if(legacyDemos === undefined || legacyDemos.indexOf(sketchName) == -1) {
						settings.sketches.unshift({'type':'sketch', 'name':sketchName, 'mod':jsonSketches[i].mod});
					}
				}

				if(sketchName == settings.fileName){
					loadSketch(sketchName);
				}
			}
			updateSketches();
		}



		/* MENU » SKETCHES */

		function legacySettings(){
			if(typeof settings.sketches[0] != 'object'){
				let tc = timeDate();
				let order = settings.sketches;
				let newOrder = [];
				let oldDemos = ["aboutsketch", "bwEllipse", "easeFunction", "sinStrings", "wanderingWorm", "audioAnalysis", "webgl_sphereBox", "textToPoints", "basel.codes", "this is a really long name"];
				order.forEach(function(o){
					if(!oldDemos.includes(o)){
						newOrder.push({'name':o, 'type':'sketch', 'mod':tc});
					}
				});
				settings.sketches = newOrder;
				updateSettings();
			}

			if(searchJSON(settings.sketches, 'name', 'demos').length == 0 || settings.revision < currentRevision){
				//settings.refresh = false; // *** check this.. if needed?
				loadDemos();
			}
		}

		function getOrder() {
			if(menuSketches.childNodes.length >0){
				const traverse = function(dir, result = []) {
					dir.childNodes.forEach((node) => {

						let nodeName = '';
						if(node.dataset != undefined && (node.dataset.type == 'folder' || node.dataset.type == 'sketch')){
							nodeName = node.dataset.id;
						}else{
							return traverse(node, result)
						}

						const nodeStats = { name: nodeName };

						// add timestamps if they don't exist!
						if(node.dataset.mod === undefined){
							let tc = timeDate();
							node.dataset.mod = tc;
						}
						nodeStats.mod = node.dataset.mod;

						if (node.dataset.type == 'folder') {
							nodeStats.type = 'folder';
							nodeStats.toggle = node.dataset.toggle;
							nodeStats.contents = [];
							result.push(nodeStats);
							return traverse(node, nodeStats.contents)
						}
						if(node.dataset.type == 'sketch'){
							nodeStats.type = 'sketch';
							result.push(nodeStats);
						}
					});
					return result;
				};

				let recursiveSortable = traverse(menuSketches);
				settings.sketches = recursiveSortable;

				updateSettings();
				initSortable();
			}
		}

		// initialize sortable
		function initSortable(){
			if(settings.sketches.length > 0 && typeof settings.sketches[0] === 'object'){
				let selSelected = false;
				let htmlStr = '<li class="sortable-placeholder" data-type="buffer"></li>'+recurse( settings.sketches , '');
				menuSketches.innerHTML = htmlStr + '<li class="sortable-placeholder" data-type="buffer"></li>';
				initFolders(menuSketches);


				function recurse(data, curFolder, parFolder) {
					let html = '<li class="sortable-placeholder" data-type="buffer"></li>';
					for (let key in data) {
						let d = data[key];

						// add timestamps if they don't exist!
						if(d.mod === undefined){
							let tc = timeDate();
							d.mod = tc;
						}

						let marq = '';
						let demoClass = ' drag-item ';
						let demoFolder = '';
						if(d.name.length > 20 || (curFolder != '' && d.name.length > 18)){marq = 'marq';}
						if(d.type == 'sketch'){
							let selClass = '';
							let navSketch = 'onmouseenter="showNav(this, \'' + d.name + '\', \'sketch\');" onmouseleave="hideNav(this);"';
							if(curFolder == 'demos' || parFolder == 'demos'){
								if(demosLocked){
									navSketch = 'onmouseenter="showNav(this, \'' + d.name + '\', \'demo-sketch\');" onmouseleave="hideNav(this);"';
									demoClass += ' demo';
								}
							}

							if(d.name == settings.fileName){
								selClass = 'sketch-selected';
								selSelected = true;
							}

							html +='<li class="item-sketch menu-sketch-holder ' + selClass + demoClass + '" data-type="sketch" data-mod="'+d.mod+'" data-id="'+d.name+'" '+navSketch+'><div class="menu-sketch-nav"></div><div class="menu-sketch '+marq+'" onclick="navMouseOver = false;loadSketch(\''+d.name+'\')">'+iconFileLines + '<div class="item-label">' +d.name+'</div></div></li>';
						}else if(d.type == 'folder'){
							curFolder = d.name;
							let icon = iconFolderExpand;
							let navFolder = 'onmouseenter="showNav(this, \''+d.name+'\', \'folder\');" onmouseleave="hideNav(this);"';
							if(parFolder == 'demos'){
								navFolder = '';
							}
							if(curFolder == 'demos' && demosLocked){
								navFolder = 'onmouseenter="showNav(this, \''+d.name+'\', \'demos\');" onmouseleave="hideNav(this);"';
								demoClass = ' demo';
								demoFolder = 'id="demofolder"';
								parFolder = curFolder;
							}

							if((settings.cocoding.active && curFolder == settings.cocoding.namespace)){
								navFolder = '';
							}
							if(d.toggle == 'expand'){
								icon = iconFolderCollapse;
							}

							if(d.contents.length == 0){
								icon = iconFolderEmpty;
								d.toggle = 'collapse';
							}
							html += '<ul '+demoFolder+' class="item-folder ' + d.toggle + demoClass + '" data-type="folder" data-id="'+d.name+'" data-mod="'+d.mod+'" data-toggle="'+d.toggle+'" ondragover="dragOver(this)" >';
							html += '<div class="folder-title" '+navFolder+'><div class="menu-sketch-nav"></div><div onclick="navMouseOver = false;toggle(this);" class="menu-folder '+marq+'"><span class="menu-folder-svg">'+icon+'</span><div class="item-label">' +d.name + '</div></div></div> ';
							html += recurse(d.contents, curFolder, parFolder);
							html += '</ul>';
							curFolder = '';
						}
					};
					html += '';
					return( html );
				}
				menuSketchesCounter.innerHTML = document.querySelectorAll('.item-sketch:not(.demo)').length;

				// main folder
				new Sortable(menuSketches, options);

				// all sub-folders
				document.querySelectorAll('.drag-item').forEach((s) => {
					new Sortable(s, options);
				});

				if(document.getElementById('demofolder') != undefined){
					new Sortable(demofolder, {
						group: {name: 'demos', pull:false, put:false},
						filter: '.demo'
					});
				}

				if(settings.refresh){
					settings.refresh = false;
					refreshDemos();
				}
				loadTippy();
				if(menuSketchesFilter.value != ''){
					filterSketches();
				}

				// scroll to selected sketch
				sketchScrollIntoView();

			}
		}

		function sketchScrollIntoView(forceScroll){
			let selSketch = document.getElementsByClassName('sketch-selected');
			if(selSketch.length > 0 && (sketchesFirstTime || forceScroll)){
				selSketch[0].scrollIntoView();
				sketchesFirstTime = false;
			}
		}

		function dragOver(elm){
			elm.style.minHeight='40px';
		}

		// load sortable, restore expanded/collapsed
		function initFolders(elm){
			elm.childNodes.forEach(function(node){
				if(node.dataset != undefined && node.dataset.type == 'folder'){
					node.style.display = 'block';
					if(node.dataset.toggle == 'expand'){
						node.childNodes.forEach((k) => {
							if(k.tagName == 'UL' || k.tagName == 'LI'){
								k.style.display = 'block';
								if(k.dataset.type == 'folder' && k.dataset.toggle == 'expand'){
									initFolders(k);
								}
							}
						});
					}
				}
			});
		}

		// expand/collapse folders
		function toggle(elm){
			if(menuSketchesFilter.value == ''){
				let divFolder = elm.parentNode.parentNode;
				if(divFolder.dataset.toggle == 'expand'){
					divFolder.dataset.toggle = 'collapse';
					elm.innerHTML = iconFolderExpand;
					divFolder.childNodes.forEach((k) => {
						if(k.tagName == 'UL' || k.tagName == 'LI')
							k.style.display = 'none';
					});
				}else{
					divFolder.dataset.toggle = 'expand';
					elm.innerHTML = iconFolderCollapse;
					divFolder.childNodes.forEach((k) => {
						if(k.tagName == 'UL' || k.tagName == 'LI')
							k.style.display = 'block';
					});
				}
				getOrder();
			}
		}

		function showNav(elm, elmID, elmType, elmLevel){
			//elm.style.width='calc(100%-78px)';
			if(elmType == 'folder'){
				if(elmLevel === 1){
					elm.parentNode.setAttribute('onmouseleave', 'navMouseOver=false;showNav(this.parentNode, \'' + elmID + '\', \''+elmType+'\');');
					elm.parentNode.innerHTML = '<a class="menu-sketch-button tippy" onclick="renameItem(\''+elmID+'\', \''+elmType+'\')" data-title="Rename">'+iconRename+'</a><a class="menu-sketch-button tippy" onclick="addFolder(\''+elmID+'\', true)" data-title="Sub-folder">'+iconFolderExpand+'</a><a class="menu-sketch-button tippy" onclick="exportSketches(\''+elmID+'\')" data-title="Export">'+iconExport+'</a><a class="menu-sketch-button tippy" onclick="removeItem(\''+elmID+'\', \''+elmType+'\')" data-title="Remove">'+iconRemove+'</a><a class="menu-sketch-button tippy" data-title="Pin Folder" style="display:none;">'+iconBookmark+'</a><a class="menu-sketch-button">'+iconMoreHorizontal+'</a>';
				}else{
					if(!navMouseOver){
						navMouseOver = true;
						elm.getElementsByClassName('menu-sketch-nav')[0].innerHTML = '<a class="menu-sketch-button" onmouseenter="showNav(this, \'' + elmID + '\', \''+elmType+'\', 1);" >'+iconMoreHorizontal+'</a>';
					}
				}

			}else if(elmType == 'sketch'){
				if(elmLevel === 1){
					elm.parentNode.setAttribute('onmouseleave', 'navMouseOver=false;showNav(this.parentNode, \'' + elmID + '\', \''+elmType+'\');');
					elm.parentNode.innerHTML = '<a class="menu-sketch-button tippy" onclick="inspectItem(\''+elmID+'\')" data-title="Inspect">'+iconAlignLeft+'</a><a class="menu-sketch-button tippy" onclick="renameItem(\''+elmID+'\', \''+elmType+'\')" data-title="Rename">'+iconRename+'</a><a class="menu-sketch-button tippy" onclick="exportSketch(\''+elmID+'\', \''+elmType+'\')" data-title="Export">'+iconExport+'</a><a class="menu-sketch-button tippy" onclick="removeItem(\''+elmID+'\', \''+elmType+'\')" data-title="Remove">'+iconRemove+'</a><a class="menu-sketch-button tippy" data-title="Pin Sketch" style="display:none;">'+iconBookmark+'</a><a class="menu-sketch-button">'+iconMoreHorizontal+'</a>';
				}else{
					if(!navMouseOver){
						navMouseOver = true;
						elm.getElementsByClassName('menu-sketch-nav')[0].innerHTML = '<a class="menu-sketch-button" onmouseenter="showNav(this, \'' + elmID + '\', \''+elmType+'\', 1);" >'+iconMoreHorizontal+'</a>';
					}
				}

			}else if(elmType == 'demos'){
				elm.getElementsByClassName('menu-sketch-nav')[0].innerHTML = '<a class="menu-sketch-button tippy" onclick="refreshDemos(\''+elmID+'\', \''+elmType+'\')" data-title="Refresh">'+iconRefresh+'</a>';
			}else if(elmType == 'demo-sketch'){
				elm.getElementsByClassName('menu-sketch-nav')[0].innerHTML = '<a class="menu-sketch-button tippy" onclick="inspectItem(\''+elmID+'\', true)" data-title="Inspect">'+iconAlignLeft+'</a>';
			}else if(elmType == 'user'){
				elm.getElementsByClassName('menu-sketch-nav')[0].innerHTML = '<a class="menu-sketch-button tippy" onclick="toggleEdit(\''+elmID+'\', \''+elmType+'\')" data-title="Refresh">'+iconToggleLeft+'</a>';
			}else if(elmType == 'self'){
				let reqClass = '';
				if(settings.cocoding.request){
					reqClass = ' req ';
				}
				elm.getElementsByClassName('menu-sketch-nav')[0].innerHTML = '<a id="request-'+elmID+'" class="menu-sketch-button tippy '+reqClass+'" onclick="cocode.editRequest(\''+elmID+'\')" data-title="Request Edit">'+iconEdit+'</a>';
			}

			loadTippy();
		}

		function hideNav(elm){
			elm.getElementsByClassName('menu-sketch-nav')[0].innerHTML = '';
			elm.style.width='calc(100%-5px)';
			navMouseOver = false;
		}

		function addFolder(folderName, subFolder){
			let newID = versionCheck('folder');//'folder ' + Math.floor(Math.random()*99);
			if(menuSketchesFilter.value != ''){
				newID = versionCheck(menuSketchesFilter.value);
			}else if(folderName != undefined){
				newID = versionCheck(folderName);
			}

			if(folderName == undefined || subFolder){
				vex.dialog.prompt({
					message: 'Add Folder:',
					value: newID, // placeholder
					callback: function (value) {
						if(value){
							addFolderProcess(value, folderName);
						}
					},
					afterOpen: function(){
						document.getElementsByClassName('vex-dialog-prompt-input')[0].select();
					}
				})
			}else{
				newID = folderName;
				addFolderProcess(newID);
			}
		}

		function addFolderProcess(newID, subFolder){
			let tc = timeDate();
			let newFolder = '<ul class="item-folder" ondragover="dragOver(this)" data-type="folder" data-toggle="expand" data-id="'+newID+'" data-mod="'+tc+'"><a onclick="toggle(this);">'+iconFolderEmpty+'</a> Folder<div class="sketches" style="display:block" ></div></ul>';
			if(subFolder != undefined){
				let tempHTML = menuSketches.querySelectorAll('[data-id="'+subFolder+'"]')[0];
				tempHTML.innerHTML = newFolder + tempHTML.innerHTML;
			}else{
				let tempHTML = menuSketches.innerHTML;
				menuSketches.innerHTML = newFolder + tempHTML;
			}
			getOrder();
		}

		function inspectItem(itemName, itemLocked){
			let inspectCode = localStorage.getItem(itemName);
			let inspectEditor;

			vex.dialog.confirm({
				focusFirstInput : false,
				unsafeMessage:'Inspect Code and optionally save changes.<br><br><div class="syncdata-header code-header">code</div><div id="inspectcode" class="popup-editor vex-long">'+inspectCode+'</div>',
				callback: function (value) {},
				buttons: [
				!itemLocked ? {
					type: 'submit',
					text: 'SAVE',
					className: 'my-button-class-name',
					click: function updateCode () {
						localStorage[itemName] = inspectEditor.getValue();
						if(settings.safeMode){
							settings.fileName = itemName;
							settings.safeMode = false;
							updateSettings();
							window.location.hash = '#';
							loadSketch(settings.fileName);
						}else if(itemName == settings.fileName){
							setTimeout(function(){editor.setValue(localStorage.getItem(itemName), 1);}, 100);
						}
					}
				} : {
					className: 'hide-button' // hide if unused
				}
				,{
					type: 'close',
					text: 'CLOSE',
					className: 'my-button-class-name'
				}]
			})
			inspectEditor = ace.edit("inspectcode");
			inspectEditor.setTheme(settings.theme);
			inspectEditor.session.setMode('ace/mode/javascript');
			inspectEditor.setOptions({
				showPrintMargin: false,
				animatedScroll: false,
				displayIndentGuides: false,
				useWorker: true,
				showLineNumbers: true,
				showGutter: true,
				tabSize: 4, useSoftTabs: false,
			});
			tidyCode(inspectEditor);
		}

		// rename sketch/folder
		function renameItem(itemName, itemType){
			let existingItems = [];
			for(let di of menuSketches.getElementsByClassName('drag-item')){
				existingItems.push(di.getAttribute('data-id'));
			}

			vex.dialog.prompt({
				message: 'Rename:',
				value: itemName, // placeholder
				callback: function (value) {
					if(value){
						let newName = value.replace(/["']/g, '');
						if(newName != '' && newName != itemName){
							let sketchesFlat = JSON.stringify(settings.sketches);
							if( existingItems.indexOf(itemName) > -1 ) {
								if( existingItems.indexOf(newName) === -1  && newName.toLowerCase() !== 'demos') {
									let sketchesFixed = sketchesFlat.replace('"'+itemName+'"', '"'+newName+'"');
									settings.sketches = JSON.parse(sketchesFixed);
								}else{
									vex.dialog.alert({
										unsafeMessage:'"'+newName +'" already exists. <br>Pick a new name',
										callback: function(){renameItem(itemName, itemType)},
										afterOpen: function(){
											vexSmall(this.rootEl);
										}
									})
									return false;
								}
							}

							updateSettings();
							initSortable();
							if(itemType == 'sketch'){
								localStorage.setItem(newName, localStorage[itemName]);
								localStorage.removeItem(itemName);
								if(settings.fileName == itemName){
									settings.fileName = newName;
									if(!settings.cocoding.active){
										setTimeout(function(){ loadSketch(newName); }, 100);
									}
								}
							}
						}
					}
				},
				afterOpen: function(){
					document.getElementsByClassName('vex-dialog-prompt-input')[0].select();
				}
			})
		}

		// taking out the trash
		function removeItem(dataID, elmType){
			let removeDetails = '';
			let icon = iconFileLines;
			if(elmType == 'folder'){
				icon = iconFolderCollapse;
				let elmContents = searchJSON(settings.sketches, 'name', dataID)[0];
				if(elmContents.type == 'folder' && elmContents.contents.length > 0){
					removeDetails = '<div class="remove-header">Includes:</div>'
					removeDetails += '<div id="importdump" class="remove-dump">';
					removeDetails += recursiveImportCheck(elmContents.contents, '', '');
					removeDetails += '</div>';
				}else{
					// remove empty folders without warning
					removeItemProcess(dataID);
					return false;
				}
			}
			vex.dialog.confirm({
				unsafeMessage: 'Delete '+elmType+': <br><span class="remove-icon">'+icon +'</span> <span class="remove-dump importdump-dup">'+ dataID + '</span><br>'+removeDetails,
				callback: function (value) {
					if (value) {
						removeItemProcess(dataID);
					}
				},
				afterOpen: function(){
					vexSmall(this.rootEl);
				}
			})
		}

		function removeItemProcess(dataID){
			let selElm = document.querySelectorAll('[data-id="'+dataID+'"]');
			selElm[0].querySelectorAll('[data-id]').forEach(function(k){
				localStorage.removeItem(k.dataset.id);
				k.remove();
			});

			// catch active sketch in trashed folder
			// let dataIDType = searchJSON(settings.sketches, 'name', dataID)[0];
			// if(dataIDType.type === 'folder'){
			// 	for(let i=0; i < dataIDType.contents.length; i++){
			// 		if(settings.fileName === dataIDType.contents[i].name){
			// 			sketchInFolder = true;
			// 		}
			// 	}
			// }

			localStorage.removeItem(dataID);
			if(selElm.length > 1){
				for(let se of selElm){
					se.remove();
				}
			}else{
				selElm[0].remove();
			}



			getOrder();

			let sketchIsGone = false;
			if(!searchSketches(settings.fileName, settings.sketches)){
				sketchIsGone = true;
			}

			if((dataID === settings.fileName || sketchIsGone)&& !settings.cocoding.active){
				loadSketch(loadLatest());
			}
		}



		/* EDITOR KEY-CMDS */
		let map = [];
		window.onkeydown = function(event) {
			map[event.keyCode] = event.type == 'keydown';

			if(map[16] && map[17]){
				addSnippet(event.key);
				event.preventDefault();
			}

			if(event.keyCode == 8){ // DELETE = prevent back navigation in FF
				let eTarget = event.target.tagName.toLowerCase();
				if(!p5code.focus() && eTarget != 'input' && eTarget != 'textarea'){
					event.preventDefault();
				}
			}
		}

		window.onkeyup = function(event) {
			map[event.keyCode] = event.type == 'keydown';
		}

		// Editor Interactions
		p5code.onkeydown = function(event) {
			map[event.keyCode] = event.type == 'keydown';
			// pLen = editor.getValue().length; // len of editor
		}

		p5code.onkeyup = function(event) {
			map[event.keyCode] = event.type == 'keydown';
			if(!settings.cocoding.active){
				localStorage[settings.fileName] = editor.getValue();
			}
		};

		menuCocodeChatInput.onkeydown = function(event){
			if(event.keyCode == 13){
				event.preventDefault();
				if(settings.cocoding.active && menuCocodeChatInput.value.trim() != ''){
					syncUp();
					cocode.socket.emit('chat', {'type':'send', 'text':menuCocodeChatInput.value, 'msgID':settings.cocoding.msgID});
					menuCocodeChatInput.value = '';
					settings.cocoding.msgID = -1;
					updateSettings();
				}
			}else{
				chatPending();
			}
		}

		menuCocodeChatInput.addEventListener('focus', () => {
			chatPending();
		});

		menuCocodeChatInput.addEventListener('blur', () => {
			chatPendingClear();
		});

		function chatPending(){
			if(settings.cocoding.msgID == -1){
				syncUp();
				settings.cocoding.msgID = Math.floor(Math.random()*999)
				updateSettings();
				cocode.socket.emit('chat', {'type':'pending', 'text':'...', 'msgID':settings.cocoding.msgID});
			}
		}

		function chatPendingClear(){
			if(settings.cocoding.msgID != -1){
				cocode.socket.emit('chat', {'type':'clear', 'text':'', 'msgID':settings.cocoding.msgID});
			}
			settings.cocoding.msgID = -1;
			updateSettings();
		}

		function chatBlur(){
			menuCocodeChatInput.blur();
			if(settings.cocoding.msgID != -1){
				cocode.socket.emit('chatPendingClear', {'msgID':settings.cocoding.msgID});
			}
			settings.cocoding.msgID = -1;
			updateSettings();
		}

		function checkErrors(){
			clearTimeout(errorTimer);
			let checkErrorsDelay = settings.compileTimer;
			if(settings.cocoding.active){
				checkErrorsDelay = 1000;
				settingsCompileTimer.value = 1000;
				settingsCompileTimer.setAttribute('disabled', 'disabled');
				settingsCompileTimer.style.opacity = .5;
			}
			errorTimer = setTimeout(function(){checkErrorsWorker();}, checkErrorsDelay);
		}

		function checkErrorsWorker(){
			let annos = editor.getSession().getAnnotations();

			if(settings.debugMode){console.log(annos)};
			let errorsFound = false;
			for(let i=0; i < annos.length; i++){
				if(annos[i].type == 'error'){
					errorsFound = true;
				}
			}
			if(errorsFound){
				validCode = false;
				checkErrors();
			}else{
				clearTimeout(errorTimer);
				validCode = true;
				if(settings.autoCompile){
					recompile();
				}
			}
			if(settings.debugMode){console.log('validCode: ' + validCode);}
		}

		// prevent lost work in default
		window.addEventListener('beforeunload', function (e) {
			if(settings.fileName == 'default'){
				let confirmationMessage = '\o/';
				(e || window.event).returnValue = confirmationMessage; 	//Gecko + IE
				return confirmationMessage;								//Webkit, Safari, Chrome
			}
		});

		function syncdataConsoleMsg(msg){
			if(!settings.cocoding.active){
				return false;
			}
			if(typeof msg === 'object'){
				msg = JSON.stringify(msg);
			}
			settings.syncdata.console.push(msg);
			if(settings.syncdata.console.length > 10){
				settings.syncdata.console = settings.syncdata.console.splice(0, 1);
			}
			updateSettings();

			let syncdataConsole = document.getElementById('syncdata-console');
			if(syncdataConsole != undefined){
				syncdataConsole.innerHTML += '\n'+msg

				let autoScroll = false;
				if(syncdataConsole.scrollHeight - syncdataConsole.scrollTop < 200){
					autoScroll = true;
				}

				if(autoScroll){
					syncdataConsole.scrollTop = syncdataConsole.scrollHeight;
				}else{
					syncdataConsole.scrollTop += 1;
				}
			}

		}

		function consoleMessage(msg, timeDelay){
			p5console.value = msg;
			if(consoleVisible == false){
				p5console.style.display = 'block';
				resizeEditor();
				consoleVisible = true;
			}
			if(timeDelay != undefined && timeDelay != 0){
				if(consoleTimer != undefined){
					clearTimeout(consoleTimer);
				}
				consoleTimer = setTimeout(consoleHide, timeDelay*1000);
			}
		}

		function consoleHide(){
			if(consoleTimer != undefined){
				clearTimeout(consoleTimer);
			}
			p5console.value = '';
			p5console.style.display = 'none';
			consoleVisible = false;
		}

		function resizeEditor(){
				if(p5console.style.display == 'block'){
					p5code.style.height = 'calc(100vh - '+ p5console.offsetHeight +'px)';
				}else{
					p5code.style.height = '100vh';
				}

				editor.resize();
		}



		/* COMPILE CODE */

		function compileCodeShortcut(hard){
			forceRecompile = true;
			clearTimeout(errorTimer);
			recompile(hard);
		}

		function recompile(force){
			let currline = editor.getSelectionRange().start.row;
			let currCode = editor.session.getLine(currline);
			curPos = editor.getCursorPosition();

			// catch missing {}'s
			let codeNoComments = removeComments(editor.getValue());

			let cbCount = {
				l : (codeNoComments.match(/\{/g) || []).length,
				r : (codeNoComments.match(/\}/g) || []).length
			}
			if(cbCount.l == 0 || cbCount.l != cbCount.r){
				let missingBracket = "'}'";
				if(cbCount.l < cbCount.r){
					missingBracket = "'{'";
				}
				consoleMessage('Missing ' + missingBracket + '. Find mistake then recompile.', 0);
				braketError = true;
				return false;
			}else{
				if(braketError){
					consoleHide();
					braketError = false;
				}

			}

			// prevent compile while autocomplete popup visible
			let acPopup = document.getElementsByClassName('ace_autocomplete')[0];
			if(acPopup != undefined){
				if(acPopup.style.display != 'none'){
					return false;
				}
			}

			if((currCode.search(/^\s(?:for|while)(|\s)(\()/) == -1) || forceRecompile || force){
				if(validCode){
					if(editor.getValue().indexOf('function setup()') != -1){ // check setup exists
						// buildSketch(); //
						updateBackground();
						if(settings.cocoding.active){
							if(settings.cocoding.sync){
								if(settings.cocoding.level == 'admin'){
									buildSketch(force); //
									cocode.recompile(force);
								}
							}else{
								buildSketch(force); //
							}
						}else{
							buildSketch(force); //
						}

						// if(settings.cocoding.active && settings.cocoding.sync && settings.cocoding.level == 'admin'){
						// 	buildSketch(); //
						// 	updateBackground();
						// 	cocode.recompile();
						// }else if(){
						// 	buildSketch(); //
						// 	updateBackground();
						// }
					}
				}
			}
			forceRecompile = false;
		}

		function removeComments(code){
			return code.replace(/\/\*[\s\S]*?\*\/|([^:]|^)\/\/.*$/gm, (_, g1, g2) => Array(_.split('\n').length).join('\n'))
		}

		function processLibs(code){
			let sketchTest = code.replace(/(?:\r\n|\r|\n|\t)/g, '');
			let sketchLoadScriptsRegEx = /(?:loadScripts|libs|scripts)\s+=\s+\[(.*["']\])/
			let sketchLoadScripts = sketchLoadScriptsRegEx.exec(sketchTest);
			let scriptsList = [];
			if(sketchLoadScripts != undefined){
				sketchLoadScripts = sketchLoadScripts[1].replace(/["']/g, '').replace(/[' '|\]]/g, '');
				sketchLoadScripts = sketchLoadScripts.split(',');

				for(let i=0; i < sketchLoadScripts.length; i++){
					if(sketchLoadScripts[i] != ''){
						scriptsList.push(sketchLoadScripts[i]);
					}
				}
			}
			return scriptsList;
		}

		// new technique to avoid accessing p5live_sketch.html sooo many times!
		function buildSketch(force){
			// replace single + multiline comments with \n to avoid processing + keep line numbers same

			// grab latest p5vars only before reload! no more interval...
			if(sketchLoaded && p5f.frameCount != undefined){
				p5vars.frameCount = p5f.frameCount+1;
				p5vars.mouseX = p5f.mouseX;
				p5vars.mouseY = p5f.mouseY;
			}

			if(!settings.cocoding.active && pLen != editor.getValue().length){
				let sketchElm = document.querySelectorAll('[data-id="'+settings.fileName+'"]')[0];
				let sketchDetails = searchJSON(settings.sketches, 'name', settings.fileName)[0];
				if(sketchElm != undefined && sketchDetails != undefined){
					sketchElm.setAttribute('data-mod', timeDate());
					sketchDetails.mod = timeDate();
					updateSettings();
					pLen = editor.getValue().length;
				}
			}

			let codeNoComments = removeComments(editor.getValue());

			// softCompile
			if(force == undefined && sketchLoaded){
				// technique to only update draw if code changed there (= continous background!)
				let rawLines = editor.session.getLines(0, editor.session.getLength());
				let drawPos = [];//{};
				let drawPosSel = -1;
				let countBrackets = false;
				let braces = 0;
				let softFunction = false;
				let softClass = false;


				let allLines = codeNoComments.split('\n');

				// test purging of comments
				// let offLines = 6;
				// console.log(rawLines[offLines]);
				// console.log(allLines[offLines]);

				// extract all functions and their line number
				for(let i=0; i<allLines.length; i++){

					// catch function or class
					if(allLines[i].includes('function ') && !countBrackets){
							countBrackets = true;
							let functionName = allLines[i].match(/function ([\w\d]*)\(/)[1].trim();
							drawPos.push({type:'function', name:functionName, start:i});
					}else if(allLines[i].includes('class ') && !countBrackets){
							countBrackets = true;
							let className = allLines[i].match(/class\s([\w\d]*)/)[1].trim();
							drawPos.push({type:'class', name:className, start:i});
					}

					// count {} and mark where class/function ends
					if(countBrackets){
						if(allLines[i].includes('{')){
							braces += (allLines[i].match(/{/g) || []).length;
						}
						if(allLines[i].includes('}')){
							braces -= (allLines[i].match(/}/g) || []).length;
							if(braces == 0){
								drawPos[drawPos.length-1].end = i;
								countBrackets = false;
							}
						}
					}
				}

				// check all changed positions + if custom function
				let funName = '';
				for(let i=0; i<drawPos.length; i++){
					for(let j=0; j < curPositions.length; j++){
						let cPos = curPositions[j];
						if(cPos.row >= drawPos[i].start && cPos.row <= drawPos[i].end){
							// console.log(drawPos[i].name); // debug where change occured
							if(drawPos[i].name != 'setup' && drawPos[i].name != 'preload' && drawPos[i].type == 'function'){
								softFunction = true;
								drawPosSel = i;
								funName = drawPos[i].name;
							}else if(drawPos[i].type == 'class'){
								softClass = true;
								drawPosSel = i;
							}
						}
					}
				}

				// if custom function, grab where it's used
				let functionPos = [];
				for(let j=0; j<drawPos.length; j++){
					if(funName == drawPos[j].name){
						// find lines where drawPos[i].name sits
						for(let i=0; i<allLines.length; i++){
							if(allLines[i].includes(drawPos[j].name + '(')){
								functionPos.push(i);
							}
						}
					}
				}

				// catch custom functions in preload + setup
				for(let i=0; i < functionPos.length; i++){
					let fPos = functionPos[i];
					for(let j=0; j < drawPos.length; j++){
						if(fPos >= drawPos[j].start && fPos <= drawPos[j].end){
							// console.log(drawPos[i].name); // debug where chage occured
							if(drawPos[j].name == 'setup' || drawPos[j].name == 'preload'){ // && !settings.cocoding.active
								softFunction = false;
							}
						}
					}
				}

				// if possible, only overwrite function/class for softCompile
				if(softClass || softFunction){
					softCompile(drawPos[drawPosSel].type, drawPos[drawPosSel].name, drawPos[drawPosSel].start, drawPos[drawPosSel].end);
					curPositions = [];
					return false; // prevent complete rebuild
				}
			}

			// hardCompile
			sketchLoaded = false;
			cocodingRecompile = true;
			let el = p5frameTemplate.cloneNode(true);
			let iFrameBody = el.getElementsByTagName('head')[0];//el.document.getElementsByTagName('body')[0];

			let scriptsCol = [];

			// load scripts remote vs local
			for(let i=0; i < includeScripts.length; i++){
				if(p5Remote){
					scriptsCol.push(includeScripts[i].remote);
				}else{
					scriptsCol.push(includeScripts[i].local);
				}
			}

			// check loadScripts / libs / scripts;
			let scriptsList = processLibs(codeNoComments);
			for(let i=0; i < scriptsList.length; i++){
				scriptsCol.push(scriptsList[i]);
			}

			// old way ***
			// for(let sc of scriptsCol){
			// 	let s = document.createElement('script');
			// 	s.type = 'text/javascript';
			// 	s.src = sc;
			// 	s.async = false;
			// 	iFrameBody.appendChild(s);
			// }

			// load sketch
			let s = document.createElement('script');
			s.type = 'text/javascript';
			let sketchCode = editor.getValue();
			let updateVars = '\npmouseX=' + p5vars.mouseX + ';\npmouseY=' + p5vars.mouseY + ';\nmouseX=' + p5vars.mouseX + ';\nmouseY=' + p5vars.mouseY + ';\nframeCount=' + p5vars.frameCount + ';\n';
			let codeSetup = addCode(sketchCode, updateVars, 'setup', 'bottom');

			let fullCode = p5custom.value + codeSetup + 'new p5(); sketchStatus();';

			let sLoader = 'loadjs(' + JSON.stringify(scriptsCol) + ', {success: function() {pingReady("p5Main", ' + JSON.stringify(fullCode) + '); },async: false});';

			s.innerHTML = sLoader;
			// s.innerHTML = fullCode; // *** old way
			if(settings.syncdata.active){
				syncdataButtonToggle();
			}

			if(!settings.safeMode){
				iFrameBody.appendChild(s);
			}

			// set dynamic html as iframe srcdoc
			p5frame.srcdoc = el.innerHTML;

			curPositions = [];
		}

		// compiling code after promise of loaded libs!
		function pongReady(scriptName, scriptCode, scriptCallback){
				let s = document.createElement('script');
				s.type = 'text/javascript';
				s.id = scriptName;
				s.innerHTML = scriptCode;
				if(p5f.document.getElementById(scriptName) == null){
					p5f.document.head.appendChild(s);
				}else{
					p5f.document.getElementById(scriptName).innerHTML = scriptCode;
				}

				if(scriptCallback){
					scriptCallback();
				}
		}

		// softCompile function or class changes
		function softCompile(codeType, codeName, codeStart, codeEnd){
			let curCodeTemp = '';
			if(codeType == 'function'){
				curCodeTemp = editor.session.getLines(codeStart, codeEnd).join('\n');
			}else if(codeType == 'class'){
				curCodeTemp = codeName + ' = class {' + editor.session.getLines(codeStart+1, codeEnd).join('\n');
			}
			let s = document.createElement('script');
			s.type = 'text/javascript';
			s.innerHTML = curCodeTemp;
			p5f.document.head.appendChild(s);
		}


		function updateBackground(){
			let bgReg = /background\(([^)]+)\)/;
			let nonComments = editor.getValue();
			nonComments = nonComments.replace(/\s*\/\/.*\n/g, '\n').replace(/\s*\/\*[\s\S]*?\*\//g, '');
			let bgMatches = bgReg.exec(nonComments);
			if(bgMatches != null){
				newBG = '';
				if(bgMatches[1].includes('#')){
					newBG = bgMatches[1].replace(/["']/g, '');
				}else{
					let cols = bgMatches[1].split(',');
					if(cols.length > 2){
						newBG = rgb2hex(cols[0].trim(), cols[1].trim(), cols[2].trim());
					}else{
						newBG = rgb2hex(cols[0].trim(), cols[0].trim(), cols[0].trim())
					}
				}
				if(sketchLoaded){
					p5f.document.body.style.background = newBG;
				}
				p5frame.style.background = newBG;
			}
		}

		function rgb2hex(red, green, blue) {
			let rgb = blue | (green << 8) | (red << 16);
			return '#' + (0x1000000 + rgb).toString(16).slice(1)
		}

		function loadScripts(elm){
			if(settings.debugMode){console.log(settings.scripts);}
			for(let i=0; i < settings.scripts.length; i++){
				elm.appendChild(loadScript(settings.scripts[i]));
			}
		}

		function loadScript(scriptPath){
			let ps = document.createElement('script');
			ps.type = 'text/javascript';
			ps.src = scriptPath;
			return ps;
		}

		function tidyCode(aceEdit){
			let tempPos = editor.getCursorPosition();
			let tempCode = js_beautify(aceEdit.getValue(), beautifyOptions);
			aceEdit.setValue(tempCode, 1);
			aceEdit.gotoLine(tempPos.row+1, tempPos.column, false);
		}



		/* SNIPPETS */
		function loadSnippets(){
			let snippetsPath = 'includes/demos/P5L_snippets.json?' + makeid(5);
			let request = new XMLHttpRequest();
			request.open('GET', snippetsPath, true);
			request.send();
			request.addEventListener('load', function(){
				let jsonObj = JSON.parse(request.responseText);
				snippets = jsonObj.snippets;
				let dropCommands = [];
				let cmds = editor.commands;
				for(let i=0; i < snippets.length; i++){
					let snippetKey = snippets[i].key+'';
					let findCommand = cmds.commandKeyBinding['ctrl-shift-'+snippetKey.toLowerCase()];
					if(findCommand != undefined){
						dropCommands.push(findCommand.name);
					}
				}
				editor.commands.removeCommands(dropCommands);
			});

		}

		function addSnippet(loadSnippet){
			let snippetIndex = snippets.map(function(d) { return d['key']; }).indexOf(loadSnippet);
			if(snippetIndex == -1){
				return false;
			}
			let snippetCode = snippets[snippetIndex].code;
			let addGlobalTop = snippetCode.global.top;
			let addGlobalBottom = snippetCode.global.bottom;
			let addSetup = snippetCode.setup;
			let addDrawTop = snippetCode.draw.top;
			let addDrawBottom = snippetCode.draw.bottom;

			let curCode = editor.getValue();
			let codeGlobalTop = addGlobalTop + '\n' + curCode;
			let codeSetup = addCode(codeGlobalTop, addSetup, 'setup', 'bottom');
			let codeDrawTop = addCode(codeSetup, addDrawTop, 'draw', 'top');
			let codeDrawBottom = addCode(codeDrawTop, addDrawBottom, 'draw', 'bottom');
			let codeGlobalBottom = codeDrawBottom + '\n\n' + addGlobalBottom;

			editor.setValue(codeGlobalBottom, 1);
			tidyCode(editor);
		}

		function addCode(codeBase, codeInsert, funName, codePos){
			let tempCode, tempPos = addPosition(codeBase, funName);
			if(codePos === 'bottom'){
				tempCode = [codeBase.slice(0, tempPos[1]), '' + codeInsert + "\n", codeBase.slice(tempPos[1])].join('');
			}else if(codePos === 'top'){
				tempCode = [codeBase.slice(0, tempPos[0]), codeInsert + '', codeBase.slice(tempPos[0])].join('');
			}
			return tempCode;
		}

		// grab start/end of function, modded for position only
		// https://stackoverflow.com/a/49240267/10885535
		function addPosition(content, functionName) {
			// Find function
			const indexOfFunc = content.indexOf(`function ${functionName}`);

			if (indexOfFunc < 0) {
				return content;
			}

			const openingBrace = content.indexOf('{', indexOfFunc);

			const startPos = openingBrace + 1;
			let endPos = startPos;
			let bracesToBalance = 1;

			while (true) {
				if (content[endPos] === '{') {
					bracesToBalance++;
				} else if (content[endPos] === '}') {
					bracesToBalance--;
					if (bracesToBalance === 0) break;
				}
				endPos++;
			}

			return [startPos, endPos];
		};



		/* SETTINGS TOGGLES */

		// toggle auto-compile
		function autoCompileToggle(){
			settings.autoCompile = !settings.autoCompile;
			autoCompileUpdate();
		}

		function autoCompileUpdate(){
			checkToggle('autoCompile', settings.autoCompile, settingsAutoMode, 'Live Coding');
			if(settings.autoCompile){
				settingsCompileTimer.style.display = 'block';
			}else{
				settingsCompileTimer.style.display = 'none';
			}
		}

		// auto-compile delay on keyup
		function compileTimerChange(){
			settings.compileTimer = settingsCompileTimer.value;
			updateSettings();
		}

		function compileTimerUpdate(){
			for(let i=0; i < settingsCompileTimer.options.length; i++){
				let opt = settingsCompileTimer.options[i];
				if(settings.compileTimer == opt.value){
					settingsCompileTimer.selectedIndex = i;
				}
			}
		}


		// toggle ecorender (pause if focus is lost)
		function ecoRenderToggle(){
			settings.ecoRender = !settings.ecoRender;
			ecoRenderUpdate();
		}

		function ecoRenderUpdate(){
			checkToggle('ecoRender', settings.ecoRender, settingsEcoMode, 'Eco Render');
		}


		// loop/noLoop on window blur

		window.onblur = function () {
			// deactivate modifier keys
			map[16] = false;
			map[17] = false;

			if(settings.cocoding.active){
				cocode.socket.emit('status', 'blur');
			}
			if(settings.ecoRender && sketchLoaded && !settings.cocoding.sync && settings.editMode){
				if(document.activeElement !== p5frame){
					p5f.noLoop();
				}
			}
		}

		window.onfocus = function () {
			// deactivate modifier keys
			map[16] = false;
			map[17] = false;

			if(settings.cocoding.active){
				cocode.socket.emit('status', 'focus');
				cocode.updateColor();
			}
			if(sketchLoaded && !paused){
				p5f.loop();
			}
		}


		// toggle fullscreen (better to use browser native fullscreen)
		function fullscreenToggle(){
			settings.fullscreenMode = !settings.fullscreenMode;
			fullscreenUpdate();
		}

		function fullscreenUpdate(){
			checkToggle('fullscreenMode', settings.fullscreenMode, settingsFullscreen, 'Full Screen');
			if(settings.fullscreenMode){
				if(sketchLoaded){
					openFullscreen();
					editorToggleUpdate();
				}
			}else{
				if(sketchLoaded){
					closeFullscreen();
				}
			}
		}


		//cursor toggle
		function cursorToggle(){
			settings.canvasCursor = !settings.canvasCursor;
			cursorToggleUpdate();
		}

		function cursorToggleUpdate(){
			checkToggle('canvasCursor', settings.canvasCursor, settingsCanvasCursor, 'Canvas Cursor');
			if(sketchLoaded){
				if(!settings.canvasCursor){
					p5f.noCursor();
					p5frameCover.style.cursor = 'none';
					p5frame.style.cursor = 'none';
				}else{
					p5f.cursor();
					p5frameCover.style.cursor = 'crosshair';
					p5frame.style.cursor = 'crosshair';
				}
			}
		}

		//console toggle
		function consoleToggle(){
			settings.console = !settings.console;
			consoleToggleUpdate();
		}

		function consoleToggleUpdate(){
			checkToggle('console', settings.console, settingsConsole, 'Console');
			if(!settings.console){
				p5console.style.display = 'none';
			}else{
				p5console.style.display = 'block';
			}
		}

		//menutab toggle
		function menutabToggle(){
			settings.menutab = !settings.menutab;
			menutabToggleUpdate();
		}

		function menutabToggleUpdate(){
			checkToggle('menutab', settings.menutab, settingsMenutab, 'Menu Tab');
			if(!settings.menutab){
				menuSwitch.style.display = 'none';
			}else{
				menuSwitch.style.display = 'block';
			}
		}

		//linenumbers toggle
		function linenumbersToggle(){
			settings.linenumbers = !settings.linenumbers;
			linenumbersUpdate();
		}

		function linenumbersUpdate(){
			checkToggle('linenumbers', settings.linenumbers, settingsLinenumbers, 'Line Numbers');
			if(!settings.linenumbers){
				editor.setOptions({
					showLineNumbers: false, // false
					showGutter: false, // false
				});
			}else{
				editor.setOptions({
					showLineNumbers: true, // false
					showGutter: true, // false
				});
			}
		}

		//autoComplete toggle
		function autocompleteToggle(){
			settings.autocomplete = !settings.autocomplete;
			autocompleteUpdate();
		}

		function autocompleteUpdate(){
			checkToggle('autocomplete', settings.autocomplete, settingsAutocomplete, 'Auto Autocomplete');
			if(!settings.autocomplete){
				editor.setOptions({
					enableLiveAutocompletion: false
				});
			}else{
				editor.setOptions({
					enableLiveAutocompletion: true
				});
			}
		}

		// lockCode toggle
		function lockDragToggle(){
			settings.lockcode = !settings.lockcode;
			lockDragUpdate();
		}

		function lockDragUpdate(){
			checkToggle('lockcode', settings.lockcode, settingsLockDrag, 'Lock Code on Drag');
		}

		// passEditorKeys toggle
		function passEditorKeysToggle(){
			settings.passEditorKeys = !settings.passEditorKeys;
			passEditorKeysUpdate();
		}

		function passEditorKeysUpdate(){
			checkToggle('passeditorkeys', settings.passEditorKeys, settingsPassEditorKeys, 'Pass-Thru Keypress');
		}

		// notify toggle
		function notifyToggle(){
			settings.notifyToggle = !settings.notifyToggle;
			notifyToggleUpdate();
		}

		function notifyToggleUpdate(){
			checkToggle('notifytoggle', settings.notifyToggle, settingsNotify, 'Notifications');
		}

		// tippy toggle
		function tippyToggle(){
			settings.tippyToggle = !settings.tippyToggle;
			tippyToggleUpdate();
		}

		function tippyToggleUpdate(){
			checkToggle('tippytoggle', settings.tippyToggle, settingsTippy, 'Tooltips');
			loadTippy();
		}

		// multi-p5live toggle
		function multitabToggle(){
			settings.multitabToggle = !settings.multitabToggle;
			multitabToggleUpdate();
		}

		function multitabToggleUpdate(){
			checkToggle('multitabtoggle', settings.multitabToggle, settingsMultitab, 'Multi-P5LIVE Warning');
		}

		// timestamp exports toggle
		function timestampToggle(){
			settings.timestampToggle = !settings.timestampToggle;
			timestampToggleUpdate();
		}

		function timestampToggleUpdate(){
			checkToggle('timestamptoggle', settings.timestampToggle, settingsTimestamp, 'Timestamp Exports');
		}

		//exportcode toggle
		function exportcodeToggle(){
			settings.exportCode = !settings.exportCode;
			linenumbersUpdate();
		}

		function exportcodeUpdate(){
			checkToggle('exportCode', settings.exportCode, settingsExportcode, 'Snapshot Code');
		}

		//BGactive toggle
		function themeBGactiveToggle(){
			settings.themeBGactive = !settings.themeBGactive;
			themeBGactiveToggleUpdate();
		}

		function themeBGactiveToggleUpdate(){
			checkToggle('themeBGactive', settings.themeBGactive, settingsBGactive, 'Code Background');
			editor.renderer.updateFull();
		}


		// checkbox function
		function checkToggle(checkName, checkVar, checkElm, checkNotify){
			if(checkVar){
				checkElm.checked = true;
			}else{
				checkElm.checked = false;
			}
			settings[checkName] = checkVar;
			updateSettings();

			// show notify of changed prefs by shortcut
			if(showNotify){
				let notifyChecked = '';
				if(checkVar){
					notifyChecked = 'checked';
				}
				let notifyName = checkName;
				if(checkNotify !== undefined){
					notifyName = checkNotify;
				}
				let notifyTxt = '<input type="checkbox" ' + notifyChecked + '> ' + notifyName;
				notifyMsg(notifyTxt);
			}
			if(settings.debugMode){console.log(checkName+': '+settings[checkName]);}
		}

		function p5varsReset(){
			p5vars = {'frameCount':0, 'mouseX':0, 'mouseY':0};
		}



		/* TOGGLE EDITOR + [canvas] + MENU */

		// hide/show editor
		function editorToggle(){
			if(p5editor.style.visibility != 'visible'){
				p5editor.style.visibility = 'visible';
			}else{
				p5editor.style.visibility = 'hidden';
			}
			editorToggleUpdate();
		}

		function editorToggleUpdate(){
			if(p5editor.style.visibility != 'visible'){
				const canv = document.querySelector('canvas');
				editor.blur();
			}else{
				editor.focus();
			}
		}

		// hide/show canvas
		// future usage for etherpad editing...

		/*
		function canvasToggle(){
			const canv = document.querySelector('canvas');
			//alert(canv);
			if(canv.style.visibility != 'visible'){
				canv.style.visibility = 'visible';
			}else{
				canv.style.visibility = 'hidden';
			}
			canvasToggleUpdate();
		}

		function canvasToggleUpdate(){
			const canv = document.querySelector('canvas');
			if(canv.style.visibility != 'visible'){
				if(sketchLoaded)
					noLoop();
			}else{
				if(sketchLoaded)
					loop();
			}
		}
		*/


		// hide/show menu
		function menuToggle(show){
			if(refVisible){
				console.log('closing ref')
					closeRef();
			}

			if(panelSettings.style.display == 'block'){
				hideSettings();
			}else{
				settings.menuMode = show || !settings.menuMode;
			}

			updateSettings();
			menuToggleUpdate();
		}

		function hideMenu(){
			settings.menuMode = false;
			updateSettings();
			menuToggleUpdate();
		}

		function menuToggleUpdate(){
			if(!settings.menuMode){
				menuPanel.style.marginRight = '-250px';
				menuSwitch.innerHTML = '«';
				window.setTimeout(hideSettings, 200);
				menuVisible = false;
				// menuPanel.style.overflow = "visible"; // test again w/ chromium
			}else{
				menuPanel.style.marginRight = '0px';
				menuSwitch.innerHTML = '»';
				filterSketchesClear();
				// menuSketchesFilter.value = ''; // *** double check
				menuVisible = true;
				// menuPanel.style.overflow = "hidden";
			}
		}


		// load theme
		function loadTheme(){
			for(let i=0; i < menuTheme.options.length; i++){
				let opt = menuTheme.options[i];
				if(settings.theme == opt.value){
					menuTheme.selectedIndex = i;
				}
			}
		}

		// set theme
		function setTheme(sel){
			editor.setTheme(menuTheme.value);
			settings.theme = menuTheme.value;
			updateSettings();
		}

		// set themeBG
		function setBG(val){
			if(settings.themeBG != val){
				settings.themeBG = '#'+ val;
				updateSettings();
				editor.renderer.updateFull();
			}
		}

		// paused for launch.. to visit in future!
		function styleMenu(){
			// buttons
			//setStyle('class', 'menu-button', 'backgroundColor', ColorLuminance(settings.themeBG, .4));
		}

		function setStyle(styleType, styleElm, styleAttribute, styleChange){
			let elms;
			if(styleType == 'class'){
				elms = document.getElementsByClassName(styleElm);
			}else if(styleType == 'tag'){
				elms = document.getElementsByTagName(styleElm);
			}else if(styleType == 'id'){
				elms = document.getElementById(styleElm);
			}
			for(let i=0; i < elms.length; i++){
				elms[i].style[styleAttribute] = styleChange;
			}
		}

		// https://www.sitepoint.com/javascript-generate-lighter-darker-color/
		/*
		function ColorLuminance(hex, lum) {
			// validate hex string
			hex = String(hex).replace(/[^0-9a-f]/gi, '');
			if (hex.length < 6) {
				hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
			}
			lum = lum || 0;

			// convert to decimal and change luminosity
			let rgb = '#', c;
			for (let i = 0; i < 3; i++) {
				c = parseInt(hex.substr(i*2,2), 16);
				c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
				rgb += ('00'+c).substr(c.length);
			}

			return rgb;
		}
		*/

		// adjust fontsize
		function fontSizeAdjust(newVal){
			settings.fontSize = newVal;
			updateSettings();
			fontSizeUpdate();
		}


		function fontSizeUpdate(){
			if(settingsFontsize !== document.activeElement){
				settingsFontsize.value = settings.fontSize;
			}
			p5code.style.fontSize = settings.fontSize + 'pt';
		}



		/* LOAD VARIOUS SKETCHES */
		function loadDefault(){
			if(!settings.cocoding.active){
				settings.fileName = 'new'; // jump to demos/new
				updateSettings();
				if(settings.sketches.length > 0){
					loadSketch(settings.fileName, 7); // put cursor in draw
				}
				filterSketchesClear();
			}else if(settings.cocoding.level == 'admin'){
				vex.dialog.confirm({
					message:'Replace COCODING code with template?',
					callback: function(value){
						if(value){
							cocode.codeReplace({'code':p5template});
							// editor.setValue(p5template, 1);
							// editor.gotoLine(7, 1, false);
							// editor.focus();
						}
					},
					afterOpen: function(){
						vexSmall(this.rootEl);
					}
				})
			}
		}




		function loadAbout(){
			let markedOptions = {
				headerPrefix:'marked-'
			};
			let demosPath = 'README.md?' + settings.revision;
			let request = new XMLHttpRequest();
			request.open('GET', demosPath, true);
			request.send();
			request.addEventListener('load', function(){
				let markedReadme = marked(request.responseText, markedOptions);
				let verrev = '<p>v '+ settings.version + ' - r' + settings.revision+'<br>';
				markedReadme = markedReadme.replace(/(<p>).+?(<br>)/, verrev); // <p[^>]*> // [v-\d].*<br>cc
				let p5liveabout = '<div id="about-alert" class="vex-long">'+markedReadme+'</div>';

				vex.dialog.alert({unsafeMessage:p5liveabout})
			});
		}



		// Tooltips via tippy
		function loadTippy(){
			if(!settings.tippyToggle){
				document.querySelectorAll('*').forEach(node => {
				if (node._tippy) {
					node._tippy.destroy();
				}
				});
				return false;
			}

			tippy('.tippy', {
				content(reference) {
					const title = reference.getAttribute('data-title')
					//reference.removeAttribute('title') // seems ok to leave there...
					return title
				},
				placement:'bottom',
				arrow:true,
				delay:0,
				duration:0,
				arrowType:'round',
				onShow(instance) {
					document.querySelectorAll('.tippy-popper').forEach(popper => {
						if (popper !== instance.popper) {
							popper._tippy.hide()
						}
					})
				}
			});

			tippy('.tippy-left', {
				content(reference) {
					const title = reference.getAttribute('data-title')
					//reference.removeAttribute('title')
					return title
				},
				placement:'left',
				arrow:true,
				delay:0,
				duration:0,
				zIndex:9999,
				boundary:'window',
				arrowType:'round',
				onShow(instance) {
					document.querySelectorAll('.tippy-popper').forEach(popper => {
						if (popper !== instance.popper) {
							popper._tippy.hide()
						}
					})
				}
			});
		}

		// *** dropdown tippy here = eventual exports/recording nav



		/*	EXPORT ASSETS	*/

		function savePNG(){
			if(sketchLoaded){
				p5f.save('P5L_' + settings.fileName + timeStampFile() + '.png');
				if(settings.exportCode){
					exportSketch(settings.fileName);
					if(showNotify){
						notifyMsg('Snapshot Saved');
					}
				}
			}
		}

		function loadHTMLTemplate(){
			let tempPath = 'includes/templates/p5live_savehtml.html?' + makeid(5);
			let request = new XMLHttpRequest();
			request.open('GET', tempPath, true);
			request.send();
			request.addEventListener('load', function(){
				let el = document.createElement('html');
				el.innerHTML = request.responseText;
				p5htmlTemplate = el;
			});
		}

		function saveHTML(){
			let el = p5htmlTemplate.cloneNode(true);
			el.getElementsByTagName('title')[0].innerHTML = settings.fileName;
			let iFrameBody = el.getElementsByTagName('head')[0];//el.document.getElementsByTagName('body')[0];

			// check loadScripts;
			let scriptsList = processLibs(removeComments(editor.getValue()));
			for(let i=0; i < scriptsList.length; i++){
				let s = document.createElement('script');
				s.type = 'text/javascript';
				s.src = scriptsList[i];
				iFrameBody.appendChild(s);
				iFrameBody.innerHTML += '\n\n';
			}


			let s = document.createElement('script');
			s.type = 'text/javascript';
			s.innerHTML = '\n//' + settings.fileName+ '\n\n' + p5custom.value +'\n\n' + editor.getValue();
			iFrameBody.appendChild(s);
			iFrameBody.innerHTML += '\n\n';
			download('<!DOCTYPE html>\n<html>\n' + el.innerHTML+'\n</html>', 'P5L_' + settings.fileName + timeStampFile() + '.html', 'text/html');
		}

		function timeDate(){
			let d = new Date() ;
			d.setTime( d.getTime() - new Date().getTimezoneOffset()*60*1000 );
			return d.getTime();
		}

		function timeStamp(timeInput){
			let d = new Date();
			d.setTime( d.getTime() - new Date().getTimezoneOffset()*60*1000 );
			if(timeInput != undefined){
				d = new Date(timeInput * 1);
			}
			return d.toISOString().replace(/[^0-9]/g, '').slice(0, -3);
		}

		function timeStampFile(timeInput){
			return (settings.timestampToggle) ? '_' + timeStamp(timeInput) : '';
		}



		/* p5.js REFERENCE */

		window.onhashchange = getRef; // *** make preparser to prevent ref opening...

		function toggleRef(force){
			if(refVisible || force){
				closeRef();
			}else{
				showRef();
			}
		}

		function showRef(){
			if(!downloadedRef){
				loaderSub.innerHTML = 'load references...';
				showLoader();
				loadRef();
				downloadedRef = true;
			}else{
				refHolder.style.display = 'block';
				getRef();
			}
		}

		// close references
		function closeRef(){
			window.location.hash = '#';
			refHolder.style.display ='none';
			refSearch = '';
			refVisible = false;
			editor.gotoLine(curPos.row+1, curPos.column);
			editor.focus();
		}

		function getRef(){
			if(settings.menuMode || settingsVisible){
				hideMenu();
			}

			refVisible = true;

			if(window.location.hash != undefined && window.location.hash.length > 1){
				let refPieces = window.location.hash.split('/');
				let grabRef = '';
				if(window.location.hash == '#new'){
					loadDefault();
					return false;
				}else if(window.location.hash == '#bug'){
					loadBug();
					return false;
				}else if(refPieces.length == 3){
					ref.innerHTML = '';
					grabRef = window.location.hash.split('/')[2];
				}else{
					allRef();
					// window.location = window.location.hash;
				}

				if(grabRef != ''){
					tippy.hideAll({ duration: 0 });
					let snippetIndex = refList.map(function(d) { return d['name']; }).indexOf(decodeURI(grabRef));
					let ex = refList[snippetIndex];
					let paramsCollect = [];
					let paramsDesc = [];
					if(ex.overloads != undefined || ex.params != undefined){
						ref.innerHTML += '<a href="#'+ex.module+'"><div class="param-title">← ' + ex.name + '</div></a><br>';

						if(ex.overloads != undefined){
							ex.overloads.forEach(function(ol){
								let params = [];
								ol.params.forEach(function(param){
									if(param.optional){
										params.push('[' + param.name + ']');
									}else{
										params.push(param.name);
									}

									if(paramsCollect.indexOf(param.name) === -1){
										paramsCollect.push(param.name);
										let paramHTML = '<div class="param"><div class="//">'+ param.name +"</div> "+ param.description.trim() +'</div>';
										paramsDesc.push(paramHTML);
									}

								})
								let paramsJoin = '';
								if(params.length > 0){
									paramsJoin = '(' + params.join(', ') + ')';
								}
								ref.innerHTML += '<div class="param-code">' + ex.name + paramsJoin + '</div>';
							})
						}else{
							let params = [];
							ex.params.forEach(function(param){
								if(paramsCollect.indexOf(param.name) === -1){
									if(param.optional){
										params.push('[' + param.name + ']');
									}else{
										params.push(param.name);
									}
									if(param.description == ''){
										param.description = '<br>';
									}
									let paramHTML = '<div class="param"><div class="param-name">' + param.name + '</div> <div class="param-desc">' + param.description +'</div></div>';
									paramsDesc.push(paramHTML);
									paramsCollect.push(param.name);
								}
							})
							if(ex.module != 'Constants'){
								let paramsJoin = '';
								if(params.length > 0){
									paramsJoin = '(' + params.join(', ') + ')';
								}
								ref.innerHTML += '<div class="param-code">' + ex.name + paramsJoin + '</div>';
							}
						}
					}else{
						ref.innerHTML += '<a href="#"><div class="param-title">← ' + ex.name + '</div></a>';
					}

					let desc = '';
					if(ex.descriptionHTML != undefined){
						desc = ex.descriptionHTML;
					}


					ref.innerHTML += '<br><div class="params"' + paramsDesc.join('') + '</div><br>' + desc;
					if(ex.examples.length > 0){
						for(let example of ex.examples){
							let exampleParse = 	example.replace(/\n/g, '<br> ');
							ref.innerHTML += '<br><div class="ref-example js" type="js">'+exampleParse+'</div><br>';
						}

					}

					let refLink = '<br><a href="https://p5js.org/reference/#/p5/'+grabRef+'" target="_blank">p5.js website reference →</a>';
						ref.innerHTML += refLink;

					hljs.configure({useBR: true});
					document.querySelectorAll('.ref-example').forEach((block) => {
					hljs.highlightBlock(block);
					});
				}
			}else{
				allRef();
			}
		}

		function filterRefClear(forceFocus){
			let filterInput = document.getElementById('ref-search');
			if(filterInput.value == ''){
				if(forceFocus){
					filterInput.focus();
				}
			}else{
				filterInput.value = '';
				filterRef();
			}
		}

		function filterRef(){
			let filterInput = document.getElementById('ref-search');
			let filterInputIcon = document.getElementById('ref-search-icon');
			let refFilteredItems = refHolder.getElementsByClassName('all-ref');
			let refModules = refHolder.getElementsByClassName('module');

			if(filterInput.value != ''){
				filterInputIcon.innerHTML = iconX;
				refSearch = filterInput.value;
				refHolder.scrollTop = 0;
				for(let fi of refFilteredItems){
					fi.classList.add('ref-hide');
				}
				for(let rm of refModules){
					rm.classList.add('ref-collapse');
				}

				let filter = filterInput.value.toLowerCase().split(' ');

				// remove empty while adding another word
				filter = filter.filter(Boolean);

				for(let rfi of refFilteredItems){
					if ( filter.some((val) => rfi.getAttribute('data-name').toLowerCase().indexOf(val) !== -1)){
					// if(rfi.getAttribute('data-name').toLowerCase().indexOf(filter) > -1){
						rfi.classList.remove('ref-hide');
					}
				}
				filterInput.focus();
			}else{
				refSearch = '';
				filterInputIcon.innerHTML = iconFilter;
				for(let fi of refFilteredItems){
					fi.classList.remove('ref-hide');
				}
				for(let rm of refModules){
					rm.classList.remove('ref-collapse');
				}
			}


		}

		function randomRef(c){
			let refFilteredItems = refHolder.getElementsByClassName('all-ref');
			let refFunctions = refHolder.getElementsByClassName('ref-link');
			let refModules = refHolder.getElementsByClassName('module');
			let showAll = document.getElementById('showall');
			let rr;

			c = setInterval(function(){
				for(let fi of refFilteredItems){
					fi.classList.add('ref-hide');
				}
				for(let rm of refModules){
					rm.classList.add('ref-collapse');
				}
				rr = refFunctions[Math.floor(Math.random()*refFunctions.length)];
				rr.classList.remove('ref-hide');
			}, 50);
			setTimeout(function(){clearInterval(c);rr.classList.add('ref-pulse');setTimeout(function(){rr.click()}, 500);}, 1000);
		}

		function allRef(){
			let refValue = '';
			ref.innerHTML = '<div class="ref-sticky"><div class="ref-title">p5.js References <a onclick="randomRef(0);" class="ref-random tippy" data-title="Surprise!">'+iconGift+'</a><br></div><div class="ref-search-holder"><span id="ref-search-icon" class="tippy-left" data-title="Filter References<br>(separate words for an <i>and</i> search)" onclick="filterRefClear(true)">'+iconFilter+'</span><input type="text" id="ref-search" placeholder="Search..." onkeyup="filterRef()" value="'+refSearch+'" onfocus="this.selectionStart = this.selectionEnd = this.value.length;" class="tippy-left" data-title="Filter References<br>(separate words for an <i>and</i> search)"></div></div>';
			let all = [];
			let grouped = groupBy(refList, (c) => c.module);
			Object.keys(grouped).forEach(function(k){
				let modHTML = '<div class="module" name="' + k + '" id="' + k + '"><div class="module-name">' + k + '</div>';
				let modAll = [];
				grouped[k].forEach(function(ci){

					let noDesc = false;
					let noParams = false;
					if(ci.description.length == 0){
						noDesc = true;
					}else if(ci.params.length == 0){
						noParams = true;
					}

					// debug single ref
					// if(ci.name == 'touchEnded'){
					// 	console.log(ci);
					// }

					if(ci.name != ''){
						let title = '';
						let desc = '';
						title += ci.code.join('<br>') + '<br>';
						let params = [];
						ci.params.forEach(function(cip){
							params.push(cip.name + ' - ' + cip.description);
						});
						title += params.join('<br>') + '<br>';
						if(ci.description != ''){
							desc = ci.description;
						}

						let dataName = 'data-name="' + ci.name + '"';
						if(!noDesc){
							if(noParams){
								modAll.push('<a class="all-ref ref-link tippy-left" href="#/p5/' + htmlEntities(ci.name) + '" onclick="refScroll=refHolder.scrollTop;refHolder.scrollTop=0;" '+dataName+' data-title="<div style=\'text-align:left;\'>' + htmlEntities(ci.description).trim() + '</div>">' + htmlEntities(ci.name) + '<br></a>');
							}else{
								modAll.push('<a class="all-ref ref-link tippy-left" href="#/p5/' + htmlEntities(ci.name) + '" onclick="refScroll=refHolder.scrollTop;refHolder.scrollTop=0;" '+dataName+' data-title="<div style=\'text-align:left;\'>' + htmlEntities(title).trim() + '</div>">' + htmlEntities(ci.name) + '<br></a>');
							}
						}else{
							modAll.push('<span class="all-ref ref-nolink tippy-left" '+dataName+' data-title="'+htmlEntities(ci.name)+'">' + htmlEntities(ci.name) + '<br></span>');
						}
					}
				});
				modHTML += modAll.join('');
				modHTML += '</div>';
				all.push(modHTML);
			});

			ref.innerHTML += '<div id="showall">' + all.join('') + '</div>';
			setTimeout(function(){loadTippy();}, 100);
			document.getElementById('ref-search').focus();

			// jump to category of viewed ref
			if(window.location.hash != undefined && window.location.hash.length > 1){
				let refPieces = window.location.hash.split('/');
				if(refPieces.length == 1){
					refHolder.scrollTop = refScroll;
					filterRef();
				}
			}

			return false;
		}

		function loadRef(){
			refList = [];
			let refPath = 'includes/p5/data.json?' + settings.revision;
			let request = new XMLHttpRequest();
			request.open('GET', refPath, true);
			request.send();
			request.addEventListener("load", function(){
				let jsonObj = JSON.parse(request.responseText.replace('referenceData = ', ''));
				let grouped = groupBy(jsonObj.classitems, (c) => c.module);
				let autoCompleteList = {'revision':currentRevision, 'version':jsonObj.project.version, 'codeKey':[{'[n]ame':'function/constant', '[p]arams':'params/module', '[t]ype':'[m]ethod'}], 'code':[]};

				// filter to own needs
				Object.keys(grouped).forEach(function(k){
					grouped[k].forEach(function(ci){
						let classItem = {};
						classItem.module = k;
						if(ci.name != undefined){
							classItem.name = ci.name;
						}else{
							classItem.name = '';
						}
						if(ci.description != undefined){
							classItem.description = ci.description.replace(/<(?:.|\n)*?>/gm, '').replace(/\n/gi, ' ');
							classItem.descriptionHTML = ci.description;
						}else{
							classItem.description = '';
						}
						let classCode = [];
						let classParams = [];
						let classExamples = [];
						let paramsCollect = [];

						if(ci.example != undefined){
							let exs = ci.example[0].match(/<code.*>(.|\n)*?<\/code>/g);
							if(exs == undefined){
								console.log(ci.name +" : "+ ci.example)
							}
							for(let ex of exs){
								classExamples.push(ex.replace(/<.*code?[^>]*>/g, ''));
							}
						}

						// if(ci.name == 'createNumberDict'){
						// 	// console.log(ci.example[0].match(/<code>(.|\n)*?<\/code>/g));
						// 	let exs = ci.example[0].match(/<code>(.|\n)*?<\/code>/g);
						// 	for(let ex of exs){
						// 		console.log(ex.replace(/<.*code?[^>]*>/g, ''));
						// 	}
						// }

						if(ci.overloads != undefined || ci.params != undefined){
							if(ci.overloads != undefined){
								ci.overloads.forEach(function(ol){
									let params = [];
									let acParams = [];
									ol.params.forEach(function(param){
										if(param.optional){
											params.push('[' + param.name + ']');
										}else{
											params.push(param.name);
											acParams.push(param.name);
										}

										if(paramsCollect.indexOf(param.name) === -1){
											paramsCollect.push(param.name);
											let paramDesc = param.description.substring(0, param.description.length-1).replace(/<.*?p[^>]*>/g, '').replace(/\n/gi, ' ');
											classParams.push({'name':param.name, 'description':paramDesc});
										}
									})
									classCode.push(ci.name + '(' + params.join(', ') + ')');

									// autoComplete list
									autoCompleteList.code.push({'n':ci.name, 'p':acParams, 't':'m'});
									if(acParams.length != params.length){
										autoCompleteList.code.push({'n':ci.name, 'p':params, 't':'m'});
									}
								})
							}else{
								let params = [];
								let acParams = [];
								ci.params.forEach(function(param){
									if(paramsCollect.indexOf(param.name) === -1){
										if(param.optional){
											params.push('[' + param.name + ']');
										}else{
											params.push(param.name);
											acParams.push(param.name);
										}
										paramsCollect.push(param.name);
										let paramDesc = param.description.substring(0, param.description.length-1).replace(/<.*?[^>]*>/g, '').replace(/\n/gi, ' ');
										classParams.push({'name':param.name, 'description':paramDesc});
									}
								})
								classCode.push(ci.name + '(' + params.join(', ') + ')');

								// autoComplete list
								autoCompleteList.code.push({'n':ci.name, 'p':acParams, 't':'m'});
								if(acParams.length != params.length){
									autoCompleteList.code.push({'n':ci.name, 'p':params, 't':'m'});
								}
							}
						}else if(ci.name != undefined && classItem.module != 'p5.sound' && classItem.module != 'Foundation'){
							let acParam = classItem.module;
							let acType = '';
							if(ci.itemtype == 'method'){
								acParam = [];
								acType = 'm';
							}
							autoCompleteList.code.push({'n':ci.name, 'p':acParam, 't':acType});
						}
						classItem.code = classCode;
						classItem.params = classParams;
						classItem.examples = classExamples;
						refList.push(classItem);

					});
				});

				// autoCompleteExport = true;
				if(autoCompleteExport){
					exportJSON(autoCompleteList, 'P5L_AUTOCOMPLETE'+timeStampFile()+'.json');
				}else{
					// console.log(autoCompleteList.code);
				}
				allRef();
				hideLoader();
				// display once downloaded
				refHolder.style.display = 'block';
				getRef();
			});

		}

		// group references
		function groupBy(xs, f) {
			return xs.reduce((r, v, i, a, k = f(v)) => ((r[k] || (r[k] = [])).push(v), r), {});
		}

		// clean up invalid characters
		function htmlEntities(str) {
			return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
		}



		/* iFrame magic */

		// get mouse clicks on top
		// initially inspired from here:
		// https://stackoverflow.com/a/44143731/10885535
		window.addEventListener('mousemove', passMouseClick);
		window.addEventListener('mouseup', passMouseClick);
		window.addEventListener('mousedown', passMouseClick);


		let pass = false;
		function passMouse(event){
			pass = !pass;
			if (pass) {
				processMouse(event);
			}
		};

		function passMouseClick(event){
			processMouse(event);
		};

		let mouseFields = ['altKey', 'clientX', 'clientY', 'composed', 'ctrlKey', 'isTrusted', 'layerX', 'layerY', 'metaKey', 'movementX', 'movementY', 'offsetX', 'offsetY', 'pageX', 'pageY', 'screenX', 'screenY', 'shiftKey', 'x', 'y', 'button', 'buttons', 'relatedTarget', 'region'];

		function getOpts(event, fields){
			let opts = {};
				fields.forEach(function(f) {
					if (f in event) {
						opts[f] = event[f];
					}
				});
			return opts;
		}

		function processMouse(event){
			let opts = getOpts(event, mouseFields);
			let copy = new MouseEvent(event.type, event);
			if(settings.cocoding.active && settings.cocoding.sync){
				if(settings.cocoding.level == 'admin'){
					if(p5editor.style.visibility == 'visible'){
						p5f.dispatchEvent(copy);
					}
					cocode.dispatchSyncEvent('mouse', event.type, opts);
				}
			}else{
				if(p5editor.style.visibility == 'visible'){
					p5f.dispatchEvent(copy);
				}
			}

			// prevent drag+drop+shift of code, while mouseDragging visuals
			if(event.type == 'mousedown' && settings.lockdown){
				editor.setReadOnly(true);
			}else if(event.type == 'mouseup'){
				if(!settings.cocoding.active || (settings.cocoding.active && (settings.cocoding.level == 'admin' || settings.cocoding.writemode || !settings.cocoding.lockdown))){
					editor.setReadOnly(false);
				}
			}

		}


		// pass keys on down
		// tips: https://stackoverflow.com/questions/596481/
		window.addEventListener('keydown', sendKey);
		window.addEventListener('keyup', sendKey);

		let keyFields = ['altKey', 'bubbles', 'cancelBubble', 'cancelable', 'charCode', 'code', 'composed', 'ctrlKey', 'isTrusted', 'key', 'keyCode', 'location', 'metaKey', 'repeat', 'returnValue', 'shiftKey', 'type', 'which'];


		function sendKey(event){
			let opts = getOpts(event, keyFields);
			let copy = new KeyboardEvent(event.type, event);

			if(p5editor.style.visibility != 'visible' || settings.passEditorKeys){
				if(settings.cocoding.active && settings.cocoding.sync){
					if(settings.cocoding.level == 'admin'){
						p5f.dispatchEvent(copy);
						cocode.dispatchSyncEvent('keyboard', event.type, opts);
					}
				}else{
					p5f.dispatchEvent(copy);
				}
			}
		}



		/*	MISC */
		function pop720(){
			let popWindow = window.open(window.location.href, 'mywindow', 'menubar=0,resizable=0,width=720,innerHeight=720');
			setTimeout(function(){popWindow.innerHeight = 720;}, 100);
		}

		function popStream(force){
			if(force){
				p5popActive = true;
			}
			if(sketchLoaded && p5popActive){
				p5popStream = p5f.document.querySelector('canvas').captureStream()

				if(p5pop && !p5pop.closed){
					p5pop.vid.srcObject = p5popStream;
				}else{
					// technique built upon : http://plnkr.co/edit/jDzbtPYrYItQ4peplOAN
					let popup_html = '<!DOCTYPE html><html><head><title>P5LIVE - VISUALS STREAM</title></head><body><div id="but" style="position:fixed;right:5px;top:5px;z-index:10;border:none;color:#fff;padding:5px;font-size:16pt;cursor:pointer;opacity:.5;" onmouseenter="this.style.opacity=1;" onmouseleave="this.style.opacity=.5;" onclick="openFullscreen();" title="Fullscreen">'+iconMaximize+'</div><br><video id="vid" playsinline autoplay muted style="position:fixed;left:0;top:0;width:100vw;height:100vh;background-color:#000;"></video><script>var vid=document.getElementById("vid");document.body.style.margin="0";document.body.style.background="'+newBG+'";function openFullscreen(){if(vid.requestFullscreen) {vid.requestFullscreen(); } else if (vid.mozRequestFullScreen) { /* Firefox */ vid.mozRequestFullScreen();}else if(vid.webkitRequestFullscreen) {/* Chrome, Safari & Opera */ vid.webkitRequestFullscreen();}else if(vid.msRequestFullscreen){/* IE/Edge */ vid.msRequestFullscreen();}}<\/script><style>::-webkit-media-controls {display:none !important;}<\/style></body></html>';
					let popup_url = URL.createObjectURL(new Blob([popup_html], {
					  type: 'text/html'
					}));
					p5pop = window.open(popup_url, "P5LIVE - VISUALS STREAM", 'left=0,top=0,width=0,height=0');
					URL.revokeObjectURL(popup_url);
					p5pop.onload = function() {
						p5pop.vid.srcObject = p5popStream;
						// let ctrls = p5pop.document.getElementById("controldiv");
						// ctrls.disabled="true";
					}

					// if p5pop closed
					p5pop.onbeforeunload = function() {
						p5popActive = false;
					}
				}
			}
		}

		function showLoader(){
			loader.style.display = 'flex';
		}

		function hideLoader(){
			loader.style.display = 'none';
			// loaderSub.innerHTML = '';
		}

		/* View in fullscreen */
		function openFullscreen() {
			let elem = document.documentElement;
			if (elem.requestFullscreen) {
				elem.requestFullscreen();
			} else if (elem.mozRequestFullScreen) { /* Firefox */
				elem.mozRequestFullScreen();
			} else if (elem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
				elem.webkitRequestFullscreen();
			} else if (elem.msRequestFullscreen) { /* IE/Edge */
				elem.msRequestFullscreen();
			}
		}

		/* Close fullscreen */
		function closeFullscreen() {
			if (document.exitFullscreen) {
				document.exitFullscreen();
			} else if (document.mozCancelFullScreen) { /* Firefox */
				document.mozCancelFullScreen();
			} else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */
				document.webkitExitFullscreen();
			} else if (document.msExitFullscreen) { /* IE/Edge */
				document.msExitFullscreen();
			}
		}

		/* General Alert */
		function alertMsg(txt){
			vex.dialog.alert({
				unsafeMessage:txt,
				afterOpen: function(){
					vexSmall(this.rootEl);
				}
			})
		}

		/* Notification for settings changed by shortcut */
		function notifyMsg(txt){
			if(!settings.editMode){
				return false;
			}
			notify.innerHTML = txt;
			notify.style.display = 'block';
			notify.style.opacity = 1.0;
			if(menuPanel.style.marginRight == '0px'){
				notify.style.right = '255px';
			}else{
				notify.style.right = '5px';
			}
			clearTimeout(notifyTimer);
			let notifyDelay = txt.length*20;
			notifyTimer = setTimeout(function(){
				notify.style.opacity = 0;
				setTimeout(function(){notify.style.display = 'none';}, 500);

			}, notifyDelay);
			showNotify = false;
		}

		/* Sketches Congrats */
		function sketchesCounter(){
			settings.statscount++;
			updateSettings();
			let txtMsg = 'P5LIVE<span class="counters">Stats</span><br><br><hr><br>';
			txtMsg += document.querySelectorAll('.item-folder:not(.demo)').length.toLocaleString()+'<span class="counters">Folders</span><br>';
			txtMsg += document.querySelectorAll('.item-sketch:not(.demo)').length.toLocaleString()+'<span class="counters">Sketches</span><br>';

			let totalChars = 0;
			let totalLines = 0;
			let sketchStats = {long:{count:0, name:''}, short:{count:9999, name:''}};
			for(let is of document.querySelectorAll('.item-sketch:not(.demo)')){
				let grabName = is.getAttribute('data-id');
				let grabSketch = localStorage.getItem(grabName);
				totalChars += grabSketch.replace('\n', '').replace('\t', '').length;
				totalLines += grabSketch.split('\n').length;
				if(grabSketch.split('\n').length > sketchStats.long.count){
					sketchStats.long.count = grabSketch.split('\n').length;
					sketchStats.long.name = grabName;
				}
				if(grabSketch.split('\n').length < sketchStats.short.count){
					sketchStats.short.count = grabSketch.split('\n').length;
					sketchStats.short.name = grabName;
				}
			}
			txtMsg += totalChars.toLocaleString()+'<span class="counters">Characters</span><br>';
			txtMsg += totalLines.toLocaleString()+'<span class="counters">Lines</span><br>';
			txtMsg += sketchStats.short.count.toLocaleString()+'<span class="counters">Shortest ('+sketchStats.short.name+')</span><br>';
			txtMsg += sketchStats.long.count.toLocaleString()+'<span class="counters">Longest ('+sketchStats.long.name+')</span><br>';
			txtMsg += settings.statscount.toLocaleString()+'<span class="counters">Viewed Stats...</span><br>';
			alertMsg(txtMsg);
		}


		/*	COCODING */
		function makeid(charCount){
			let text = '';
			for( let i=0; i < charCount; i++ )
				text += chars.charAt(Math.floor(Math.random() * chars.length));
			return text;
		}

		function cocodingInit(){
			if(settings.cocoding.active){
				vex.dialog.confirm({
					message: 'Exit COCODING?',
					callback: function (value) {
						if (value) {
							cocodingExit(loadLatest());
						}
					},
					afterOpen: function(){
						vexSmall(this.rootEl);
					}
				})
			}else{
				cocodingReset();
				let sessID = makeid(5);
				settings.cocoding.active = true;
				settings.cocoding.token = hashCode(sessID);
				updateSettings();
				document.location.search = 'cc=' + sessID;
			}
		}

		function hashCode(s) {
			let h;
			for(let i = 0; i < s.length; i++)
				h = Math.imul(31, h) + s.charCodeAt(i) | 0;

			return h;
		}

		function cocodingExit(sketch){
			cocodingReset();
			settings.fileName = sketch;
			updateSettings;
			// loadSketch(settings.fileName);
			window.history.replaceState(null, null, window.location.pathname);
			window.location = window.location.pathname;
		}

		function cocoding(){
			menuCocodeHolder.style.display = 'block';
			menuCocodeChatHolder.style.display = 'block';
			editor.setValue('// Loading COCODING Session: '+settings.cocoding.namespace, 1);
			syncdataConsoleClear();
			settings.syncdata.active = false;
			settings.syncdata.libs = [];
			settings.syncdata.cocodeadded = false;
			updateSettings();
			cocode = new CocodeApp(settings.cocoding.namespace);
			if(cocodingFirstTime){
				setTimeout(function(){
					cocode.rename();
				}, 500);
			}
		}

		// reset all cocoding except nick + color
		function cocodingReset(){
			Object.keys(initSettings.cocoding).forEach(function(cc){
				if(cc != 'nick' && cc != 'color'){
					settings.cocoding[cc] = initSettings.cocoding[cc];
				}
			});
			updateSettings();
		}


		/*	SyncData */

		// load presets
		function syncDataPresetLoad(){
			syncdataPresets = [];
			let syncdataPresetsPath = 'includes/demos/P5L_syncdata-presets.json?' + makeid(5);
			let request = new XMLHttpRequest();
			request.open('GET', syncdataPresetsPath, true);
			request.send();
			request.addEventListener('load', function(){
				let jsonObj = JSON.parse(request.responseText);
				for(let p of jsonObj.structure[0].contents){
					let presetName = p.name.replace('syncdata-', '');
					let presetSketch = {code:p.code, name:presetName, protected:true};
					syncdataPresets.push(presetSketch);
				}

				// load localSyncdataPresets
				for(let sdp of settings.syncdata.sketches){
					syncdataPresets.push(sdp);
				}
			});
		}

		function syncdataWindow(){
			let editorInit = true;
			let reloadVex = false;
			let reloadAlert = 0;
			let syncdataPresetsOptions = '';
			let doneDemos = false;
			for(let sdp of syncdataPresets){
				if(sdp.protected == false && !doneDemos){
					syncdataPresetsOptions += '<option name="select-divider" value="select-divider" label="------------" disabled>';
					doneDemos = true;
				}
				syncdataPresetsOptions += '<option name="'+sdp.name+'" value="'+sdp.name+'">'+sdp.name+'</option>';
			}

			let syncdataVex = vex.dialog.confirm({
				focusFirstInput : false,
				unsafeMessage:'<div style="font-size:10pt;line-height:1.3em;font-style:italic;">Sync local data with anyone in COCODING session!<br>Code below is saved in local settings, <code>Load Preset</code> replaces it.</div><select name="Presets" onchange="syncdataPresetChange(this.value)"><option name="select" value="select">Load Preset</option>'+syncdataPresetsOptions+'Load Preset</option></select> <span id="preset-button-group"><button onclick="vex.closeAll();syncdataPresetSave();" class="tippy" data-title="Create new preset">Save Preset</button> <button id="preset-button-remove" onclick="vex.closeAll();syncdataPresetRemove(this.name);" name="" class="tippy" data-title="Remove selected preset" style="display:none;">Remove Preset</button></span><br><br><div class="syncdata-header code-header">code</div><div id="syncdata" class="vex-long popup-editor"></div><div class="syncdata-header tippy-left" style="cursor:pointer;" data-title="Click to Clear Console" onclick="syncdataConsoleClear();">console</div><textarea id="syncdata-console" readonly="readonly">'+settings.syncdata.console.join('\n')+'</textarea>',

				callback: function (value) {},
				buttons: [
				{
					type: 'close',
					text: '× CLOSE',
					click: function(){
						vex.close(syncdataVex);
					}
				},
				{
					type: 'submit',
					text: settings.syncdata.active ? '► RE-RUN' : '► RUN', // iconPlay
					click: function updateCode () {
						settings.syncdata.active = true;
						updateSettings();
						syncdataButtonToggle();
						recompile(true);
						cocode.recompile();
						prepReload();
					}
				},
				settings.syncdata.active ? {
					type: 'stop',
					text: '◼ STOP',
					click: function updateCode () {
						settings.syncdata.active = false;
						settings.syncdata.libs = [];
						updateSettings();
						syncdataSend({meta:'stop'});
						syncdataButtonToggle();
						recompile(true);
						vex.close(syncdataVex);
					}
				} : {
					className: 'hide-button' // hide if unused
				},
				settings.syncdata.active && settings.cocoding.level == 'admin' && !settings.syncdata.cocodeadded ? {
					type: 'cocode',
					text: '↓ COCODE',
					click: function updateCode () {
						settings.syncdata.cocodeadded = true;
						updateSettings();
						syncdataCocode();
						vex.close(syncdataVex);
					}
				} : {
					className: 'hide-button' // hide if unused
				}

				],
				onSubmit: function(e) {
					e.preventDefault();
				},
				afterOpen: function(){
					syncdataEditor = ace.edit("syncdata");
					syncdataEditor.setTheme(settings.theme);
					syncdataEditor.session.setMode('ace/mode/javascript');
					syncdataEditor.setOptions({
						showPrintMargin: false,
						animatedScroll: false,
						displayIndentGuides: false,
						useWorker: true,
						showLineNumbers: true,
						showGutter: true,
						tabSize: 4, useSoftTabs: false,
					});

					syncdataEditor.setValue(settings.syncdata.code, settings.syncdata.cursor.row);

					setTimeout(function(){
						syncdataEditor.gotoLine(settings.syncdata.cursor.row, settings.syncdata.cursor.column);
						let syncdataConsole = document.getElementById('syncdata-console');
						syncdataConsole.scrollTop = syncdataConsole.scrollHeight;
					}, 100);

					syncdataEditor.getSession().on('change', function() {
						settings.syncdata.code = syncdataEditor.getValue();
					});

					syncdataEditor.getSession().selection.on('changeCursor', function(){
						if(!editorInit){
							settings.syncdata.cursor = syncdataEditor.getCursorPosition();
							updateSettings();

						}
					});

					tidyCode(syncdataEditor);
					loadTippy();
					editorInit = false;
				},
				afterClose: function(){
					if(reloadVex){
						vex.close(reloadAlert);
						syncdataWindow();
					}
				}
			})



			function prepReload(){
				reloadVex = true;

				vex.dialog.alert({
					unsafeMessage:'<div style="font-size:10pt;line-height:1.3em;font-style:italic;">Refreshing SyncData...</div>',
					buttons:[],
					afterOpen: function(){
						reloadAlert = this;
						vex.close(syncdataVex);
					}
				})
			}
		}

		function syncdataPresetCheck(){
			let presetName = document.getElementById('presetname-input').value;
			let presetNameWarning = document.getElementById('presetname-warning');
			presetNameWarning.innerHTML = '';
			for(let sdp of settings.syncdata.sketches){
				if(sdp.name == presetName){
					presetNameWarning.innerHTML = 'SAVE will replace current preset.';
				}
			}
		}

		function syncdataPresetRemove(presetVal){
			for(let i=0; i < syncdataPresets.length; i++){
				if(syncdataPresets[i].name == presetVal && syncdataPresets[i].protected || presetVal == ''){
					let thisVex = vex.dialog.alert({
						unsafeMessage:'Can\'t remove P5LIVE preset...',
					afterOpen: function(){
						vexSmall(this.rootEl);
					},
					afterClose: function(){
						syncdataWindow();
					}
					})
					return false;
				}
			}

			vex.dialog.confirm({
				unsafeMessage: 'Remove Preset: '+presetVal,
				callback: function (value) {
					if (value) {
						settings.syncdata.code = '// '+presetVal+' Removed!';
						for(let i=0; i < settings.syncdata.sketches.length; i++){
							if(settings.syncdata.sketches[i].name == presetVal){
								settings.syncdata.sketches.splice(i, 1);//console.log(i);
							}
						}
						for(let i=0; i < syncdataPresets.length; i++){
							if(syncdataPresets[i].name == presetVal){
								syncdataPresets.splice(i, 1);//console.log(i);
							}
						}
						updateSettings();
					}
				},
				afterOpen: function(){
					vexSmall(this.rootEl);
				},
				afterClose: function(){
					syncdataWindow();
				}
			})
		}

		function syncdataPresetSave(){
				let presetChange = false;
				let presetNamesFiltered = '';
				for(let sdp of settings.syncdata.sketches){
					presetNamesFiltered += '<option name="'+sdp.name+'" value="'+sdp.name+'">'+sdp.name+'</option>';
				}
				let setPresetVex = vex.dialog.confirm({
					// focusFirstInput : false,
					callback:function(){},
					unsafeMessage:'<div style="font-size:10pt;line-height:1.3em;font-style:italic;">Set preset name or use existing one to replace it.<br><br><select name="Presets" onchange="document.getElementById(\'presetname-input\').value = this.value;syncdataPresetCheck();document.getElementById(\'presetname-input\').select();"><option name="" value="">Select User Preset</option>'+presetNamesFiltered+'</select><br><input style="font-size:14pt" id="presetname-input" name="presetname-input" type="text" value="" placeholder="Preset Name..." onkeyup="syncdataPresetCheck();"><br><span id="presetname-warning"></span>',
					buttons: [
					{
						type: 'submit',
						text: 'Save',
						className: '',
						click: function () {
							let presetName = document.getElementById('presetname-input').value;
							let presetNameWarning = document.getElementById('presetname-warning');

							// check duplicate name
							let replacePreset = false;
							for(let sdp of settings.syncdata.sketches){
								if(sdp.name == presetName){
									replacePreset = true;
								}
							}

							let newPreset = {code:settings.syncdata.code, name:presetName, protected:false};
							if(replacePreset){
								// replace preset
								for(let i=0; i < settings.syncdata.sketches.length; i++){
									if(settings.syncdata.sketches[i].name == presetName){
										settings.syncdata.sketches[i].code = newPreset.code;
									}
								}
								for(let i=0; i < syncdataPresets.length; i++){
									if(syncdataPresets[i].name == presetName){
										syncdataPresets[i].code = newPreset.code;
									}
								}
							}else{
								syncdataPresets.push(newPreset);
								settings.syncdata.sketches.push(newPreset);
							}
							updateSettings();
							presetChange = true;
							vex.close(this);
						}
					}
					,{
						type: 'close',
						text: 'Cancel',
						click: function(){
							vex.close(this);
						}
					}],
					afterOpen: function(){
						vexSmall(this.rootEl);
						setTimeout(function(){document.getElementById('presetname-input').focus();}, 100);
					},
					afterClose: function(){
						syncdataWindow();
					}
				})
			}

		function syncdataPresetChange(presetVal, localEditor){
			if(presetVal != 'select'){
				for(let sdp of syncdataPresets){
					if(sdp.name == presetVal){
						if(!sdp.protected){
							document.getElementById('preset-button-remove').style.display = 'inline';
							document.getElementById('preset-button-group').style.display = 'inline';
						}else{
							document.getElementById('preset-button-remove').style.display = 'none';
						}
						syncdataConsoleClear()
						settings.syncdata.cursor = {row:0, column:0};
						settings.syncdata.cocodeadded = false;
						updateSettings();
						syncdataEditor.setValue(sdp.code, -1);
						document.getElementById('preset-button-remove').setAttribute('name', presetVal);
						setTimeout(function(){
							syncdataEditor.gotoLine(settings.syncdata.cursor.row, settings.syncdata.cursor.column);
						}, 100);

					}
				}
			}
		}

		function syncdataConsoleClear(){
			settings.syncdata.console = [];
			updateSettings();
			if(document.getElementById('syncdata-console')){
				document.getElementById('syncdata-console').innerHTML = '';
			}
		}

		function syncdataButtonToggle(){
			let syncdataBtn = document.getElementById('syncdata-button');
			if(settings.syncdata.active){
				syncdataBtn.style.backgroundColor = '#aaaa00';
			}else{
				syncdataBtn.style.backgroundColor = '#666';
			}
		}

		function syncdataParse(){
			if(settings.cocoding.active && settings.syncdata.active){
				syncdataButtonToggle();
				if(!settings.syncdata.active){
					return false;
				}

				// parse scripts to p5Frame
				settings.syncdata.libs = processLibs(removeComments(settings.syncdata.code));
				updateSettings();

				let scriptsCol = [];
				for(let ccll of settings.syncdata.libs){
					scriptsCol.push(ccll);
				}

				scriptsCol.push('includes/js/p5live.cocoding.js');

				let syncdataID = 'syncdata-code';
				// let scriptsColJoin = "'" + scriptsCol.join("','") + "'";
				// scriptsColJoin += ",'includes/js/p5live.cocoding.js'";
				let s = document.createElement('script');
				s.type = 'text/javascript';

				let syncdataCode = settings.syncdata.code;
				if(syncdataCode.indexOf('/* 2 - COCODE */') > -1){
					syncdataCode = syncdataCode.substr(0, syncdataCode.indexOf('/* 2 - COCODE */'));
				}

				let sLoader = 'loadjs(' + JSON.stringify(scriptsCol) + ', {success: function() {pingReady("'+syncdataID+'", ' + JSON.stringify(syncdataCode) + '); },async: false});';

				s.innerHTML = sLoader;

				if(sketchLoaded){
					if(scriptsCol.length > 1){
						p5f.document.head.appendChild(s);
					}else{
						pongReady(syncdataID, syncdataCode);
					}
				}

				document.getElementById('syncdata-button').style.backgroundColor = '#008800';
			}
		}

		function syncdataCocode(){
			let cocodeBreak = '/* 2 - COCODE */';
			if(settings.syncdata.code.indexOf(cocodeBreak) == -1){
				let thisVex = vex.dialog.alert({
					unsafeMessage:'No COCODING snippet found. <br>Check it\'s preceded by:<br><pre>'+cocodeBreak+'</pre>',
				afterOpen: function(){
					vexSmall(this.rootEl);
				}
				})
				return false;
			}

			var cocodeClipboard = settings.syncdata.code.substr(settings.syncdata.code.indexOf(cocodeBreak) + cocodeBreak.length);
			var cocodeClipboard = cocodeClipboard.split('\n');
			for(let i = 0; i < cocodeClipboard.length; i++){
				var urlRegex =/^\/\//gm;
				cocodeClipboard[i] = cocodeClipboard[i].replace(urlRegex, '');
			}
			cocodeClipboard = cocodeClipboard.join('\n');
			let curCode = editor.getValue();
			editor.setValue(curCode +"\n"+ cocodeClipboard, 1);
			tidyCode(editor);
			editor.gotoLine(0, 1, false);
		}

		function syncdataSend(obj){
			if(settings.cocoding.lockdown){
				if(settings.cocoding.level != 'admin' && !settings.cocoding.writemode){
					return false;
				}
			}
			syncUp();
			obj.usesyncdata = settings.syncdata.active;
			cocode.socket.emit('syncData', obj);
		}

		// GUI replaced by SyncData...
		// function copyLink(elm){
		// 	let dummy = document.createElement('input'),
		// 	text = window.location.href;

		// 	document.body.appendChild(dummy);
		// 	dummy.value = text;
		// 	dummy.select();
		// 	document.execCommand('copy');
		// 	document.body.removeChild(dummy);

		// 	// share info
		// 	let oldContent = elm._tippy.props.content;
		// 	elm._tippy.setContent('Copied!');
		// 	elm._tippy.show(200);
		// 	setTimeout(function(){
		// 		elm._tippy.hide();
		// 		elm._tippy.setContent(oldContent);
		// 	}, 800);
		// }

		function toggleLockdown(){
			settings.cocoding.lockdown = !settings.cocoding.lockdown;
			updateSettings();
			cocode.lockdown(settings.cocoding.lockdown);
		}

		function updateToggleLockdown(){
			let settingsLockdown = document.getElementById('cocode-lockdown');
			let syncdataBtn = document.getElementById('syncdata-button');
			if(settings.cocoding.lockdown){
				settingsLockdown.innerHTML = iconLock;
				if(settings.cocoding.level != 'admin'){
					syncdataBtn.setAttribute('disabled', 'disabled');
				}else if(settings.cocoding.writemode){
					syncdataBtn.removeAttribute('disabled');
				}
			}else{
				settingsLockdown.innerHTML = iconUnlock;
				syncdataBtn.removeAttribute('disabled');
			}
			toggleButtonActive(settingsLockdown, settings.cocoding.lockdown);

			if(settings.cocoding.level == 'admin'){
				let settingsSync = document.getElementById('cocode-sync');
				if(settings.cocoding.lockdown){
					settingsSync.removeAttribute('disabled');

				}else{
					settingsSync.setAttribute('disabled', 'disabled');
					settings.cocoding.sync = false;
					updateToggleSync();
				}
			}
			updateSettings();
		}

		function toggleSync(){
			settings.cocoding.sync = !settings.cocoding.sync;
			updateSettings();
			updateToggleSync();
			cocode.sync(settings.cocoding.sync);
		}

		function updateToggleSync(){
			let settingsSync = document.getElementById('cocode-sync');
			toggleButtonActive(settingsSync, settings.cocoding.sync);
		}

		function toggleButtonActive(elm, toggleMode){
			if(toggleMode){
				elm.classList.add('cocoding-active');
			}else{
				elm.classList.remove('cocoding-active');
			}
		}

	</script>
</body>
</html>
