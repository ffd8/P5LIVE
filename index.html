<!DOCTYPE html>
<html>
<head>
	<title>P5LIVE</title>
	<meta charset="utf-8">
	<meta name="description" content="P5LIVE - p5.js collaborate live-coding vj environment!">
	<meta name="author" content="teddavis.org">

	<link rel="icon" type="image/png" href="includes/icons/icon.png">
	<link rel="apple-touch-icon" href="includes/icons/apple-touch-icon.png">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-mobile-web-app-title" content="P5LIVE">
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1">

	<!-- Facebook -->
	<meta property="og:url" content="https://teddavis.org/p5live">
	<meta property="og:type" content="website">
	<meta property="og:title" content="P5LIVE">
	<meta property="og:description" content="p5.js collaborate live-coding vj environment!">
	<meta property="og:image" content="https://teddavis.org/p5live/includes/social/p5live.png">

	<!-- Twitter -->
	<meta name="twitter:card" content="summary">
	<meta name="twitter:site" content="P5LIVE">
	<meta name="twitter:creator" content="teddavis.org">
	<meta name="twitter:title" content="P5LIVE">
	<meta name="twitter:description" content="p5.js collaborate live-coding vj environment!">
	<meta name="twitter:image" content="https://teddavis.org/p5live/includes/social/p5live.png">

	<!-- Style -->
	<link rel="stylesheet" type="text/css" media="all" href="style.css?53">
</head>
<body>
	<iframe id="chalkboard"></iframe>
	<iframe id="sonicode" src="includes/templates/p5live_sonicode.html" style="display:none;"></iframe>
	<div id="p5-drop"> </div>
	<div id="loader">
		<div id="loader-msg">
			P5LIVE
			<div id="loader-sub">loading...</div>
		</div>
		<div class="lds-dual-ring"></div>
		<div id="loader-bg"> </div>
	</div>

	<div id="p5-editor">
		<pre id="p5-code" autofocus class="p5-ta"></pre>
	</div>
	<textarea id="p5-console"></textarea>

	<iframe id="p5-frame" sandbox="allow-same-origin allow-scripts allow-downloads allow-pointer-lock" srcdoc="" ></iframe>
	<div id="p5-frame-cover"></div>

	<div id="refholder">
		<div id="ref-bg"></div>
		<div id="ref"></div>
		<div id="ref-close" class="tippy" onclick="closeRef();" data-title="Close"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div>
	</div>

	<div id="notify"></div>

	<div id="menu" class="panel">
		<div class="menu-bg"></div>
		<div id="menu-switch" onclick="menuToggle();">X</div>
		<div id="panel-menu" class="menu-sections">

			<div class="menu-section menu-section-top" id="menu-section-p5live">
				<div class="menu-section-bg"></div>
				<div class="menu-header">P5LIVE<span id="menu-p5live-version" class="counters"></span><span id="menu-p5live-resize">1920x1080</span></div>
				<div class="menu-sketches-buttons" id="p5live-buttons">
					<button class="menu-button tippy" onclick="loadAbout();this.blur();" data-title="About">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-help-circle"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12" y2="17"></line></svg>
					</button>
					<button class="menu-button tippy" onclick="showSettings();this.blur();" data-title="Settings">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
					</button>
					<button class="menu-button tippy" onclick="showRef();this.blur();" data-title="p5.js Reference">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-book-open"><path class="st0" d="M2,3h6c2.2,0,4,1.8,4,4v14c0-1.7-1.3-3-3-3H2V3z"/><path class="st0" d="M22,3h-6c-2.2,0-4,1.8-4,4v14c0-1.7,1.3-3,3-3h7V3z"/><path class="st0" d="M12,23.5"/><path class="st0" d="M8.6,10.8H5"/><path class="st0" d="M8.6,14.6H5"/><path class="st0" d="M8.6,7.1H5"/><path class="st0" d="M18.8,10.8h-3.6"/><path class="st0" d="M18.8,14.6h-3.6"/><path class="st0" d="M18.8,7.1h-3.6"/></svg>
					</button>

					<button class="menu-button tippy" onclick="toggleChalkboard();this.blur();" data-title="Toggle Chalkboard">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
					</button>
					<button id="button-stream" class="menu-button" onmouseenter="showButtonsExtended('stream', 'flex');this.blur();" onmouseleave="hideButtonsExtended('stream');this.blur();">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-monitor"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
					</button>

					<button id="button-export" class="menu-button menu-button-extend" onmouseenter="showButtonsExtended('export', 'flex');this.blur();" onmouseleave="hideButtonsExtended('export');">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
					</button>
				</div>

				<div class="menu-sketches-buttons-extended" id="p5live-buttons-export" style="" onmouseenter="showButtonsExtended('export', 'flex');" onmouseleave="hideButtonsExtended('export');">
					<button class="menu-button tippy" onclick="savePNG();this.blur();" data-title="Export Snapshot<br>PNG [+ CODE]">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-camera"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
					</button>
					<button class="menu-button tippy" onclick="linkCode(this);this.blur();" data-title="Export Link">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
					</button>
					<button class="menu-button tippy" onclick="saveHTML();this.blur();" data-title="Export HTML">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
					</button>
				</div>

				<div class="menu-sketches-buttons-extended" id="p5live-buttons-stream" style="" onmouseenter="showButtonsExtended('stream', 'flex');" onmouseleave="hideButtonsExtended('stream');">
					<button class="menu-button tippy" onclick="popStream(true);this.blur();"  data-title="Visuals-only Popup">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-cast"><path d="M2 16.1A5 5 0 0 1 5.9 20M2 12.05A9 9 0 0 1 9.95 20M2 8V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6"></path><line x1="2" y1="20" x2="2" y2="20"></line></svg>
					</button>
					
					<button class="menu-button tippy" onclick="popCode();this.blur();"  data-title="Code-only Popup">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-align-left"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>
					</button>
				</div>
			</div>

			<div class="menu-section menu-section-top" id="menu-section-cocode">
				<div class="menu-section-bg"></div>
				<div class="menu-header" id="menu-cocode-header">COCODING<span id="menu-cocode-counter" class="counters"></span><span id="menu-cocode-sync" class="counters" style="display:none;"> – <span id="menu-cocode-sync-up" class="sync">⇡</span><span id="menu-cocode-sync-down" class="sync">⇣</span></span></div>
				<div class="menu-sketches-buttons" id="cocoding-buttons-active" style="display:none;">
					<button class="menu-button tippy cocoding-active" onclick="cocodingInit();" data-title="Stop COCODING">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-power"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></svg>
					</button>
					<button class="menu-button tippy" onclick="cloneSketchCOCODING();this.blur();" data-title="Clone Sketch">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
					</button>
					<button class="menu-button tippy" id="syncdata-button" onclick="syncdataWindow(this);this.blur();" data-title="SyncData">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-radio"><circle cx="12" cy="12" r="2"></circle><path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"></path></svg>
					</button>
					<button class="menu-button tippy admin-lock" id="cocode-lockdown" onclick="toggleLockdown()" data-title="Toggle Lockdown">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-unlock"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V5a4 5 1 0 1 6.9-1"></path></svg>
					</button>
					<button class="menu-button tippy admin-lock" id="cocode-sync" onclick="toggleSync()" data-title="Broadcast mouseX/Y + frameCount" disabled>
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-cast"><path d="M2 16.1A5 5 0 0 1 5.9 20M2 12.05A9 9 0 0 1 9.95 20M2 8V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6"></path><line x1="2" y1="20" x2="2" y2="20"></line></svg>
					</button>
				</div>
				<div class="menu-sketches-buttons" id="cocoding-buttons-inactive">
					<button class="menu-button tippy cocoding-inactive" id="menu-cocoding" onclick="cocodingInit();" data-title="Start COCODING!">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-share-2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
					</button>
				</div>
				<div id="menu-cocode-sketches-holder" class="menu-sketches-holder" style="display:none;" onmouseenter="showUsers();" onmouseleave="hideUsers();">
					<div id="menu-cocode-sketches" class="menu-sketches"></div>
				</div>
				<div id="menu-cocode-chat-holder" class="" style="display:none;" onmouseleave="chatBlur();">
					<div class="menu-cocode-chat-title"></div>
					<div id="menu-cocode-chat-dialog" class="menu-cocode-chat menu-sketches-holder" onclick="document.getElementById('chat-input').focus();">

					</div>
					<input id="chat-input" type="text" name="chat-input" placeholder="Chat..." onfocus="this.selectionStart = this.selectionEnd = this.value.length;">
				</div>
			</div>

			<div class="menu-section menu-section-top" id="menu-section-recode" style="">
				<div class="menu-section-bg"></div>
				<div class="menu-header" id="menu-recode-header">RECODING<span id="menu-recoding-steps" class="counters"></span></div>

				<div id="menu-section-recoding-inactive">
					<div class="menu-sketches-buttons">
						<button class="menu-button tippy" onclick="recodingStart();this.blur();" data-title="Record">
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-target"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4" fill="white"></circle></svg>
						</button>
					</div>
				</div>

				<div id="menu-section-recoding-active" style="display:none;">
					<div class="menu-sketches-buttons">
						<button id="recoding-record" class="menu-button tippy" onclick="recodingStart();this.blur();" data-title="Record">
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-target"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4" fill="white"></circle></svg>
						</button>
						<button id="recoding-play" class="menu-button tippy hide-cocoding" onclick="recodingPlay();this.blur();" data-title="Play">
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
						</button>
						<button id="button-recoding-settings" class="menu-button tippy hide-cocoding" style="" onclick="toggleButtonsExtended('recoding-settings', 'block');this.blur();" data-title="Playback Settings">
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sliders"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>
						</button>
						<button class="menu-button tippy" onclick="recodingExport(this);this.blur();" data-title="Export">
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
						</button>
						<button class="menu-button tippy" onclick="recodingReset();this.blur();" data-title="Reset">
							<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-slash"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>
						</button>
					</div>
					<div class="menu-sketches-buttons hide-cocoding"  style="margin-top:0px;border-bottom:0;">
						<div id="recoding-range-holder" class="menu-button" style="flex: 4;min-width: 80%;background:#555;box-sizing: border-box;"> <!-- border-left:1px solid #888; -->
							<input class="tippy" data-title="Scrub" id="recoding-range" type="range" disabled="disabled" min=0 max=1 value=0 name="" style="width: 96%;height:20px;" onmousedown="recodingStop()" onmouseup="recoding.scrubStop()" oninput="recodingScrub(this.value)">
						</div>
					</div>
					<div id="p5live-buttons-recoding-settings" class="menu-settings-recoding menu-contents" style="display:none;">
						<div class="tippy-left" style="cursor:help;" data-title="Loop playback" onclick="">
							<input id="recoding-settings-loop" type="checkbox" name="recoding-loop" onchange="recoding.loop = this.checked;"> Loop
						</div>
						<div class="tippy-left" style="cursor:help;" data-title="Max delay in playback">
							<input id="recoding-settings-gaps" type="checkbox" name="recoding-gap" onchange="recoding.gaps = this.checked;recodingSettings();"> Max Gap:  <input  id="recoding-settings-gapsmax" type="" name="" class="menu-settings-input-text" value="5" onkeyup="recoding.gapsMax = this.value;recodingSettings();"> sec
						</div>
						<div class="tippy-left" style="cursor:help;" data-title="Playback on keyPress" onclick="">
							<input id="recoding-settings-catmode" type="checkbox" name="recoding-catmode" onchange="recoding.toggleCat(this.checked)"> CatMode
						</div>
						<div class="tippy-left" style="cursor:help;" data-title="Adjust playback speed <br>(smaller = slower)">
							Speed:  <input id="recoding-settings-speed" type="" name="" class="menu-settings-input-text" value="1.0" onkeyup="recoding.setSpeed(this.value);">
						</div>
					</div>
				</div>
			</div>

			<div class="menu-section" id="menu-section-sketches" style="margin-bottom:0;">
				<div class="menu-section-bg"></div>
				<div id="menu-sketches-header" onclick="sketchesCounter();" class="menu-header">SKETCHES<span id="menu-sketches-counter" class="counters"></span></div>
				<div class="menu-sketches-buttons">
					<button class="menu-button tippy" onclick="loadDefault();" data-title="New Sketch">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-plus"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
					</button>
					<button class="menu-button tippy" onclick="cloneSketch();" data-title="Clone Sketch">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
					</button>
					<button class="menu-button tippy" onclick="addFolder();" data-title="New Folder">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder-plus"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>
					</button>
					<input id="file-input" type="file" name="name" multiple style="display: none;" onchange="importSketches(this.files);" onclick="this.value=null;" />
					<button class="menu-button tippy" onclick="importSketchesDialog();" data-title="Import Sketches">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-upload"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
					</button>
					<button class="menu-button tippy" onclick="exportSketches();" data-title="Export All Sketches">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
					</button>
				</div>

				<div id="menu-sketches-filter-clear" class="tippy-left" data-title="Filter Sketches<br>(separate words for <i>AND</i> search)" onclick="filterSketchesClear(true)"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div>
				<div id="menu-sketches-filter-fulltext" class="tippy-left" data-title="Filter Sketches<br>(Full text/code search)" onclick="filterToggleFullText()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-code"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg></div>
				<input type="text" class="tippy-lefty" data-title="Filter Sketches<br>(separate words for <i>AND</i> search)" name="" placeholder="Filter..." id="menu-sketches-filter" onkeyup="filterParse()">
				<div id="menu-sketches-holder" class="menu-sketches-holder">
					<div id="menu-sketches" class="menu-sketches"></div>
				</div>
			</div>



		</div>

		<div id="panel-settings" class="menu-sections">

			<div class="menu-section">
				<div class="menu-section-bg"></div>
				<div class="menu-header">P5LIVE</div>
				<div class="menu-sketches-buttons" id="p5live-buttons">
					<button class="menu-button tippy invisible" onclick="hideSettings();" data-title="About P5LIVE">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-help-circle"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12" y2="17"></line></svg>
					</button>
					<button class="menu-button tippy" onclick="hideSettings();" data-title="Hide Settings">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
					</button>
					<button class="menu-button tippy invisible"  onclick="hideSettings();" data-title="p5.js References">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-book-open"><path class="st0" d="M2,3h6c2.2,0,4,1.8,4,4v14c0-1.7-1.3-3-3-3H2V3z"/><path class="st0" d="M22,3h-6c-2.2,0-4,1.8-4,4v14c0-1.7,1.3-3,3-3h7V3z"/><path class="st0" d="M12,23.5"/><path class="st0" d="M8.6,10.8H5"/><path class="st0" d="M8.6,14.6H5"/><path class="st0" d="M8.6,7.1H5"/><path class="st0" d="M18.8,10.8h-3.6"/><path class="st0" d="M18.8,14.6h-3.6"/><path class="st0" d="M18.8,7.1h-3.6"/></svg>
					</button>

					<button class="menu-button tippy invisible" onclick="hideSettings();" data-title="Toggle Chalkboard">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
					</button>
					<button class="menu-button tippy invisible" onclick="hideSettings();" data-title="Visuals-only Popup">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-monitor"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>
					</button>

					<button id="button-export" class="menu-button menu-button-extend tippy invisible" onclick="hideSettings();" data-title="Export">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
					</button>



				</div>
			</div>

			<div class="menu-section">
				<div class="menu-section-bg"></div>
				<div class="menu-header">SETTINGS</div>
				<div class="menu-sketches-buttons">

					<button class="menu-button tippy" onclick="resetSettings();" data-title="Reset Settings">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
					</button>
					<input id="file-input-settings" type="file" name="name" style="display: none;" multiple onchange="importSettings(this.files);" onclick="this.value=null;" />
					<button class="menu-button tippy" onclick="importSettingsDialog();" data-title="Import Settings">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-upload"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
					</button>
					<button class="menu-button tippy" onclick="exportSettings();" data-title="Export Settings">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
					</button>
				</div>
				<div class="menu-settings menu-contents">
					<div class="menu-settings-content">
						<!-- <div class="tippy-left" data-title="Set Audio Inputs " style="display:none;">
							<div class="select">
								<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg><select id="audioSource" class="av-select"></select>
							</div>

							<div class="select" style="display:none;">
								<label for="audioOutput">Audio out: </label><select id="audioOutput" class="av-select"></select>
							</div>

							<div class="select" style="display:none;">
								<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-video"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg><select id="videoSource" class="av-select"></select>
							</div>
						</div> -->
					<div class="tippy-left" style="cursor:help;" data-title="Auto-compile code on keyup">
						<input type="checkbox" id="settings-autocompile" name="settings-autocompile" value="settings-autocompile" onclick="autoCompileToggle();">
						<span onclick="autoCompileToggle();">Live Coding </span>
							<select id="settings-compiletimer" class="tippy menu-settings-dropdown" style="" data-title="Delay for compile after keyUp" onchange="compileTimerChange();">
									<option value="250">250ms</option>
									<option value="500">500ms</option>
									<option value="1000">1000ms</option>
									<option value="2000">2000ms</option>
							</select>
					</div>
					<div class="tippy-left" style="cursor:help;" data-title="Display console messages">
						<input type="checkbox" id="settings-console" name="settings-console" value="settings-console"  onclick="consoleToggle();">
						<span onclick="consoleToggle();">Console </span>
						<select id="settings-console-mode" class="tippy menu-settings-dropdown" style="" data-title="AUTO hide or SHOW static" onchange="consoleMode()">
								<option value="auto">AUTO</option>
								<option value="show">SHOW</option>
						</select>
					</div>
					<div class="tippy-left" style="cursor:help;" data-title="noLoop() if window loses focus<br>(save computer resources)" onclick="ecoRenderToggle();">
						<input type="checkbox" id="settings-ecorender" name="settings-ecorender" value="settings-ecorender">
						Eco Render
					</div>
					<div class="tippy-left" style="cursor:help;" data-title="Display Menu-Tab <br>If unchecked, must use shortcut" onclick="menutabToggle();">
						<input type="checkbox" id="settings-menutab" name="settings-menutab" value="settings-menutab">
						Menu Tab
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Include sketch code with Snapshot" onclick="exportcodeToggle();">
						<input type="checkbox" id="settings-exportcode" name="settings-exportcode" value="settings-exportcode"> Snapshot Code
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Display code line numbers" onclick="linenumbersToggle();">
						<input type="checkbox" id="settings-linenumbers" name="settings-linenumbers" value="settings-linenumbers"> Line Numbers
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Pulse on recompiles" onclick="pulseToggle();">
						<input type="checkbox" id="settings-recompilepulse" name="settings-recompilepulse" value="settings-recompilepulse"> Recompile Pulse
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Automatic Autocomplete<br>If disabled (suggested), trigger with <div class='shortcut'>ALT + SPACE</div>" onclick="autocompleteToggle();">
						<input type="checkbox" id="settings-autocomplete" name="settings-autocomplete" value="settings-autocomplete"> Auto Autocomplete
					</div>

					<div class="tippy-left" style="cursor:help; display:none;" data-title="Editor locked onmousedragged, <br>prevents errors in displaced code" onclick="lockDragToggle();">
						<input type="checkbox" id="settings-lockdrag" name="settings-lockdrag" value="settings-lockdrag"> Lock Code on Drag
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Pass any keypress from editor to p5 canvas" onclick="passEditorKeysToggle();">
						<input type="checkbox" id="settings-passeditorkeys" name="settings-passeditorkeys" value="settings-passeditorkeys"> Pass-Thru KeyPress
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Display Notifications" onclick="notifyToggle();">
						<input type="checkbox" id="settings-notifytoggle" name="settings-notifytoggle" value="settings-notifytoggle"> Notifications
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Display Tooltips" onclick="tippyToggle();">
						<input type="checkbox" id="settings-tippytoggle" name="settings-tippytoggle" value="settings-tippytoggle"> Tooltips
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Warn if P5LIVE opened multiple times<br>(leads to sketches out of sync)" onclick="multitabToggle();">
						<input type="checkbox" id="settings-mutitabtoggle" name="settings-mutitabtoggle" value="settings-mutitabtoggle"> Multi-P5LIVE Warning
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Add _YYYYMMDD_HHMMSS to filenames?" onclick="timestampToggle();">
						<input type="checkbox" id="settings-timestamptoggle" name="settings-timestamptoggle" value="settings-timestamptoggle"> Timestamp Exports
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Always show cursor flags or<br>only with mouseover userlist" onclick="cocodingFlagsToggle();">
						<input type="checkbox" id="settings-cocodingflagstoggle" name="settings-cocodingflagstoggle" value="settings-cocodingflagstoggle"> COCODING Flags
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Autosaves session code <br>if server connection lost" onclick="cocodingAutosaveToggle();">
						<input type="checkbox" id="settings-cocodingautosavetoggle" name="settings-cocodingautosavetoggle" value="settings-cocodingautosavetoggle"> COCODING Autosave
					</div>

					<div id="settings-checkupdatestoggle-holder" class="tippy-left" style="cursor:help;" data-title="Ping Github for updates to OFFLINE mode" onclick="checkupdatesToggle();">
						<input type="checkbox" id="settings-checkupdatestoggle" name="settings-checkupdatestoggle" value="settings-checkupdatestoggle"> Check for Updates
					</div>

					<div class="tippy-left" style="display:none;cursor:help;" data-title="Add extra libs to your sketches, will be added on each compile">
						<span>Libs:</span>
						<input type="text" id="settings-libs" name="settings-libs" placeholder="CSV, of, libs">
					</div>
					<div class="tippy-left" style="cursor:help;" data-title="Backup sketches to P5LIVE/_backups folder">
						Backup:
						<select id="menu-settings-backup" class="menu-settings-dropdown" onchange="setBackup(this.selectedIndex);">
							<option value="0">Disabled</option>
							<option value="1">On Exit</option>
							<option value="2">Daily</option>
							<option value="3">Weekly</option>
							<option value="4">Monthly</option>
						</select>
						<button class="menu-settings-dropdown backup-now" onclick="backupSketches();">Now</button>
					</div>

					<hr>

					<h2>EDITOR</h2>
					<div class="tippy-left" style="cursor:help;" data-title="Editor font-size">
						Size:  <input type="" name="menu-settings-fontsize" id="menu-settings-fontsize" class="menu-settings-input-text" value="15" onkeyup="fontSizeSet(this.value);"> pt
					</div>

					
					<!-- <div class="tippy-left" style="cursor:help;" data-title="Override theme's un-styled text">
						Text: <input type="checkbox" id="settings-usebg" name="settings-usebg" value="settings-usebg" onchange="themeTXTactiveToggle();">
						<div id="pickr-txt" class="pickr-txt"></div>
					</div>
					<div class="tippy-left" style="cursor:help;" data-title="Override theme's active line">
						Active-Line: <input type="checkbox" id="settings-usebg" name="settings-usebg" value="settings-usebg" onchange="themeALactiveToggle();">
						<div id="pickr-al" class="pickr-al"></div>
					</div> -->
					<!-- .ace_active-line -->

					
					<div class="tippy-left" style="cursor:help;" data-title="Set editor theme">
						Theme:
						<select id="menu-settings-theme"  class="menu-settings-dropdown" onchange="setTheme(this.selectedIndex);">
							<optgroup label="Dark">
								<option value="ace/theme/ambiance">Ambiance</option>
								<option value="ace/theme/chaos">Chaos</option>
								<option value="ace/theme/clouds_midnight">Clouds Midnight</option>
								<option value="ace/theme/dracula">Dracula</option>
								<option value="ace/theme/cobalt">Cobalt</option>
								<option value="ace/theme/gruvbox">Gruvbox</option>
								<option value="ace/theme/gob">Green on Black</option>
								<option value="ace/theme/idle_fingers">idle Fingers</option>
								<option value="ace/theme/kr_theme">krTheme</option>
								<option value="ace/theme/merbivore">Merbivore</option>
								<option value="ace/theme/merbivore_soft">Merbivore Soft</option>
								<option value="ace/theme/mono_industrial">Mono Industrial</option>
								<option value="ace/theme/monokai">Monokai</option>
								<option value="ace/theme/nord_dark">Nord Dark</option>
								<option value="ace/theme/one_dark">One Dark</option>
								<option value="ace/theme/pastel_on_dark">Pastel on dark</option>
								<option value="ace/theme/solarized_dark">Solarized Dark</option>
								<option value="ace/theme/terminal">Terminal</option>
								<option value="ace/theme/tomorrow_night">Tomorrow Night</option>
								<option value="ace/theme/tomorrow_night_blue">Tomorrow Night Blue</option>
								<option value="ace/theme/tomorrow_night_bright">Tomorrow Night Bright</option>
								<option value="ace/theme/tomorrow_night_eighties">Tomorrow Night 80s</option>
								<option value="ace/theme/twilight">Twilight</option>
								<option value="ace/theme/vibrant_ink">Vibrant Ink</option>
							</optgroup>
							<optgroup label="Bright">
								<option value="ace/theme/chrome">Chrome</option>
								<option value="ace/theme/clouds">Clouds</option>
								<option value="ace/theme/crimson_editor">Crimson Editor</option>
								<option value="ace/theme/dawn">Dawn</option>
								<option value="ace/theme/dreamweaver">Dreamweaver</option>
								<option value="ace/theme/eclipse">Eclipse</option>
								<option value="ace/theme/github">GitHub</option>
								<option value="ace/theme/iplastic">IPlastic</option>
								<option value="ace/theme/solarized_light">Solarized Light</option>
								<option value="ace/theme/textmate">TextMate</option>
								<option value="ace/theme/tomorrow">Tomorrow</option>
								<option value="ace/theme/xcode">XCode</option>
								<option value="ace/theme/kuroir">Kuroir</option>
								<option value="ace/theme/katzenmilch">KatzenMilch</option>
								<option value="ace/theme/sqlserver">SQL Server</option>
							</optgroup>

							<!-- <optgroup label = "DARK">
							<option value="ace/theme/gob">Green on Black</option>
							<option value="ace/theme/ambiance">Ambiance</option>
							<option value="ace/theme/cobalt">Cobalt</option>
							<option value="ace/theme/pastel_on_dark">Pastel on dark</option>
							<option value="ace/theme/twilight">Twilight</option>
							</optgroup>
							<optgroup label = "LIGHT">
							</optgroup> -->
						</select>
					</div>

					<div class="settings-pickr tippy-left" style="cursor:help;" data-title="Color behind code lines">
						<div class="pickr-toggle" onclick="themeBGactiveToggle();">
							<input type="checkbox" id="settings-usebg" name="settings-usebg" value="settings-usebg"> Background 
						</div>
						<div id="pickr-background" class="pickr"></div>
					</div>

					<div class="settings-pickr tippy-left" style="cursor:help;" data-title="Override theme's un-styled text">
						<div class="pickr-toggle" onclick="themeCOLORactiveToggle();">
							<input type="checkbox" id="settings-usecolor" name="settings-usecolor" value="settings-usecolor"> Text 
						</div>
						<div id="pickr-color" class="pickr"></div>
					</div>

					<div class="settings-pickr tippy-left" style="cursor:help;" data-title="Override theme's active line">
						<div class="pickr-toggle" onclick="themeACTIVEactiveToggle();">
							<input type="checkbox" id="settings-useactive" name="settings-useactive" value="settings-useactive"> Active-Line 
						</div>
						<div id="pickr-active" class="pickr"></div>
					</div>

					<div class="tippy-left" style="cursor:help;" data-title="Set keybindings <br>(adjust shortcuts as needed)">
						Keybinding:
						<select id="menu-settings-keybindings" class="menu-settings-dropdown" onchange="setKeybinding(this.value);">
							<option value="keybinding">Ace</option>
							<option value="sublime">Sublime</option>
							<option value="vscode">VS Code</option>
							<option value="vim">Vim</option>
							<option value="emacs">Emacs</option>
						</select>
					</div>
					<div class="tippy-left" style="cursor:help;display:flex;" data-title="Modify snippets">
						<div>Snippets: </div> 
						<div>
							<button onclick="snippetsToggle()" style="cursor:pointer;background:none;color:#fff;border:1px solid #888;outline:none;font-size:8pt;">Launch Editor</button>
							<div id="settings-snippetsghostmode-holder" style="margin-left:-28px;" >
								<span onclick="snippetsghostmodeToggle();" class="tippy-left" data-title="Animated typing of snippet" style="cursor:help;"><input type="checkbox" id="settings-snippetsghostmode-toggle" name="settings-snippetsghostmode-toggle" value="settings-snippetsghostmodetoggle"> GhostMode</span>
								<span class="tippy-left" data-title="Animated typing delay" style="cursor:help;"><input type="" name="settings-snippetsghostmode-delay" id="settings-snippetsghostmode-delay" class="menu-settings-input-text" style="width:32px;" value="5" onkeyup="snippetsghostmodeDelay(this.value);"></span>
							</div>
						</div>
						
					</div>	
					
					<div>
						<span class="tippy-left" data-title="Sonify editor changes" style="cursor:help;" onclick="sonicodeToggle();"><input type="checkbox" id="settings-sonicode" name="settings-sonicode" value="settings-sonicode"> SoniCode</span> <span class="tippy-left" data-title="Oscillator Wavetype or Midi output" style="cursor:help;">
								<select id="settings-sonicode-mode" class="menu-settings-dropdown" onchange="sonicodeMode(this.value);">
									<option value="sine">Sine</option>
									<option value="triangle">Triangle</option>
									<option value="square">Square</option>
									<option value="sawtooth">Sawtooth</option>
									<option value="midi">Midi</option>
								</select>
							</span>
						<div id="settings-sonicode-details">
							
							<span class="tippy-left" data-title="Polycount (voices)" style="cursor:help;">
								Poly: <select id="settings-sonicode-poly" class="menu-settings-dropdown" onchange="sonicodePoly(this.value);">
									<option value="1">1</option>
									<option value="2">2</option>
									<option value="3">3</option>
									<option value="4">4</option>
									<option value="5">5</option>
									<option value="6">6</option>
									<option value="7">7</option>
									<option value="8">8</option>
								</select>
							</span>
							<span class="tippy-left" data-title="Base floor (in Hz)<br>for char to freq" style="cursor:help;">
								Transpose: <select id="settings-sonicode-base" class="menu-settings-dropdown" onchange="sonicodeBase(this.value);">
									<option value="0">0</option>
									<option value="27.50">1</option>
									<option value="55">2</option>
									<option value="110">3</option>
									<option value="220">4</option>
									<option value="440">5</option>
									<option value="880">6</option>
									<option value="1760">7</option>
									<option value="3520.00">8</option>
									<option value="7040.00">9</option>
								</select>
							</span>
						</div>
					</div>	

				<hr>

				<h2>SHORTCUTS 
					<span class="settings-shortcuts-reset tippy"onclick="updateShortcuts(true);" data-title="Reset Shortcuts">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
					</span>
				</h2>
					<div id="menu-shortcuts-holder">

					</div>
				</div>
				<h2>RESET</h2>
				<div class="menu-sketches-buttons" style="border-top:1px solid #888;">
					<button class="menu-button tippy" onclick="resetP5();" data-title="Reset P5LIVE">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-slash"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>
					</button>
				</div>
			</div>



		</div>


	</div>

	<div id="snippets-panel-apply">
		<div class="snippets-bg"></div>
		<div id="snippets-content">
			<div class="menu-section">
				<div class="menu-section-bg"></div>
				<div class="menu-header">
					SNIPPETS 
					<div class="snippets-close tippy" data-title="Close Panel" onclick="snippetsApplyToggle()">
						X
					</div>
				</div>
				<div class="menu-sketches-buttons snippets-buttons">
					<select id="snippets-select-apply" class="snippets-select menu-button tippy" onchange="snippetsApplySelect(this.value)" data-title="Select Snippet"></select>

					<button class="menu-button snippets-btn-all tippy" onclick="snippetsApply()" data-title="Apply Snippet"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check-square"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg></button>

					<button class="menu-button snippets-btn-all tippy" onclick="snippetsToggle()" data-title="Edit Snippet"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></button>

					
				</div>
			</div>
		</div>
	</div>

	<div id="snippets-panel">
		
		
		<div class="snippets-bg"></div>
		<div id="snippets-content">
			<div id="snippets-manager-holder" style="width:100%;height:100%;position:absolute;left:-100%;top:0;display:none;">
			<iframe id="snippets-manager" src="" onload="snippetsManagerLoaded = true;" style="position:relative;left:15px;width:calc(100% - 15px);height:100%;border:none;"></iframe>
			<!-- http://localhost:8888/p5live_snippets/ -->
			<!-- https://ffd8.github.io/p5live-snippets/ -->
			<script type="text/javascript">
				window.addEventListener('message', e => {
					const data = e.message || e.data
					if(e.origin == "https://ffd8.github.io" || e.origin == "http://localhost:8888"){
						if(data.msg == 'add'){
							snippetsImportParse(data.snippet)							
						}else if(data.msg == 'apply'){
							snippetsApply(data.snippet.code, false)
						}else if(data.msg == 'toggle'){
							snippetsManagerToggle()
							editor.focus()
						}else if(data.msg == 'blur'){
							document.getElementById('snippets-manager').blur()
							// editor.focus()
						}
					}    
				},false);

			</script>
		</div>


			<div class="menu-section">
				<div class="menu-section-bg"></div>
				<div class="menu-header">
					SNIPPETS EDITOR
					<div class="snippets-close tippy" data-title="Close Panel" onclick="snippetsToggle()">
						X
					</div>
				</div>
				<div class="menu-sketches-buttons">
					<select id="snippets-select" class="snippets-select menu-button tippy" onchange="snippetsForm(this.value)" data-title="Select Snippet"></select>
					
					<button class="menu-button snippets-btn-all tippy" onclick="snippetsApply()" data-title="Apply Snippet"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check-square"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg></button>

					<button id="snippets-btn-clone" class="menu-button snippets-btn-all tippy" onclick="snippetsUpdate('clone')" data-title="Clone Snippet"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button>
					
					<button class="menu-button snippets-btn-all tippy" onclick="snippetsImportDialog()" data-title="Import Snippet"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-upload"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg></button>
					<input id="file-input-snippet" type="file" name="name" style="display: none;" multiple onchange="snippetsImport(this.files);" onclick="this.value=null;" />

					<button class="menu-button snippets-btn-all tippy" onclick="snippetsManagerToggle()" data-title="Snippets Manager"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-database"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg></button>

					<button id="snippets-btn-save" class="menu-button snippets-btn-demo tippy" onclick="snippetsSave()" data-title="Save Changes"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg></button>
					
					<button class="menu-button snippets-btn-demo tippy" onclick="snippetsUpdate('rename')" data-title="Rename Snippet"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class=" feather feather-edit-3"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg></button>
					
					<button class="menu-button snippets-btn-demo tippy" onclick="snippetsExport()" data-title="Export Snippet"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></button>

					<button class="menu-button snippets-btn-demo tippy" onclick="snippetsDelete()" data-title="Delete Snippet"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
				</div>
			</div>

			<!-- <div id="snippets-nav">
				
			</div> -->
			
			<div class="snippets-section">
				<div class="snippets-label">
					<span>// global top </span>
					<svg class="tippy" data-title="Tidy Code" onclick="tidyCode(snip.editors['gt'])" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather feather-align-left"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>
				</div>
				<pre id="snippets-code-gt"></pre>
			</div>
			<div class="snippets-section">
				<div class="snippets-label">
					<span>// setup bottom</span>
					<svg class="tippy" data-title="Tidy Code" onclick="tidyCode(snip.editors['s'])" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather feather-align-left"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>
				</div>
				<pre id="snippets-code-s"></pre>
			</div>
			<div class="snippets-section">
				<div class="snippets-label">
					<span>// draw top</span>
					<svg class="tippy" data-title="Tidy Code" onclick="tidyCode(snip.editors['dt'])" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather feather-align-left"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>
				</div>
				<pre id="snippets-code-dt"></pre>
			</div>
			<div class="snippets-section">
				<div class="snippets-label">
					<span>// draw bottom</span>
					<svg class="tippy" data-title="Tidy Code" onclick="tidyCode(snip.editors['db'])" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather feather-align-left"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>
				</div>
				<pre id="snippets-code-db"></pre><br>
			</div>
			<div class="snippets-section">
				<div class="snippets-label">
					<span>// global bottom</span>
					<svg class="tippy" data-title="Tidy Code" onclick="tidyCode(snip.editors['gb'])" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather feather-align-left"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>
				</div>
				<pre id="snippets-code-gb"></pre>
			</div>
		</div>
	</div>

<textarea style="display:none;" id="p5-template">
function setup() {
	createCanvas(windowWidth, windowHeight);

}

function draw() {

}</textarea>
<textarea style="display:none;" id="p5-custom">
/* CUSTOM FUNCTIONS FOR P5LIVE */
// keep fullscreen if window resized
function windowResized() {
	resizeCanvas(windowWidth, windowHeight);
}

// custom ease function
function ease(iVal, oVal, eVal){
	return oVal += (iVal - oVal) * eVal;
}

// processing compatibility
function println(msg){
	print(msg);
}
</textarea>

	<!-- Script Styles -->
	<link rel="stylesheet" href="includes/js/pickr/nano.min.css"/>
	<link rel="stylesheet" href="includes/js/vex/css/vex.css" />
	<link rel="stylesheet" href="includes/js/vex/css/vex-theme-plain.css" />
	<link rel="stylesheet" href="includes/js/highlight/a11y-dark.css" />

	<!-- Scripts -->
	<script src="includes/js/ace/src-min-noconflict/ace.js?8" type="text/javascript" charset="utf-8"></script>
	<script src="includes/js/ace/src-min-noconflict/ext-language_tools.js?8" type="text/javascript" charset="utf-8"></script>
	<script src="includes/utils/ace.recoding.js?50"></script>
	<script src="includes/utils/ace.ghost.js?50"></script>
	<script src="includes/utils/ace-snippets.js?50"></script>
	<script src="includes/js/Sortable.js"></script>
	<script src="includes/js/beautify.min.js"></script>
	<script src="includes/js/pickr/pickr.min.js"></script>
	<script src="includes/js/popper.min.js"></script>
	<script src="includes/js/tippy.all.js"></script>
	<script src="includes/js/marked.min.js"></script>
	<script src='includes/js/download.js'></script>
	<script src="includes/js/vex/js/vex.combined.min.js"></script>
	<script src="includes/js/dropzone.js"></script>
	<script src="includes/js/mousetrap/mousetrap.min.js"></script>
	<script src="includes/js/mousetrap/mousetrap-record.js"></script>
	<script src="includes/js/mousetrap/mousetrap-pause.min.js"></script>
	<script src="includes/js/highlight/highlight.pack.js"></script>
	<script src="includes/js/name_generator.js"></script>
	<script src="includes/js/loopBreaker.min.js"></script>
	<script src="includes/js/socket.io.js"></script>
	<script src="includes/js/rga.js"></script>

	<script type="text/javascript">
		'use strict'

		/* INIT */
		let currentVersion = '1.7.0';
		let currentRevision = 54;
		let developBranch = false;
		let p5Version = 1 // set to 2 for testing 2.0

		// resetP5(); // manual reset

		function resetP5(){
			if(settings.cocoding.active){
				settingsCocodingWarning();
				return false;
			}

			vex.dialog.confirm({
				unsafeMessage: 'Completely reset P5LIVE?<br><i>All sketches will be removed.</i>',
				callback: function (value) {
					if (value) {
						localStorage.clear();
						// localStorage.settings = initSettings;
						// updateSettings();
						location.reload();
					}
				},
				afterOpen: function(){
					vexClass(this.rootEl, 'vex-small')
				}
			})
		}

		// settings
		let initSettings = {
			'version':currentVersion,
			'revision':currentRevision,
			'welcome':true,
			'autoCompile':true,
			'compileTimer':500,
			'ecoRender': true,
			'canvasCursor': true,
			'console': true,
			'consoleMode': 'auto',
			'fullscreenMode':false,
			'fileName': '',
			'menuMode': true,
			'menutab':true,
			'exportCode':true,
			'notifyToggle':true,
			'tippyToggle':true,
			'multitabToggle':true,
			'timestampToggle':true,
			'cocodingAutosaveToggle':true,
			'cocodingFlagsToggle':false,
			'checkupdates':true,
			'debugMode': false,
			'editMode':true,
			'safeMode': false,
			'shortcuts':{
				'softcompile':{
					'name':'SoftCompile'
					,'key':'ctrl+enter'
					,'callback':'recompile()'
				}
				,'hardcompile':{
					'name':'HardCompile'
					,'key':'ctrl+shift+enter'
					,'callback':'recompile(true)'
				}
				,'editor':{
					'name':'Editor'
					,'key':'ctrl+e'
					,'callback':'editorToggle()'
				}
				,'menu':{
					'name':'Menu'
					,'key':'ctrl+m'
					,'callback':'menuToggle()'
				}
				,'settings':{
					'name':'Settings'
					,'key':'ctrl+,'
					,'callback':'showSettings(true)'
				},'snippets':{
					'name':'Snippets'
					,'key':'ctrl+shift+s'
					,'callback':'snippetsApplyToggle()'
				},'snippets_edit':{
					'name':'Snippets Editor'
					,'key':'alt+shift+s'
					,'callback':'snippetsToggle()'
				}
				,'references':{
					'name':'References'
					,'key':'ctrl+r'
					,'callback':'toggleRef()'
				}
				,'chalkboard':{
					'name':'Chalkboard'
					,'key':'ctrl+b'
					,'callback':'toggleChalkboard()'
				}
				,'autocompile':{
					'name':'Live-Coding Toggle'
					,'key':'ctrl+a'
					,'callback':'autoCompileToggle()'
				}
				,'newsketch':{
					'name':'New Sketch'
					,'key':'ctrl+n'
					,'callback':'loadDefault()'
				},'clonesketch':{
					'name':'Clone Sketch'
					,'key':'ctrl+shift+c'
					,'callback':'cloneSketch()'
				}
				,'tidy':{
					'name':'Tidy Code'
					,'key':'ctrl+t'
					,'callback':'tidyCode(editor)'
				}
				,'codecomment':{
					'name':'Comment Code'
					,'key':'meta+/'
					,'init': 'editor.commands.bindKey(settings.shortcuts["codecomment"].key, "togglecomment")'
				}
				,'fontbigger':{
					'name':'Increase Fontsize'
					,'key':'ctrl+='
					,'callback':'fontSizeAdjust(0.25)'
				}
				,'fontsmaller':{
					'name':'Decrease Fontsize'
					,'key':'ctrl+-'
					,'callback':'fontSizeAdjust(- 0.25)'
				}
				,'pause':{
					'name':'Pause'
					,'key':'ctrl+p'
					,'callback':'pauseSketch()'
				}
				,'snapshot':{
					'name':'Export Snapshot'
					,'key':'ctrl+s'
					,'callback':'savePNG()'
				}
				,'import':{
					'name':'Import Sketch'
					,'key':'ctrl+o'
					,'callback':'importSketchesDialog()'
				}
				,'jump':{
					'name':'Quick Sketch Jump'
					,'key':'ctrl' // modifier for 1-0
					,'init':'setupJumpSketches(settings.shortcuts["jump"].key)'
					,'tippy':'Then combine w/ 1, 2,...0 to jump thru sketches'
				}
				,'audio':{
					'name':'Audio Snippet'
					,'key':'ctrl+shift+a'
					,'callback':`snippetsApplySelect('demo-audio');snippetsApply()`
					,'fixed':false
				},'osc':{
					'name':'OSC Snippet'
					,'key':'ctrl+shift+o'
					,'callback':`snippetsApplySelect('demo-osc');snippetsApply()`
					,'fixed':false
				}
			},
			'editor':{
				'fontSize':15, 'keybinding':'keybinding', 'linenumbers':true, 'autocomplete': false, 'lockcode':true, 'passEditorKeys':false, 'recompilepulse':true,
			},
			'snippets': {
				'demo':{
					
				},
				'user':{

				}
				
				
			},
			'sketches': [],
			'snippetsghostmode': {
				'active': false,
				'delay': 15
			},
			'sonicode':{
				'mode': 'sine',
				'poly': 1,
				'active': false,
				'sonicodePoly': 0,
				'base': 3
			},
			'statscount': 0,
			'syncdata': {
				'sketches': [],
				'code': '',
				'active': false,
				'libs' : [],
				'cursor': {row:0, column:0},
				'console': [],
				'namespace': '',
				'cocodeadded':false
			},
			'cocoding': {'active':false, 'timestamp':null, 'nick':'', 'namespace':'', 'lockdown':false, 'level':'', 'token':0, 'sync':false, 'request':false, 'writemode':false, 'color':'#00aa00', 'cursor':{'row':0, 'column':0}, 'msgID':-1, 'hasAdmin':false, 'error':false, 'code':''},
			'scripts': ['includes/p5/p5.min.js', 'includes/p5/addons/p5.sound.min.js'],
			'theme': 'ace/theme/gob',
			'themeBG': '#00323FE0',
			'themeBGactive': true,
			'themeCOLORactive': true,
			'themeCOLOR': '#B2F7DB',
			'themeACTIVEactive': true,
			'themeACTIVE': '#11EED830',
			'refresh':true,
			'chalkboard': {
				'backgroundColor':'#00280A', 'backgroundOpacity':.75, 'strokeColor':'#ffffff', 'strokeWeight':10, 'strokeOpacity':1.0,
			},
			'backup' : {
				'frequency':2, 'last':0,
			}
		}

		// init variabless
		var p5editor = document.getElementById('p5-editor'),
		p5code = document.getElementById('p5-code'),
		p5console = document.getElementById('p5-console'),
		p5custom = document.getElementById('p5-custom'),
		p5template = document.getElementById('p5-template').value,
		p5frame = document.getElementById('p5-frame'),
		p5frameCover = document.getElementById('p5-frame-cover'),
		p5f = p5frame.contentWindow;

		let p5script = document.getElementById('holdscript'),
		menuResize = document.getElementById('menu-p5live-resize'),
		menuCocode = document.getElementById('menu-section-cocode'),
		menuSectionP5live = document.getElementById('menu-section-p5live'),
		menuSectionSketches = document.getElementById('menu-section-sketches'),
		menuCocodeCounter = document.getElementById('menu-cocode-counter'),
		menuCocodeSync = document.getElementById('menu-cocode-sync'),
		menuCocodeUp = document.getElementById('menu-cocode-sync-up'),
		menuCocodeDown = document.getElementById('menu-cocode-sync-down'),
		// syncdataBtn = document.getElementById('syncdata-button'),
		menuCocodeSketches = document.getElementById('menu-cocode-sketches'),
		menuCocodeHolder = document.getElementById('menu-cocode-sketches-holder'),
		menuCocodeChatHolder = document.getElementById('menu-cocode-chat-holder'),
		menuCocodeChatInput = document.getElementById('chat-input'),
		menuCocodeChatDialog = document.getElementById('menu-cocode-chat-dialog'),
		menuRecodingHolder = document.getElementById('menu-section-recode'),
		menuRecodingActive = document.getElementById('menu-section-recoding-active'),
		menuRecodingInActive = document.getElementById('menu-section-recoding-inactive'),
		sketchesHolder = document.getElementById('menu-sketches-holder'),
		menuSketches = document.getElementById('menu-sketches'),
		menuSketchesFilter = document.getElementById('menu-sketches-filter'),
		menuSketchesCounter = document.getElementById('menu-sketches-counter'),
		settingsFontsize = document.getElementById('menu-settings-fontsize'),
		settingsAutoMode = document.getElementById('settings-autocompile'),
		settingsEcoMode = document.getElementById('settings-ecorender'),
		settingsCanvasCursor = document.getElementById('settings-canvascursor'),
		settingsConsole = document.getElementById('settings-console'),
		settingsConsoleMode = document.getElementById('settings-console-mode'),
		settingsMenutab = document.getElementById('settings-menutab'),
		settingsLinenumbers = document.getElementById('settings-linenumbers'),
		settingsRecompilepulse = document.getElementById('settings-recompilepulse'),
		settingsAutocomplete = document.getElementById('settings-autocomplete'),
		settingsExportcode = document.getElementById('settings-exportcode'),
		settingsLockDrag = document.getElementById('settings-lockdrag'),
		settingsPassEditorKeys = document.getElementById('settings-passeditorkeys'),
		settingsNotify = document.getElementById('settings-notifytoggle'),
		settingsTippy = document.getElementById('settings-tippytoggle'),
		settingsMultitab = document.getElementById('settings-mutitabtoggle'),
		settingsTimestamp = document.getElementById('settings-timestamptoggle'),
		settingsCocodingAutosave = document.getElementById('settings-cocodingautosavetoggle'),
		settingsCocodingFlags = document.getElementById('settings-cocodingflagstoggle'),
		settingsCheckupdates = document.getElementById('settings-checkupdatestoggle'),
		settingsCheckupdatesHolder = document.getElementById('settings-checkupdatestoggle-holder'),
		settingsTheme = document.getElementById('menu-settings-theme'),
		settingsBGactive = document.getElementById('settings-usebg'),
		settingsCOLORactive = document.getElementById('settings-usecolor'),
		settingsACTIVEactive = document.getElementById('settings-useactive'),
		settingsKeybindings = document.getElementById('menu-settings-keybindings'),
		settingsCompileTimer = document.getElementById('settings-compiletimer'),
		settingsBackup = document.getElementById('menu-settings-backup'),
		settingsSnippetsghostmodeToggle = document.getElementById('settings-snippetsghostmode-toggle'),
		settingsSnippetsghostmodeDelay = document.getElementById('settings-snippetsghostmode-delay'),
		settingsSoniCode = document.getElementById('settings-sonicode'),
		settingsSoniCodeMode = document.getElementById('settings-sonicode-mode'),
		settingsSoniCodePoly = document.getElementById('settings-sonicode-poly'),
		settingsSoniCodeBase = document.getElementById('settings-sonicode-base'),
		settingsSoniCodeDetails = document.getElementById('settings-sonicode-details'),
		settingsShortcuts = document.getElementById('menu-shortcuts-holder'),
		refHolder = document.getElementById('refholder'),
		ref = document.getElementById('ref'),
		menuPanel = document.getElementById('menu'),
		panelMenu = document.getElementById('panel-menu'),
		panelSettings = document.getElementById('panel-settings'),
		menuSwitch = document.getElementById('menu-switch'),
		menuCocoding = document.getElementById('menu-cocode-header'),
		loader = document.getElementById('loader'),
		loaderSub = document.getElementById('loader-sub'),
		notify = document.getElementById('notify'),
		chalkboard = document.getElementById('chalkboard'),
		sonicode = document.getElementById('sonicode').contentWindow,
		shortcutRecording = false,
		menuVisible = false, refVisible = false, settingsVisible = false,
		settings = getSettings(),
		validCode = true, sketchesFirstTime = true,
		sketchLoaded = false, forceRecompile = false, loadingInit = false,
		paused = false, multitabWarning = false, useRecompilePulse = true,
		markerID = [], pulsemarkerID = [], errorTimer, consoleTimer, consoleVisible = false, braketError,
		cocode, editorId, p5frameTemplate, p5htmlTemplate, p5liveUtils = {},
		snippets, snippetsManagerLoaded = false,
		p5vars = {frameCount:0, pframeCount:0, mouseX:0, mouseY:0}, newBG = '',
		refList = [], downloadedRef = false, refScroll = 0, refSearch = '',
		chars = 'abcdefghijklmnopqrstuvwxyz0123456789', // ABCDEFGHIJKLMNOPQRSTUVWXYZ
		showNotify = false, navMouseOver = false,
		curPos, curPositions = [], updateCursor, showCursors = false, notifyTimer, hideButtonsTimer,
		demosLocked = true, autoCompleteExport = false,
		syncdataEditor, syncdataPresets = [],
		cocodingFirstTime = false, cocodingShowMic = false, cocodingUnload = false,
		cocodingRecompile = false,
		changelog = {show:false, revision:0, version:0},
		recoding, exhibitMode = false, useP5 = true, useP5Sound = true
		;

		var chalkboardVisible = false, chalkboardInit = false,
		chalkboardSettingsUpdate, chalkboardFrame,
		p5pop, p5popStream, p5popActive = false, p5lCans, p5lCanSel = 0, p5lCansOptions = [],
		p5l = {remote:false, fancy:false, console:true, consoleMode:'auto', version: p5Version}
		;

		function onlineStatus(){
			if (navigator.onLine) {
			  p5l.online = true
			} else {
			  p5l.online = false
			}
		}
		onlineStatus()

		// force off
		settings.debugMode = false;

		// init editor
		let Range = ace.require('ace/range').Range;
		let Document = ace.require("ace/document").Document
		let langTools = ace.require('ace/ext/language_tools');
		let snippetManager = ace.require("ace/snippets").snippetManager
		let UndoManager = ace.require("ace/undomanager").UndoManager
		let undoManager = new UndoManager();
		var editor = ace.edit('p5-code');
		var editorGhost = new AceGhost(editor)
		editor.setTheme(settings.theme);
		editor.session.setMode('ace/mode/javascript');
		editor.session.on('changeMode', function(e, session) {
		    if('ace/mode/javascript' === session.getMode().$id) {
		        if(!!session.$worker) {
		            session.$worker.send('changeOptions', [{
		                asi: true // disable "Missing semicolon." warning in editor for JavaScript
		            }])
		        }
		    }
		})
		// editor.getSession().setUndoManager(this.undoManager);

		editor.setOptions({
			showPrintMargin: false,
			animatedScroll: true,
			displayIndentGuides: false,
			useWorker: true,
			showLineNumbers: false,
			showGutter: false,
			scrollPastEnd:1,
			tabSize: 4, useSoftTabs: false,
			enableBasicAutocompletion: true,
			enableSnippets: true
		});

		// function loadSnippetsManager(acOBJ){
		snippetManager.register(aceSnippets)
		// }

		// ghostmode snippet
		let snippetReg = /\${\d}|\${\w+:.}|\$(?:\d+|\w+)|\$\d|\${\d:.*}/g
		snippetManager.expandSnippetForSelection = function(e, t) {
            var n = e.getCursorPosition(), r = e.session.getLine(n.row), i = r.substring(0, n.column), s = r.substr(n.column), o = this.snippetMap, u;
            return this.getActiveScopes(e).some(function(e) {
                var t = o[e];
                return t && (u = this.findMatchingSnippet(t, i, s)),
                !!u
            }, this),

            // if ghost, grab start undostack
            (settings.snippetsghostmode.active && u != undefined) ? editorGhost.getUndoStack() : '',

            u ? t && t.dryRun ? !0 : (e.session.doc.removeInLine(n.row, n.column - u.replaceBefore.length, n.column + u.replaceAfter.length),
            this.variables.M__ = u.matchBefore,
            this.variables.T__ = u.matchAfter,

            // toggle ghost/instant
            settings.snippetsghostmode.active ? setTimeout(()=>{
            	// console.log('ace-snippet-ghost')
            	// *** prevent hardCompile on replace... solved?
            	editorGhost.animateText(u.content.replace(/\${\d}/, '/*$*/').replace(snippetReg, ''), 0, ()=>{
		            setTimeout(()=>{
		            	var range = editor.find('/*$*/')
		            	editor.replace('')
		            	if(!settings.cocoding.active){
							localStorage[settings.fileName] = editor.getValue();
						}
		            }, 1)	
	       		})
            }):setTimeout(()=>{
            	// console.log('ace-snippet-instant')
            	this.insertSnippetForSelection(e, u.content)
            }),
            this.variables.M__ = this.variables.T__ = null,
            !0) : !1
        }

		function getEditor(){
			return editor.getValue()
		}

		function loadAutoComplete(acOBJ, compName, compScore){
			// propose trimmed list/script to https://github.com/processing/p5.js/issues/3666
			let acList = [];
			let curFunction = '';

			// cycle through auto complete list
			acOBJ.code.forEach(function (ac){

				// if method/function
				if(ac.t == 'm'){
					// add once without params for easy adding
					if(ac.n != curFunction){
						acList.push({'cap':ac.n + '()', 'snip':ac.n + '()'});
						curFunction = ac.n;
					}

					// add w/ params using tab feature
					let acParamsTab = []
					for(let i=0; i < ac.p.length; i++){
						acParamsTab.push('${'+(i+1)+':'+ac.p[i]+'}');
					}
					let acParamsListTab = ac.n + '(' +acParamsTab.join(', ')+ ')';
					let acParamsList = ac.n + '(' +ac.p.join(', ')+ ')';
					acList.push({'cap':acParamsList, 'snip':acParamsListTab});
				}else{
					// add constants/misc
					acList.push({'cap':ac.n, 'snip':ac.n});
				}
			});

			// create custom completer
			var completer = {
				getCompletions: function(editor, session, pos, prefix, callback) {
					var text = editor.getValue(); if (prefix.length === 0) { callback(null, []); return }
					var completions = [];
					for(let wl of acList){
						completions.push({caption: wl.cap, snippet: wl.snip, meta: compName, score:compScore});
					}
					callback(null, completions);
				}
			}

			// add list to auto completer
			langTools.addCompleter(completer);
		}

		p5editor.style.visibility = 'visible';


		// RECODING
		recoding = new AceRecoding(editor, editor)
		recoding.elms = {
			steps: document.getElementById('menu-recoding-steps'),
			range: document.getElementById('recoding-range'),
			btns : {
				record: document.getElementById('recoding-record'),
				play: document.getElementById('recoding-play')
			}
		}
		recoding.loadSession()
		// recoding.debug = true

		function recodingCheck(){
			let check = false
			if(menuRecodingActive.style.display != 'none' && recoding.playing){
				check = true
			}
			return check
		}

		function recodingToggle(hide){
			if(hide){
				menuRecodingInActive.style.display = 'block'
				menuRecodingActive.style.display = 'none'
				resizeSketchesHolder();
			}else{
				if(menuRecodingInActive.style.display != 'none'){
					menuRecodingInActive.style.display = 'none'
					menuRecodingActive.style.display = 'block'
					resizeSketchesHolder();
				}
			}
		}

		function recodingImport(file){
			let reader = new FileReader()
			reader.onload = function(data) {
				let jsonObj = JSON.parse(data.target.result)
				recodingImportParse(jsonObj)
			}
			reader.readAsText(file)
		}

		function recodingImportParse(jsonObj){
			if(jsonObj.hasOwnProperty('type') && jsonObj.type === 'RECODING'){
				if(recoding.elms.range){
					recoding.elms.range.value = 0
				}
				// recoding.reset()
				recoding.session.history = jsonObj.data
				recoding.scrubSet()
				recoding.init()
				recodingToggle()
				recodingPlay()
				return true
			}else{
				return false
			}
		}

		function recodingStart(){
			if(!recoding.recording){
				recodingToggle()
				recoding.session.fileName = settings.fileName
				recoding.record()
				recoding.elms.btns.record.innerHTML = icon.pauseCircle
				recoding.elms.btns.play.innerHTML = icon.play
				editor.focus()
			}else{
				recoding.stop()
				recoding.elms.btns.record.innerHTML = icon.record
			}
		}

		function recodingPlay(){
			if(recoding.recording){
				recoding.stop()
			}

			if(recoding.session.history.length > 0){
				if(settings.fileName != 'recoding'){
					loadSketch('recoding')
				}
				setTimeout(function(){sketchScrollIntoView(true)}, 100)
				if(!recoding.playing){
					recoding.play()
					recoding.elms.btns.play.innerHTML = icon.pause
				}else{
					recoding.stop()
					recoding.elms.btns.play.innerHTML = icon.play
				}
			}
		}

		function recodingStop(){
			recoding.stop()
			recoding.elms.btns.record.innerHTML = icon.record
			recoding.elms.btns.play.innerHTML = icon.play
		}

		function recodingSettings(){
			if(recoding.playing){
				recoding.stop();
				recoding.play();
			}
		}

		function recodingScrub(val){
			if(settings.fileName != 'recoding'){
				loadSketch('recoding')
			}
			setTimeout(function(){sketchScrollIntoView(true)}, 100)
			recoding.scrub(val)
		}

		function recodingExport(elm){
			let recodingVex = vex.dialog.prompt({
				message: 'RECODING filename:',
				value: recoding.session.fileName, // placeholder filename
				callback: function (value) {
					if(value){
						let newName = value.replace(/["']/g, '');
						if(newName == ''){
							newName = 'recoding'
						}

						recoding.session.fileName = newName
						recoding.export()

						// share info
						let oldContent = elm._tippy.props.content
						elm._tippy.setContent('Saved!')
						elm._tippy.show(200)
						setTimeout(function(){
							elm._tippy.hide()
							elm._tippy.setContent(oldContent)
						}, 2000)
					}
				},
				afterOpen: function(){
					document.getElementsByClassName('vex-dialog-prompt-input')[0].select()
					setTimeout(function(){recodingVex.form[1].innerHTML = 'Export'}, 0) // vex rename button!
					vexClass(this.rootEl, 'vex-small')
				}
			})
		}

		function recodingReset(force){
			if(force){
				recoding.stop()
				recoding.reset()
				recodingToggle(true)
				clearParam()
				return false
			}else{
				vex.dialog.confirm({
					message: 'Reset RECODING history?',
					callback: function (value) {
						if (value) {
							recoding.reset()
							recodingToggle(true)
							clearParam()
						}
					},
					afterOpen: function(){
						vexClass(this.rootEl, 'vex-small')
					}
				})
			}
		}



		// ICONS!
		var icon = {};
		icon.alignLeft = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-align-left"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>';
		icon.bookmark = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-bookmark"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>';
		icon.checkCircle = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>';
		icon.checkSquare = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check-square"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>';
		icon.copy ='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
		icon.edit = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>';
		icon.export = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-small feather-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>';
		icon.eye = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-eye"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>';
		icon.fileLines = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>';
		icon.filter = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-filter"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>';
		icon.folderEmpty = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>';
		icon.folderCollapse = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder-minus"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="9" y1="14" x2="15" y2="14"></line></svg>';
		icon.folderExpand = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder-plus"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>';
		icon.gift = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-gift"><polyline points="20 12 20 22 4 22 4 12"></polyline><rect x="2" y="7" width="20" height="5"></rect><line x1="12" y1="22" x2="12" y2="7"></line><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path></svg>';
		icon.lock = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ff0000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-lock"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>';
		icon.maximize = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-maximize"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>';
		icon.micOff = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic-off"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>';
		icon.mic = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mic"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>';
		icon.moreVertical = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-more-vertical"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>';
		icon.moreHorizontal = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-more-horizontal"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>';
		icon.play = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';
		icon.power = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-power"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></svg>';
		icon.radio = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-radio"><circle cx="12" cy="12" r="2"></circle><path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"></path></svg>';
		icon.refresh = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-refresh-cw"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>';
		icon.remove = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-small feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>';
		icon.rename = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class=" feather-small feather-edit-3"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>';
		icon.save = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>';
		icon.screencast = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-radio"><circle cx="12" cy="12" r="2"></circle><path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"></path></svg>';
		icon.settings = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>';
		icon.shield = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-shield"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>';
		icon.toggleLeft = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-toggle-left"><rect x="1" y="5" width="22" height="14" rx="7" ry="7"></rect><circle cx="8" cy="12" r="3"></circle></svg>';
		icon.toggleRight = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-toggle-right"><rect x="1" y="5" width="22" height="14" rx="7" ry="7"></rect><circle cx="16" cy="12" r="3"></circle></svg>';
		icon.user = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>';
		icon.users = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-users"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>';
		icon.userCheck = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user-check"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline></svg>';
		icon.unlock = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-unlock"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V5a4 5 1 0 1 6.9-1"></path></svg>';
		icon.x = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
		icon.xCircle = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x-circle"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
		icon.record = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-target"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4" fill="white"></circle></svg>';
		icon.play = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';
		icon.sliders = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sliders"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>';
		icon.trash = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>';
		icon.repeat = '<svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-repeat"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>';
		icon.clock = '<svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>';
		icon.pause = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-pause"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>';
		icon.pauseCircle = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-pause-circle"><circle cx="12" cy="12" r="10"></circle><line x1="10" y1="15" x2="10" y2="9"></line><line x1="14" y1="15" x2="14" y2="9"></line></svg>';
		icon.newFile = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-plus"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>';


		// code-line color picker
		function loadColorPicker(elm, pickrSettings){
			let defaultColor = settings[pickrSettings];
			if(defaultColor.includes('#')){
				defaultColor = defaultColor.substring(1);
			}
			let pickr = Pickr.create({
				el: elm,
				useAsButton: true,
				theme: 'nano', // or 'monolith', or 'nano'
				default: defaultColor,

				components: {
					preview: true,
					opacity: true,
					hue: true,

					interaction: {
						input: true,
						cancel:false,
						save: true
					},
				},

				// rename buttons
				i18n: {
					'btn:save': 'Close',
				}
			});



			pickr.on('init', (instance) => {
				setPickr(defaultColor, elm, pickrSettings)
			}).on('change', (color, eventSource, instance) => {
				setPickr(color.toHEXA().join(''), elm, pickrSettings)
			}).on('save', (color, instance) => {
				instance.hide();
			}).on('cancel', instance => {
				instance.hide();
			});
		}


		let options = {
			group: {name: 'sketches'},
			bubbleScroll: true, // apply autoscroll to all parent elements, allowing for easier movement
			revertOnSpill: true,
			animation: 0,
			filter:'.sortable-placeholder, .demo',
			emptyInsertThreshold: 0,
			dragClass: 'sortable-drag',
			ghostClass: 'sortable-ghost',
			draggable: ['li', 'ul'],
			swapInvert:true,
			store: {
				set: function (sortable) {
					getOrder();
				}
			}
		}

		function vexClass(elm, className){
			elm.classList.add(className);
		}

		let includeScripts = {
			p5:{
				'local':p5l.version == 2 ? 'includes/p5/p5.min-2.js' :'includes/p5/p5.min.js',
				'remote':p5l.version == 2 ? 'https://cdn.jsdelivr.net/npm/p5@2/lib/p5.min.js' : 'https://cdn.jsdelivr.net/npm/p5@1/lib/p5.min.js',
				'parts': {base: 'https://cdn.jsdelivr.net/npm/p5@', file: '/lib/p5.min.js'}
			},
			p5sound:{
				'local':p5l.version == 2 ? 'https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.11.1/addons/p5.sound.min.js':'includes/p5/addons/p5.sound.min.js',
				'remote':p5l.version == 2 ? 'https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.11.1/addons/p5.sound.min.js':'https://cdn.jsdelivr.net/gh/processing/p5.js-sound/lib/p5.sound.min.js', // *** temp fix for safari!
			}
		};
		includeScripts.p5sound.path = includeScripts.p5sound.remote


		// testing q5xjs
		// includeScripts = [
		// 	{
		// 		'local':'includes/p5/q5.min.js',
		// 		'remote':'https://cdn.jsdelivr.net/npm/q5xjs@0.0.2/q5.min.js'
		// 	}
		// ]

		// markers for COCODING
		// built upon: https://stackoverflow.com/a/24812641/10885535
		let marker = {}
		marker.cursors = []
		marker.update = function(html, markerLayer, session, config) {
			let start = config.firstRow, end = config.lastRow;
			let cursors = this.cursors
			for (let i = 0; i < cursors.length; i++) {
				let pos = this.cursors[i];
				if (pos.row < start) {
					continue;
				} else if (pos.row > end) {
					break;
				} else {
					// compute cursor position on screen
					// this code is based on ace/layer/marker.js
					let screenPos = session.documentToScreenPosition(pos.row, pos.column)
					let aceGutter = document.getElementsByClassName('ace_gutter')[0].offsetWidth
					let height = config.lineHeight*1.4;
					let width = config.characterWidth;
					let top = markerLayer.$getTop(screenPos.row, config) - height*.3;
					let left = markerLayer.$padding + aceGutter + screenPos.column * width;

					// update if exists + rebuild on textsize change
					let elm = document.getElementById('cursor_'+pos.id);
					if(elm != undefined){
						elm.parentNode.removeChild(elm);
					}

					// can add any html here
					let el = document.createElement('div');
					el.id = 'cursor_'+pos.id;
					el.className = 'cursor';
					el.style.position = 'absolute';
					el.style.height = height + 'px';
					el.style.width = width + 'px';
					el.style.top = top + 'px';
					el.style.left = left + 'px';
					if(pos.id != settings.cocoding.nick){
						el.style.borderLeft = '3px solid ' + pos.color + 'aa';
					}else{
						let cursorSelf = document.getElementsByClassName('ace_cursor')[0];
						cursorSelf.style.borderColor = pos.color + 'aa';
						el.style.left = (left+3) + 'px';
					}
					el.style.zIndex = 9999999;
					el.style.color = '#000';
					el.style.cursor = 'help';
					if(!showCursors && !settings.cocodingFlagsToggle && !exhibitMode){ // *** showcursors
						el.style.display = 'none';
					}
					el.innerHTML = '<div class="cursor-label" style="background:'+pos.color+'aa;left:0px;white-space: nowrap;line-height:1em;">'+pos.id+'</div>';
					p5editor.appendChild(el);
				}
			}
		}
		marker.redraw = function() {
			this.session._signal('changeFrontMarker');
		}
		marker.session = editor.session;
		marker.session.addDynamicMarker(marker, true);


		class CocodeApp{
			constructor(namespace) {
				this.initialized = false;
				this.socket = '';
				this.namespace = namespace;
				if(!p5l.remote){ //   && !developBranch
					this.socket = io('/' + this.namespace, { transports: ['websocket'],secure: true, query : {nick : settings.cocoding.nick}}); // io('http://localhost:5000/' + this.namespace);
				}else{
					if(developBranch){
						this.socket = io('https://cocoding-dev.p5live.org/' + this.namespace, { transports: ['websocket'], secure: true, query : {nick : settings.cocoding.nick} });
					}else{
						this.socket = io('https://cocoding.p5live.org/' + this.namespace, { transports: ['websocket'], secure: true, query : {nick : settings.cocoding.nick} });
					}
				}
				this.rgaConnect();
				this.users = {};
				editor.setWrapBehavioursEnabled(false);

				this.updateColor();
				this.token();

				this.socket.on('init', () => {
					syncDown();
					setTimeout(function(){editor.setValue(p5template, 1);}, 100);
				});

				this.socket.on('syncSettings', (data)=>{
					syncDown();
					let settingsUpdate = JSON.parse(data);
					settings.cocoding.lockdown = settingsUpdate.lockdown;
					settings.cocoding.sync = settingsUpdate.sync;
					settings.cocoding.hasAdmin = settingsUpdate.hasAdmin;
					updateSettings();

					//lockdown
					if(settings.cocoding.lockdown){
						editor.setReadOnly(true);
						if(settings.cocoding.level == 'admin' || settings.cocoding.writemode){
							editor.setReadOnly(false);
						}
					}else{
						editor.setReadOnly(false);
					}
					updateToggleLockdown();

					if(settings.cocoding.sync){
						if(settingsUpdate.fc > 0){
							p5f.frameCount = settingsUpdate.fc;
						}
					}
					updateToggleSync();
					// let settingsSync = document.getElementById('cocode-sync');
					// toggleButtonActive(settingsSync, settings.cocoding.sync);

				});

				this.socket.on('cocodeReady', () =>{
					syncDown();
					if(!this.initialized){
						document.getElementById('cocoding-buttons-inactive').innerHTML = document.getElementById('cocoding-buttons-active').innerHTML;
						document.getElementById('cocoding-buttons-active').innerHTML = '';
						loadTippy();
						this.initialized = true;
					}
				});

				this.socket.on('full', () =>{
					syncDown();
					vex.dialog.alert({
						message:'Sorry COCODING is full at the moment.',
						callback: function(){cocodingExit(loadLatest());}
					})
				});

				this.socket.on('checkAdmin', (checkStatus)=>{
					if(checkStatus){
						settings.cocoding.token = checkStatus;
						updateSettings();
						this.token();
					}
				});

				this.socket.on('setLevel', (statusMode)=>{
					syncDown();
					settings.cocoding.level = statusMode;
					updateSettings();
					let adminDivs = document.getElementsByClassName('admin-lock');
					if(statusMode != 'admin'){
						for(let i=0; i<adminDivs.length; i++){
							adminDivs[i].setAttribute('disabled', 'disabled');
						}
					}else{
						for(let i=0; i<adminDivs.length; i++){
							adminDivs[i].removeAttribute('disabled')
						}
					}
				});

				this.socket.on('dispatchSyncEvent', (evData)=>{
					syncDown();
					let ev = JSON.parse(evData);
					let copy;
					if(ev.mode == 'keyboard'){
						copy = new KeyboardEvent(ev.type, ev.options);
					}else if(ev.mode == 'mouse'){
						copy = new PointerEvent(ev.type, ev.options);
					}
					p5f.dispatchEvent(copy);
					p5f.frameCount = ev.fc;
				});

				this.socket.on('recompile', (force)=>{
					syncDown();
					buildSketch(force); //
					updateBackground();
				});

				this.socket.on('rename', (nick)=>{
					syncDown();
					settings.cocoding.nick = nick;
					updateSettings();
				});

				this.socket.on('codeReplaceRequest', (data)=>{
					syncDown();
					vex.dialog.confirm({
						unsafeMessage:'Replace code request<br><hr><div class="code-replace-header">User </div>' + data.userID + '<br><div class="code-replace-header">SketchName</div>' + data.sketchName + '<br><div class="code-replace-header">SketchCode</div> <textarea id="code-replace-textarea" class="code-replace-textarea">' + data.sketchCode + '</textarea>',
						callback: function (value) {
							if (value) {
								let checkedCode = document.getElementById('code-replace-textarea').value;
								cocode.codeReplace({'code':checkedCode});
								// editor.setValue(checkedCode, 1);
								// window.setTimeout(function(){cocode.recompile()}, 300);
								// window.setTimeout(function(){recompile(true)}, 400);
							}else{
								cocode.codeReplaceReject(data);
							}
						}
					})
				});

				this.socket.on('codeReplaceReject', (data)=>{
					syncDown();
					vex.dialog.alert({
						message:'Request denied.',
						callback: function(){}
					})
				});

				this.socket.on('codeReplaceBusy', ()=>{
					syncDown();
					vex.dialog.alert({
						message:'Busy with another request, try later.',
						callback: function(){}
					})
				});

				this.socket.on('requestReject', ()=>{
					syncDown();
					settings.cocoding.request = false;
					updateSettings();
				});

				this.socket.on('codeReplace', (data)=>{
					syncDown();
					// RGA.AceEditorRGA.prototype.destroy;

					// RGA.AceEditorRGA._lastText = data.code;
					// this.rgaConnect();
					if(settings.cocoding.level == 'admin'){
						editor.setValue('', 1);
						// this.rgaConnect();
						window.setTimeout(function(){editor.setValue(data.code, 1);}, 300);
					}

					window.setTimeout(function(){cocode.recompile()}, 400);
					window.setTimeout(function(){recompile(true)}, 500);
				});

				this.socket.on('toggleEdit', (writeMode)=>{
					syncDown();
					if(writeMode){
						settings.cocoding.writemode = true;
						settings.cocoding.request = false;
						document.getElementById('syncdata-button').removeAttribute('disabled');
						updateSettings();
						editor.setReadOnly(false);
					}else{
						settings.cocoding.writemode = false;
						document.getElementById('syncdata-button').setAttribute('disabled', 'disabled');
						updateSettings();
						editor.setReadOnly(true);
					}
				});

				this.socket.on('syncCursors', (usersRaw) => {
					syncDown();
					this.syncCursors(usersRaw);
				});

				this.socket.on('syncData', (obj)=>{
					syncDown();
					if(sketchLoaded){
						p5f.parseData(obj);
					}
				});

				this.socket.on('addChat', (obj)=>{
					syncDown();
					this.addChat(obj, true);
				});

				this.socket.on('syncChat', (obj)=>{
					syncDown();
					this.parseChat(obj);
				});

				this.socket.on('clearPendingChat', ()=>{
					let pendingChats = document.getElementsByClassName('pending-chat');
					for(let pc of pendingChats){
						pc.remove();
					}
				});

				this.socket.on('syncUsers', (usersRaw) => {
					syncDown();
					this.users = JSON.parse(usersRaw);
					let users = [];
					for (let key in this.users) {
						users.push(this.users[key])
					};

					// sort by request or writemode
					if(settings.cocoding.level == 'admin'){
						users.sort(function(userA,userB){return userA.level-userB.level || userA.request-userB.request || userA.writemode-userB.writemode}).reverse();
					}else{
						users.reverse();
					}

					menuCocodeSketches.innerHTML = '';
					let activeSelf = '';
					let usersHTML = '';
					let usersSelf;
					menuCocodeCounter.innerHTML = users.length;
					for (let i=0; i < users.length; i++) {
						if(users[i].nick != settings.cocoding.nick){
							let userNav = '';
							if(settings.cocoding.lockdown){
								if(settings.cocoding.level == 'admin'){
									if(users[i].writemode){
										userNav = '<a class=" tippy" onclick="cocode.toggleEdit(\''+users[i].nick+'\')" data-title="Toggle EditMode">'+icon.toggleRight+'</a>';
									}else{
										userNav = '<a class=" tippy" onclick="cocode.toggleEdit(\''+users[i].nick+'\')" data-title="Toggle EditMode">'+icon.toggleLeft+'</a>';
									}
								}
							}

							let active = '';
							let marq = '';
							let writeClass = '';
							let userIcon = icon.users;
							if(settings.cocoding.lockdown){
								if(users[i].request){
									writeClass = ' write-req ';
								}else if(users[i].writemode || users[i].level == 'admin'){
									writeClass = ' write-access ';
								}
							}
							if(users[i].level == 'admin'){
								userIcon = icon.shield;
							}

							if(users[i].nick.length > 10){marq = 'marq';}
							if(users[i].status == 'blur'){
								active = 'style="opacity:.5;"';
							}

							let userNavIconsCount = 1;
							let userNavIcons = '<div class="cocoding-nav">';
							if(users[i].usesyncdata && (!settings.cocoding.lockdown || users[i].writemode)){
								userNavIcons += '<div class="cocoding-sketch-button user-radio-toggle">';
									userNavIcons += '<div class="cocoding-sketch-button-user">'+userIcon+'</div>';
									userNavIcons += '<div class="cocoding-sketch-button-radio">'+icon.radio+'</div>';
								userNavIcons += '</div>';
							}else{
								userNavIcons += '<div class="cocoding-sketch-button">'+userIcon+'</div>';
							}

							if(cocodingShowMic){
								userNavIconsCount++;
								if(1==1){ // *** mic icon logic
									userNavIcons += '<div class="cocoding-sketch-button">'+icon.micOff+'</div>';
								}else{
									userNavIcons += '<div class="cocoding-sketch-button">'+icon.mic+'</div>';
								}
							}

							if(settings.cocoding.lockdown){
									userNavIcons += '<div class="cocoding-sketch-button">'+userNav+'</div>';
							}
							userNavIcons += '</div>';

							let ccNameStyle = {};
							ccNameStyle.width = 'calc(100% - '+(userNavIconsCount*20)+'px)';


							let singleUserHTML = '<li id="user-'+users[i].nick+'" style="background:'+users[i].color+';" class="item-sketch menu-sketch-holder '+writeClass+'"><div class="menu-sketch"><div class="cocoding-name '+marq+'" style="width:'+ccNameStyle.width+'; left:'+ccNameStyle.left+';" onclick="cocode.scrollCursor('+users[i].cursor.row+','+users[i].cursor.column+');">' +users[i].nick+'</div>'+userNavIcons+'</div></li>';

							if(users[i].level == 'admin'){
								usersHTML = singleUserHTML + usersHTML;
							}else{
								usersHTML += singleUserHTML;
							}

						}else{
							usersSelf = users[i];
							if(usersSelf.status == 'blur'){
								activeSelf = 'style="opacity:.5;"';
							}
						}
					}

					let selfNav = '';
					let userIcon = icon.user;


					let writeClass = '';
					if(settings.cocoding.lockdown && settings.cocoding.level != 'admin'){
						if(usersSelf.request){
							writeClass = ' write-req ';
						}else if(settings.cocoding.writemode){
							writeClass = ' write-access ';
						}
					}

					if(settings.cocoding.level == 'admin'){
						userIcon = icon.shield;
					}

					let marq = '';
					if(settings.cocoding.nick.length > 10){marq = 'marq';}

					let userNavIconsCount = 1;
					let userNavIcons = '<div class="cocoding-nav">';
					if(settings.syncdata.active && (!settings.cocoding.lockdown || settings.cocoding.writemode)){
						userNavIcons += '<div class="cocoding-sketch-button user-radio-toggle">';
							userNavIcons += '<div class="cocoding-sketch-button-user">'+icon.radio+'</div>';
							userNavIcons += '<div class="cocoding-sketch-button-radio">'+userIcon+'</div>';
						userNavIcons += '</div>';
					}else{
						userNavIcons += '<div class="cocoding-sketch-button">'+userIcon+'</div>';
					}

					if(cocodingShowMic){
						userNavIconsCount++;
						if(1==1){
							userNavIcons += '<div class="cocoding-sketch-button">'+icon.micOff+'</div>';
						}else{
							userNavIcons += '<div class="cocoding-sketch-button">'+icon.mic+'</div>';
						}
					}

					if(settings.cocoding.level == 'user' && settings.cocoding.lockdown){
						let userEditIcon = icon.edit;
						let userEditRequest = 'onclick="cocode.editRequest(\''+settings.cocoding.nick+'\')"';
						let userEditTippy = 'Request Edit';
						if(settings.cocoding.writemode){
							userEditIcon = icon.checkSquare
							userEditRequest = '';
							userEditTippy = 'You can Edit!';
						}
						if(writeClass == ' write-req '){
							userEditTippy = 'Request Pending...';
						}
						userNavIcons += '<div class="cocoding-sketch-button tippy" id="request-'+settings.cocoding.nick+'" '+userEditRequest+' data-title="'+userEditTippy+'">'+userEditIcon+'</div>';
					}

					userNavIcons += '</div>';

					let ccNameStyle = {};
					ccNameStyle.width = 'calc(100% - '+(userNavIconsCount*20)+'px)';

					menuCocodeSketches.innerHTML = '<li id="cocodingself" style="background:'+settings.cocoding.color+';" class="item-sketch menu-sketch-holder '+writeClass+'" '+activeSelf+' >'+selfNav+'<div class="menu-sketch cocoding-user"><div class="cocoding-name '+marq+' tippy" data-title="Set Color + Nickname" style="width:'+ccNameStyle.width+';" onclick="cocode.rename();">' +settings.cocoding.nick+'</div>'+userNavIcons+'</div></li>' + usersHTML;
					loadTippy();
					this.syncCursors(usersRaw);
				});

				this.socket.on('connect_error', err => this.cocodeError(err));
				this.socket.on('connect_failed', err => this.cocodeError(err));
				this.socket.on('reconnect', msg => this.cocodeReconnect());
			}

			cocodeError(err){
				// editor.setReadOnly(true);

				// // offer to save code if connection lost
				if(!settings.cocoding.error && settings.cocodingAutosaveToggle){
					cloneSketchCOCODING();
					vex.dialog.alert({
						unsafeMessage: 'COCODING – Connection lost...<br>Session code cloned, just to be safe!',
						afterOpen: function(){
							vexClass(this.rootEl, 'vex-small')
						}
					})
				}
				settings.cocoding.error = true;
				updateSettings();
				// console.log('WSx error: '+settings.cocoding.error);
			}

			cocodeReconnect(){
				if(!settings.cocoding.error && settings.cocodingAutosaveToggle){
					cloneSketchCOCODING();
					settings.cocoding.error = true;
					updateSettings();
				}else if(exhibitMode){
					console.log('reconnected quietly')
					settings.cocoding.error = false
					updateSettings()
					return false
				}

				vex.dialog.alert({
					unsafeMessage: 'COCODING – Server Reconnected<br><br>Session code auto-saved! Manually inspect, copy + paste it into the session.<br>',
					callback: function (value) {
						if (value) {
							settings.cocoding.error = false;
							updateSettings();
							location.reload();
						}
					},
					afterOpen: function(){
						vexClass(this.rootEl, 'vex-small')
					}
				})

				// console.log('WSx error: '+settings.cocoding.error);
			}


			rgaConnect(){
				syncUp();
				RGA.AceEditorRGA.setup(editor, this.socket);
			}

			userBG(newVal){
				document.getElementById('cocodingself').style.background = newVal;
			}

			rename(mode){
				// incase no admin is present, offer it
				let renameAdmin = '';
				if(!settings.cocoding.hasAdmin){
					renameAdmin = '<span id="cocoding-rename-admin" class="tippy" data-title="Claim Admin" onclick="cocode.checkAdmin();" style="cursor:pointer;width:25px;">'+icon.shield+'</span>'; //
				}

				vex.dialog.open({
					input:[
					'<div id="cocoding-rename-color" class="cocoding-rename-input"><label for="color">Color</label><br>',
					'<input id="cocodingcolor" name="pickr" type="text" autocomplete="off" readonly class="cocode-pickr" style="cursor:pointer;width:50px"></div>',
					'<div id="cocoding-rename-nick" class="cocoding-rename-input"><label for="nick">Nickname</label>'+renameAdmin+'<br>',
					'<input id="cocodingnick" name="nick" type="text" value="' + settings.cocoding.nick + '"></div>',
					'<br><br>',



					].join(''),
					callback: function (data) {
						if(data){
							//console.log(data);
							if(data.nick != settings.cocoding.nick){
								let newName = data.nick.replace(/["']/g, '');
								if(newName.trim() != '' && newName != settings.cocoding.nick){
									settings.cocoding.nick = newName;
									cocode.login();
									updateSettings();
								}
							}
							if(data.pickr != undefined && data.pickr != settings.cocoding.color){
								settings.cocoding.color = data.pickr;
								cocode.userBG(data.pickr);
								cocode.updateColor();
								updateSettings();
							}else{
								//settings.cocoding.color = data.pickr;
							}

						}
					},
					afterOpen: function(){
						loadTippy();
						vexClass(this.rootEl, 'vex-small')
						document.getElementById('cocodingcolor').style.background = settings.cocoding.color;
						let defaultColor = '#00aa00';

						if(settings.cocoding.color != null){
							defaultColor = settings.cocoding.color;
						}
						//document.querySelectorAll('.ace_cursor')[0].style.background = defaultColor;
						const pickr2 = Pickr.create({
							el: '#cocodingcolor',
							useAsButton: true,
							theme: 'nano',
							default: defaultColor,

							components: {
								preview: true,
								opacity: false,
								hue: true,

								// Input / output Options
								interaction: {
									input: true,
									save: true,
									cancel:false
								},
							},

							// rename buttons
							i18n: {
								'btn:save': 'Close',
							}
						});

						if(mode == 1){
							pickr2.show();
						}else{
							setTimeout(function(){document.getElementById('cocodingnick').select();}, 100);
						}

						pickr2.on('change', (color, instance) => {
							document.getElementById('cocodingcolor').value = '#' + color.toHEXA().join('');
							document.getElementById('cocodingcolor').style.background = '#' + color.toHEXA().join('');
							document.getElementById('cocodingcolor').style.color = '#' + color.toHEXA().join('');
						}).on('save', (color, instance) => {
							instance.hide();

							// instance.hide();
						}).on('cancel', instance => {
						})
					}
				})
			}

			login(){
				syncUp();
				this.socket.emit('login', settings.cocoding.nick);
			}

			updateColor(){
				syncUp();
				// first time cocoder = random color
				if(settings.cocoding.color != null && settings.cocoding.color == '#00aa00'){
					settings.cocoding.color = '#'+Math.floor(Math.random()*16777215).toString(16);
				}
				updateSettings();
				this.socket.emit('updateColor', settings.cocoding.color);
			}

			token(){
				syncUp();
				this.socket.emit('token', settings.cocoding.token);
			}

			checkAdmin(){
				syncUp();
				this.socket.emit('checkAdmin');
			}

			lockdown(lockdownMode){
				syncUp();
				this.socket.emit('lockdown', lockdownMode)
			}

			codeReplaceRequest(userID, sketchName, sketchCode){
				let reqData = {'userID':userID, 'sketchName':sketchName, 'sketchCode':sketchCode}
				syncUp();
				this.socket.emit('codeReplaceRequest', reqData);
			}

			codeReplaceReject(data){
				syncUp();
				this.socket.emit('codeReplaceReject', data);
			}

			codeReplace(data){
				syncUp();
				this.socket.emit('codeReplace', data);
			}

			editRequest(userID){
				settings.cocoding.request = !settings.cocoding.request;
				updateSettings();

				let reqData = {'userID':userID, 'mode':settings.cocoding.request}
				syncUp();
				this.socket.emit('editRequest', reqData);
			}

			toggleEdit(userID){
				syncUp();
				this.socket.emit('toggleEdit', {'userID':userID});
			}

			requestReject(userID){
				syncUp();
				this.socket.emit('rejectRequest', {'userID':userID});
			}

			dispatchSyncEvent(evMode, evType, evOpts){
				let ev = {'mode':evMode, 'type':evType, 'options':evOpts, 'fc':p5f.frameCount};
				syncUp();
				this.socket.emit('dispatchSyncEvent', ev);
			}

			recompile(force){
				syncUp();
				this.socket.emit('recompile', force);
			}

			sync(syncMode){
				syncUp();
				this.socket.emit('sync', {'mode':syncMode, 'fc':p5f.frameCount});
			}

			cursorPos(pos){
				syncUp();
				this.socket.emit('cursor', pos);
			}

			parseChat(chatObj){
				menuCocodeChatDialog.innerHTML = '';
				for(let chatItem of chatObj){
					cocode.addChat(chatItem);
				}
			}

			addChat(msg){
				let msgID = '', pendingChat = '';
				let pendingMsg = document.getElementById(msg.msgID);
				let notifyChat = false;
				if(msg.type && msg.type == 'pending'){
					msgID = 'id="'+msg.msgID+'"';
					pendingChat = 'pending-chat';
				}else if(msg.type && msg.type == 'clear'){
					if(pendingMsg != undefined){
						pendingMsg.remove();
						return false;
					}
				}else{
					if(pendingMsg != undefined){
						pendingMsg.remove();
						notifyChat = true;
					}
				}

				// check if at bottom of chat
				let autoScroll = false;
				if(menuCocodeChatDialog.scrollHeight - menuCocodeChatDialog.scrollTop < 200){
					autoScroll = true;
				}

				let msgHTML = '<div class="chat-item" '+msgID+'>';
					msgHTML += '<div class="chatmsg '+pendingChat+'">';
					let marq = '';
					if(msg.nick.length > 7){marq = 'longname marq';}
					msgHTML += '<div class="chatname '+marq+'" style="background:'+msg.color+';">'+msg.nick+'</div>&nbsp;';
					msgHTML += '<span class="chattext ">'+linkify(msg.text)+'</span>';
					msgHTML += '</div>';
					msgHTML += '</div>';
					menuCocodeChatDialog.innerHTML += msgHTML;

					// only auto scroll if at bottom, otherwise small offset for feedback
					if(autoScroll){
						menuCocodeChatDialog.scrollTop = menuCocodeChatDialog.scrollHeight;
					}else{
						menuCocodeChatDialog.scrollTop += 10;
					}

					// check if settings.. + if menu hidden...
					if(settings.notifyToggle && (menuPanel.style.marginRight == '-250px' || panelSettings.style.display == 'block') && notifyChat){
						let notifyHTML = '';
						notifyHTML += '<div class="chatname '+marq+'" style="background:'+msg.color+';">'+msg.nick+'</div>&nbsp;';
						notifyHTML += '<br><span class="chattext ">'+linkify(msg.text)+'</span>';

						notifyMsg(notifyHTML);
					}
			}

			scrollCursor(userRow, userColumn){
				editor.renderer.scrollCursorIntoView({row: userRow, column: userColumn}, 0.5);
			}

			syncCursors(usersRaw){
				this.users = JSON.parse(usersRaw);
					marker.cursors = [];

					let elements = document.getElementsByClassName('cursor');
					while(elements.length > 0){
						elements[0].parentNode.removeChild(elements[0]);
					}

					for (let key in this.users) {
						// don't show own cursor, if lockdown, only show those with write access
						if((!settings.cocoding.lockdown || (settings.cocoding.lockdown && this.users[key].writemode)) && this.users[key].nick !== settings.cocoding.nick){
							marker.cursors.push({row:this.users[key].cursor.row, column:this.users[key].cursor.column, color:this.users[key].color, id:this.users[key].nick});
						}
					};
					marker.redraw();
			}
		};

		// cocode extras

		function linkify(text) {
			var urlRegex =/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
			return text.replace(urlRegex, function(url) {
				return '<a href="' + url + '" target="_blank">' + url + '</a>';
			});
		}

		function showUsers(){
			let cursorSel = document.getElementsByClassName('cursor');
			for(let i=0; i < cursorSel.length; i++){
				cursorSel[i].style.display = 'block';
			}
			showCursors = true;
		}

		function hideUsers(){
			if(settings.cocodingFlagsToggle){
				return false
			}
			let cursorSel = document.getElementsByClassName('cursor');
			for(let i=0; i < cursorSel.length; i++){
				cursorSel[i].style.display = 'none';
			}
			showCursors = false;
		}

		let syncUpTimer;
		function syncUp(){
			clearTimeout(syncUpTimer);
			menuCocodeUp.style.opacity = 1;
			syncUpTimer = window.setTimeout(function(){
				menuCocodeUp.style.opacity = .25;
			}, 200);

		}

		let syncDownTimer;
		function syncDown(){
			clearTimeout(syncDownTimer);
			menuCocodeDown.style.opacity = 1;
			syncDownTimer = window.setTimeout(function(){
				menuCocodeDown.style.opacity = .25;
			}, 200);

		}



		/* FANCY EDITOR FUNCTIONS */

		editor.getSession().selection.on('changeCursor', function(){
			//console.log(editor.getCursorPosition());
			curPos = editor.getCursorPosition();

			// sync cursors in COCODING
			if(settings.cocoding.active && cocode != null){
				updateCursor = window.setTimeout(function(){cocode.cursorPos(curPos);}, 200);
			}
			// curPositions.push(editor.getCursorPosition());
		})

		editor.getSession().on('change', function(delta){
			curPos = delta.start;
			curPositions.push(delta.start);
			checkErrors();
		});

		// check for errors
		editor.getSession().on('changeAnnotation', function(){
			let annot = editor.getSession().getAnnotations();

			// extra debug info (too raw.. but nice to have better p5.js specific debugging in console)
			// for (var key in annot) {
			// 	if (annot.hasOwnProperty(key))
			// 	console.log(annot[key].text + "on line " + " " + annot[key].row);
			// }

			validCode = true;
			for(let i=0; i < annot.length; i++){
				if(annot[i].type === 'error'){
					addMarker(annot[i].row);
					if(!braketError)
					consoleMessage('Error line ~ '+ (annot[i].row+1) )
					validCode = false;
				}
			}
			if(validCode){
				if(!braketError)
				consoleHide()
				removeMarkers();
			}
		});

		
		function recompilePulse(s = 0, e = editor.session.getLength()){
			if(useRecompilePulse){
				pulsemarkerID.push({id:editor.session.addMarker(new Range(s, 0, e, 9000), "ace_marker", "text")})
				setTimeout(removePulseMarkers, 300)
			}
		}

		function addMarker(n){
			let elementPos = markerID.map(function(x) {return x.line; }).indexOf(n);
			if (elementPos === -1) {
				markerID.push({'line':n, 'id':editor.session.addMarker(new Range(n, 0, n, 7000), 'myMarker', 'fullLine')});
			}
		}

		function removeMarkers(){
			for(let i=0; i < markerID.length; i++){
				editor.session.removeMarker(markerID[i].id);
			}
			markerID = [];
		}

		function removePulseMarkers(){
			for(let i=0; i < pulsemarkerID.length; i++){
				editor.session.removeMarker(pulsemarkerID[i].id);
			}
			pulsemarkerID = [];
		}

		// set editor BG
		editor.renderer.on('afterRender', function(){
			adjustLines();
		});

		function adjustLines(){
			let pcode = p5editor.getElementsByClassName('ace_line');
			for(let i=0; i < pcode.length; i++){
				let pitem = pcode[i];
				if(settings.themeBGactive && pitem.getElementsByClassName( 'ace_line_bg' ).length < 1){
					let pcontents = pitem.innerHTML;
					pitem.innerHTML = '<span class="ace_line_bg" style="background:' + settings.themeBG + '">' + pcontents + '</span>';
				}
			}
			
			if(settings.themeCOLORactive){
					p5code.style.color = settings.themeCOLOR
			}else{
				p5code.style.color = 'inherit'
			}

			if(settings.themeACTIVEactive){
				let activeLine = document.querySelector('.ace_marker-layer .ace_active-line')
				if(activeLine != null){
					activeLine.style.backgroundColor = settings.themeACTIVE
				}
			}else{
				if(document.querySelector('.ace_marker-layer .ace_active-line') !== null){
					document.querySelector('.ace_marker-layer .ace_active-line').style.backgroundColor = 'inherit'
				}
			}

		}



		/* CMD-KEYS (removing key conflicts, replaced below w/o conflict) */
		function setEditorCommands(){
			if(settings.editor.keybinding == 'vim'){
				ace.config.loadModule('ace/keyboard/vim', function(module) {
				   var VimApi = module.CodeMirror.Vim;
				   VimApi.defineEx('write', 'w', function(cm, input) {
				      recompile(true);
				   });
				});
			}else{
				editor.commands.removeCommands([
					'backspace' // ctrl + h
					,'gotoleft' // ctrl + f
					,'gotoright' // ctrl + f
					,'golineup' // ctrl + p mac
					,'golinedown' // ctrl + n
					,'gotolinestart' // ctrl + a
					,'gotolineend' // ctrl + e
					,'jumptomatching' // ctrl + p windows
					,'splitline' // ctrl + o (totally removed)
					,'transposeletters' // ctrl + t (totally removed)
					,'selecttolinestart' // ctrl + shift + a (audio snippet)
					]);

				// replace backspace w/o ctrl + h
				editor.commands.addCommand({
					name: 'backspace',
					bindKey: { win: 'Shift-Backspace|Backspace', mac: 'Ctrl-Backspace|Shift-Backspace|Backspace' },
					exec: function(e) { e.remove('left') },
					multiSelectAction: 'forEach',
					scrollIntoView: 'cursor'
				});

				// replace gotoright w/o ctrl + f
				editor.commands.addCommand({
					name: 'gotoright',
					bindKey: { win: 'Right', mac: 'Right' },
					exec: function(e,t) { e.navigateRight(t.times) },
					multiSelectAction: 'forEach',
					scrollIntoView: 'cursor',
					readOnly:!0
				});

				// replace gotoleft w/o ctrl + b
				editor.commands.addCommand({
					name: 'gotoleft',
					bindKey: { win: 'Left', mac: 'Left' },
					exec: function(e,t) { e.navigateLeft(t.times) },
					multiSelectAction: 'forEach',
					scrollIntoView: 'cursor',
					readOnly:!0
				});

				// replace golineup w/o ctrl + p
				editor.commands.addCommand({
					name: 'golineup',
					bindKey: { win: 'Up', mac: 'Up' },
					exec: function(e,t) { e.navigateUp(t.times) },
					multiSelectAction: 'forEach',
					scrollIntoView: 'cursor',
					readOnly:!0
				});

				// replace golinedown w/o ctrl + n
				editor.commands.addCommand({
					name: 'golinedown',
					bindKey: { win: 'Down', mac: 'Down' },
					exec: function(e,t) { e.navigateDown(t.times) },
					multiSelectAction: 'forEach',
					scrollIntoView: 'cursor',
					readOnly:!0
				});

				// replace gotolinestart w/o ctrl + a
				editor.commands.addCommand({
					name: "gotolinestart",
					description: "Go to line start",
					bindKey: { win: 'Alt-Left|Home', mac: 'Command-Left|Home' },
					exec: function(editor) { editor.navigateLineStart(); },
					multiSelectAction: "forEach",
					scrollIntoView: "cursor",
					readOnly: true
				});

				// replace gotolineend w/o ctrl + e
				editor.commands.addCommand({
					name: "gotolineend",
					description: "Go to line end",
					bindKey: { win: 'Alt-Right|End', mac: 'Command-Right|End' },
					exec: function(editor) { editor.navigateLineEnd(); },
					multiSelectAction: "forEach",
					scrollIntoView: "cursor",
					readOnly: true
				});

				// replace jumptomatching w/o ctrl + p
				editor.commands.addCommand({
					name: "jumptomatching",
					description: "Jump to matching",
					bindKey: { win: 'Ctrl-\\', mac: 'Command-\\' },
					exec: function(editor) { editor.jumpToMatching(); },
					multiSelectAction: "forEach",
					scrollIntoView: "animate",
					readOnly: true
				});
			}
		}


		// beautify!
		let beautifyOptions = {
			'indent_size': '1',
			'indent_char': '\t',
			'max_preserve_newlines': '5',
			'preserve_newlines': true,
			'keep_array_indentation': false,
			'break_chained_methods': false,
			'indent_scripts': 'normal',
			'brace_style': 'none,preserve-inline',
			'space_before_conditional': false,
			'unescape_strings': false,
			'jslint_happy': false,
			'end_with_newline': false,
			'wrap_line_length': '0',
			'indent_inner_html': false,
			'comma_first': false,
			'e4x': false
		}


		/* DEBUG EDITOR COMMANDS + STORAGE */

		// list ace editor commands
		function listCommands(){
			let cmds = editor.commands.commands;
			let k = [];
			for (let cmd in cmds){
				k.push(cmd.name + ' = ' + cmd.bindKey);
			}
		}

		// check storageKeys
		function getKeys(){
			let k = [];
			for (let key in localStorage){
				k.push(key);
			}
		}

		if(settings.debugMode){
			listCommands();
			getKeys();
		}



		/* p5 iframe communication */

		// mark error line
		window.document.addEventListener('p5Status', handleEvent, false)
		function handleEvent(e) {
			if(e.detail.lineNumber != undefined){
				let errorLine = parseInt(e.detail.lineNumber)-1;
				addMarker(errorLine);
			}else{
				removeMarkers()
			}
			// sketchloaded
			if(e.detail.status){
				// p5f.frameCount = p5vars.frameCount;
				// p5f.mouseX = p5vars.mouseX;
				// p5f.mouseY = p5vars.mouseY;

				// p5f.setup(); // better than clear/background, reinit w/ updated vars
				//p5varsReset();

				sketchLoaded = true;
				popStream();
				syncdataParse(); // promise for syncdata if active

				if(recoding.recording){
					recoding.compile()
				}

				if(sketchLoaded && cocodingRecompile && settings.cocoding.level == 'admin'){
					cocode.recompile(true);
					cocodingRecompile = false;
				}
			}else{
				sketchLoaded = false;
				// set timer for refreshing if error
			}
		}



		/* ASSETS */
		preloadAssets() // waterfall assets - settings

		function preloadAssets(){
			checkOffline();
			checkSettings();

			// p5live sketch template
			loaderSub.innerHTML = 'loading templates...';
			let sketchPath = 'includes/templates/p5live_sketch.html?' + currentRevision;
			fetch(sketchPath)
			.then(res => res.text())
			.then(html => {
				let el = document.createElement('html');
				el.innerHTML = html;
				p5frameTemplate = el;
			})

			// p5 savehtml template
			.then(() => {
				let htmlPath = 'includes/templates/p5live_savehtml.html?' + currentRevision;
				return fetch(htmlPath)
			})
			.then(res => res.text())
			.then(html => {
				let el = document.createElement('html');
				el.innerHTML = html;
				p5htmlTemplate = el;
			})

			// p5 audio utils
			.then(() => {
				let fetchPath = 'includes/utils/p5live-audio.js?' + currentRevision;
				return fetch(fetchPath)
			})
			.then(res => res.text())
			.then(js => {
				p5liveUtils.audio = js
			})

			// p5 midi utils
			.then(() => {
				let fetchPath = 'includes/utils/p5live-midi.js?' + currentRevision;
				return fetch(fetchPath)
			})
			.then(res => res.text())
			.then(js => {
				p5liveUtils.midi = js
			})

			// load snippets
			.then(() => {
				loaderSub.innerHTML = 'loading snippets...';
				loadKeybindings();
				setEditorCommands();
				snippetsLoad()
				let snippetsPath = 'includes/demos/P5L_snippets-v2.json?' + currentRevision;
				return fetch(snippetsPath)
			})
			.then(res => res.json())
			.then(jsonObj => loadSnippets(jsonObj))

			// // load ace snippets
			// .then(() => {
			// 	let acPath = 'includes/utils/ace-snippets.js?' + currentRevision;
			// 	return fetch(acPath)
			// })
			// .then(res => res.text())
			// .then(acOBJ => loadSnippetsManager(JSON.parse(acOBJ)))


			// load autocomplete p5
			.then(() => {
				let acPath = 'includes/utils/p5_autocomplete.json?' + currentRevision;
				return fetch(acPath)
			})
			.then(res => res.json())
			.then(acOBJ => loadAutoComplete(acOBJ, 'p5', 2))

			// load autocomplete hydra
			.then(() => {
				let acPath = 'includes/utils/hydra_autocomplete.json?' + currentRevision;
				return fetch(acPath)
			})
			.then(res => res.json())
			.then(acOBJ => loadAutoComplete(acOBJ, 'hydra', 1))

			// load syncdataPresets
			.then(() => {
				let syncdataPresetsPath = 'includes/demos/P5L_syncdata-presets.json?' + currentRevision;
				return fetch(syncdataPresetsPath)
			})
			.then(res => res.json())
			.then(sdpOBJ => {
				if(settings.hasOwnProperty('syncdata')){
					syncDataPresetLoad(sdpOBJ)
				}
			})

			// everything else
			.then(() => {
				loaderSub.innerHTML = 'loading settings...';
				loadSettings()
				// *** future tour
			})

			
			// grab p5 versions
			let p5VersionPath = p5l.online ? 'https://data.jsdelivr.com/v1/packages/gh/processing/p5.js' : 'includes/p5/p5-versions.json'
			fetch(p5VersionPath).then(res => res.json())
			.then(jsonObj => {
				includeScripts.p5.versions = []
				for(let v of jsonObj.versions){
					includeScripts.p5.versions.push(v.version)
				}
			})
			.catch((error) => {
			  console.log(`P5LIVE: Error fetching p5-versions`)
			});
		}



		function checkOffline(){
			// check online or offline
			if(window.location.hostname.includes('teddavis.org') || window.location.hostname.includes('dev.p5live.org')){
				p5l.remote = true;
				settingsCheckupdatesHolder.style.display = 'none';
				if(developBranch){
					document.title = 'P5LIVE – DEVELOP';
				}
			}else{
				p5l.remote = false;
				document.title = 'P5LIVE – OFFLINE';
			}

			// OFFLINE mode
			if(!p5l.remote){
				// check fancy
				fetch('./fancy')
				.then(function(response){
					if(response.status == 200){
						p5l.fancy = true;
						console.log("P5LIVE - OFFLINE: Fancy Mode!");
					}else{
						console.log("P5LIVE - OFFLINE: Simple Mode");
						return false;
					}
				})
			}

		}



		/* SETTINGS */

		// get settings from localstorage
		function getSettings(){
			let tempSettings = initSettings;
			if(localStorage.hasOwnProperty('settings')){
				tempSettings = JSON.parse(localStorage.getItem('settings'));
			}
			return tempSettings;
		}

		function checkSettings(){
			// make sure all settings are there, 3 levels in
			let settingsChanged = false;
			Object.keys(initSettings).forEach(function(k){
				if(!settings.hasOwnProperty(k)){
					settings[k] = initSettings[k];
					settingsChanged = true;
				}
				if(typeof initSettings[k] === 'object' && initSettings[k] !== null){
					Object.keys(initSettings[k]).forEach(function(kk){
						if(!settings[k].hasOwnProperty(kk)){
							settings[k][kk] = initSettings[k][kk];
							settingsChanged = true;
						}
						if(typeof initSettings[k][kk] === 'object' && initSettings[k][kk] !== null){
							Object.keys(initSettings[k][kk]).forEach(function(kkk){
								if(!settings[k][kk].hasOwnProperty(kkk)){
									settings[k][kk][kkk] = initSettings[k][kk][kkk];
									settingsChanged = true;
								}
							});
						}
					});
				}
				if(settingsChanged){
					settings.refresh = true;
				}
			});
			updateSettings();
		}

		// react to settings once gathered
		function loadSettings(){

			if(settings.revision == undefined || settings.revision < currentRevision){
				changelog.show = true;
				changelog.revision = settings.revision;
				changelog.version = settings.version;
				settings.revision = currentRevision;
				settings.version = initSettings.version;
				settings.fileName = 'new';
				// settings.welcome = true;
				settings.refresh = true;
				updateSettings();
			}


			// check version
			let versionHTML = `
			<span class="tippy" data-title="Latest version">${settings.version}</span>
			`
			document.getElementById('menu-p5live-version').innerHTML = versionHTML;

			let remoteVersionPath = 'https://raw.githubusercontent.com/ffd8/P5LIVE/main/package.json';
			let localVersionPath = './package.json';
			let rVersion = 0;
			if(!p5l.remote && settings.checkupdatesToggle){
				fetch(remoteVersionPath)
				.then(res => res.json())
				.then(dataR => {
					rVersion = dataR.version;
					return fetch(localVersionPath)
				})
				.then(res => res.json())
				.then(dataL => {
					if(dataL.version < rVersion){
						document.getElementById('menu-p5live-version').style.display = 'inline'
						let updateHTML = `
						<a href="https://github.com/ffd8/P5LIVE#https" target="_blank" class="tippy" data-title="v ${dataL.version} - <span class='pulse'>${rVersion}</span>" style="color:white;text-decoration:none;">» UPDATE</a>
						`
						document.getElementById('menu-p5live-version').innerHTML = updateHTML;
						loadTippy();
					}
				})
				.catch(function(err){})
			}

			fontSizeUpdate();
			autoCompileUpdate();
			compileTimerUpdate();
			menuToggleUpdate();
			ecoRenderUpdate();
			consoleToggleUpdate();
			consoleModeUpdate();
			menutabToggleUpdate();
			autocompleteUpdate();
			linenumbersUpdate();
			pulseUpdate();
			lockDragUpdate();
			exportcodeUpdate();
			notifyToggleUpdate();
			tippyToggleUpdate();
			multitabToggleUpdate();
			timestampToggleUpdate();
			checkupdatesToggleUpdate();
			cocodingAutosaveToggleUpdate();
			cocodingFlagsToggleUpdate();
			passEditorKeysUpdate();
			loadTheme();
			loadBackup();
			themeBGactiveToggleUpdate();
			themeCOLORactiveToggleUpdate();
			themeACTIVEactiveToggleUpdate();
			snippetsghostmodeToggleUpdate();
			snippetsghostmodeDelayUpdate();
			sonicodeToggleUpdate();
			loadColorPicker('#pickr-background', 'themeBG')
			loadColorPicker('#pickr-color', 'themeCOLOR')
			loadColorPicker('#pickr-active', 'themeACTIVE')
			vex.defaultOptions.className = 'vex-theme-plain'
			legacySettings(); // update sketches from 1.0.2

			if(settings.cocoding != undefined){
				settings.cocoding.active = false;
			}
			settings.safeMode = false;
			updateSketches();
			filterParse();
			snippetsLoad()

			if(settings.refresh){
				refreshDemos();
				settings.refresh = false;
				updateSettings();
			}


			// *** move params to own function
			settings.editMode = true;
			if(checkParam('edit') && !boolParam('edit')){
				settings.editMode = false;
				editor.setReadOnly(true);
				p5editor.style.display = 'none';
				menuPanel.style.display = 'none';
				settings.welcome = false;
				updateSettings();
			}else{
				loaderSub.innerHTML = 'shortcuts...';
				updateShortcuts();
			}

			if(checkParam('exhibit') && boolParam('exhibit')){
				exhibitMode = true
			}

			// load sketch by param
			if(checkParam('sketch')){
				settings.welcome = false
				updateSettings();
				setTimeout(function(){
					let urlSketch = decodeURI(getParam('sketch'));
					if(searchSketches(urlSketch, settings.sketches)){
						settings.fileName = urlSketch;
						updateSettings();
						loadSketch(settings.fileName);
						setTimeout(function(){sketchScrollIntoView(true);}, 500);
					}
				}, 500);
				
			}

			// load RECODING by param
			if(checkParam('recoding')){
				loadDefault()
				let urlSketch = decodeURI(getParam('recoding'))
				fetch(urlSketch)
				.then(res => res.json())
				.then(jsonResponse => {
				  	if(recodingImportParse(jsonResponse)){
				  		if(checkParam('loop')){
				  			recoding.loop = boolParam('loop')
				  			document.getElementById('recoding-settings-loop').checked = recoding.loop
				  		}

				  		if(checkParam('gaps')){
				  			recoding.gaps = boolParam('gaps')
				  			document.getElementById('recoding-settings-gaps').checked = recoding.gaps
				  			recodingSettings()
				  		}

				  		if(checkParam('gapsmax')){
				  			recoding.gapsMax = getParam('gapsmax')
				  			document.getElementById('recoding-settings-gapsmax').value = recoding.gapsMax
				  			recodingSettings()
				  		}

				  		if(checkParam('speed')){
				  			recoding.setSpeed(getParam('speed'))
				  			document.getElementById('recoding-settings-speed').value = getParam('speed')
				  		}

				  		if(checkParam('catmode')){
				  			recoding.toggleCat(boolParam('catmode'))
				  			document.getElementById('recoding-settings-catmode').checked = recoding.catMode
				  		}
				  	}
					if(getParam('loop') || getParam('gaps') || getParam('gapsmax') || getParam('speed')){
				  		setTimeout(function(){toggleButtonsExtended('recoding-settings', 'block')}, 0)
				  	}
				})
				.catch((error) => {
					alertMsg('RECODING load error – Check URL path.')
				})
			}

			// toggle visibility by param
			if(checkParam('menu')){
				if(!boolParam('menu')){
					hideMenu()
				}else{
					menuToggle(true);
				}
			}

			if(checkParam('editor')){
				if(!boolParam('editor')){
					editorToggle(false)
				}
			}

			if(checkParam('readonly')){
				if(boolParam('readonly')){
					settings.editMode = false;
					editor.setReadOnly(true);
					processMouse = null
					updateSettings();
				}
			}


			// load code via URL
			if(checkParam('code')){
				loadDefault();
				setTimeout(function(){
					editor.setValue(b64_to_utf8(getParam('code')), 1);
					localStorage[settings.fileName] = editor.getValue();
					clearParam();
				}, 100);
			}

			// load COCODING
			if(checkParam('cc')){
				loaderSub.innerHTML = 'cocoding...';
				if(getParam('cc').length != 5){
					cocodingExit(loadLatest());
					return false;
				}
				let ccSpace = getParam('cc');
				if(settings.cocoding.token != hashCode(ccSpace)){
					cocodingReset();
				}
				settings.cocoding.active = true;
				menuCocodeSync.style.display = 'inline';
				if(settings.cocoding.timestamp == null){
					settings.cocoding.timestamp = timeStamp().substring(0, 8);
				}
				menuCocode.style.display = 'block';
				settings.fileName = ccSpace;
				settings.cocoding.namespace = settings.fileName;
				if(settings.cocoding.nick == undefined || settings.cocoding.nick == ''){
					settings.cocoding.nick = generateName();//makeid(6);
					cocodingFirstTime = true;
				}
				updateSketches();
				cocoding();

				if(window.location.hash.substring(1).toLowerCase() === 'bug'){
					console.log('bug!');
					settings.safeMode = true;
					updateSettings();
				}
			}else if(window.location.hash){
				if(window.location.hash.substring(1) === 'new'){
					loadDefault();
				}else if(window.location.hash.substring(1).toLowerCase() === 'bug'){
					loadBug();
				}else{ // else if(window.location.hash.indexOf('ref') != -1)
					loaderSub.innerHTML = 'loading references...';
					loadRef();
					loadSketch(settings.fileName);
				}
			}else{
				cocodingReset();
				// setTimeout(function(){loadSketch(settings.fileName);}, 1000); // ** replace w/ fetch
				loadSketch(settings.fileName); // *** double check working
			}

			if(settings.welcome){
				loadAbout();
				if(!settings.cocoding.active){
					loadDefault();
				}
				menuToggle(true);
				settings.welcome = false;
				updateSettings();
			}

			if(changelog.show){
				loadChangelog();
			}

			resizeSketchesHolder();
			hideLoader();

			// test multiple open
			// inspiration: https://stackoverflow.com/a/43291970/10885535
			if(settings.multitabToggle && settings.editMode){
				localStorage.openpages = Date.now();
				var onLocalStorageEvent = function(e){
					if(e.key == "openpages"){
						// Listen if anybody else opening the same page!
						localStorage.page_available = Date.now();
					}
					if(e.key == "page_available" && !multitabWarning){
							multitabWarning = true;
							vex.dialog.alert({
								unsafeMessage:'<span class="pulse">Warning:</span> <br>'+document.title+' open in multiple tabs!<br>Close all but one to avoid data loss.',
								afterOpen: function(){
									vexClass(this.rootEl, 'vex-small')
								},
								callback: function(){
									multitabWarning = false;
								}
							});
					}
				};
				setTimeout(function(){window.addEventListener('storage', onLocalStorageEvent, false);}, 0);
			}

			// prevent external links exhibitmode
			if(exhibitMode){
				preventLinks()
			}

		}

		function preventLinks(){
		    var anchors = document.getElementsByTagName("a");
		    console.log(anchors)
		    for (var i = 0; i < anchors.length; i++) {
		        anchors[i].onclick = function() {return false;};
		    }
		}

		function legacySettings(){
			//console.log(settings);
			if(settings.sketches != null && typeof settings.sketches[0] != 'object'){
				let tc = timeDate();
				let order = settings.sketches;
				let newOrder = [];
				let oldDemos = ["aboutsketch", "bwEllipse", "easeFunction", "sinStrings", "wanderingWorm", "audioAnalysis", "webgl_sphereBox", "textToPoints", "basel.codes", "this is a really long name"];
				order.forEach(function(o){
					if(!oldDemos.includes(o)){
						newOrder.push({'name':o, 'type':'sketch', 'mod':tc});
					}
				});
				settings.sketches = newOrder;
				updateSettings();
			}

			if(searchJSON(settings.sketches, 'name', 'demos').length == 0 || settings.revision < currentRevision){
				//settings.refresh = false; // *** check this.. if needed?
				loadDemos();
			}
		}

		function getParam(paramSearch){
			let params = document.location.search.substring(1).split('&');
			for(let i=0; i<params.length; i++){
				let keyVal = params[i].split('=');
				if(keyVal[0] == paramSearch){
					
					// accept 1/0 for true/false
					// if(keyVal[1] === '1'){
					// 	keyVal[1] = true
					// }else if(keyVal[1] === '0'){
					// 	keyVal[1] = false
					// }
					return keyVal[1];
				}
			}
		}

		function clearParam(){
			window.history.replaceState(null, null, window.location.pathname);
		}

		function checkParam(paramSearch){
			return getParam(paramSearch) != undefined ? true : false
		}

		function boolParam(paramSearch){
			return JSON.parse(getParam(paramSearch))
		}

		// toggle extended P5LIVE nav buttons
		function toggleButtonsExtended(elm, display){
			let ebNav = document.getElementById('p5live-buttons-' + elm);
			let ebButton = document.getElementById('button-' + elm);

			if(ebNav.style.display !== display){
				ebNav.style.display = display;
				ebButton.style.background='#444';
			}else{
				ebNav.style.display = 'none';
				ebButton.style.background='#666';
			}

			resizeSketchesHolder();
		}

		function showButtonsExtended(elm, display){
			clearTimeout(hideButtonsTimer)
			Array.from(document.querySelectorAll(`.menu-sketches-buttons-extended`)).forEach((element,index) => {
				element.style.display = 'none';
			});
			
			let ebNav = document.getElementById('p5live-buttons-' + elm);
			let ebButton = document.getElementById('button-' + elm);

			ebNav.style.display = display;
			ebButton.style.background='#444';
			resizeSketchesHolder();
		}

		function hideButtonsExtended(elm, display){
			clearTimeout(hideButtonsTimer)
			let ebNav = document.getElementById('p5live-buttons-' + elm);
			let ebButton = document.getElementById('button-' + elm);

			hideButtonsTimer = setTimeout(()=>{
				ebNav.style.display = 'none';
				ebButton.style.background='#666';
				resizeSketchesHolder();
			}, 1000)	
		}



		/*	SKETCHES TASKS	*/
		// set settings to localstorage
		function updateSettings(){
			localStorage.setItem('settings', JSON.stringify(settings));
			if(settings.debugMode){console.log(getSettings());}
		}

		function showSettings(show){
			if(show){
				if(refVisible){
					closeRef();
				}

				if(settingsVisible){
					hideSettings();
					menuToggle(false);
				}else{
					settingsVisible = true;
					menuToggle(true);
				}

			}
			panelSettings.style.display = 'block';
			panelMenu.style.display = 'none';
			settingsVisible = true;
			snippetsPosition()
		}

		function hideSettings(){
			panelSettings.style.display = 'none';
			panelMenu.style.display = 'block';
			settingsVisible = false;
			snippetsPosition()
		}

		function resizeSketchesHolder(){
			let sectionHeader = menuSectionSketches.offsetHeight - sketchesHolder.offsetHeight;
			let offsetHeight = 0;
			let offsetItems = document.getElementsByClassName('menu-section-top');
			for(let oi of offsetItems){
				offsetHeight += oi.offsetHeight + 60; // add gap between panels
			}
			let sectionHeight = offsetHeight - 45; //remove last gap
			sketchesHolder.style.height = Math.floor(window.innerHeight - sectionHeight) + 'px';
		}

		let checkWindowResize, checkCans;
		window.onresize = function(){
			clearTimeout(checkWindowResize);
			menuResize.style.opacity = 1
			menuResize.innerHTML = `${window.innerWidth}x${window.innerHeight}`
			checkWindowResize = setTimeout(function(){
				resizeSketchesHolder();
				if(p5pop){
					setTimeout(collectCans, 500)		
				}
				menuResize.style.opacity = 0
			}, 500);

			
		};

		function resetSettings(){
			if(settings.cocoding.active){
				settingsCocodingWarning();
				return false;
			}
			vex.dialog.confirm({
				unsafeMessage: 'Reset to default settings?<br>Sketches will be left untouched.',
				callback: function (value) {
					if (value) {
						Object.keys(initSettings).forEach(function(k){
							if(k != 'sketches' && k != 'welcome'){
								settings[k] = initSettings[k];
							}
						});
						updateSettings();
						loadSettings();
					}
				},
				afterOpen: function(){
					vexClass(this.rootEl, 'vex-small')
				}
			})
		}

		function settingsCocodingWarning(){
			vex.dialog.alert({
				unsafeMessage:'Exit COCODING to change settings.',
				afterOpen: function(){
					vexClass(this.rootEl, 'vex-small')
				}
			});
		}

		function exportSettingsPrepare(){
			let jsonExport = {};
			jsonExport.doctype = 'P5L_SETTINGS';
			jsonExport.date = timeStamp();
			jsonExport.settings = {}
			Object.keys(settings).forEach(function(k){
				if(k != 'sketches'){
					jsonExport.settings[k] = settings[k];
				}
			});
			return jsonExport;
		}

		function exportSettings(){
			exportJSON(exportSettingsPrepare(), 'P5L_SETTINGS'+timeStampFile()+'.json');
		}

		function importSettings(data){
			if(settings.cocoding.active){
				settingsCocodingWarning();
				return false;
			}

			for(let i=0; i < data.length; i++){
				let reader = new FileReader();
				reader.onload = function(data) {
					let tSettings = JSON.parse(data.target.result);
					importSettingsParse(tSettings);
				}
				reader.readAsText(data[i]);
			}
		}

		function importSettingsParse(tSettings){
			if(tSettings.hasOwnProperty('doctype') && tSettings.doctype == 'P5L_SETTINGS'){
				let warnImport = 'Replace settings with imported file?';
				if(tSettings.revision < initSettings.revision){
					warnImport += '<br>Imported settings are from an earlier version of P5LIVE, hopefully this will work...';
				}

				// first confirm importing of settings
				vex.dialog.confirm({
					unsafeMessage:warnImport,
					callback: function(value){
						if(value){
							Object.keys(tSettings.settings).forEach(function(k){
								if(settings.hasOwnProperty(k)){
									if(k != 'version' && k != 'revision'){
										settings[k] = tSettings.settings[k];
									}
								}
							});
							updateSettings();
							loadSettings();
						}
					},
					afterOpen: function(){
						vexClass(this.rootEl, 'vex-small')
					}
				})
			}else{
				vex.dialog.alert({
					message:'Oops, select a P5L_SETTINGS file.'
				})
			}
		}

		function updateShortcuts(reset){
			updateSettings();
			shortcutRecording = false;
			Mousetrap.reset();
			Mousetrap.unpause();

			let shortcutsList = '';
			Object.keys(initSettings.shortcuts).forEach(function(sc, cc){
				let shortcut = settings.shortcuts[sc];
				let shortcutOG = initSettings.shortcuts[sc];
				// console.log(sc +" / "+ initSettings.shortcuts[sc])

				let shortcutKey = shortcutOG.key;
				if(shortcut !== undefined && shortcut.hasOwnProperty('key') && shortcut.key !== shortcutOG.key && !reset){
					shortcutKey = shortcut.key;
				}

				if(reset){
					settings.shortcuts[sc] = initSettings.shortcuts[sc];
				}

				if(shortcutOG.init != undefined){
					eval(shortcutOG.init);
				}else{
					Mousetrap.bind(shortcutKey, function(){
						if(settings.notifyToggle){
							showNotify = true;
						}
						eval(shortcutOG.callback);
						return false;
					}).stopCallback = function(e, element, combo) {};
				}

				let shortcutTippy = 'Click to modify shortcut';
				if(shortcutOG.tippy != undefined){
					shortcutTippy += '<br>' + shortcutOG.tippy;
				}

				if(!shortcutOG.hasOwnProperty('fixed')){
					shortcutsList +='<div class="shortcut-item tippy-left" data-title="' + shortcutTippy + '" onclick="recordShortcut(this, \''+sc+'\')">' + shortcutOG.name + ' <div class="shortcut-keys" ><span id="shortcut-' + sc + '" class="shortcut-input">' + parseShortcut(shortcutKey) + '</span></div></div>';
				}
				
			});
			settingsShortcuts.innerHTML = shortcutsList;
			loadTippy();

			if(reset){
					updateSettings()
			}
	}

		function parseShortcut(txt){
			let scParts = txt.split('+');
			for(let i=0; i<scParts.length;i++){
				switch(scParts[i].toLowerCase()){
					case 'meta':
						scParts[i] = '<span class="shortcut-key">⌘</span>'
					break;
					case 'ctrl':
						scParts[i] = '<span class="shortcut-key">CTRL</span>'
					break;
					default:
						scParts[i] = '<span class="shortcut-key">' + scParts[i].toUpperCase() + '</span>';
					break;
				}
			}
			return scParts.join('+');
		}

		function recordShortcut(elm, sc){
			if(shortcutRecording){
				updateShortcuts();
			}else{
				elm.classList.add('shortcut-ani');
				Mousetrap.pause();
				let shortcut = settings.shortcuts[sc];
				shortcutRecording = true;
				Mousetrap.record(function(sequence) {
					if(sequence.length == 1){ // only single combo
						let repeatShortcut = false;
						Object.keys(settings.shortcuts).forEach(function(ssc){
							let sshortcut = settings.shortcuts[ssc];
							if(sequence[0] == sshortcut.key || sequence[0] == shortcut.key){
								repeatShortcut = true;
							}
						});
						if(!repeatShortcut && shortcutRecording){
							console.log(shortcut.key);
							Mousetrap.unbind(shortcut.key)
							shortcut.key = sequence[0];
						}
					}
					updateShortcuts();
				});
			}
		}

		// setup quickjump shortcuts
		function setupJumpSketches(key){
			let keyBindings = [];
			for(let i=0; i < 10;i++){
				keyBindings.push(key+'+'+i);
			}
			Mousetrap.bind(keyBindings, function(e) {
				jumpSketches(e.key);
			});
		}

		// quick jump
		function jumpSketches(kc){
			let keySketch = kc - 1;
			if(keySketch == -1){keySketch = 9;}
			loadSketch(listSketches(settings.sketches)[keySketch]);
			sketchScrollIntoView(true);
		}

		// bug
		function loadBug(){
			if(!settings.cocoding.active){
				settings.safeMode = true;
				let bugName = settings.fileName;
				updateSettings();
				loadDefault();
				inspectItem(bugName);
			}
		}

		// set sketches list to localstorage
		function updateSketches(){
			updateSettings();
			initSortable();
		}

		var filterTimer, filterFullText = false
		function filterParse(){
			clearTimeout(filterTimer)
			filterTimer = setTimeout(filterFullText ? filterSketchesFullText : filterSketches, 500)
		}

		function filterToggleFullText(){
			filterFullText = !filterFullText
			let filterFull = document.getElementById('menu-sketches-filter-fulltext');
			filterParse()
			menuSketchesFilter.focus();

			if(filterFullText){
				filterFull.style.opacity = 1
			}else{
				filterFull.style.opacity = .5
			}
		}

		// search laundry list of sketches
		// inspired by: https://www.w3schools.com/howto/howto_js_filter_lists.asp
		function filterSketches(){
			// filterSketchesFullText()
			// return

			let demosFolder = document.getElementById('demofolder');
			let filterClear = document.getElementById('menu-sketches-filter-clear');
			let filter = menuSketchesFilter.value.toLowerCase().split(' ');
			let filterItems = menuSketches.getElementsByClassName('drag-item');

			// remove empty while adding another word
			// https://stackoverflow.com/a/19888749/10885535
			filter = filter.filter(Boolean);

			// remove filter from all
			for(let fi of filterItems){
				fi.classList.remove('filter');
				fi.classList.remove('filter-match');
			}

			// if chars typed
			if(filter != ''){
				filterClear.classList.add('pulse')

				// scroll back to top
				sketchesHolder.scrollTop = 0;

				
				// **** name only search
				for (let fi of filterItems) {

					// if item's name filtered
					let filterItemName = fi.getAttribute('data-id');

					// match separated words ***
					if ( filter.some((val) => filterItemName.toLowerCase().indexOf(val) !== -1)){
					// if (filterItemName.toLowerCase().indexOf(filter) > -1) {

						// add to filter items
						fi.classList.add('filter');

						// if item folder, filter-reveal all children
						if(fi.getAttribute('data-type') == 'folder'){
							fi.getElementsByClassName('menu-folder-svg')[0].innerHTML = icon.folderEmpty;
							let fiKids = fi.getElementsByClassName('drag-item');
							for(let fik of fiKids){
								fik.classList.add('filter');
								if(fik.getAttribute('data-type') == 'folder'){
									fik.getElementsByClassName('menu-folder-svg')[0].innerHTML = icon.folderEmpty;
								}
							}
						}

						// if item within folder, filter-reveal all parents
						let folderParents = getParentFolders(fi);
						for(let fp of folderParents){
							fp.classList.add('filter');
							fp.getElementsByClassName('menu-folder-svg')[0].innerHTML = icon.folderEmpty;
						}
					} else {
						// else hide item
						fi.style.display = 'none';
					}
				}

				

				// show all filtered items, mark matches
				let getFilters = menuSketches.getElementsByClassName('filter');
				for(let gf of getFilters){
					gf.style.display = 'block';
					let filterItemName = gf.getAttribute('data-id');

					// match separated words ***
					if (filterItemName != undefined && filter.some((val) => filterItemName.toLowerCase().indexOf(val) !== -1)){
					// if (filterItemName != undefined && filterItemName.toLowerCase().indexOf(filter) !== -1){
						gf.classList.add('filter-match');
					}
				}
				

				// hide demos (unless modifying)
				// if(demosFolder != undefined && demosLocked){
				// 	demosFolder.style.display = 'none';
				// }

				// change filter icon based on state
				filterClear.innerHTML = icon.x;
			}else{
				// show all if filter empty
				for (let fi of filterItems) {
					fi.style.display = '';
				}
				// if(demosFolder != undefined){
				// 	demosFolder.style.display = '';
				// }
				filterClear.innerHTML = icon.filter;
				filterClear.classList.remove('pulse')
				initSortable();
			}
		}

		let fullCode = []
		function filterSketchesFullText(){
			let demosFolder = document.getElementById('demofolder');
			let filterClear = document.getElementById('menu-sketches-filter-clear');
			let filter = menuSketchesFilter.value//.toLowerCase().split(' ');
			let filterItems = menuSketches.getElementsByClassName('drag-item');

			// remove empty while adding another word
			// filter = filter.filter(Boolean);

			// remove filter from all
			for(let fi of filterItems){
				fi.classList.remove('filter');
				fi.classList.remove('filter-match');
			}

			// test fullcode search
			if(fullCode.length == 0){
				for (var key in localStorage){
				   fullCode.push({filename:key, code:localStorage[key]})
				}
			}

			// if chars typed
			if(filter != ''){

				filterClear.classList.add('pulse')
				var results = fullCode.filter(item => String(item.code).includes(filter) || String(item.filename).includes(filter) );

				for (let fi of filterItems) {
					if(results.find(item => String(item.filename) == fi.getAttribute('data-id'))){
						fi.classList.add('filter');
						fi.classList.add('filter-match');
						fi.style.display = 'block';

						// if item folder, filter-reveal all children
						if(fi.getAttribute('data-type') == 'folder'){
							fi.getElementsByClassName('menu-folder-svg')[0].innerHTML = icon.folderEmpty;
							let fiKids = fi.getElementsByClassName('drag-item');
							for(let fik of fiKids){
								fik.classList.add('filter');
								if(fik.getAttribute('data-type') == 'folder'){
									fik.getElementsByClassName('menu-folder-svg')[0].innerHTML = icon.folderEmpty;
								}
							}
						}

						// if item within folder, filter-reveal all parents
						let folderParents = getParentFolders(fi);
						for(let fp of folderParents){
							fp.classList.add('filter');
							fp.getElementsByClassName('menu-folder-svg')[0].innerHTML = icon.folderEmpty;
						}

					}else{
						fi.style.display = 'none';
					}
				}


				// scroll back to top
				sketchesHolder.scrollTop = 0;

				// show all filtered items, mark matches
				let getFilters = menuSketches.getElementsByClassName('filter');
				for(let gf of getFilters){
					gf.style.display = 'block';
					let filterItemName = gf.getAttribute('data-id');

					// match separated words ***
					// if (filterItemName != undefined && filter.some((val) => filterItemName.toLowerCase().indexOf(val) !== -1)){
					// // if (filterItemName != undefined && filterItemName.toLowerCase().indexOf(filter) !== -1){
					// 	gf.classList.add('filter-match');
					// }
				}

				// change filter icon based on state
				filterClear.innerHTML = icon.x;
			}else{
				// show all if filter empty
				for (let fi of filterItems) {
					fi.style.display = '';
				}

				filterClear.innerHTML = icon.filter;
				filterClear.classList.remove('pulse')
				initSortable();
			}
		}

		function getParentFolders(elem) {
			var parents = [];
			while(elem.parentNode && elem.parentNode.nodeName.toLowerCase() == 'ul') {
				elem = elem.parentNode;
				parents.push(elem);
			}
			return parents;
		}

		// clear filter
		function filterSketchesClear(forceFocus){
			if(menuSketchesFilter.value == ''){
				if(forceFocus){
					menuSketchesFilter.focus();
				}
			}else{
				menuSketchesFilter.value = '';
				filterSketches();
			}
			sketchScrollIntoView(true);
		}

		// padding version numbers of sketch
		function pad(num, size) {
			let s = '0000' + num;
			return s.substr(s.length-size);
		}

		// use sketch versions instead of timestamp
		function versionCheck(sketchName, importObj){
			let tempName = sketchName;
			let forkScores = tempName.split('_');
			if(forkScores.length > 0){
				let forkVersion = forkScores[forkScores.length-1];
				if(!isNaN(forkVersion) && forkVersion.length == 3){
					forkScores[forkScores.length-1] = pad(parseInt(forkVersion)+1, 3);
				}else{
					forkScores.push('001');
				}
			}
			tempName = forkScores.join('_');

			// check entire sketches for dup version name
			if(importObj !== undefined){
				while(searchSketches(tempName, settings.sketches) || searchSketches(tempName, importObj)){
					tempName = versionCheck(tempName, importObj);
				}
			}else{
				while(searchSketches(tempName, settings.sketches)){
					tempName = versionCheck(tempName);
				}
			}

				return tempName;
		}

		// save sketch as...
		function cloneSketch(){
			if(settings.cocoding.active){
				cloneSketchCOCODING();
				return false;
			}

			let forkName = versionCheck(settings.fileName);
			let tc = timeDate();

			// cloning above sketch!
			let cloneLocation = jsonIndex('name', settings.fileName, settings.sketches);

			let checkDemo = document.querySelectorAll('[data-id="'+settings.fileName+'"]')[0].classList.contains('demo');
			let checkDir = searchJSON(settings.sketches, 'name', settings.fileName)[0];
			

			if(checkDir != undefined && checkDir.parent != undefined && checkDir.parent != 'demos' && !checkDemo || !demosLocked){
				let useDir = searchJSON(settings.sketches, 'name', checkDir.parent)[0];
				cloneLocation = jsonIndex('name', settings.fileName, useDir.contents);
				// console.log('clonelocation: '+cloneLocation)
				useDir.contents.splice(cloneLocation, 0, {'type':'sketch', 'name':forkName, 'mod':tc});
				// useDir.contents.unshift({'type':'sketch', 'name':forkName, 'mod':tc});
				useDir.toggle = 'expand';
			}else{
				settings.sketches.splice(cloneLocation, 0, {'type':'sketch', 'name':forkName, 'mod':tc});
			}

			settings.fileName = forkName;
			updateSettings();

			updateSketches();
			localStorage[settings.fileName] = editor.getValue();
			editor.focus();
			editor.session.off('change', cloneSketch);
			sketchScrollIntoView(true);
			notifyMsg('Cloned Sketch!')
		}

		function subSketch(dirName){
			let useDir = searchJSON(settings.sketches, 'name', dirName)[0];
			let forkName = versionCheck('new');
			let tc = timeDate();
			let cloneLocation = 0

			useDir.contents.splice(cloneLocation, 0, {'type':'sketch', 'name':forkName, 'mod':tc});
			useDir.toggle = 'expand';
			
			settings.fileName = forkName;
			localStorage[settings.fileName] = p5template;
			updateSettings();
			updateSketches();
			editor.focus();
			loadSketch(settings.fileName)
		}

		function jsonIndex(key, name, obj){
			let c = 0;
			for(let s of obj){
				if(s[key] == name){
					return c;
				}
				c++;
			}
		}

		function cloneSketchCOCODING(){
			let tc = timeDate();
			let forkSession = 'cc_'+settings.cocoding.namespace+'_'+settings.cocoding.timestamp;
			if(searchJSON(settings.sketches, 'name', forkSession).length == 0){
				addFolder(forkSession);
			}
			// let forkName = forkSession+'_'+timeStamp();
			let forkName = versionCheck(settings.fileName);

			settings.fileName = forkName;
			updateSettings();
			let forkObj = searchJSON(settings.sketches, 'name', forkSession)[0];
			forkObj.contents.unshift({'type':'sketch', 'name':forkName, 'mod':tc});
			forkObj.toggle = 'expand';
			updateSketches();
			localStorage[forkName] = editor.getValue();
		}

		// load sketch
		function loadSketch(sketch, lineNum){
			if(settings.cocoding.active){

				// **** temp off for testing code replace below
				vex.dialog.confirm({
					message: 'Exit COCODING?',
					callback: function (value) {
						if (value) {
							cocodingExit(sketch);

						}
					},
					afterOpen: function(){
						vexClass(this.rootEl, 'vex-small')
					}
				})


				// *** launch once better RGA solution for complete text replace is found
				/*
				if(settings.cocoding.level == 'admin'){
					vex.dialog.confirm({
						unsafeMessage:'Replace code with<br><hr><div class="code-replace-header">SketchName</div>'+sketch+'<br><div class="code-replace-header">SketchCode</div> <textarea id="code-replace-textarea" class="code-replace-textarea">'+localStorage[sketch]+'</textarea>',
						callback: function (value) {
							if (value) {
								let checkedCode = document.getElementById('code-replace-textarea').value;
								cocode.codeReplace({'code':checkedCode});
								//cocode.codeReplace({'code':localStorage[sketch]});
								// editor.setValue(localStorage[sketch], 1);
								// window.setTimeout(function(){cocode.recompile()}, 300);
								// window.setTimeout(function(){recompile(true)}, 400);
								return;
							}
						}
					})
				}else{
					if(settings.cocoding.writemode || !settings.cocoding.lockdown){
						vex.dialog.confirm({
							unsafeMessage: 'Request to replace code with:\n' + sketch,
							callback: function (value) {
								if (value) {
									cocode.codeReplaceRequest(settings.cocoding.nick, sketch, localStorage[sketch]);
								}
							}
						})
					}else{
						vex.dialog.alert({
							message:"Editor is locked, request to edit.",
							callback: function(){}
						})
					}
				}
				*/

			}else {
				// catch RECODING
				if(recodingCheck() && settings.fileName === 'recoding' && sketch !== settings.fileName){
					recodingStop()
					recodingScrub(0)
					// recodingReset(true)
				}else if(recodingCheck()){
					recodingStop()
					recodingScrub(0)
				}

				if(localStorage.hasOwnProperty(sketch)){
					editor.getSession().off('change', cloneSketch);
					// auto expand folder (incase of short-cut selection)
					recursiveFolderExpand(settings.sketches, sketch, '');
					settings.fileName = sketch;
					editor.setValue(localStorage[settings.fileName], 1);

					updateSketches();

					p5varsReset();

					// restart undo to prevent overwrite selected sketch
					editor.getSession().setUndoManager(new ace.UndoManager());
					if(!recodingCheck()){
						editor.focus();
					}
					let lineCount = editor.session.getLines(0, editor.session.getLength()).length;
					if(lineNum != undefined && lineCount >= lineNum){
						editor.gotoLine(lineNum, 1, false);
					}

					let checkDemo = searchJSON(settings.sketches, 'name', 'demos');//listSketches(settings.sketches.demo);
					if(searchSketches(settings.fileName, checkDemo) && demosLocked){
						// if(settings.fileName == 'new'){
							// window.location.hash = '#'; // *** removed for conflict w/ #bug + refs...
						// }
						if(settings.fileName !== 'recoding'){
							editor.getSession().on('change', cloneSketch);
						}
					}

					if(loader.style.display === 'none'){
						recompile(true);
						loadingInit = true
					}
				}else if(!localStorage.hasOwnProperty(sketch) && searchSketches(sketch, settings.sketches)){

					vex.dialog.confirm({
						message:'Sketch code missing, remove from list?',
						callback: function(value){
							if(value){
								removeItemProcess(sketch);
							}
						}
					})
				}else{
					// start new sketch
					if(listSketches(settings.sketches).length > 0){
						settings.fileName = loadLatest();
						updateSettings();
						loadSketch(settings.fileName);
					}else{
						loadDefault();
					}
				}
			}
		}

		window.addEventListener('beforeunload', function (e) {
			if(!settings.cocoding.active && !cocodingUnload){ // ignore if toggling COCODING
			    e.preventDefault();
			    let freq = settings.backup.frequency;
			    let lastBackup = settings.backup.last;

			    let dateLast = new Date(settings.backup.last)
				let dateNow = new Date();
				let timeDiff = Math.abs(dateNow.getTime() - dateLast.getTime());
				let diffDays = Math.ceil(timeDiff / (1000 * 3600 * 24));

			    switch(freq){
			    	case 1: // every exit
			    		backupSketches();
			    	break;
			    	case 2: // daily
			    		if(diffDays > 1){
			    			backupSketches();
			    		}
			    	break;
			    	case 3: // weekly
			    		if(diffDays > 7){
			    			backupSketches();
			    		}
			    	break;
			    	case 4: // monthly
			    		if(diffDays > 30){
			    			backupSketches();
			    		}
			    	break;
			    }
			}
		});

		function backupSketches(){
			let tempSketches = exportSketchesPrepare();
			tempSketches.sketches.settings = exportSettingsPrepare();
			tempSketches.timestamp = timeStampFile();

			if(!p5l.remote && p5l.fancy){
				let whichBrowser = getBrowser()
				if(whichBrowser != undefined && whichBrowser.hasOwnProperty('type')){
					tempSketches.browser = whichBrowser.type
				}else{
					tempSketches.browser = ''
				}
				serverMsg('/backup', tempSketches)
			}else{
				exportJSON(tempSketches.sketches, 'P5L_BACKUP' + tempSketches.timestamp + '.json');
			}

			settings.backup.last = new Date().getTime();
			updateSettings();
		}

		function serverMsg(path, data, cb){
			let tempPath = path
			let request = new XMLHttpRequest()
			request.open('POST', tempPath, true)
			request.setRequestHeader("Content-Type", "application/json;charset=UTF-8")
			request.onreadystatechange = () => {
				if (request.readyState === 4) {
					cb(request.response);
				}
			}
			request.send(JSON.stringify(data))
		}

		// https://gist.github.com/lyquix-owner/34a3ed98b990c3c61151d30de2f42702
		function getBrowser(){
			var ua = navigator.userAgent, browser;

			// helper functions to deal with common regex
			function getFirstMatch(regex) {
				var match = ua.match(regex);
				return (match && match.length > 1 && match[1]) || '';
			}

			function getSecondMatch(regex) {
				var match = ua.match(regex);
				return (match && match.length > 1 && match[2]) || '';
			}

			// start detecting
			if (/opera|opr/i.test(ua)) {
				browser = {
					name: 'Opera',
					type: 'opera',
					version: getFirstMatch(/version\/(\d+(\.\d+)?)/i) || getFirstMatch(/(?:opera|opr)[\s\/](\d+(\.\d+)?)/i)
				}
			}  else if (/msie|trident/i.test(ua)) {
				browser = {
					name: 'Internet Explorer',
					type: 'msie',
					version: getFirstMatch(/(?:msie |rv:)(\d+(\.\d+)?)/i)
				}
			} else if (/chrome.+? edge/i.test(ua)) {
				browser = {
					name: 'Microsft Edge',
					type: 'msedge',
					version: getFirstMatch(/edge\/(\d+(\.\d+)?)/i)
				}
			} else if (/chrome|crios|crmo/i.test(ua)) {
				browser = {
					name: 'Google Chrome',
					type: 'chrome',
					version: getFirstMatch(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)
				}
			} else if (/firefox/i.test(ua)) {
				browser = {
					name: 'Firefox',
					type: 'firefox',
					version: getFirstMatch(/(?:firefox)[ \/](\d+(\.\d+)?)/i)
				}
			} else if (!(/like android/i.test(ua)) && /android/i.test(ua)) {
				browser = {
					name: 'Android',
					type: 'android',
					version: getFirstMatch(/version\/(\d+(\.\d+)?)/i)
				}
			} else if (/safari/i.test(ua)) {
				browser = {
					name: 'Safari',
					type: 'safari',
					version: getFirstMatch(/version\/(\d+(\.\d+)?)/i)
				}
			} else {
				browser = {
					name: getFirstMatch(/^(.*)\/(.*) /),
					version: getSecondMatch(/^(.*)\/(.*) /)
				}
				browser.type = browser.name.toLowerCase().replace(/\s/g, '');
			}
			return browser;
		}

		// load top sketch
		function loadLatest(){
			return listSketches(settings.sketches)[0];
		}

		// pause sketch on demand
		function pauseSketch(){
			if(sketchLoaded){
				paused = !paused;
				if(paused){
					p5f.noLoop();
					if(showNotify){
						notifyMsg('Paused');
					}
				}else{
					p5f.loop();
					if(showNotify){
						notifyMsg('Resumed');
					}
				}
			}
		}

		function searchSketches(sketchName, obj){
			let sketchesFlat = JSON.stringify(obj);
			if( sketchesFlat.indexOf('"' + sketchName + '"') > -1 ) {
				return true;
			}else{
				return false;
			}
		}

		function cloneJSON(obj){
			return JSON.parse(JSON.stringify(obj));
		}

		function searchJSON(obj, key, value, out, dir) {
			if(out == undefined){
				out = [];
			}
			if(Array.isArray(obj)){
				obj.forEach(function(o){
					if(o[key] == value){
						if(dir !== undefined){
							o.parent = dir;
						}
						out.push(o);
					}else if(o.contents){ // *** else if or just if??
						searchJSON(o.contents, key, value, out, o.name);
					}
				});
			}

			return out;
		}

		function filterJSON(obj, key, value, out, dir) {
			if(out == undefined){
				out = [];
			}
			if(Array.isArray(obj)){
				obj.forEach(function(o){
					if(o[key] == value){
						if(dir !== undefined){
							o.parent = dir;
						}
						if(o.type == 'folder'){
							for( var i = 0; i < o.contents.length; i++){
								if(o.contents[i].dup){
									o.contents.splice(i, 1);
								}
							}
							out.push(o);
						}

						if(o.type == 'sketch'){
							if(!searchSketches(o.name, out)){
								out.push(o);
							}
						}
					}

					if(o.contents){ // *** else if or just if??
						filterJSON(o.contents, key, value, out, o.name);
					}
				});
			}

			return out;
		}



		/* IMPORT/EXPORT SKETCHES */

		function exportJSON(jsonData, jsonFilename){
			const filename = jsonFilename;
			const jsonStr = JSON.stringify(jsonData, undefined, 2);

			let element = document.createElement('a');
			element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(jsonStr));
			element.setAttribute('download', filename);
			element.style.display = 'none';
			document.body.appendChild(element);
			element.click();
			document.body.removeChild(element);
		}

		function exportJS(jsonData, jsonFilename){

			let sketchDetails = jsonData.structure[0]

			// code
			// let fileDetails = jsonData.structure[0]
			// let fileCode = sketchDetails.code
			// delete sketchDetails.code
			// console.log(fileCode)
			// console.log(sketchDetails)

			let fileHeader = {P5LIVE: {name:sketchDetails.name, mod:sketchDetails.mod}}

			let fileText = `// ${JSON.stringify(fileHeader)} \n\n${sketchDetails.code}`
			// console.log(fileText)
			const data = new Blob([fileText], {type: 'text/plain'});
			const a = document.createElement('a')
			a.style.display = 'none'
			a.download = jsonFilename//`P5L-${timestamp}.js`
			a.href = URL.createObjectURL(data)
			a.click()

			setTimeout(() => {
				window.URL.revokeObjectURL(a.href);
			}, 300);
		}

		// export single sketch to JSON
		// function exportSketch(sketch, customTimestamp){
		// 	let tempSketches = {};
		// 	tempSketches.version = settings.version;
		// 	tempSketches.revision = settings.revision;
		// 	tempSketches.count = {sketches:1, folders:0};
		// 	tempSketches.structure = [];

		// 	let sketchDetails = searchJSON(settings.sketches, 'name', sketch)[0];
		// 	if(settings.cocoding.active && customTimestamp !== undefined){
		// 		sketchDetails = {};
		// 		sketchDetails.name = settings.fileName;//settings.cocoding.namespace + '_snapshot';
		// 		sketchDetails.mod = timeDate();
		// 		sketchDetails.type = 'sketch';
		// 		sketchDetails.code = editor.getValue();
		// 	}else if(localStorage.hasOwnProperty(sketch)){
		// 		sketchDetails.code = localStorage.getItem(sketch);
		// 	}else{
		// 		alertMsg('Sketch code missing...');
		// 		return false;
		// 	}

		// 	tempSketches.structure.push(sketchDetails);
		// 	let tempTimestamp = timeStampFile(sketchDetails.mod);

		// 	if(customTimestamp !== undefined){
		// 		tempTimestamp = customTimestamp;
		// 	}
		// 	exportJSON(tempSketches, 'P5L_' + sketch + tempTimestamp + '.json');
		// }

		// export single sketch to JS
		function exportSketch(sketch, customTimestamp){
			let tempSketches = {};
			tempSketches.version = settings.version;
			tempSketches.revision = settings.revision;
			tempSketches.count = {sketches:1, folders:0};
			tempSketches.structure = [];

			let sketchDetails = searchJSON(settings.sketches, 'name', sketch)[0];
			if(sketch == 'editor' || (settings.cocoding.active && customTimestamp !== undefined)){
				sketchDetails = {};
				sketchDetails.name = settings.fileName;//settings.cocoding.namespace + '_snapshot';
				sketchDetails.mod = timeDate();
				sketchDetails.type = 'sketch';
				sketchDetails.code = editor.getValue();
			}else if(localStorage.hasOwnProperty(sketch)){
				sketchDetails.code = localStorage.getItem(sketch);
			}else{
				alertMsg('Sketch code missing...');
				return false;
			}

			// check for audio/midi snippet (only html export!)
			if(checkCodeMatch(sketchDetails.code, ['setupAudio', 'updateAudio'])){
				// sketchDetails.code += `\n\n ${p5liveUtils.audio}`
				sketchDetails.code += `\n\n/* \nP5LIVE - Audio\nIf using outside P5LIVE, include p5live-audio.js \nhttps://cdn.jsdelivr.net/gh/ffd8/P5LIVE/includes/utils/p5live-audio.js\n*/`
			}

			if(checkCodeMatch(sketchDetails.code, ['setupMidi', 'updateMidi'])){
				// sketchDetails.code += `\n\n ${p5liveUtils.midi}`
				sketchDetails.code += `\n\n/* \nP5LIVE - Midi\nIf using outside P5LIVE, include p5live-midi.js \nhttps://cdn.jsdelivr.net/gh/ffd8/P5LIVE/includes/utils/p5live-midi.js\n*/`
			}
			
			tempSketches.structure.push(sketchDetails);
			let tempTimestamp = timeStampFile(sketchDetails.mod);

			if(customTimestamp !== undefined){
				tempTimestamp = customTimestamp;
			}

			exportJS(tempSketches, 'P5L_' + sketchDetails.name + tempTimestamp + '.js');
		}

		function checkCodeMatch(code, words){
			let sketchTest = code.replace(/(?:\r\n|\r|\n|\t)/g, '');
			let regex = new RegExp(`(?=${words.join("|")}).*`, "gm");
			let sketchScriptsString = sketchTest.match(regex);
			return sketchScriptsString != null ? true : false
		}

		// export all/folder[s] w/ sketches to JSON
		function exportSketchesPrepare(folder){
			let tempSketches = {}, objCopy, tempType;
			tempSketches.version = settings.version;
			tempSketches.revision = settings.revision;

			if(folder !== undefined){
				let folderObj = searchJSON(settings.sketches, 'name', folder);
				objCopy = cloneJSON(folderObj);
				tempType = 'FOLDER_'+ folder+'';
			}else{
				objCopy = cloneJSON(settings.sketches);
				tempType = 'SKETCHES';
			}
			if(!demosLocked && folder === 'demos'){
				tempSketches.structure = exportAddCode(objCopy, true);
			}else{
				tempSketches.structure = exportAddCode(objCopy);
			}

			// remove demos
			if(demosLocked){
				tempSketches.structure = tempSketches.structure.filter(function( obj ) {
					return obj.name !== 'demos';
				});
			}

			let folderCount = findValues(tempSketches.structure, 'type', 'folder', 'name').length;
			tempSketches.count = {sketches:listSketches(tempSketches.structure).length, folders:folderCount};

			return {'sketches':tempSketches, 'type':tempType};
		}

		function exportSketches(folder){
			let tempSketches = exportSketchesPrepare(folder);
			exportJSON(tempSketches.sketches, 'P5L_' + tempSketches.type + timeStampFile() + '.json');
		}

		function exportPurgeDemos(obj){
			let objPurge = [];

			return obj;
		}

		function exportAddCode(objStructure, allowDemos) { // obj
			for (let k in objStructure) {
				let ric = objStructure[k];

				if(ric.type == 'sketch'){
					if(localStorage.hasOwnProperty(ric.name)){
						ric.code = localStorage.getItem(ric.name);
					}
				}

				// if folder, recurse deeper
				if(ric.type == 'folder' && (ric.name != 'demos') || allowDemos){
					ric.contents = exportAddCode(ric.contents, allowDemos);
				}
			};
			return objStructure;
		}


		function listSketches(obj){
			return findValues(obj, 'type', 'sketch', 'name');
		}

		function findValues(obj, key, filter, saveKey){
			return findValuesHelper(obj, key, filter, saveKey, []);
		}

		function findValuesHelper(obj, key, filter, saveKey, list) {
			if (!obj) return list;
			if (obj instanceof Array) {
				for (let i in obj) {
					list = list.concat(findValuesHelper(obj[i], key, filter, saveKey, []));
				}
				return list;
			}
			if (obj[key] && obj[key] == filter) list.push(obj[saveKey]);

			if ((typeof obj == 'object') && (obj !== null) ){
				let children = Object.keys(obj);
				if (children.length > 0){
					for (let i = 0; i < children.length; i++ ){
						list = list.concat(findValuesHelper(obj[children[i]], key, filter, saveKey, []));
					}
				}
			}
			return list;
		}

		// share CODE via URL
		function linkCode(elm){
			let baseCode = utf8_to_b64(editor.getValue())
			// let dummy = document.createElement('input');
			// document.body.appendChild(dummy);
			// dummy.value = 'https://p5live.org/?code=' + baseCode;
			// dummy.select();
			// document.execCommand('copy');
			// document.body.removeChild(dummy);
			clipboard('https://p5live.org/?code=' + baseCode);

			// share info
			let oldContent = elm._tippy.props.content;
			elm._tippy.setContent('Copied to clipboard!');
			elm._tippy.show(200);
			setTimeout(function(){
				elm._tippy.hide();
				elm._tippy.setContent(oldContent);
			}, 2000);

		}

		function clipboard(txt){
			let dummy = document.createElement('input');
			document.body.appendChild(dummy);
			dummy.value = txt;
			dummy.select();
			document.execCommand('copy');
			document.body.removeChild(dummy);
		}

		function clipboardLines(elm){
			let txt = document.getElementById(elm).innerText;

			// modified from: https://stackoverflow.com/a/50230647/10885535
			let dummy = document.createElement('textarea');
		    dummy.innerHTML = txt;
		    document.body.appendChild(dummy);
		    dummy.select();
		    document.execCommand('copy');
		    document.body.removeChild(dummy);
		}

		// https://developer.mozilla.org/de/docs/Web/API/WindowOrWorkerGlobalScope/btoa
		function utf8_to_b64(str) {
			return window.btoa(unescape(encodeURIComponent(str)));
		}

		function b64_to_utf8(str) {
			return decodeURIComponent(escape(window.atob(str)));
		}


		// DRAG + DROP
		let divDrop = document.getElementById('p5-drop');
		let myDropzone = new Dropzone(document.body, {
			autoProcessQueue: false,
			url: '/data', // unused but needed for URL expectation
			acceptedFiles:'.json, .js',
			clickable:false,
			init: function() {
				this.on('addedfile', function(file, responseText) {
					// let loadedRecoding = recodingImport(file)
					// if(!loadedRecoding){
					// if(file.accepted){ // not working..
						importSketches(myDropzone.files);
					// }
					// }
					divDrop.style.display = 'none';
					myDropzone.files = []; // clear list
				});
				this.on('dragenter', function(file, responseText) {
					// console.log(event.dataTransfer.dropEffect)
					if(event.dataTransfer.dropEffect != 'move' && !document.hasFocus()){
						divDrop.style.display = 'block';
					}
				});
				this.on('dragleave', function(file, responseText) {
					divDrop.style.display = 'none';
				});
				this.on('drop', function(file, responseText) {
					divDrop.style.display = 'none';
				});
				this.on('dragover', function(file, responseText) {
					// event.preventDefault();
					// console.log(event.dataTransfer.dropEffect);
					if(event.dataTransfer.dropEffect != 'move' && !document.hasFocus()){
						divDrop.style.display = 'block';
					}
				});
				this.on('error', function(file, responseText) {
					badImport();
					myDropzone.files = []; // clear list
				});
			},
		});

		function badImport(customType){
			let type = '.json + .js';
			if(customType !== undefined){
				type = customType;
			}
			vex.dialog.alert({
				unsafeMessage:'Error importing. <br>Only P5LIVE '+type+' are accepted.',
			})
		}

		function IsJsonString(str) {
		  try {
		    let json = JSON.parse(str);
		    return (typeof json === 'object');
		  } catch (e) {
		    return false;
		  }
		}

		function importSettingsDialog(){
			document.getElementById('file-input-settings').click();
		}

		function importSketchesDialog(){
			document.getElementById('file-input').click();
		}

		// import sketches from JSON
		function importSketches(data){
			loaderSub.innerHTML = 'checking duplicates...';
			showLoader();
			for(let i=0; i < data.length; i++){
				let reader = new FileReader();
				reader.onload = function(data) {
					if(!IsJsonString(data.target.result)){
						hideLoader();
						let importLines = data.target.result.split('\n')
						let header = importLines[0].substring(3, importLines[0].length)

						let tc = timeDate();
						let filename = versionCheck('new');
						if(IsJsonString(header)){
							header = JSON.parse(header).P5LIVE
							filename = versionCheck(header.name);
							tc = header.mod
							importLines.splice(0, 2)
						}
							// console.log([forkName, tc])

						// console.log(importLines.join('\n'))
						// return

						// let forkSession = 'cc_'+settings.cocoding.namespace+'_'+settings.cocoding.timestamp;
						// if(searchJSON(settings.sketches, 'name', forkSession).length == 0){
						// 	addFolder(forkSession);
						// }
						// let forkName = forkSession+'_'+timeStamp();

						// settings.fileName = filename;
						// updateSettings();
						// settings.sketches.unshift({'type':'sketch', 'name':filename, 'mod':tc});
						// updateSketches();
						// localStorage[filename] = importLines.join('\n');
						// loadSketch(loadLatest());
						// setTimeout(function (){sketchScrollIntoView(true);}, 100);

						let tempStructure = [{'type':'sketch', 'name':filename, 'mod':tc, 'code':importLines.join('\n')}]
						importSingle(tempStructure)


						return;
					}else{
						let jsonObj = JSON.parse(data.target.result);
						let jsonObjList = JSON.parse(data.target.result);
						let isBackup = false, isBackupSettings = false, isBackupSketches = false;
						if(jsonObj.hasOwnProperty('settings') && jsonObj.settings.hasOwnProperty('doctype')){
							if(jsonObj.settings.doctype === 'P5L_SETTINGS'){
								isBackup = true;
							}

						}

						if(jsonObj.hasOwnProperty('type') && jsonObj.type === 'RECODING'){
							if(recoding.elms.range !== undefined){
								recoding.elms.range.value = 0
							}
							recodingToggle()
							recoding.reset()
							recoding.init()
							recoding.session.history = jsonObj.data
							recoding.scrubSet()
							recoding.init()
							recodingPlay()
							return false
						}

						if(jsonObj.hasOwnProperty('structure')){
							let count, importData;
							let jsonStructure = jsonObjList.structure;
							recursiveDupCheck(jsonStructure); // flag dups
							let jsonStructureDups = filterJSON(cloneJSON(jsonStructure), 'dup', false);

							// console.log(jsonStructureDups);
							// console.log(recursiveDupFilter(jsonStructure))
							//recursiveDupFilter(jsonStructure);
							//console.log(filterJSON(jsonStructure, 'dup', false));

							// let jsonStructureSorted = jsonObj.structure.reverse();

							if(demosLocked){
								jsonStructure = jsonStructure.filter(function( obj ) {
									return obj.name !== 'demos';
								});
								if(jsonStructure.length === 0){
									return false;
								}
							}


							// console.log(jsonStructure)
							// console.log(recursiveDupCheck(jsonStructureDups));

							// hideLoader();
							// return false;

							if(!legacyImport(jsonObj)){
								// immediately import if single sketch, ask to load
								if(jsonObj.count.sketches === 1 && jsonObj.structure[0].type === 'sketch'){
									hideLoader();
									importSingle(jsonStructure)
									return;
								}
								count = jsonObj.count.sketches;
								importData = 'Import the following <span id="import-count">('+count+')</span> sketches?<br>';

								if(isBackup){
									importData = 'P5LIVE Backup Detected! <br><br>SETTINGS:<br><input type="checkbox" id="backup-settings" name="backup-settings" checked> Import settings?<br><br>SKETCHES:<br><input type="checkbox" id="backup-sketches" name="backup-sketches" checked onchange="toggleImport(this.checked)"> Import sketches <span id="import-count">('+count+')</span>?<br>' ;
								}
							}else{
								count = (JSON.stringify(jsonObjList.structure).match(/name/g) || []).length;
								if(searchJSON(jsonObjList.structure, 'name', 'demos').length > 0){
									count -= searchJSON(settings.sketches, 'name', 'demos')[0].contents.length;
								}
								importData = 'Import the following ('+count+') sketches?<br>';
							}

							let importDupFound = false;
							for (let key in jsonStructure) {
								if(searchSketches(jsonStructure[key].name, settings.sketches) && jsonStructure[key].name.toLowerCase() != 'demos'){
									importDupFound = true;
								}
							}
							if(importDupFound){
								importData += '<span id="dups-check"><input id="dups-checkbox" type="checkbox" onchange="toggleDups(this.checked, '+count+');"> <span class="importdump-dup">Skip duplicates?</span></span><br>';
							}
							importData += '<div id="importdump">';
							importData += recursiveImportWarning(jsonStructure, '', '');
							importData += '</div>';
							// *** add checkbox to ignore duplicates on import...

							hideLoader();
							// first confirm importing of whole structure/sketches
							vex.dialog.confirm({
								unsafeMessage:importData,
								callback: function(value){
									if(value){
										let dupsCheckbox = false;
										if(importDupFound){
											dupsCheckbox = document.getElementById('dups-checkbox').checked;
										}
										if(isBackup){
											isBackupSettings = document.getElementById('backup-settings').checked;
											isBackupSketches = document.getElementById('backup-sketches').checked;

										}

										if(!isBackup || (isBackup && isBackupSketches)){
											loaderSub.innerHTML = 'importing sketches...';
											showLoader();
											if(legacyImport(jsonObj)){
												let legacyDemos = ["new", "P5LIVE_meta", "P5LIVE_COCODING_meta", "bwEllipse", "easeFunction", "sinStrings", "wanderingWorm", "audioAnalysis", "webgl_primatives", "webgl_sphereBox", "slidersGrid", "textToPoints", "basel.codes", "this is a really long name", "osc_setup", "midi_setup"];
												jsonStructure.forEach(function(jsonItem){
													if(jsonItem.mod === undefined){
														jsonItem.mod = timeDate();
													}
													if(jsonItem.type == 'folder' && (jsonItem.name.toLowerCase() != 'demos' || searchJSON(settings.sketches, 'name', 'demos').length == 0)){
														// foreach folder/sketch check duplicates and give unique names

														// each base folder
														if(searchSketches(jsonItem.name, settings.sketches)){
															jsonItem.name += '_'+ timeStamp(); //versionCheck(jsonItem.name);
														}

														// each recursive sketch/folder within
															recursiveNamecheck(jsonItem.contents, jsonObj.sketches);

														// add structure to top of sketches list
														settings.sketches.unshift({'type':'folder', 'name':jsonItem.name, 'mod':jsonItem.mod, 'toggle':jsonItem.toggle, 'contents':jsonItem.contents});

													}else if(jsonItem.type == 'sketch'){

														if(legacyDemos.indexOf(jsonItem.name) == -1){
															settings.sketches.unshift({'type':'sketch', 'name':jsonItem.name, 'mod':jsonItem.mod});
														}
													}
												})
												updateSettings();
												initSortable();
												//updateSketches();

												// import structure as folder..
												parseSketches(jsonObj, legacyDemos);
											}else{
												// new importer from r34
												//console.log(dupsCheckbox)
												importSketchesParser(jsonStructure.reverse(), dupsCheckbox);
												hideLoader();
											}
											hideLoader();
										}
										// if backup, check settings import
										if(isBackupSettings){
											importSettingsParse(jsonObj.settings);
										}

									}

								},
								afterOpen: function(){
									vexFocus();
								}
							})
						}else{
							// import single sketch w/o confirm dialog
							if(legacyImport(jsonObj)){
								checkDupSketches(jsonObj, 'sketchName');
								parseSketches(jsonObj);
								hideLoader();
							}else{
								hideLoader();
								badImport('SKETCHES');
								return false;
							}
						}	
					}

					
				}
				reader.readAsText(data[i]);
			}
			hideLoader();
		}

		function importSingle(jsonStructure){
			let importText = `Load Imported Sketch?`
			if(!jsonStructure[0].name.includes('new_')){
				importText += '<br><div id="importdump"><div class="import-sketch">'+icon.fileLines+' ' + jsonStructure[0].name+'</div></div>'
			}
			vex.dialog.confirm({
			unsafeMessage: importText,
			callback: function (value) {
				if (value) {
					importSketchesParser(jsonStructure, false);
					loadSketch(loadLatest());
					setTimeout(function (){sketchScrollIntoView(true);}, 100);
				}
			},
			afterOpen: function(){
				vexClass(this.rootEl, 'vex-small')
			}
		})
		}

		function toggleImport(importsCheck){
			let imports = document.getElementById('importdump');
			let importDup = document.getElementById('dups-check');
			let importDupCheck = document.getElementById('dups-checkbox');

			imports.style.opacity = 1.0;
			if(!importsCheck){
				imports.style.opacity = .25;
			}

			if(importDup !== null){
				importDup.style.opacity = 1.0;
				importDupCheck.disabled = false;
				if(!importsCheck){
					importDup.style.opacity = .25;
					importDupCheck.disabled = true;
				}
			}
		}

		function toggleDups(skipDups, count){
			let importCount = document.getElementById('import-count');
			let dups = document.getElementById('importdump').getElementsByClassName('import-sketch dup');
			let contents = document.getElementById('importdump').getElementsByClassName('import-contents');
			let dirs = document.getElementById('importdump').getElementsByClassName('import-folder');
			console.log(count +" / "+dups.length);
			for(let d of dups){
				d.style.display = "block";
				importCount.innerHTML = count;
				if(skipDups){
					d.style.display = "none";
					importCount.innerHTML = count - (dups.length);
				}
			}
			for(let d of dirs){
				d.style.display = "block";
				let dContents = d.parentNode.childNodes;
				let dCount = dContents.length;
				for(let dc of dContents){
					if(dc.style.display == 'none'){
						dCount--;
					}
				}
				if(dCount <= 1){
					d.style.display = "none";
				}
				// console.log(dContents.length +" / "+ dCount)
				// if(d.childNodes.length == 0){
				// 	d.parentNode.style.display = "none";
				// }
			}

			// for(let d of contents){
			// 	d.style.display = "block";
			// 	let dContents = d.getElementsByClassName('import-sketch');
			// 	let dCount = dContents.length;
			// 	// console.log(dContents)
			// 	for(let dc of dContents){
			// 		if(dc.style.display == 'none'){
			// 			dCount--;
			// 		}
			// 	}
			// 	if(dCount <= 1){
			// 		d.style.display = "none";
			// 	}
			// }
			// console.log(objDup)
			// console.log(objNormal)
		}

		function legacyImport(obj){
			if(obj.hasOwnProperty('revision')){
				if(obj.revision === undefined || obj.revision < 34){
					return true;
				}else{
					return false;
				}
			}else if(obj.hasOwnProperty('sketches')){
				return true;
			}else{
				return false;
			}
		}

		function importSketchesParser(importObj, skipDups){
			if(demosLocked){
				importObj = importObj.filter(function( obj ) {
					return obj.name !== 'demos';
				});
			}

			if(skipDups){
				importObj = filterJSON(importObj, 'dup', false)
			}
			//console.log(importObj)

			recursiveImportDup(importObj, importObj);
			importObj.forEach(function(jsonItem){
				if(jsonItem.type == 'folder'){
					settings.sketches.unshift({'type':'folder', 'name':jsonItem.name, 'mod':jsonItem.mod, 'toggle':jsonItem.toggle, 'contents':jsonItem.contents});
				}else if(jsonItem.type == 'sketch'){
					// if(!skipDups || (skipDups && jsonItem.hasOwnProperty('dups') && !jsonItem.dups)){
						settings.sketches.unshift({'type':'sketch', 'name':jsonItem.name, 'mod':jsonItem.mod});
					// }

				}
			});
			updateSettings();
			initSortable();
			recursiveImportCode(importObj); // add code after sketches menu updated
		}

		function recursiveNames(obj, outputData){
			if(outputData === undefined){
				outputData = [];
			}
			for (let k in obj) {
				let ric = obj[k];

				// grab all names
				if(ric.type == 'sketch'){
					outputData.push(ric.name);
				}

				// if folder, go deeper
				if(ric.type == 'folder'){
					outputData.push(ric.name);
					recursiveNames(ric.contents, outputData);
				}
			};
			return outputData;
		}

		function recursiveImportDup(obj, objHold){
			for (let k in obj) {
				let allNames = recursiveNames(objHold);
				let ric = obj[k];

				if(searchSketches(ric.name, settings.sketches)){
					ric.name = versionCheck(ric.name, allNames);
				}

				delete ric['dup'];

				// if folder, go deeper
				if(ric.type == 'folder'){
					recursiveImportDup(ric.contents, obj);
				}
			};
		}

		function recursiveImportCode(obj){
			for (let k in obj) {
				let ric = obj[k];

				// if sketch, add to localStorage
				if(ric.type == 'sketch'){
					localStorage.setItem(ric.name, ric.code);
				}

				// if folder, go deeper
				if(ric.type == 'folder'){
					recursiveImportCode(ric.contents);
				}
			};
		}

		function recursiveDupCheck(obj, objHold){
			for (let k in obj) {
				let ric = obj[k];
				ric.dup = false;

				if(searchSketches(ric.name, settings.sketches)){
					ric.dup = true;
				}

				// if folder, go deeper
				if(ric.type == 'folder'){
					recursiveDupCheck(ric.contents, obj);
				}
			};
		}

		// function recursiveDupFilter(obj, objHold, level){
		// 	if(objHold === undefined){
		// 		objHold = [];//JSON.parse(JSON.stringify(obj));
		// 	}
		// 	if(level === undefined){
		// 		level = 0;
		// 	}

		// 	// searchJSON(obj, key, value, out, dir)
		// 	let objCopy = cloneJSON(obj);
		// 	if(level > 0){
		// 		obj = obj.contents;
		// 	}
		// 	for (let k in obj) {
		// 		let ric = obj[k];
		// 		// ric.dup = false;

		// 		// !searchSketches(ric.name, settings.sketches)
		// 		if(level == 0 && ric.type == 'sketch' && !ric.dup){
		// 			objHold.push(ric);
		// 			//delete obj[k];
		// 		}

		// 		// if(ric.type == 'folder'){
		// 		// 	// curFolder = ric.name;
		// 		// 	if(!searchSketches(ric.name, settings.sketches)){
		// 		// 		let objContents = ric.contents;
		// 		// 		objHold.push(ric);
		// 		// 		// ric.dup = true;
		// 		// 	}
		// 		// 	recursiveDupFilter(ric.contents, objHold);
		// 		// }

		// 		// if(!searchSketches(ric.name, settings.sketches)){
		// 		// 	objHold.push(ric);
		// 		// 	// ric.dup = true;
		// 		// }

		// 		// if folder, go deeper
		// 		if(ric.type == 'folder'){
		// 			// console.log(ric.contents.length);
		// 			if(!searchSketches(ric.name, settings.sketches)){
		// 				objHold.push(ric);
		// 				//ric.dup = true;
		// 			}
		// 			recursiveDupFilter(ric, objHold, level+1);
		// 		}
		// 	};
		// 	console.log(objHold)

		// 	//return objHold;
		// }

		function recursiveImportWarning(objStructure, level, outputData) {
			for (let k in objStructure) {
				let ric = objStructure[k];
				let ricDup = '';

				if(searchSketches(ric.name, settings.sketches)){
					// ricDup = 'class="importdump-dup"';
					ricDup = 'dup"';
					// if(ric.type == 'folder'){
					// 	ricDup = 'class="importdump-dup-folder"';
					// }
					// ric.name += '_'+ timeStamp(); // versionCheck(rnc.name);
				}

				// if sketch, update sketches name too
				if(objStructure[k].type == 'sketch'){
					outputData += '<div class="import-sketch '+ricDup+'">' + level + icon.fileLines +'<span>'+ ric.name + '</span></div>';
				}

				// if folder, recurse deeper
				if(ric.type == 'folder' && ric.name != 'demos'){
					outputData += '<div class="import-contents">';
						outputData += '<div class="import-folder '+ricDup+'">' + level + icon.folderEmpty +'<span>'+ ric.name + '</span></div>'; //  '+ricDup+' // removed from folder...
						outputData = recursiveImportWarning(ric.contents, '&nbsp;&nbsp;'+level, outputData);
					outputData += '</div>';
				}
			};
			return outputData;
		}

		// recursively check for duplicate names when importing ( < r34) or removing
		function recursiveNamecheck(objStructure, objSketches) { // obj
			for (let k in objStructure) {
				let rnc = objStructure[k];
				let rncDup = false;
				let rncPName = rnc.name;

				// if duplicate, give unique name
				if(searchSketches(rnc.name, settings.sketches)){ // && rnc.type == 'sketch'
					rnc.name += '_'+ timeStamp(); // versionCheck(rnc.name);
					fixNamecheck(objSketches, rncPName, rnc.name);
				}

				// if folder, recurse deeper
				if(rnc.type == 'folder'){
					recursiveNamecheck(rnc.contents, objSketches);
				}
			};
		}

		// fix any duplicate names
		function fixNamecheck(obj, oldName, newName){
			for (let i = 0; i < obj.length; i++) {
				if (obj[i]['sketchName'] === oldName) {
					obj[i]['sketchName'] = newName;
				}
			}
		}

		// fix any duplicates on single file imports
		function checkDupSketches(obj, keyName){
			let jsonSketches = obj.sketches;
			for(let i=0; i < jsonSketches.length; i++){
				if(searchSketches(jsonSketches[i][keyName], settings.sketches)){
					jsonSketches[i][keyName] = versionCheck(jsonSketches[i][keyName]);
				}
			}
		}

		// recursively check folder containing sketch
		function recursiveFolderExpand(objStructure, sketch, curFolder) { // obj
			for (let key in objStructure) {
				// sketch, update sketches name too
				if(objStructure[key].type == 'sketch' && objStructure[key].name == sketch){
					if(curFolder!= '' && curFolder.toggle != 'expand'){
						curFolder.toggle = 'expand';
						initSortable();
					}
				}

				// if folder, recurse deeper
				if(objStructure[key].type == 'folder'){
					recursiveFolderExpand(objStructure[key].contents, sketch, objStructure[key]);
				}
			};
		}

		// load demos
		function loadDemos(force = false){
			let demosPath = 'includes/demos/P5L_demos.json?' + currentRevision;
			if(force){
				demosPath = 'includes/demos/P5L_demos.json?' + currentRevision + timeStamp();
			}
			let request = new XMLHttpRequest();
			request.open('GET', demosPath, true);
			request.send();
			request.addEventListener('load', function(){
				if(searchSketches('demos', settings.sketches)){
					removeItemProcess('demos');
				}
				let jsonObj = JSON.parse(request.responseText);
				let jsonItem = jsonObj.structure[0];

				settings.sketches.push({'type':'folder', 'name':jsonItem.name, 'mod':jsonItem.mod, 'toggle':jsonItem.toggle, 'contents':jsonItem.contents});

				updateSettings();
				initSortable();
				recursiveImportCode(jsonObj.structure);

				if(settings.fileName == 'new'){
					loadDefault();
				}
			});
		}

		function refreshDemos(){
			window.setTimeout(function(){
				if(searchSketches('demos', settings.sketches)){
					removeItemProcess('demos');
				}
				window.setTimeout(function(){loadDemos(true);}, 100);
			}, 200);
		}

		function parseSketches(jsonObj, legacyDemos){
			let jsonSketches = jsonObj.sketches.reverse();
			for(let i=0; i < jsonSketches.length; i++){
				let sketchName = jsonSketches[i].sketchName;
				let sketchCode = jsonSketches[i].sketchCode;
				localStorage.setItem(sketchName, sketchCode);

				// add to settings if doesn't exist
				if(!searchSketches(sketchName, settings.sketches)) {
					if(jsonSketches[i].mod === undefined){
						jsonSketches[i].mod = timeDate();
					}
					if(legacyDemos === undefined || legacyDemos.indexOf(sketchName) == -1) {
						settings.sketches.unshift({'type':'sketch', 'name':sketchName, 'mod':jsonSketches[i].mod});
					}
				}

				if(sketchName == settings.fileName){
					loadSketch(sketchName);
				}
			}
			updateSketches();
		}



		/* MENU » SKETCHES */

		function getOrder() {
			if(menuSketches.childNodes.length >0){
				const traverse = function(dir, result = []) {
					dir.childNodes.forEach((node) => {

						let nodeName = '';
						if(node.dataset != undefined && (node.dataset.type == 'folder' || node.dataset.type == 'sketch')){
							nodeName = node.dataset.id;
						}else{
							return traverse(node, result)
						}

						const nodeStats = { name: nodeName };

						// add timestamps if they don't exist!
						if(node.dataset.mod === undefined){
							let tc = timeDate();
							node.dataset.mod = tc;
						}
						nodeStats.mod = node.dataset.mod;

						if (node.dataset.type == 'folder') {
							nodeStats.type = 'folder';
							nodeStats.toggle = node.dataset.toggle;
							nodeStats.contents = [];
							result.push(nodeStats);
							return traverse(node, nodeStats.contents)
						}
						if(node.dataset.type == 'sketch'){
							nodeStats.type = 'sketch';
							result.push(nodeStats);
						}
					});
					return result;
				};

				let recursiveSortable = traverse(menuSketches);
				settings.sketches = recursiveSortable;

				updateSettings();
				initSortable();
			}
		}

		// initialize sortable
		function initSortable(){
			if(settings.sketches.length > 0 && typeof settings.sketches[0] === 'object'){
				let htmlStr = '<li class="sortable-placeholder" data-type="buffer"></li>'+recurse( settings.sketches , '');
				menuSketches.innerHTML = htmlStr + '<li class="sortable-placeholder" data-type="buffer"></li>';
				initFolders(menuSketches);


				function recurse(data, curFolder, parFolder) {
					let html = '<li class="sortable-placeholder" data-type="buffer"></li>';
					for (let key in data) {
						let d = data[key];

						// add timestamps if they don't exist!
						if(d.mod === undefined){
							let tc = timeDate();
							d.mod = tc;
						}

						let marq = '';
						let demoClass = ' drag-item ';
						let demoFolder = '';
						if(d.name.length > 20 || (curFolder != '' && d.name.length > 18)){marq = 'marq';}
						if(d.type == 'sketch'){
							let selClass = '';
							let navSketch = 'onmouseenter="showNav(this, \'' + d.name + '\', \'sketch\');" onmouseleave="hideNav(this);"';
							if(curFolder == 'demos' || parFolder == 'demos'){
								if(demosLocked){
									navSketch = 'onmouseenter="showNav(this, \'' + d.name + '\', \'demo-sketch\');" onmouseleave="hideNav(this);"';
									demoClass += ' demo';
								}
							}

							let selSelf = 'loadSketch(\''+d.name+'\');';
							if(d.name == settings.fileName && !settings.cocoding.active){
								selClass = 'sketch-selected';
								if(curFolder !== 'demos' && parFolder !== 'demos'){
									selSelf = `renameItem(\'${d.name}\', \'sketch\')`
								}
							}

							html +='<li class="item-sketch menu-sketch-holder ' + selClass + demoClass + '" data-type="sketch" data-mod="'+d.mod+'" data-id="'+d.name+'" '+navSketch+'><div class="menu-sketch-nav"></div><div class="menu-sketch '+marq+'" onclick="navMouseOver = false;'+selSelf+'">'+icon.fileLines + '<div class="item-label">' +d.name+'</div></div></li>';
						}else if(d.type == 'folder'){
							curFolder = d.name;
							let iconSel = icon.folderExpand;
							let navFolder = 'onmouseenter="showNav(this, \''+d.name+'\', \'folder\');" onmouseleave="hideNav(this);"';
							if(parFolder == 'demos'){
								navFolder = '';
							}
							if(curFolder == 'demos' && demosLocked){
								navFolder = 'onmouseenter="showNav(this, \''+d.name+'\', \'demos\');" onmouseleave="hideNav(this);"';
								demoClass = ' demo';
								demoFolder = 'id="demofolder"';
								parFolder = curFolder;
							}

							if((settings.cocoding.active && curFolder == settings.cocoding.namespace)){
								navFolder = '';
							}
							if(d.toggle == 'expand'){
								iconSel = icon.folderCollapse;
							}

							if(d.contents.length == 0){
								iconSel = icon.folderEmpty;
								d.toggle = 'collapse';
							}
							html += '<ul '+demoFolder+' class="item-folder ' + d.toggle + demoClass + '" data-type="folder" data-id="'+d.name+'" data-mod="'+d.mod+'" data-toggle="'+d.toggle+'" ondragover="dragOver(this)" >';
							html += '<div class="folder-title" '+navFolder+'><div class="menu-sketch-nav"></div><div onclick="navMouseOver = false;toggle(this);" class="menu-folder '+marq+'"><span class="menu-folder-svg">'+iconSel+'</span><div class="item-label">' +d.name + '</div></div></div> ';
							html += recurse(d.contents, curFolder, parFolder);
							html += '</ul>';
							curFolder = '';
						}
					};
					html += '';
					return( html );
				}
				menuSketchesCounter.innerHTML = document.querySelectorAll('.item-sketch:not(.demo)').length;

				// main folder
				new Sortable(menuSketches, options);

				// all sub-folders
				document.querySelectorAll('.drag-item').forEach((s) => {
					new Sortable(s, options);
				});

				if(document.getElementById('demofolder') != undefined){
					new Sortable(demofolder, {
						group: {name: 'demos', pull:false, put:false},
						filter: '.demo'
					});
				}

				if(settings.refresh){
					settings.refresh = false;
					refreshDemos();
				}
				loadTippy();
				if(menuSketchesFilter.value != ''){
					filterParse();
				}

				// scroll to selected sketch
				sketchScrollIntoView();

			}
		}

		function sketchScrollIntoView(forceScroll){
			let selSketch = document.getElementsByClassName('sketch-selected');
			if(selSketch.length > 0 && (sketchesFirstTime || forceScroll)){
				// selSketch[0].scrollIntoView();
				let rectElem = selSketch[0].getBoundingClientRect(), rectContainer=document.getElementById('menu-sketches-holder').getBoundingClientRect();
				if (rectElem.bottom > rectContainer.bottom) selSketch[0].scrollIntoView(false);
				if (rectElem.top < rectContainer.top) selSketch[0].scrollIntoView();
				sketchesFirstTime = false;
			}
		}

		function dragOver(elm){
			elm.style.minHeight='40px';
		}

		// load sortable, restore expanded/collapsed
		function initFolders(elm){
			elm.childNodes.forEach(function(node){
				if(node.dataset != undefined && node.dataset.type == 'folder'){
					node.style.display = 'block';
					if(node.dataset.toggle == 'expand'){
						node.childNodes.forEach((k) => {
							if(k.tagName == 'UL' || k.tagName == 'LI'){
								k.style.display = 'block';
								if(k.dataset.type == 'folder' && k.dataset.toggle == 'expand'){
									initFolders(k);
								}
							}
						});
					}
				}
			});
		}

		// expand/collapse folders
		function toggle(elm){
			if(menuSketchesFilter.value == ''){
				let divFolder = elm.parentNode.parentNode;
				if(divFolder.dataset.toggle == 'expand'){
					divFolder.dataset.toggle = 'collapse';
					elm.innerHTML = icon.folderExpand;
					divFolder.childNodes.forEach((k) => {
						if(k.tagName == 'UL' || k.tagName == 'LI')
							k.style.display = 'none';
					});
				}else{
					divFolder.dataset.toggle = 'expand';
					elm.innerHTML = icon.folderCollapse;
					divFolder.childNodes.forEach((k) => {
						if(k.tagName == 'UL' || k.tagName == 'LI')
							k.style.display = 'block';
					});
				}
				getOrder();
			}
		}

		function showNav(elm, elmID, elmType, elmLevel){
			//elm.style.width='calc(100%-78px)';
			if(elmType == 'folder'){
				if(elmLevel === 1){
					elm.parentNode.setAttribute('onmouseleave', 'navMouseOver=false;showNav(this.parentNode, \'' + elmID + '\', \''+elmType+'\');');
					elm.parentNode.innerHTML = '<a class="menu-sketch-button tippy" onclick="renameItem(\''+elmID+'\', \''+elmType+'\')" data-title="Rename">'+icon.rename+'</a><a class="menu-sketch-button tippy" onclick="subSketch(\''+elmID+'\', true)" data-title="Sub-Sketch">'+icon.newFile+'</a><a class="menu-sketch-button tippy" onclick="addFolder(\''+elmID+'\', true)" data-title="Sub-folder">'+icon.folderExpand+'</a><a class="menu-sketch-button tippy" onclick="exportSketches(\''+elmID+'\')" data-title="Export">'+icon.export+'</a><a class="menu-sketch-button tippy" onclick="removeItem(\''+elmID+'\', \''+elmType+'\')" data-title="Remove">'+icon.remove+'</a><a class="menu-sketch-button tippy" data-title="Pin Folder" style="display:none;">'+icon.bookmark+'</a><a class="menu-sketch-button menu-more">'+icon.moreHorizontal+'</a>';
				}else{
					if(!navMouseOver){
						navMouseOver = true;
						elm.getElementsByClassName('menu-sketch-nav')[0].innerHTML = '<a class="menu-sketch-button menu-more" onmouseenter="showNav(this, \'' + elmID + '\', \''+elmType+'\', 1);" >'+icon.moreHorizontal+'</a>';
					}
				}

			}else if(elmType == 'sketch'){
				if(elmLevel === 1){
					let dateMod = elm.parentNode.parentNode.getAttribute('data-mod')
					let tippyDate = ''
					if(dateMod){
						tippyDate = ` data-title="${new Date(dateMod * 1).toISOString().split('T')[0]}"`
					}

					elm.parentNode.setAttribute('onmouseleave', 'navMouseOver=false;showNav(this.parentNode, \'' + elmID + '\', \''+elmType+'\');');
					elm.parentNode.innerHTML = '<a class="menu-sketch-button tippy" onclick="inspectItem(\''+elmID+'\')" data-title="Inspect">'+icon.alignLeft+'</a><a class="menu-sketch-button tippy" onclick="renameItem(\''+elmID+'\', \''+elmType+'\')" data-title="Rename">'+icon.rename+'</a><a class="menu-sketch-button tippy" onclick="exportSketch(\''+elmID+'\')" data-title="Export">'+icon.export+'</a><a class="menu-sketch-button tippy" onclick="removeItem(\''+elmID+'\', \''+elmType+'\')" data-title="Remove">'+icon.remove+'</a><a class="menu-sketch-button tippy" data-title="Pin Sketch" style="display:none;">'+icon.bookmark+'</a><a class="menu-sketch-button menu-more tippy" '+tippyDate+'>'+icon.moreHorizontal+'</a>';
				}else{
					if(!navMouseOver){
						navMouseOver = true;
						elm.getElementsByClassName('menu-sketch-nav')[0].innerHTML = '<a class="menu-sketch-button menu-more" onmouseenter="showNav(this, \'' + elmID + '\', \''+elmType+'\', 1);" >'+icon.moreHorizontal+'</a>';
					}
				}

			}else if(elmType == 'demos'){
				elm.getElementsByClassName('menu-sketch-nav')[0].innerHTML = '<a class="menu-sketch-button tippy" onclick="refreshDemos(\''+elmID+'\', \''+elmType+'\')" data-title="Refresh">'+icon.refresh+'</a>';
			}else if(elmType == 'demo-sketch'){
				elm.getElementsByClassName('menu-sketch-nav')[0].innerHTML = '<a class="menu-sketch-button tippy" onclick="inspectItem(\''+elmID+'\', true)" data-title="Inspect">'+icon.alignLeft+'</a>';
			}else if(elmType == 'user'){
				elm.getElementsByClassName('menu-sketch-nav')[0].innerHTML = '<a class="menu-sketch-button tippy" onclick="toggleEdit(\''+elmID+'\', \''+elmType+'\')" data-title="Refresh">'+icon.toggleLeft+'</a>';
			}else if(elmType == 'self'){
				let reqClass = '';
				if(settings.cocoding.request){
					reqClass = ' req ';
				}
				elm.getElementsByClassName('menu-sketch-nav')[0].innerHTML = '<a id="request-'+elmID+'" class="menu-sketch-button tippy '+reqClass+'" onclick="cocode.editRequest(\''+elmID+'\')" data-title="Request Edit">'+icon.edit+'</a>';
			}

			loadTippy();
		}

		function hideNav(elm){
			elm.getElementsByClassName('menu-sketch-nav')[0].innerHTML = '';
			elm.style.width='calc(100%-5px)';
			navMouseOver = false;
		}

		function addFolder(folderName, subFolder){
			let newID = versionCheck('folder');//'folder ' + Math.floor(Math.random()*99);
			if(menuSketchesFilter.value != ''){
				newID = versionCheck(menuSketchesFilter.value);
			}else if(folderName != undefined){
				newID = versionCheck(folderName);
			}

			if(folderName == undefined || subFolder){
				vex.dialog.prompt({
					message: 'Add Folder:',
					value: newID, // placeholder
					callback: function (value) {
						if(value){
							let cleanValue = versionCheck(value)
							addFolderProcess(cleanValue, folderName);
						}
					},
					afterOpen: function(){
						document.getElementsByClassName('vex-dialog-prompt-input')[0].select();
					}
				})
			}else{
				newID = folderName;
				addFolderProcess(newID);
			}
		}

		function addFolderProcess(newID, subFolder){
			let tc = timeDate();
			let newFolder = '<ul class="item-folder" ondragover="dragOver(this)" data-type="folder" data-toggle="expand" data-id="'+newID+'" data-mod="'+tc+'"><a onclick="toggle(this);">'+icon.folderEmpty+'</a> Folder<div class="sketches" style="display:block" ></div></ul>';
			if(subFolder != undefined){
				let tempHTML = menuSketches.querySelectorAll('[data-id="'+subFolder+'"]')[0];
				tempHTML.innerHTML = newFolder + tempHTML.innerHTML;
			}else{
				// *** try to add folder above current sketch
				let tempHTML = menuSketches.innerHTML;
				menuSketches.innerHTML = newFolder + tempHTML;
			}
			getOrder();
		}

		function inspectItem(itemName, itemLocked){
			let inspectCode = localStorage.getItem(itemName);
			let inspectEditor;

			vex.dialog.confirm({
				focusFirstInput : false,
				unsafeMessage:'Inspect Code and optionally save changes.<br><br><div class="syncdata-header code-header">code</div><div id="inspectcode" class="popup-editor vex-long">'+inspectCode+'</div>',
				callback: function (value) {},
				afterOpen: function(){
					vexClass(this.rootEl, 'vex-padding')
				},
				buttons: [
				!itemLocked ? {
					type: 'submit',
					text: 'SAVE',
					className: 'my-button-class-name',
					click: function updateCode () {
						localStorage[itemName] = inspectEditor.getValue();
						if(settings.safeMode){
							settings.fileName = itemName;
							settings.safeMode = false;
							updateSettings();
							window.location.hash = '#';
							loadSketch(settings.fileName);
						}else if(itemName == settings.fileName){
							setTimeout(function(){editor.setValue(localStorage.getItem(itemName), 1);}, 100);
						}
					}
				} : {
					className: 'hide-button' // hide if unused
				}
				,{
					type: 'close',
					text: 'CLOSE',
					className: 'my-button-class-name',
					click: function(){
						editor.focus();
					}
				}]
			})
			inspectEditor = ace.edit("inspectcode");
			inspectEditor.setTheme(settings.theme);
			inspectEditor.session.setMode('ace/mode/javascript');
			inspectEditor.setOptions({
				showPrintMargin: false,
				animatedScroll: false,
				displayIndentGuides: false,
				useWorker: true,
				showLineNumbers: true,
				showGutter: true,
				tabSize: 4, useSoftTabs: false,
			});
			tidyCode(inspectEditor);
			inspectEditor.focus();
			inspectEditor.moveCursorTo(0,0);
		}

		// rename sketch/folder
		function renameItem(itemName, itemType){
			let existingItems = [];
			for(let di of menuSketches.getElementsByClassName('drag-item')){
				existingItems.push(di.getAttribute('data-id'));
			}

			vex.dialog.prompt({
				message: 'Rename:',
				value: itemName, // placeholder
				callback: function (value) {
					if(value){
						let newName = value.replace(/["']/g, '');
						if(newName != '' && newName != itemName){
							let sketchesFlat = JSON.stringify(settings.sketches);
							if( existingItems.indexOf(itemName) > -1 ) {
								if( existingItems.indexOf(newName) === -1  && newName.toLowerCase() !== 'demos') {
									let sketchesFixed = sketchesFlat.replace('"'+itemName+'"', '"'+newName+'"');
									settings.sketches = JSON.parse(sketchesFixed);
								}else{
									vex.dialog.alert({
										unsafeMessage:'"'+newName +'" already exists. <br>Pick a new name',
										callback: function(){renameItem(newName, itemType)},
										afterOpen: function(){
											vexClass(this.rootEl, 'vex-small')
										}
									})
									return false;
								}
							}

							updateSettings();
							initSortable();
							if(itemType == 'sketch'){
								localStorage.setItem(newName, localStorage[itemName]);
								localStorage.removeItem(itemName);
								if(settings.fileName == itemName){
									settings.fileName = newName;
									updateSketches();
									// *** removing below if no prob, no need to refresh??
									// if(!settings.cocoding.active){
									// 	setTimeout(function(){ loadSketch(newName); }, 100);
									// }
								}
							}
						}
					}
				},
				afterOpen: function(){
					document.getElementsByClassName('vex-dialog-prompt-input')[0].select();
					vexClass(this.rootEl, 'vex-small')
				}
			})
		}

		// taking out the trash
		function removeItem(dataID, elmType){
			let removeDetails = '';
			let iconSel = icon.fileLines;
			if(elmType == 'folder'){
				iconSel = icon.folderCollapse;
				let elmContents = searchJSON(settings.sketches, 'name', dataID)[0];
				if(elmContents.type == 'folder' && elmContents.contents.length > 0){
					removeDetails = '<div class="remove-header">Includes:</div>'
					removeDetails += '<div id="importdump" class="remove-dump">';
					removeDetails += recursiveImportWarning(elmContents.contents, '', '');
					removeDetails += '</div>';
				}else{
					// remove empty folders without warning
					removeItemProcess(dataID);
					return false;
				}
			}
			vex.dialog.confirm({
				unsafeMessage: 'Delete '+elmType+': <br><span class="remove-icon">'+iconSel +'</span> <span class="remove-dump importdump-dup">'+ dataID + '</span><br>'+removeDetails,
				callback: function (value) {
					if (value) {
						removeItemProcess(dataID);
					}
				},
				afterOpen: function(){
					vexClass(this.rootEl, 'vex-small')
				}
			})
		}

		function removeItemProcess(dataID){
			let nextLoad = nextSketch(1)

			let selElm = document.querySelectorAll('[data-id="'+dataID+'"]');
			selElm[0].querySelectorAll('[data-id]').forEach(function(k){
				localStorage.removeItem(k.dataset.id);
				k.remove();
			});

			// catch active sketch in trashed folder
			// let dataIDType = searchJSON(settings.sketches, 'name', dataID)[0];
			// if(dataIDType.type === 'folder'){
			// 	for(let i=0; i < dataIDType.contents.length; i++){
			// 		if(settings.fileName === dataIDType.contents[i].name){
			// 			sketchInFolder = true;
			// 		}
			// 	}
			// }

			localStorage.removeItem(dataID);
			if(selElm.length > 1){
				for(let se of selElm){
					se.remove();
				}
			}else{
				selElm[0].remove();
			}



			getOrder();

			let sketchIsGone = false;
			if(!searchSketches(settings.fileName, settings.sketches)){
				sketchIsGone = true;
			}

			if((dataID === settings.fileName || sketchIsGone) && !settings.cocoding.active){
				if(nextLoad === undefined){
					loadSketch(loadLatest());
				}else{
					loadSketch(nextLoad);
				}
			}
		}

		function nextSketch(dir){
			let sketchesOverview = listSketches(settings.sketches);
			let curIndex = sketchesOverview.indexOf(settings.fileName);
			if(curIndex !== undefined){
				if(dir === -1){
					curIndex--;
				}else{
					curIndex++;
				}

				return sketchesOverview[curIndex];
				// if(sketchesOverview[curIndex] !== undefined){
				// 	loadSketch(sketchesOverview[curIndex]);
				// 	setTimeout(function(){sketchScrollIntoView(true)}, 100)
				// }
			}else{
				return false
			}
		}


		/* EDITOR KEY-CMDS */
		let keyMap = [];
		keyMap[16] = false;
		keyMap[17] = false;
		window.onkeydown = function(event) {
			keyMap[event.keyCode] = event.type == 'keydown';

			if(recoding.playing && recoding.catMode){
				recoding.playCat()
				event.preventDefault();
				return false;
			}

			if(keyMap[16] && keyMap[17]){
				if(event.keyCode == 8){
					removeItem(settings.fileName, 'sketch'); // quick delete sketch
				}else if(event.keyCode === 38 || event.keyCode === 40){
					let otherSketch = nextSketch(1)
					if(event.keyCode === 38){
						otherSketch = nextSketch(-1);
					}

					if(otherSketch !== undefined){
						loadSketch(otherSketch);
						setTimeout(function(){sketchScrollIntoView(true)}, 0)
					}

				}else{
					// addSnippet(event.key);
				}
				event.preventDefault();
			}

			if(event.keyCode == 8){ // DELETE = prevent back navigation in FF
				let eTarget = event.target.tagName.toLowerCase();
				if(!p5code.focus() && eTarget != 'input' && eTarget != 'textarea'){
					event.preventDefault();
				}
			}
		}

		window.onkeyup = function(event) {
			keyMap[event.keyCode] = event.type == 'keydown';
		}

		// Editor Interactions
		p5code.onkeydown = function(event) {
			keyMap[event.keyCode] = event.type == 'keydown';
		}

		p5code.onkeyup = function(event) {
			keyMap[event.keyCode] = event.type == 'keydown';
			if(!settings.cocoding.active){
				localStorage[settings.fileName] = editor.getValue();
			}
		};

		menuCocodeChatInput.onkeydown = function(event){
			if(event.keyCode == 13){
				event.preventDefault();
				if(settings.cocoding.active && menuCocodeChatInput.value.trim() != ''){
					syncUp();
					cocode.socket.emit('chat', {'type':'send', 'text':menuCocodeChatInput.value, 'msgID':settings.cocoding.msgID});
					menuCocodeChatInput.value = '';
					settings.cocoding.msgID = -1;
					updateSettings();
				}
			}else{
				chatPending();
			}
		}

		menuCocodeChatInput.addEventListener('focus', () => {
			chatPending();
		});

		menuCocodeChatInput.addEventListener('blur', () => {
			chatPendingClear();
		});

		function chatPending(){
			if(settings.cocoding.msgID == -1){
				syncUp();
				settings.cocoding.msgID = Math.floor(Math.random()*999)
				updateSettings();
				cocode.socket.emit('chat', {'type':'pending', 'text':'...', 'msgID':settings.cocoding.msgID});
			}
		}

		function chatPendingClear(){
			if(settings.cocoding.msgID != -1){
				cocode.socket.emit('chat', {'type':'clear', 'text':'', 'msgID':settings.cocoding.msgID});
			}
			settings.cocoding.msgID = -1;
			updateSettings();
		}

		function chatBlur(){
			menuCocodeChatInput.blur();
			if(settings.cocoding.msgID != -1){
				cocode.socket.emit('chatPendingClear', {'msgID':settings.cocoding.msgID});
			}
			settings.cocoding.msgID = -1;
			updateSettings();
		}

		function checkErrors(){
			clearTimeout(errorTimer);
			let checkErrorsDelay = settings.compileTimer;
			if(settings.cocoding.active){
				checkErrorsDelay = 1000;
				settingsCompileTimer.value = 1000;
				settingsCompileTimer.setAttribute('disabled', 'disabled');
				settingsCompileTimer.style.opacity = .5;
			}
			errorTimer = setTimeout(function(){checkErrorsWorker();}, checkErrorsDelay);
		}

		function checkErrorsWorker(){
			let annos = editor.getSession().getAnnotations();

			if(settings.debugMode){console.log(annos);};
			let errorsFound = false;
			for(let i=0; i < annos.length; i++){
				if(annos[i].type == 'error'){
					errorsFound = true;
				}
			}

			if(errorsFound){
				validCode = false;
				checkErrors();
			}else{
				clearTimeout(errorTimer);
				validCode = true;
				if(settings.autoCompile && !recoding.playing && !loadingInit){
					recompile();
				}
			}
			if(settings.debugMode){console.log('validCode: ' + validCode);}
			
			loadingInit = false // solves double load of sketch!
		}

		// prevent lost work in default
		window.addEventListener('beforeunload', function (e) {
			if(settings.fileName == 'default'){
				let confirmationMessage = '\o/';
				(e || window.event).returnValue = confirmationMessage; 	//Gecko + IE
				return confirmationMessage;								//Webkit, Safari, Chrome
			}
		});

		function syncdataConsoleMsg(msg){
			if(!settings.cocoding.active){
				return false;
			}
			if(typeof msg === 'object'){
				msg = JSON.stringify(msg);
			}
			settings.syncdata.console.push(msg);
			if(settings.syncdata.console.length > 10){
				settings.syncdata.console = settings.syncdata.console.splice(0, 1);
			}
			updateSettings();

			let syncdataConsole = document.getElementById('syncdata-console');
			if(syncdataConsole != undefined){
				syncdataConsole.innerHTML += '\n'+msg

				let autoScroll = false;
				if(syncdataConsole.scrollHeight - syncdataConsole.scrollTop < 200){
					autoScroll = true;
				}

				if(autoScroll){
					syncdataConsole.scrollTop = syncdataConsole.scrollHeight;
				}else{
					syncdataConsole.scrollTop += 1;
				}
			}

		}

		function consoleMessage(msg, timeDelay){
			if(typeof msg === 'object'){
				msg = JSON.stringify(msg);
			}
			p5console.value = `» ${msg}`;
			if(p5editor.style.visibility == 'visible'){
				p5console.style.display = 'block';
				// resizeEditor();
				consoleVisible = true;
			}
			if(timeDelay != undefined && timeDelay != 0){
				if(consoleTimer != undefined){
					clearTimeout(consoleTimer);
				}
				consoleTimer = setTimeout(consoleHide, timeDelay*1000);
			}
			p5console.style.height = "1px";
  			p5console.style.height = (p5console.scrollHeight)+"px";
		}

		function consoleHide(){
			// console.log([settings.console, settings.consoleMode])
			if(settings.console && settings.consoleMode == 'show'){
				// console.log('clear console')
				consoleTimer = setTimeout(()=>{
					p5console.value = '';
				}, 2000)
				return false
			}

			if(consoleTimer != undefined){
				clearTimeout(consoleTimer);
			}
			p5console.value = '';
			p5console.style.display = 'none';
			consoleVisible = false;
		}

		function resizeEditor(){
				if(p5console.style.display == 'block'){
					p5code.style.height = 'calc(100vh - '+ p5console.offsetHeight +'px)';
				}else{
					p5code.style.height = '100vh';
				}

				editor.resize();
		}



		/* COMPILE CODE */

		function compileCodeShortcut(hard){
			forceRecompile = true;
			clearTimeout(errorTimer);
			recompile(hard);
		}

		function recompile(force){

			// catch #bug attempt to recompile while COCODING
			if(force && settings.safeMode){
				vex.dialog.confirm({
					message:'#bug » recompile sketch?',
					callback: function(value){
						if(value){
							settings.safeMode = false;
							updateSettings();
							window.location.hash = '#';
							recompile(force);
						}
					},
					afterOpen: function(){
						vexClass(this.rootEl, 'vex-small')
					}
				})
			}

			let currline = editor.getSelectionRange().start.row;
			let currCode = editor.session.getLine(currline);
			curPos = editor.getCursorPosition();

			// catch missing {}'s
			let codeNoComments = removeComments(editor.getValue());

			let cbCount = {
				l : (codeNoComments.match(/\{/g) || []).length,
				r : (codeNoComments.match(/\}/g) || []).length
			}

			let pCount = {
				l : (codeNoComments.match(/\(/g) || []).length,
				r : (codeNoComments.match(/\)/g) || []).length
			}
			if(cbCount.l != cbCount.r){ // cbCount.l == 0 || 
				let missingBracket = "'}'";
				if(cbCount.l < cbCount.r){
					missingBracket = "'{'";
				}
				consoleMessage('Missing ' + missingBracket + '. Check code then recompile.', 0);
				braketError = true;
				return false;
			}else if(pCount.l != pCount.r){
				let missingBracket = "')'";
				if(pCount.l < pCount.r){
					missingBracket = "(";
				}
				consoleMessage('Missing ' + missingBracket + '. Check code then recompile.', 0);
				braketError = true;
				return false;
			}else{
				if(braketError){
					consoleHide();
					braketError = false;
				}

			}

			// prevent compile while autocomplete popup visible
			let acPopup = document.getElementsByClassName('ace_autocomplete')[0];
			if(acPopup != undefined){
				if(acPopup.style.display != 'none'){
					return false;
				}
			}

			if((currCode.search(/^\s(?:for|while)(|\s)(\()/) == -1 || !editor.getValue().match(/(\/\/).*(no.*protect)/g)) || forceRecompile || force){
				if(validCode){
						// buildSketch(); //
						updateBackground();
						if(settings.cocoding.active){
							if(settings.cocoding.sync){
								if(settings.cocoding.level == 'admin'){
									buildSketch(force); //
									cocode.recompile(force);
								}
							}else{
								buildSketch(force);
							}
						}else{
							buildSketch(force);
						}

						// if(settings.cocoding.active && settings.cocoding.sync && settings.cocoding.level == 'admin'){
						// 	buildSketch(); //
						// 	updateBackground();
						// 	cocode.recompile();
						// }else if(){
						// 	buildSketch(); //
						// 	updateBackground();
						// }
				}
			}
			forceRecompile = false;
		}

		function removeComments(code){
			return code.replace(/\/\*[\s\S]*?\*\/|([^:\}\)]|^)\/\/.*$/gm, (_, g1, g2) => Array(_.split('\n').length).join('\n'))
			// const regex = /\/\*[\s\S]*?\*\/|([^:\}\)\w]|^)(\/\/.*)|(["'`])(?:(?!\3)[^\\]|\\.)*\3/gm;

			// return code.replace(regex, (match, p1, p2, p3) => {
			//   if (p3) return match; // If inside quotes, return the match as is
			  
			//   if (p2) {
			//     const newlineCount = p2.split('\n').length;
			//     return p1 + Array(newlineCount).join('\n'); // Replace with newlines if outside quotes
			//   }
			  
			//   return match; // For other matches (block comments), return as is
			// });
		}

		// *** check if online, check if already have libs array
		function processLibs(code){
			let sketchTest = code.replace(/(?:\r\n|\r|\n|\t)/g, '');
			let sketchScriptsString = sketchTest.match(/(?=loadScripts|libs|scripts).*?(\])/);
			let scriptsList = [];
			if(sketchScriptsString != undefined){
				let sketchLoadScripts = sketchScriptsString[0].match(/(["'])(?:(?=(\\?))\2.)*?\1/g);
				for(let i=0; i < sketchLoadScripts.length; i++){
					if(sketchLoadScripts[i] != ''){
						scriptsList.push(sketchLoadScripts[i].replace(/["']/g, ''));
					}
				}
			}
			// clear empties
			scriptsList = scriptsList.filter(Boolean)
			return scriptsList;
		}

		function processImports(code){
			let sketchFlat = code.replace(/(?:\r\n|\r|\n|\t)/g, '');
			let sketchImportMap = sketchFlat.match(/imports\s*=\s*({[\s\S]*?})/);
			if(sketchImportMap != null){
				sketchImportMap = JSON.parse(sketchImportMap[1]);
			}
			return sketchImportMap
		}

		function hydraBlock(){
			let rawLines = editor.session.getLines(0, editor.session.getLength());
			let currline = editor.getSelectionRange().start.row;
			let currCode = editor.session.getLine(currline);

			// search +/- cur pos for new lines
			let hb = {
				block : currCode,
				start : currline,
				end : currline
			}
			
			let i = currline-1
			while(i >= 0 && rawLines[i].trimStart() != ''){
				hb.block = editor.session.getLine(i)+ '\n' + hb.block
				hb.start--
				i--
			}

			i = currline+1
			while(i < rawLines.length && rawLines[i].trimStart() != '' && rawLines[i].trimStart() != '\n' && !rawLines[i].includes('function')){
				hb.block += '\n' + editor.session.getLine(i)
				hb.end++
				i++
			}

			hb.block.replaceAll(/\/\/ sandbox.*/g, '')

			return hb;
		}

		// new technique to avoid accessing p5live_sketch.html sooo many times!
		function buildSketch(force){
			// replace single + multiline comments with \n to avoid processing + keep line numbers same
			useP5 = true
			useP5Sound = true
			if(editor.getValue().match(/(\/\/).no p5$/gm)){
				useP5 = false;
			}
			if(editor.getValue().match(/(\/\/).*(no.*p5sound$)/gm)){
				useP5Sound = false;
			}

			// grab latest p5vars only before reload! no more interval...
			if(sketchLoaded && p5f.frameCount != undefined){
				// catch broken sketch
				if(useP5 && p5f.frameCount <= p5vars.pframeCount){
					force = true
				}

				p5vars.frameCount = p5f.frameCount+1;
				p5vars.mouseX = p5f.mouseX;
				p5vars.mouseY = p5f.mouseY;
				p5vars.pframeCount = p5vars.frameCount
			}

			if(!settings.cocoding.active){
				let sketchElm = document.querySelectorAll('[data-id="'+settings.fileName+'"]')[0];
				let sketchDetails = searchJSON(settings.sketches, 'name', settings.fileName)[0];
				if(sketchElm != undefined && sketchDetails != undefined){
					// *** overwrite mod or leave it alone?
					// sketchElm.setAttribute('data-mod', timeDate());
					// sketchDetails.mod = timeDate();
					// updateSettings();
				}
			}

			let codeNoComments = removeComments(editor.getValue());

			// softCompile
			if((force == undefined && sketchLoaded) || (force == undefined && !useP5)){
				// technique to only update draw if code changed there (= continous background!)
				let rawLines = editor.session.getLines(0, editor.session.getLength());
				let drawPos = [];//{};
				let drawPosSel = -1;
				let countBrackets = false;
				let braces = 0;
				let softFunction = false;
				let softClass = false;


				let allLines = codeNoComments.split('\n');

				// sandbox
				let sandboxMatch = editor.getValue().match(/^\/\/\s*(hydra)*sandbox.*?\/\/.*?(hydra)*sandbox.*?\n*/ism);
				if(sandboxMatch !== null){
					var currline = editor.getSelectionRange().start.row;
					var currCode = editor.session.getLine(currline);
					var sandboxParts = sandboxMatch[0].split('\n');
					if(sandboxParts.indexOf(currCode) > -1){

						let hb = hydraBlock();
						
						// check if added via snippet
						let checkSnippet = sandboxMatch[0].replaceAll('\n', '')
						if(checkSnippet == '// sandbox// sandbox'){
							force = true;
						}

						p5f.eval(hb.block)
						recompilePulse(hb.start, hb.end)
						if(recoding.recording){
							recoding.compile()
						}
						
						if(p5popCode){
							p5popCode.recompilePulse(hb.start, hb.end)
						}

						// p5f.eval(sandboxMatch[0])
						if(!force){
							return false;
						}
					}
				}

				// test purging of comments
				// let offLines = 6;
				// console.log(rawLines[offLines]);
				// console.log(allLines[offLines]);

				// extract all functions and their line number
				for(let i=0; i<allLines.length; i++){

					// catch function or class
					if(allLines[i].includes('function ') && !countBrackets){
							countBrackets = true;
							let functionName = allLines[i].match(/function ([\w\d]*)\(/)[1].trim();
							drawPos.push({type:'function', name:functionName, start:i});
					}else if(allLines[i].includes('class ') && !countBrackets){
							countBrackets = true;
							let className = allLines[i].match(/class\s([\w\d]*)/)[1].trim();
							drawPos.push({type:'class', name:className, start:i});
					}

					// count {} and mark where class/function ends
					if(countBrackets){
						if(allLines[i].includes('{')){
							braces += (allLines[i].match(/{/g) || []).length;
						}
						if(allLines[i].includes('}')){
							braces -= (allLines[i].match(/}/g) || []).length;
							if(braces == 0){
								drawPos[drawPos.length-1].end = i;
								countBrackets = false;
							}
						}
					}
				}

				// check all changed positions + if custom function
				let funName = '';
				for(let i=0; i<drawPos.length; i++){
					for(let j=0; j < curPositions.length; j++){
						let cPos = curPositions[j];
						if(cPos.row >= drawPos[i].start && cPos.row <= drawPos[i].end){
							// console.log(drawPos[i].name); // debug where change occured
							if(drawPos[i].name != 'setup' && drawPos[i].name != 'preload' && drawPos[i].type == 'function'){
								softFunction = true;
								drawPosSel = i;
								funName = drawPos[i].name;
							}else if(drawPos[i].type == 'class'){
								softClass = true;
								drawPosSel = i;
							}
						}
					}
				}

				// if custom function, grab where it's used
				let functionPos = [];
				for(let j=0; j<drawPos.length; j++){
					if(funName == drawPos[j].name){
						// find lines where drawPos[i].name sits
						for(let i=0; i<allLines.length; i++){
							if(allLines[i].includes(drawPos[j].name + '(')){
								functionPos.push(i);
							}
						}
					}
				}

				// catch custom functions in preload + setup
				for(let i=0; i < functionPos.length; i++){
					let fPos = functionPos[i];
					for(let j=0; j < drawPos.length; j++){
						if(fPos >= drawPos[j].start && fPos <= drawPos[j].end){
							// console.log(drawPos[i].name); // debug where chage occured
							if(drawPos[j].name == 'setup' || drawPos[j].name == 'preload'){ // && !settings.cocoding.active
								softFunction = false;
							}
						}
					}
				}

				// if possible, only overwrite function/class for softCompile
				if(softClass || softFunction){
					softCompile(drawPos[drawPosSel].type, drawPos[drawPosSel].name, drawPos[drawPosSel].start, drawPos[drawPosSel].end);
					curPositions = [];

					if(recoding.recording){
						recoding.compile()
					}

					return false; // prevent complete rebuild
				}
			}

			// hardCompile
			sketchLoaded = false;
			cocodingRecompile = true;
			let el = p5frameTemplate.cloneNode(true);

			let iFrameHead = el.getElementsByTagName('head')[0];//el.document.getElementsByTagName('body')[0];
			let iFrameBody = el.getElementsByTagName('body')[0];//el.document.getElementsByTagName('body')[0];

			let scriptsCol = [];

			// load p5/p5sound scripts remote vs local
			for (const iScript in includeScripts) {
				//no p5
				if(!useP5){
					if(iScript == 'p5' || iScript == 'p5sound') continue;					
				}

				// no p5.sound
				if(!useP5Sound){
					if(iScript == 'p5sound') continue;
				}


				// check p5Version
				let p5versionCheck = editor.getValue().match(/(?:\/\/\s*p5\s*=.*)/gi)
				if(iScript == 'p5'){
					if(p5versionCheck){


						// grab version
						let p5versionRequest = p5versionCheck[0].match(/(?<=(["'`]\b))(?:(?=(\\?))\2.)*?(?=\1)/gi)

						// if version found
						if(p5versionRequest){
							p5l.version = parseFloat(p5versionRequest)
							
							if(p5l.remote){
								// if online, grab directly from CDN
								let parts = includeScripts.p5.parts
								includeScripts.p5.path = parts.base + p5versionRequest + parts.file
								scriptsCol.push(includeScripts.p5.path);
							}else{
								// if offline, attempt local load
								let p5VersionLocal = `includes/p5/versions/${p5versionRequest}.js`
								let parts = includeScripts.p5.parts
								includeScripts.p5.path = parts.base + p5versionRequest + parts.file

								const request = new XMLHttpRequest();
								request.open("GET", p5VersionLocal, false); // `false` makes the request synchronous

								request.send(null);

								if (request.status === 200) {
									// found locally, load
						    		scriptsCol.push(p5VersionLocal);
								}else{
									// not found, download to offline versions
								  	// console.log('not found: ' + p5VersionLocal)
									// console.log(includeScripts.p5.path)
									
									onlineStatus()
									if(p5l.online){
										// if(includeScripts.p5.versions.includes(p5versionRequest)){
											try{
												serverMsg('/version', {version:p5versionRequest, path:includeScripts.p5.path}, (res)=>{recompile()})
											}catch(e){
												console.log(error)
											}
											return false
										// }
									}else{
										console.log('P5LIVE: failed to find/download requested p5 version')
										scriptsCol.push(includeScripts.p5.local);
									}
								}
							}
							
						}else{
							scriptsCol.push(includeScripts[iScript].remote);
						}
					}else{
						if(p5l.remote){
							scriptsCol.push(includeScripts[iScript].remote);
						}else{
							scriptsCol.push(includeScripts[iScript].local);
						}
					}
				}else{
					if(p5l.version < 2){
						if(p5l.remote){
							scriptsCol.push(includeScripts[iScript].remote);
						}else{
							scriptsCol.push(includeScripts[iScript].local);
						}
					}
					
				}

				
			}
			// for(let i=0; i < includeScripts.length; i++){
			// 	if(p5l.remote){
			// 		scriptsCol.push(includeScripts[i].remote);
			// 	}else{
			// 		scriptsCol.push(includeScripts[i].local);
			// 	}
			// }

			// old way ***
			for(let sc of scriptsCol){
				let s = document.createElement('script');
				s.type = 'text/javascript';
				s.src = sc;
				// s.async = false;
				iFrameHead.appendChild(s); // **** BIG change to body from head.. test?!
			}

			scriptsCol = []
			// check loadScripts / libs / scripts;
			let scriptsList = processLibs(codeNoComments);
			for(let i=0; i < scriptsList.length; i++){
				scriptsCol.push(`${scriptsList[i]}?${Math.floor(Math.random()*9999)}`);
			}

			// old way ***
			for(let sc of scriptsCol){
				let s = document.createElement('script');
				s.type = 'text/javascript';
				s.src = sc;
				// s.async = false;
				iFrameBody.appendChild(s); // **** BIG change to body from head.. test?!
			}

			var importMap = processImports(codeNoComments)
			if(importMap != null){
				console.log(importMap)
				let s = document.createElement('script')
				s.type = 'importmap'
				s.innerHTML = `{\n"imports":${JSON.stringify(importMap)}\n}`
				iFrameBody.appendChild(s);

				let m = document.createElement('script')
				m.type = 'module'
				m.innerHTML = ``
				for (const [key, value] of Object.entries(importMap)) {
				    // resultArray.push(key, value);
				    m.innerHTML += `import '${key}';\n`
				    // m.innerHTML += `window['${key}'] = ${key}\n`
				}
				iFrameBody.appendChild(m);
				console.log(m)
			}


			// load sketch
			let s = document.createElement('script');
			s.type = 'text/javascript';
			let sketchCode = editor.getValue();

			// break infinite loops
			if(!sketchCode.match(/(\/\/).*(no.*protect)/g) || settings.cocoding.active){
				try{
					sketchCode = loopBreaker(sketchCode).code;
				} catch (e) {
					console.log(`👀 error found near line ~ ${e.lineNumber}`);
					// console.log(e.description)
				  return false;
				}
			}

			// console.log(sketchCode);
			let updateVars = '\nmyP5.pmouseX=' + p5vars.mouseX + ';\nmyP5.pmouseY=' + p5vars.mouseY + ';\nmyP5.mouseX=' + p5vars.mouseX + ';\nmyP5.mouseY=' + p5vars.mouseY + ';\nmyP5.frameCount=' + p5vars.frameCount + ';\n';

			let codeSetup = sketchCode + updateVars;
			let fullCode = p5custom.value + codeSetup;
			if(useP5){
				codeSetup = addCode(sketchCode, updateVars, 'setup', 'bottom');
				fullCode = p5custom.value + codeSetup + '\nvar myP5 = new p5(); sketchStatus();';
			}else{
				setTimeout(popStream, 500)
			}
			// let fullCode = p5custom.value + codeSetup + '\nnew p5(); sketchStatus();';

			// *** disabling loadjs route.. failed is missing file.. (needed for remote/local lib loading)
			// let sLoader = 'loadjs(' + JSON.stringify(scriptsCol) + ', {success: function() {pingReady("p5Main", ' + JSON.stringify(fullCode) + '); },error: function(pathsNotFound) {console.log(pathsNotFound);},async: false});';

			// s.innerHTML = sLoader;
			// console.log(fullCode)
			s.innerHTML = fullCode; // *** old (better?) way

			if(settings.syncdata.active){
				syncdataButtonToggle();
			}

			// updated route, load html, then script once ready
			// console.log(el.innerHTML)
			p5frame.srcdoc = el.innerHTML;
			p5frame.onload = function(){
				if(!settings.safeMode){
					p5f.document.body.appendChild(s);
					recompilePulse()

					if(p5popCode){
						p5popCode.recompilePulse()
					}
				}
			}

			curPositions = [];
		}

		// compiling code after promise of loaded libs!
		function pongReady(scriptName, scriptCode, scriptCallback){
				let s = document.createElement('script');
				s.type = 'text/javascript';
				s.id = scriptName;
				s.innerHTML = scriptCode;
				if(p5f.document.getElementById(scriptName) == null){
					p5f.document.head.appendChild(s);
				}else{
					p5f.document.getElementById(scriptName).innerHTML = scriptCode;
				}

				if(scriptCallback){
					scriptCallback();
				}
		}

		// softCompile function or class changes
		function softCompile(codeType, codeName, codeStart, codeEnd){
			let curCodeTemp = '';
			if(codeType == 'function'){
				curCodeTemp = editor.session.getLines(codeStart, codeEnd).join('\n');
			}else if(codeType == 'class'){
				curCodeTemp = codeName + ' = class {' + editor.session.getLines(codeStart+1, codeEnd).join('\n');
			}
			let s = document.createElement('script');
			s.type = 'text/javascript';

			// break infinite loops
			if(!editor.getValue().match(/(\/\/).*(no.*protect)/g)){
				try{
					curCodeTemp = loopBreaker(curCodeTemp).code;
				} catch (e) {
					console.log(e.description);
				  return false;
				}

			}
			s.innerHTML = curCodeTemp;
			p5f.document.head.appendChild(s);
			recompilePulse(codeStart, codeEnd)

			if(p5popCode){
				p5popCode.recompilePulse(codeStart, codeEnd)
			}
		}

		function getBackground(){
			let bgReg = /background\(([^)]+)\)/;
			let nonComments = editor.getValue();
			nonComments = nonComments.replace(/\s*\/\/.*\n/g, '\n').replace(/\s*\/\*[\s\S]*?\*\//g, '');
			let bgMatches = bgReg.exec(nonComments);
			if(bgMatches != null){
				newBG = '';
				if(bgMatches[1].includes('#')){
					newBG = bgMatches[1].replace(/["']/g, '');
				}else{
					let cols = bgMatches[1].split(',');
					if(cols.length > 2){
						newBG = rgb2hex(cols[0].trim(), cols[1].trim(), cols[2].trim());
					}else{
						newBG = rgb2hex(cols[0].trim(), cols[0].trim(), cols[0].trim());
					}
				}
				return newBG;
			}else{
				return false;
			}
		}


		function updateBackground(){
			let curBG = getBackground()
			if(curBG){
				if(sketchLoaded){
					p5f.document.body.style.background = curBG;
				}
				p5frame.style.background = curBG;
			}
		}

		function rgb2hex(red, green, blue) {
			let rgb = blue | (green << 8) | (red << 16);
			return '#' + (0x1000000 + rgb).toString(16).slice(1)
		}

		function loadScripts(elm){
			if(settings.debugMode){console.log(settings.scripts);}
			for(let i=0; i < settings.scripts.length; i++){
				elm.appendChild(loadScript(settings.scripts[i]));
			}
		}

		function loadScript(scriptPath){
			let ps = document.createElement('script');
			ps.type = 'text/javascript';
			ps.src = scriptPath;
			return ps;
		}

		function tidyCode(aceEdit){
			let tempPos = aceEdit.getCursorPosition();
			let tempCode = js_beautify(aceEdit.getValue(), beautifyOptions);
			aceEdit.setValue(tempCode, 1);
			aceEdit.gotoLine(tempPos.row+1, tempPos.column, false);
			aceEdit.focus()
		}



		/* SNIPPETS */

		
		// add for ace snippets: https://github.com/ajaxorg/ace/blob/v1.42.0/src/snippets.js#L1086

		function snippetsToggle(hide){
			let snippetsPanel = document.getElementById('snippets-panel')
			snippetsPosition()

			if(snippetsPanel.style.display == 'block' || hide){
				snippetsPanel.style.display = 'none'
			}else{
				snippetsPanel.style.display = 'block'
				snippetsApplyToggle(true)
			}
			snippetsForm(snip.current)
			// snippetsForm('demo-audio')
		}

		function snippetsManagerInit(){
			snippetsManagerLoaded = true
		}

		function snippetsManagerToggle(hide){
			let snippetsManagerHolder = document.getElementById('snippets-manager-holder')
			let snippetsManager = document.getElementById('snippets-manager')
			if(snippetsManagerHolder.style.display == 'block' || hide){
				snippetsManagerHolder.style.display = 'none'
			}else{
				snippetsManagerHolder.style.display = 'block'
				if(!snippetsManagerLoaded){
					snippetsManager.src = 'http://localhost:8888/p5live_snippets/?' +11//+ settings.revision	
					// snippetsManager.src = 'https://ffd8.github.io/p5live-snippets/?' + settings.revision	
				}
			}
		}

		function snippetsPosition(){
			let snippetsPanel = document.getElementById('snippets-panel')
				let snippetsPanelRight = 0
				if(checkMenu()){
					snippetsPanelRight += 250
				}
				if(document.getElementById('menu-switch').style.display == 'block'){
					snippetsPanelRight+= 30
				}

				snippetsPanel.style.right = snippetsPanelRight+'px';
		}

		function snippetsApplyToggle(hide){
			snip.selectApply.value = snip.current
			let snippetsApplyPanel = document.getElementById('snippets-panel-apply')
				if(checkMenu()){
					snippetsApplyPanel.style.right = '250px';
				}else{
					snippetsApplyPanel.style.right = '0px';
				}

				if(snippetsApplyPanel.style.display == 'block' || hide){
					snippetsApplyPanel.style.display = 'none'
				}else{
					snippetsApplyPanel.style.display = 'block'
					snippetsToggle(true)
					
					// focus on select for keyboard browsing + tab to apply
					editor.blur()
					snip.selectApply.focus()
				}
		}

		function snippetsApply(snippetCode = null, closeSnippets = true){
			let curSnippet = snippetApplyPrep(snippetCode)
			let tempSnippet = cloneJSON(curSnippet)

			let checkLibs = processLibs(tempSnippet.gt)
			let hasLibs = editor.getValue().match(/(?=var|let|const).*(?=loadScripts|libs|scripts).*?(\])/gs)
			if(checkLibs.length > 0 && hasLibs != null){
				tempSnippet.libs = checkLibs
				// strip libs from code, add to object, add to libs on apply
				tempSnippet.gt = tempSnippet.gt.replace(/(?=var|let|const).*(?=loadScripts|libs|scripts).*?(\])/gs, '')
			}
			// console.log(curSnippet)


			if(settings.snippetsghostmode.active){
				snippetApplyGhost(tempSnippet)
			}else{
				snippetsApplyInstant(tempSnippet)
			}

			if(closeSnippets){				
				snippetsToggle(true)
				snippetsApplyToggle(true)
			}
		}

		function snippetApplyPrep(snippetCode = null){
			if(snippetCode == null){
				let snippet = snip.current
				// console.log(snippet)
				let snippetBase = 'user'
				if(snippet.substring(0, 5) == 'demo-'){
					snippetBase = 'demo'
				}
				let snippetName = snippet.substring(5, snippet.length)
				if(settings.snippets[snippetBase].hasOwnProperty(snippetName)){
					return settings.snippets[snippetBase][snippetName];
				}else{
					return false
				}
			}else{
				return snippetCode
			}
			
		}
		
		function snippetsApplyInstant(snippetCode){
				let addGlobalTop = snippetCode.gt;
				let addGlobalBottom = snippetCode.gb;
				let addSetup = snippetCode.s;
				let addDrawTop = snippetCode.dt;
				let addDrawBottom = snippetCode.db;

				let curCode = editor.getValue();
				let curPos = editor.getCursorPosition()
				let curLineText = editor.session.getLine(curPos.row);

				// process found libs
				// console.log(snippetCode)
				if(snippetCode.hasOwnProperty('libs')){
					let curLibs = curCode.match(/(?=var|let|const).*(?=loadScripts|libs|scripts).*?(\])/gs)[0]

					// https://stackoverflow.com/a/47939877/10885535
					let newLibs = curLibs.slice(0, -1) + snippetCode.libs.map(lib => `,\n'${lib}'`).join('') + ',' + curLibs.slice(-1)
					curCode = curCode.replace(curLibs, `\n${newLibs}\n`)
				}

				let codeGlobalTop = addGlobalTop + '\n' + curCode;
				let codeSetup = addCode(codeGlobalTop, addSetup, 'setup', 'bottom');
				let codeDrawTop = addCode(codeSetup, addDrawTop, 'draw', 'top');
				let codeDrawBottom = addCode(codeDrawTop, addDrawBottom, 'draw', 'bottom');
				let codeGlobalBottom = codeDrawBottom + '\n\n' + addGlobalBottom;

				editor.setValue(codeGlobalBottom, 1);
				tidyCode(editor);
				editor.focus()

				if(!settings.cocoding.active){
					localStorage[settings.fileName] = editor.getValue();
				}

				// return cursor to previous position (** fix if blank line)
				let curLines = editor.getValue().split('\n')
				if(curLineText != ''){
					let curRow = curLines.indexOf(curLineText)
					editor.moveCursorTo(curRow, curPos.column);
					editor.renderer.scrollCursorIntoView({row: curRow, column: curPos.column}, 0.5);
				}
		}

		function snippetApplyGhost(snippetCode){
			let curCode = editor.getValue();
			let curPos = editor.getCursorPosition()
			let curLineText = editor.session.getLine(curPos.row);

			editorGhost.snippetsApply(snippetCode)				

			// return cursor to previous position (** fix if blank line)
			let curLines = editor.getValue().split('\n')
			if(curLineText != ''){
				let curRow = curLines.indexOf(curLineText)
				editor.moveCursorTo(curRow, curPos.column);
				editor.renderer.scrollCursorIntoView({row: curRow, column: curPos.column}, 0.5);
			}
		}


		let snip = {
			sections : ['gt', 's', 'dt', 'db', 'gb'],
			select: document.getElementById('snippets-select'),
			selectApply: document.getElementById('snippets-select-apply'),
			editors:{},
			changed : false,
			current: 'demo-audio'
		}

		function snippetsLoad(){
			snippetsSelect(snip.current.substring(5, snip.current.length))

			for (const s of snip.sections) {
				snip.editors[s] = ace.edit(document.getElementById(`snippets-code-${s}`))
				let snipEdit = snip.editors[s]
				snipEdit.setTheme(settings.theme);
				snipEdit.session.setMode('ace/mode/javascript');
				snipEdit.setOptions({
					showPrintMargin: false,
					animatedScroll: false,
					displayIndentGuides: false,
					useWorker: true,
					showLineNumbers: false,
					showGutter: false,
					tabSize: 4, useSoftTabs: false,
				});
				snipEdit.getSession().on('change', function() {
					snip.changed = true
					snippetsSavePulse()
				});
			}
			snippetsForm('demo-audio')
		}

		function snippetsSelect(sel){
			if(settings.hasOwnProperty('snippets')){
				snip.select.innerHTML = ''
				snip.selectApply.innerHTML = ''
				snippetSelectParse('demo', sel)
				snippetSelectParse('user', sel)
				// console.log(sel)
			}
		}

		function snippetSelectParse(base, sel){
			let snippets = settings.snippets
			snip.select.innerHTML += `<optgroup label="${base}">`
			snip.selectApply.innerHTML += `<optgroup label="${base}">`
			for (const key in snippets[base]) {
				let selected = ''
				if(sel == key){
					selected = 'selected'
					snip.current = `${base}-${sel}`
				}
				snip.select.innerHTML += `<option value="${base}-${key}" ${selected}>${key}</option>`
				snip.selectApply.innerHTML += `<option value="${base}-${key}" ${selected}>${key}</option>`
			}
			snip.select.innerHTML += `</optgroup>`
			snip.selectApply.innerHTML += `</optgroup>`
		}

		function snippetsApplySelect(snippet){
			snip.current = snippet
			snippetsSelect(snip.current.substring(5, snip.current.length))
		}

		function snippetsForm(snippet){
			if(snippet !== undefined){
				let snippetBase = 'user'
				if(snippet.substring(0, 5) == 'demo-'){
					snippetBase = 'demo'
				}
				let snippetName = snippet.substring(5, snippet.length)
				if(settings.snippets[snippetBase].hasOwnProperty(snippetName)){
					let snippetCur = settings.snippets[snippetBase][snippetName]
					for (const key in snip.editors) {
						snip.editors[key].setValue(snippetCur[key], 1)
					}
					snip.changed = false
					snippetsSavePulse()
					snippetsNav()
					if(snippetBase == 'demo'){
						snippetsNav(true)
					}
					snip.current = snippet
				}
				
			}else{
				return {
					gt: snip.editors.gt.getValue(),
					s: snip.editors.s.getValue(),
					dt: snip.editors.dt.getValue(),
					db: snip.editors.db.getValue(),
					gb: snip.editors.gb.getValue(),
				}
			}
		}

		function snippetsNav(mode){
			let snippetBtns = document.getElementsByClassName('snippets-btn-demo')
			for(let sb of snippetBtns){
				sb.style.display = 'inline'
				sb.disabled = false
				if(mode){
					// sb.style.display = 'none'
					sb.disabled = 'disabled'
				}
			}
		}

		function snippetsSave(){
			settings.snippets.user[snippetsCurrent()] = snippetsForm()
			updateSettings()
			snip.changed = false
			snippetsSavePulse()
		}

		function snippetsSavePulse(){
			if(snip.changed){
				if(snip.current.includes('demo-')){
					document.getElementById('snippets-btn-clone').classList.add('pulse')					
				}else{
					document.getElementById('snippets-btn-save').classList.add('pulse')					
				}
			}else{
				document.getElementById('snippets-btn-clone').classList.remove('pulse')					
				document.getElementById('snippets-btn-save').classList.remove('pulse')
			}
		}

		function snippetsImportDialog(){
			document.getElementById('file-input-snippet').click()
		}

		function snippetsImport(data){
			for(let i=0; i < data.length; i++){
				let reader = new FileReader()
				reader.onload = function(data) {
					// console.log(data)
					let tSnippet
					
					try{
						tSnippet = JSON.parse(data.target.result);
						
						if(tSnippet.hasOwnProperty('doctype') && tSnippet.doctype == 'P5L_SNIPPET'){
							snippetsImportParse(tSnippet)
						}else{
							vex.dialog.alert({
								message:'Oops, select a P5L_SNIPPET file.'
							})
						}
					}catch(e){
						// console.log(e)
						vex.dialog.alert({
							message:'Oops, select a P5L_SNIPPET file.'
						})
					}
					
				}
				reader.readAsText(data[i])
			}
		}

		function snippetsImportParse(tSnippet){
			let newName = tSnippet.name.replace(/["']/g, '')
			let nameDup = false
			if(settings.snippets.user.hasOwnProperty(newName)){
				newName += `_${Math.floor(Math.random()*9999)}`
				nameDup = true
			}

			settings.snippets.user[newName] = tSnippet.code
			updateSettings()
			snippetsSelect(newName)
			snippetsForm(`user-${newName}`)
			if(nameDup){
				snippetsUpdate('import')
			}
		}

		function snippetsExport(){
			let tempTimestamp = timeStampFile();
			let snippetExport = {version:currentVersion, revision:currentRevision, doctype:'P5L_SNIPPET', name:snippetsCurrent()}
			snippetExport.code = snippetsForm()
			exportJSON(snippetExport, 'P5L_SNIPPET_' + snippetExport.name + tempTimestamp + '.json');
		}

		function snippetsUpdate(mode, rename){
			vex.dialog.prompt({
				message: mode == 'clone' ? 'Save As:' : 'Rename:',
				value: rename ? rename : snippetsCurrent(), // placeholder
				callback: function (value) {
					if(value){
						let newName = value.replace(/["']/g, '');
						if(newName != ''){
							if(!settings.snippets.user.hasOwnProperty(newName)) {
								if(mode == 'clone'){
									settings.snippets.user[newName] = snippetsForm()
								}else if(mode == 'rename' || mode == 'import'){
									delete settings.snippets.user[snippetsCurrent()]
									settings.snippets.user[newName] = snippetsForm()
								}
								updateSettings()
								snippetsSelect(`${newName}`)
								snippetsNav()
								snip.changed = false
								snippetsSavePulse()
							}else{
								if(mode == 'clone' || mode == 'rename' || (newName != snippetsCurrent() && settings.snippets.user.hasOwnProperty(newName))){
									vex.dialog.alert({
										unsafeMessage:'"'+newName +'" already exists. <br>Pick a new name',
										callback: function(){snippetsUpdate(mode, newName)},
										afterOpen: function(){
											vexClass(this.rootEl, 'vex-small')
										}
									})
								}
								return false;
							}
						}
					}
				},
				afterOpen: function(){
					document.getElementsByClassName('vex-dialog-prompt-input')[0].select();
				}
			})
		}

		function snippetsCurrent(){
			return snip.select.value.substring(5, snip.select.value.length)
		}

		function snippetsDelete(){
			vex.dialog.confirm({
				unsafeMessage: `Delete: ${snippetsCurrent()}?`,
				callback: function (value) {
					if (value) {
						delete settings.snippets.user[snippetsCurrent()]
						updateSettings()
						snippetsSelect()
						snippetsForm('demo-new')
					}
				},
				afterOpen: function(){
					vexClass(this.rootEl, 'vex-small')
				}
			})
		}
		

		// OLD SNIPPETS
		function loadSnippets(jsonObj){
			// console.log(jsonObj)
			settings.snippets.demo = jsonObj
			// snippets = jsonObj;
			// let dropCommands = [];
			// let cmds = editor.commands;
			// for(let i=0; i < snippets.length; i++){
			// 	let snippetKey = snippets[i].key+'';
			// 	let findCommand = cmds.commandKeyBinding['ctrl-shift-'+snippetKey.toLowerCase()];
			// 	if(findCommand != undefined){
			// 		dropCommands.push(findCommand.name);
			// 	}
			// }
			// editor.commands.removeCommands(dropCommands);
		}

		// ** replaced with applySnippet()
		// function addSnippet(loadSnippet){
		// 	let snippetIndex = snippets.map(function(d) { return d['key']; }).indexOf(loadSnippet);
		// 	if(snippetIndex == -1){
		// 		return false;
		// 	}
		// 	let snippetCode = snippets[snippetIndex].code;
		// 	let addGlobalTop = snippetCode.global.top;
		// 	let addGlobalBottom = snippetCode.global.bottom;
		// 	let addSetup = snippetCode.setup;
		// 	let addDrawTop = snippetCode.draw.top;
		// 	let addDrawBottom = snippetCode.draw.bottom;

		// 	let curCode = editor.getValue();
		// 	let curPos = editor.getCursorPosition()
		// 	let curLineText = editor.session.getLine(curPos.row);

		// 	let codeGlobalTop = addGlobalTop + '\n' + curCode;
		// 	let codeSetup = addCode(codeGlobalTop, addSetup, 'setup', 'bottom');
		// 	let codeDrawTop = addCode(codeSetup, addDrawTop, 'draw', 'top');
		// 	let codeDrawBottom = addCode(codeDrawTop, addDrawBottom, 'draw', 'bottom');
		// 	let codeGlobalBottom = codeDrawBottom + '\n\n' + addGlobalBottom;

		// 	editor.setValue(codeGlobalBottom, 1);
		// 	tidyCode(editor);

		// 	// return cursor to previous position (** fix if blank line)
		// 	let curLines = editor.getValue().split('\n')
		// 	if(curLineText != ''){
		// 		let curRow = curLines.indexOf(curLineText)
		// 		editor.moveCursorTo(curRow, curPos.column);
		// 		editor.renderer.scrollCursorIntoView({row: curRow, column: curPos.column}, 0.5);
		// 	}
		// }

		function addCode(codeBase, codeInsert, funName, codePos){
			let tempCode, tempPos = addPosition(codeBase, funName);
			if(codePos === 'bottom'){
				tempCode = [codeBase.slice(0, tempPos[1]), '' + codeInsert + "\n", codeBase.slice(tempPos[1])].join('');
			}else if(codePos === 'top'){
				tempCode = [codeBase.slice(0, tempPos[0]), codeInsert + '', codeBase.slice(tempPos[0])].join('');
			}
			return tempCode;
		}

		// grab start/end of function, modded for position only
		// https://stackoverflow.com/a/49240267/10885535
		function addPosition(content, functionName) {
			// Find function
			const indexOfFunc = content.indexOf(`function ${functionName}`);

			if (indexOfFunc < 0) {
				return content;
			}

			const openingBrace = content.indexOf('{', indexOfFunc);

			const startPos = openingBrace + 1;
			let endPos = startPos;
			let bracesToBalance = 1;

			while (true) {
				if (content[endPos] === '{') {
					bracesToBalance++;
				} else if (content[endPos] === '}') {
					bracesToBalance--;
					if (bracesToBalance === 0) break;
				}
				endPos++;
			}

			return [startPos, endPos];
		};



		/* SETTINGS TOGGLES */

		// toggle auto-compile
		function autoCompileToggle(){
			settings.autoCompile = !settings.autoCompile;
			autoCompileUpdate();
		}

		function autoCompileUpdate(){
			checkToggle('autoCompile', settings.autoCompile, settingsAutoMode, 'Live Coding');
			if(settings.autoCompile){
				settingsCompileTimer.style.display = 'inline';
			}else{
				settingsCompileTimer.style.display = 'none';
			}
		}

		// auto-compile delay on keyup
		function compileTimerChange(){
			settings.compileTimer = settingsCompileTimer.value;
			updateSettings();
		}

		function compileTimerUpdate(){
			for(let i=0; i < settingsCompileTimer.options.length; i++){
				let opt = settingsCompileTimer.options[i];
				if(settings.compileTimer == opt.value){
					settingsCompileTimer.selectedIndex = i;
				}
			}
		}


		// toggle ecorender (pause if focus is lost)
		function ecoRenderToggle(){
			settings.ecoRender = !settings.ecoRender;
			ecoRenderUpdate();
		}

		function ecoRenderUpdate(){
			checkToggle('ecoRender', settings.ecoRender, settingsEcoMode, 'Eco Render');
		}


		// loop/noLoop on window blur

		window.onblur = function () {
			// deactivate modifier keys
			keyMap[16] = false;
			keyMap[17] = false;

			if(settings.cocoding.active){
				cocode.socket.emit('status', 'blur');
			}
			if(settings.ecoRender && sketchLoaded && !settings.cocoding.sync && settings.editMode && !chalkboardVisible){
				if(document.activeElement !== p5frame){
					p5f.noLoop();
				}
			}
		}

		window.onfocus = function () {
			// deactivate modifier keys
			keyMap[16] = false;
			keyMap[17] = false;

			if(settings.cocoding.active){
				cocode.socket.emit('status', 'focus');
				cocode.updateColor();
			}
			if(sketchLoaded && !paused){
				p5f.loop();
			}
		}

		p5editor.onfocus = function () {
			// deactivate modifier keys
			keyMap[16] = false;
			keyMap[17] = false;
		}


		// toggle fullscreen (better to use browser native fullscreen)
		function fullscreenToggle(){
			settings.fullscreenMode = !settings.fullscreenMode;
			fullscreenUpdate();
		}

		function fullscreenUpdate(){
			checkToggle('fullscreenMode', settings.fullscreenMode, settingsFullscreen, 'Full Screen');
			if(settings.fullscreenMode){
				if(sketchLoaded){
					openFullscreen();
					editorToggleUpdate();
				}
			}else{
				if(sketchLoaded){
					closeFullscreen();
				}
			}
		}



		//console toggle
		function consoleToggle(){
			settings.console = !settings.console;
			consoleToggleUpdate();
		}

		function consoleToggleUpdate(){
			checkToggle('console', settings.console, settingsConsole, 'Console');
			if(!settings.console){
				p5console.style.display = 'none';
				settingsConsoleMode.style.display = 'none'
				p5l.console = false
			}else{
				p5console.style.display = 'block';
				settingsConsoleMode.style.display = 'inline'
				p5l.console = true
			}
		}

		// console toggle
		function consoleMode(){
			settings.consoleMode = settingsConsoleMode.value;
			consoleModeUpdate()
			updateSettings();
		}

		function consoleModeUpdate(){
			for(let i=0; i < settingsConsoleMode.options.length; i++){
				let opt = settingsConsoleMode.options[i];
				if(settings.consoleMode == opt.value){
					settingsConsoleMode.selectedIndex = i;
				}
			}
			p5l.consoleMode = settings.consoleMode
			if(p5l.consoleMode == 'show'){
				p5console.style.display = 'block';
			} else {
				// p5console.style.display = 'none';
			}
		}

		//menutab toggle
		function menutabToggle(){
			settings.menutab = !settings.menutab;
			menutabToggleUpdate();
		}

		function menutabToggleUpdate(){
			checkToggle('menutab', settings.menutab, settingsMenutab, 'Menu Tab');
			if(!settings.menutab){
				menuSwitch.style.display = 'none';
			}else{
				menuSwitch.style.display = 'block';
			}
			snippetsPosition()
		}

		//linenumbers toggle
		function linenumbersToggle(){
			settings.editor.linenumbers = !settings.editor.linenumbers;
			linenumbersUpdate();
		}

		function linenumbersUpdate(){
			checkToggle('linenumbers', settings.editor.linenumbers, settingsLinenumbers, 'Line Numbers');
			if(!settings.editor.linenumbers){
				editor.setOptions({
					showLineNumbers: false, // false
					showGutter: false, // false
				});
			}else{
				editor.setOptions({
					showLineNumbers: true, // false
					showGutter: true, // false
				});
			}
		}

		//linenumbers toggle
		function pulseToggle(){
			settings.editor.recompilepulse = !settings.editor.recompilepulse;
			pulseUpdate();
		}

		function pulseUpdate(){
			checkToggle('recompilepulse', settings.editor.recompilepulse, settingsRecompilepulse, 'Recompile Pulse');
			if(!settings.editor.recompilepulse){
				useRecompilePulse = false
			}else{
				useRecompilePulse = true
			}
		}

		//autoComplete toggle
		function autocompleteToggle(){
			settings.editor.autocomplete = !settings.editor.autocomplete;
			autocompleteUpdate();
		}

		function autocompleteUpdate(){
			checkToggle('autocomplete', settings.editor.autocomplete, settingsAutocomplete, 'Auto Autocomplete');
			if(!settings.editor.autocomplete){
				editor.setOptions({
					enableLiveAutocompletion: false
				});
			}else{
				editor.setOptions({
					enableLiveAutocompletion: true
				});
			}
		}

		// lockCode toggle
		function lockDragToggle(){
			settings.editor.lockcode = !settings.editor.lockcode;
			lockDragUpdate();
		}

		function lockDragUpdate(){
			checkToggle('lockcode', settings.editor.lockcode, settingsLockDrag, 'Lock Code on Drag');
		}

		// passEditorKeys toggle
		function passEditorKeysToggle(){
			settings.editor.passEditorKeys = !settings.editor.passEditorKeys;
			passEditorKeysUpdate();
		}

		function passEditorKeysUpdate(){
			checkToggle('passeditorkeys', settings.editor.passEditorKeys, settingsPassEditorKeys, 'Pass-Thru Keypress');
		}

		// notify toggle
		function notifyToggle(){
			settings.notifyToggle = !settings.notifyToggle;
			notifyToggleUpdate();
		}

		function notifyToggleUpdate(){
			checkToggle('notifytoggle', settings.notifyToggle, settingsNotify, 'Notifications');
		}

		// tippy toggle
		function tippyToggle(){
			settings.tippyToggle = !settings.tippyToggle;
			tippyToggleUpdate();
		}

		function tippyToggleUpdate(){
			checkToggle('tippytoggle', settings.tippyToggle, settingsTippy, 'Tooltips');
			loadTippy();
		}

		// multi-p5live toggle
		function multitabToggle(){
			settings.multitabToggle = !settings.multitabToggle;
			multitabToggleUpdate();
		}

		function multitabToggleUpdate(){
			checkToggle('multitabtoggle', settings.multitabToggle, settingsMultitab, 'Multi-P5LIVE Warning');
		}

		// timestamp exports toggle
		function timestampToggle(){
			settings.timestampToggle = !settings.timestampToggle;
			timestampToggleUpdate();
		}

		function timestampToggleUpdate(){
			checkToggle('timestamptoggle', settings.timestampToggle, settingsTimestamp, 'Timestamp Exports');
		}

		// autosave if server connection lost
		function cocodingAutosaveToggle(){
			settings.cocodingAutosaveToggle = !settings.cocodingAutosaveToggle;
			cocodingAutosaveToggleUpdate();
		}

		function cocodingAutosaveToggleUpdate(){
			checkToggle('cocodingautosavetoggle', settings.cocodingAutosaveToggle, settingsCocodingAutosave, 'COCODING Autosave');
		}

		// always show user flags
		function cocodingFlagsToggle(){
			settings.cocodingFlagsToggle = !settings.cocodingFlagsToggle;
			cocodingFlagsToggleUpdate();
		}

		function cocodingFlagsToggleUpdate(){
			checkToggle('cocodingflagstoggle', settings.cocodingFlagsToggle, settingsCocodingFlags, 'COCODING Flags');
		}

		// check P5LIVE version updates
		function checkupdatesToggle(){
			settings.checkupdatesToggle = !settings.checkupdatesToggle;
			checkupdatesToggleUpdate();
		}

		function checkupdatesToggleUpdate(){
			checkToggle('checkupdatestoggle', settings.checkupdatesToggle, settingsCheckupdates, 'Check Updates');
		}

		//exportcode toggle
		function exportcodeToggle(){
			settings.exportCode = !settings.exportCode;
			linenumbersUpdate();
		}

		function exportcodeUpdate(){
			checkToggle('exportCode', settings.exportCode, settingsExportcode, 'Snapshot Code');
		}

		//themeBGactive toggle
		function themeBGactiveToggle(){
			settings.themeBGactive = !settings.themeBGactive;
			themeBGactiveToggleUpdate();
		}

		function themeBGactiveToggleUpdate(){
			checkToggle('themeBGactive', settings.themeBGactive, settingsBGactive, 'Code Background');
			editor.renderer.updateFull();
		}

		//themeColoractive toggle
		function themeCOLORactiveToggle(){
			settings.themeCOLORactive = !settings.themeCOLORactive;
			themeCOLORactiveToggleUpdate();
		}

		function themeCOLORactiveToggleUpdate(){
			checkToggle('themeCOLORactive', settings.themeCOLORactive, settingsCOLORactive, 'Code Color');
			editor.renderer.updateFull();
		}

		//themeActiveactive toggle
		function themeACTIVEactiveToggle(){
			settings.themeACTIVEactive = !settings.themeACTIVEactive;
			themeACTIVEactiveToggleUpdate();
		}

		function themeACTIVEactiveToggleUpdate(){
			checkToggle('themeACTIVEactive', settings.themeACTIVEactive, settingsACTIVEactive, 'Active Line Color');
			editor.renderer.updateFull();
		}

		function snippetsghostmodeToggle(){
			settings.snippetsghostmode.active = !settings.snippetsghostmode.active;
			snippetsghostmodeToggleUpdate();
		}

		function snippetsghostmodeToggleUpdate(){
			checkToggle('snippetsghostmode.active', settings.snippetsghostmode.active, settingsSnippetsghostmodeToggle, 'Snippets GhostMode');
		}

		function snippetsghostmodeDelay(newVal){
			settings.snippetsghostmode.delay = parseFloat(newVal);
			updateSettings();
			snippetsghostmodeDelayUpdate();
		}

		function snippetsghostmodeDelayUpdate(){
			if(settingsSnippetsghostmodeDelay !== document.activeElement){
				settingsSnippetsghostmodeDelay.value = parseFloat(settings.snippetsghostmode.delay)
			}
			editorGhost.delay = settings.snippetsghostmode.delay
		}

		function sonicodeToggle(){
			settings.sonicode.active = !settings.sonicode.active;
			sonicodeToggleUpdate();
		}

		// var p5livePolySynth, p5livePolySynthLoader, p5livePolySynthLoaded = false
		function sonicodeToggleUpdate(){
			checkToggle('sonicode.active', settings.sonicode.active, settingsSoniCode, 'SoniCode');

			for(let i=0; i < settingsSoniCodeMode.options.length; i++){
				let opt = settingsSoniCodeMode.options[i];
				if(settings.sonicode.mode == opt.value){
					settingsSoniCodeMode.selectedIndex = i;
				}
			}

			for(let i=0; i < settingsSoniCodePoly.options.length; i++){
				let opt = settingsSoniCodePoly.options[i];
				if(settings.sonicode.poly == opt.value){
					settingsSoniCodePoly.selectedIndex = i;
				}
			}

			for(let i=0; i < settingsSoniCodeBase.options.length; i++){
				let opt = settingsSoniCodeBase.options[i];
				if(settings.sonicode.base == opt.value){
					settingsSoniCodeBase.selectedIndex = i;
				}
			}

			if(settings.sonicode.active){
				settingsSoniCodeDetails.style.display = 'block'
				// editor.getSession().on('change', function(delta) {
				//     var curChar = delta.lines[0].charCodeAt(0)
				//     sonicode(curChar)
				// }) 

				editor.on('change', sonicodeParse);
				if(!sonicode.p5livePolySynthLoaded){
					console.log('loading sonicode')
					sonicodeSetup()
				}
			}else{
				settingsSoniCodeDetails.style.display = 'none'
				if(sonicode.p5livePolySynthLoaded){
					editor.off('change', sonicodeParse);
				}
			}
		}

		// function sonicodeSetup(){
		// 	// wait until p5 libs loaded
		// 	if(p5f.p5 == undefined){
		// 		clearInterval(p5livePolySynthLoader)
		// 		p5livePolySynthLoader = setInterval(()=>{
		// 			if(p5f.p5 !== undefined){
		// 				clearInterval(p5livePolySynthLoader)
		// 				sonicodeSetup()
		// 				p5livePolySynthLoaded = true
		// 			}
		// 		}, 400)
		// 		return
		// 	}


		// 	p5livePolySynth = new p5f.p5.PolySynth();
		// 	p5livePolySynth.polyvalue = settings.sonicode.poly

		// 	if(settings.sonicode.mode == 'midi'){

		// 	}else{
		// 		for(let av of p5livePolySynth.audiovoices){
		// 			av.oscillator.oscillator.type = settings.sonicode.mode
		// 		}
		// 	}
			
		// }

		function sonicodeMode(mode){
			settings.sonicode.mode = mode
			sonicodeSetup()
		}

		function sonicodePoly(poly){
			settings.sonicode.poly = poly
			sonicodeSetup()
		}

		function sonicodeBase(base){
			settings.sonicode.base = base
			sonicodeSetup()
		}

		function sonicodeSetup(){
			updateSettings()
			sonicode.sonicodeSetup(settings.sonicode)
		}

		function sonicodeParse(delta) {
			sonicode.sonicodeParse(delta)
		}


		// checkbox function
		function checkToggle(checkName, checkVar, checkElm, checkNotify){
			if(checkVar){
				checkElm.checked = true;
			}else{
				checkElm.checked = false;
			}
			settings[checkName] = checkVar;
			updateSettings();

			// show notify of changed prefs by shortcut
			if(showNotify){
				let notifyChecked = '';
				if(checkVar){
					notifyChecked = 'checked';
				}
				let notifyName = checkName;
				if(checkNotify !== undefined){
					notifyName = checkNotify;
				}
				let notifyTxt = '<input type="checkbox" ' + notifyChecked + '> ' + notifyName;
				notifyMsg(notifyTxt);
			}
			if(settings.debugMode){console.log(checkName+': '+settings[checkName]);}
		}

		function p5varsReset(){
			p5vars = {frameCount:0, pframeCount:0, mouseX:0, mouseY:0};
		}



		/* TOGGLE EDITOR + [canvas] + MENU */

		// hide/show editor
		function editorToggle(force){
			if(p5editor.style.visibility != 'visible' && !force){
				p5editor.style.visibility = 'visible';
				p5console.style.display = 'block'
			}else{
				p5editor.style.visibility = 'hidden';
				if(settings.consoleMode == 'auto'){
					p5console.style.display = 'none'
				}
			}
			editorToggleUpdate();
		}

		function editorToggleUpdate(){
			if(p5editor.style.visibility != 'visible'){
				const canv = document.querySelector('canvas');
				editor.blur();
			}else{
				editor.focus();
			}
		}

		// hide/show canvas
		// future usage for etherpad editing...

		/*
		function canvasToggle(){
			const canv = document.querySelector('canvas');
			//alert(canv);
			if(canv.style.visibility != 'visible'){
				canv.style.visibility = 'visible';
			}else{
				canv.style.visibility = 'hidden';
			}
			canvasToggleUpdate();
		}

		function canvasToggleUpdate(){
			const canv = document.querySelector('canvas');
			if(canv.style.visibility != 'visible'){
				if(sketchLoaded)
					noLoop();
			}else{
				if(sketchLoaded)
					loop();
			}
		}
		*/


		// hide/show menu
		function menuToggle(show){
			if(refVisible){
				// console.log('closing ref')
				closeRef();
			}

			if(panelSettings.style.display == 'block'){
				hideSettings();
			}else{
				settings.menuMode = show || !settings.menuMode;
			}

			updateSettings();
			menuToggleUpdate();
			resizeSketchesHolder();
			snippetsPosition()
		}

		function hideMenu(){
			settings.menuMode = false;
			updateSettings();
			menuToggleUpdate();
		}

		function menuToggleUpdate(){
			if(!settings.menuMode){
				menuPanel.style.marginRight = '-250px';
				menuSwitch.innerHTML = '«';
				window.setTimeout(hideSettings, 200);
				menuVisible = false;
				// menuPanel.style.overflow = "visible"; // test again w/ chromium
			}else{
				menuPanel.style.marginRight = '0px';
				menuSwitch.innerHTML = '»';
				filterSketchesClear();
				// menuSketchesFilter.value = ''; // *** double check
				menuVisible = true;
				// menuPanel.style.overflow = "hidden";
			}

			// toggle position of chalkboard
			if(chalkboardFrame !== undefined){
				chalkboardFrame.checkMenu();
			}
		}


		// load theme
		function loadTheme(){
			for(let i=0; i < settingsTheme.options.length; i++){
				let opt = settingsTheme.options[i];
				if(settings.theme == opt.value){
					settingsTheme.selectedIndex = i;
				}
			}
		}

		// set theme
		function setTheme(sel){
			editor.setTheme(settingsTheme.value);
			settings.theme = settingsTheme.value;
			updateSettings();
		}

		// set pickrColor
		function setPickr(val, elm, pickrSettings){
			if(settings[pickrSettings] != val){
				settings[pickrSettings] = '#'+ val;
				// console.log(elm)
				// console.log(document.querySelector('#pickr-background'))
				document.querySelector(elm).style.backgroundColor = '#' + val;

				// document.getElementById(elm).style.backgroundColor = '#' + val;
				updateSettings();
				editor.renderer.updateFull();
			}
		}


		// load keybindings
		function loadKeybindings(){
			for(let i=0; i < settingsKeybindings.options.length; i++){
				let opt = settingsKeybindings.options[i];
				if(settings.hasOwnProperty('editor') && settings.editor.keybinding == opt.value){
					setKeybinding(opt.value);
					settingsKeybindings.selectedIndex = i;
				}
			}
		}

		// set keybindings
		function setKeybinding(sel){
			settings.editor.keybinding = sel;
			updateSettings();
			editor.setKeyboardHandler('ace/keyboard/'+sel);
			setEditorCommands();
		}

		function loadBackup(){
			for(let i=0; i < settingsBackup.options.length; i++){
				let opt = settingsBackup.options[i];
				if(settings.backup.frequency == opt.value){
					settingsBackup.selectedIndex = i;
				}
			}
			// setBackup(settings.backup.frequency);
		}

		function setBackup(sel){
			settings.backup.frequency = sel;
			updateSettings();
		}

		// paused for launch.. to visit in future!
		function styleMenu(){
			// buttons
			//setStyle('class', 'menu-button', 'backgroundColor', ColorLuminance(settings.themeBG, .4));
		}

		function setStyle(styleType, styleElm, styleAttribute, styleChange){
			let elms;
			if(styleType == 'class'){
				elms = document.getElementsByClassName(styleElm);
			}else if(styleType == 'tag'){
				elms = document.getElementsByTagName(styleElm);
			}else if(styleType == 'id'){
				elms = document.getElementById(styleElm);
			}
			for(let i=0; i < elms.length; i++){
				elms[i].style[styleAttribute] = styleChange;
			}
		}

		// https://www.sitepoint.com/javascript-generate-lighter-darker-color/
		/*
		function ColorLuminance(hex, lum) {
			// validate hex string
			hex = String(hex).replace(/[^0-9a-f]/gi, '');
			if (hex.length < 6) {
				hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
			}
			lum = lum || 0;

			// convert to decimal and change luminosity
			let rgb = '#', c;
			for (let i = 0; i < 3; i++) {
				c = parseInt(hex.substr(i*2,2), 16);
				c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
				rgb += ('00'+c).substr(c.length);
			}

			return rgb;
		}
		*/

		// adjust fontsize
		function fontSizeAdjust(newVal){
			settings.editor.fontSize = parseFloat(settings.editor.fontSize) + parseFloat(newVal);
			updateSettings();
			fontSizeUpdate();
		}

		function fontSizeSet(newVal){
			settings.editor.fontSize = parseFloat(newVal);
			updateSettings();
			fontSizeUpdate();
		}

		function fontSizeUpdate(){
			if(settingsFontsize !== document.activeElement){
				settingsFontsize.value = settings.editor.fontSize;
			}
			p5code.style.fontSize = settings.editor.fontSize + 'pt';
			p5console.style.fontSize = settings.editor.fontSize + 'pt';
		}



		/* LOAD VARIOUS SKETCHES */
		function loadDefault(){
			if(!settings.cocoding.active){
				settings.fileName = 'new'; // jump to demos/new
				updateSettings();
				if(settings.sketches.length > 0){
					loadSketch(settings.fileName, 7); // put cursor in draw
				}
				filterSketchesClear();
			}else if(settings.cocoding.level == 'admin'){
				vex.dialog.confirm({
					message:'Replace COCODING code with template?',
					callback: function(value){
						if(value){
							cocode.codeReplace({'code':p5template});
							// editor.setValue(p5template, 1);
							// editor.gotoLine(7, 1, false);
							// editor.focus();
						}
					},
					afterOpen: function(){
						vexClass(this.rootEl, 'vex-small')
					}
				})
			}
		}




		function loadAbout(){
			let markedOptions = {
				headerPrefix:'marked-'
			};
			let demosPath = 'README.md?' + settings.revision;
			let request = new XMLHttpRequest();
			request.open('GET', demosPath, true);
			request.send();
			request.addEventListener('load', function(){
				let markedReadme = marked(request.responseText, markedOptions);
				let verrev = '<p>v '+ settings.version + ' - r' + settings.revision+'<br>';
				markedReadme = markedReadme.replace(/(<p>).+?(<br>)/, verrev); // <p[^>]*> // [v-\d].*<br>cc
				let p5liveabout = `<div id="about-toc"><select id="about-toc-select" onchange="scrollVex(this.value)"><option value="marked-p5live">[≡] README – TABLE OF CONTENTS</option></select></div><div id="p5liveabout" class="vex-about vex-long">${markedReadme}</div>`;

				vex.dialog.alert({
					unsafeMessage:p5liveabout,
					afterOpen: function(){
						vexFocus();
		
						var voxmsg = document.getElementById('p5liveabout')

						// check scroll
						voxmsg.addEventListener('scroll', (e)=>{
							var toc = document.getElementById('about-toc-select')
							var opClosest = {min:1000, id:'', prev: toc.value}
							hs.forEach(op => {
								var opTop = document.getElementById(op.id).offsetTop
								var opOffset = Math.abs(voxmsg.scrollTop - opTop)
								if(opOffset <= 20){ // opOffset <= opClosest.min
									opClosest.min = opOffset
									opClosest.id = op.id
								}
							})

							if(opClosest.id != '' && opClosest.id != opClosest.prev){
								toc.value = opClosest.id
							}
						})

						// build TOC
						var hs = voxmsg.querySelectorAll("h1, h2, h3, h4")
						var toc = document.getElementById('about-toc-select')
						hs.forEach(op => {
							op.spacing = ('').padStart(op.tagName.substring(1, 2)*3, ' ')
							if(op.id !== "marked-p5live"){
								toc.innerHTML += `<option value="${op.id}">${op.spacing + op.innerHTML}</option>`
							}
						})

						// disable about links in exhibitmode
						if(exhibitMode){
							preventLinks()
						}
					}
				})
			});
		}

		function scrollVex(elm){
			var voxmsg = document.getElementById('p5liveabout')
			var el = document.getElementById(elm).offsetTop
			if(elm == 'marked-p5live'){
				el = 0
			}
			voxmsg.scroll({top: el, behavior: 'smooth'})
		}

		function loadChangelog(){
			// changelog.revision
			let portWarning = ''
			if(!p5l.remote){
				portWarning = `<br><br><b>v1.5.0+ now uses port :5001 by default! Restart offline-mode \`npm start 5000\` for sketches and/or backup everything then switch to :5001.</b>`
			}
			let changeUpdate = `
				<h1 style="font-size:1.5em;">P5LIVE</h1>
				Updated: <i>v${changelog.version} r${changelog.revision} → v${settings.version} r${settings.revision}</i><br>
				See <a onclick="vex.closeAll();loadAbout()" style="cursor:pointer;text-decoration:underline;">About</a> for overview<br>
				Visit <a href="https://github.com/ffd8/P5LIVE/pulls?q=is%3Apr+is%3Aclosed" target="_blank" style="color:#fff;">Github Repo</a> for details.${portWarning}`
			vex.dialog.alert({
				unsafeMessage:changeUpdate,
				afterOpen: function(){
					vexClass(this.rootEl, 'vex-small')
					vexFocus();
				}
			});
		}



		// Tooltips via tippy
		function loadTippy(){
			if(!settings.tippyToggle){
				document.querySelectorAll('*').forEach(node => {
				if (node._tippy) {
					node._tippy.destroy();
				}
				});
				return false;
			}

			tippy('.tippy', {
				content(reference) {
					const title = reference.getAttribute('data-title')
					//reference.removeAttribute('title') // seems ok to leave there...
					return title
				},
				placement:'bottom',
				arrow:true,
				delay:0,
				duration:0,
				arrowType:'round',
				onShow(instance) {
					document.querySelectorAll('.tippy-popper').forEach(popper => {
						if (popper !== instance.popper) {
							popper._tippy.hide()
						}
					})
				}
			});

			tippy('.tippy-left', {
				content(reference) {
					const title = reference.getAttribute('data-title')
					//reference.removeAttribute('title')
					return title
				},
				placement:'left',
				arrow:true,
				delay:0,
				duration:0,
				zIndex:9999,
				boundary:'window',
				arrowType:'round',
				onShow(instance) {
					document.querySelectorAll('.tippy-popper').forEach(popper => {
						if (popper !== instance.popper) {
							popper._tippy.hide()
						}
					})
				}
			});
		}


		/*	EXPORT ASSETS	*/

		function savePNG(){
			if(sketchLoaded){
				let tempTimestamp = timeStampFile();
				p5f.save('P5L_' + settings.fileName + tempTimestamp + '.png');
				if(settings.exportCode){
					exportSketch('editor', tempTimestamp);
					if(showNotify){
						notifyMsg('Snapshot Saved');
					}
				}
			}
		}

		function saveHTML(){
			let el = p5htmlTemplate.cloneNode(true);
			el.getElementsByTagName('title')[0].innerHTML = settings.fileName;
			let iFrameHead = el.getElementsByTagName('head')[0];//el.document.getElementsByTagName('body')[0];
			let iFrameBody = el.getElementsByTagName('body')[0];//el.document.getElementsByTagName('body')[0];

			let curCode = editor.getValue()
			let curBG = getBackground();
			iFrameBody.style.background = curBG ? curBG : '#000';

			let scriptsCol = [];

			// load p5 remote
			for (const iScript in includeScripts) {
				// no p5.sound
				if(curCode.match(/(\/\/).*(no.*p5.*sound)/g) || p5l.version >= 2){ // *** temp disable sound w/ v2
					if(iScript == 'p5sound') continue;
				}
				scriptsCol.push(includeScripts[iScript].path);
			}

			// check loadScripts / libs / scripts;
			let scriptsList = processLibs(removeComments(curCode));
			for(let i=0; i < scriptsList.length; i++){
				scriptsCol.push(scriptsList[i]);
			}


			for(let i=0; i < scriptsCol.length; i++){
				let s = document.createElement('script');
				s.type = 'text/javascript';
				s.src = scriptsCol[i];
				iFrameHead.appendChild(s);
				iFrameHead.innerHTML += '\n';
			}

			// check for audio/midi snippet
			if(checkCodeMatch(curCode, ['setupAudio', 'updateAudio'])){
				curCode += `\n\n ${p5liveUtils.audio}`
			}

			if(checkCodeMatch(curCode, ['setupMidi', 'updateMidi'])){
				curCode += `\n\n ${p5liveUtils.midi}`
			}

			let s = document.createElement('script');
			s.type = 'text/javascript';
			s.innerHTML = '\n//' + settings.fileName+ '\n\n' + p5custom.value +'\n\n' + curCode+'\n';
			iFrameBody.appendChild(s);
			iFrameBody.innerHTML += '\n\n';
			download('<!DOCTYPE html>\n<html>\n' + el.innerHTML+'\n</html>', 'P5L_' + settings.fileName + timeStampFile() + '.html', 'text/html');
		}

		function timeDate(){
			let d = new Date() ;
			d.setTime( d.getTime() - new Date().getTimezoneOffset()*60*1000 );
			return d.getTime();
		}

		function timeStamp(timeInput){
			let d = new Date();
			d.setTime( d.getTime() - new Date().getTimezoneOffset()*60*1000 );
			if(timeInput != undefined){
				d = new Date(timeInput * 1);
			}
			return d.toISOString().replace(/[^0-9]/g, '').slice(0, -3);
		}

		function timeStampFile(timeInput){
			return (settings.timestampToggle) ? '_' + timeStamp(timeInput) : '';
		}



		/* p5.js REFERENCE */

		window.onhashchange = getRef; // *** make preparser to prevent ref opening...

		function toggleRef(force){
			if(refVisible || force){
				closeRef();
			}else{
				showRef();
			}
		}

		function showRef(){
			if(!downloadedRef){
				loaderSub.innerHTML = 'load references...';
				showLoader();
				loadRef();
				downloadedRef = true;
			}else{
				refHolder.style.display = 'block';
				getRef();
			}
		}

		// close references
		function closeRef(){
			window.location.hash = '#';
			refHolder.style.display ='none';
			refSearch = '';
			refVisible = false;
			editor.gotoLine(curPos.row+1, curPos.column);
			editor.focus();
		}

		function getRef(){
			if(settings.menuMode || settingsVisible){
				hideMenu();
			}

			refVisible = true;

			if(window.location.hash != undefined && window.location.hash.length > 1){
				let refPieces = window.location.hash.split('/');
				let grabRef = '';
				if(window.location.hash == '#new'){
					loadDefault();
					return false;
				}else if(window.location.hash == '#bug'){
					loadBug();
					return false;
				}else if(refPieces.length == 3){
					ref.innerHTML = '';
					grabRef = window.location.hash.split('/')[2];
				}else{
					allRef();
					// window.location = window.location.hash;
				}

				if(grabRef != ''){
					tippy.hideAll({ duration: 0 });
					let snippetIndex = refList.map(function(d) { return d['name']; }).indexOf(decodeURI(grabRef));
					let ex = refList[snippetIndex];
					let paramsCollect = [];
					let paramsDesc = [];
					let methodCheck = ''
					if(ex.itemtype == 'method'){
						methodCheck = '()'
					}
					if(ex.overloads != undefined || ex.params != undefined){
						ref.innerHTML += '<a href="#'+ex.module+'"><div class="param-title">← ' + ex.name + methodCheck + '</div></a><br>';

						if(ex.overloads != undefined){
							ex.overloads.forEach(function(ol){
								let params = [];
								ol.params.forEach(function(param){
									if(param.optional){
										params.push('[' + param.name + ']');
									}else{
										params.push(param.name);
									}

									if(paramsCollect.indexOf(param.name) === -1){
										paramsCollect.push(param.name);
										let paramHTML = '<div class="param"><div class="//">'+ param.name +"</div> "+ param.description.trim() +'</div>';
										paramsDesc.push(paramHTML);
									}

								})
								let paramsJoin = '';
								if(params.length > 0){
									paramsJoin = '(' + params.join(', ') + ')';
								}
								ref.innerHTML += '<div class="param-code">' + ex.name + methodCheck + paramsJoin + '</div>';
							})
						}else{
							// console.log(ex)
							let params = [];
							ex.params.forEach(function(param){
								if(paramsCollect.indexOf(param.name) === -1){
									if(param.optional){
										params.push('[' + param.name + ']');
									}else{
										params.push(param.name);
									}
									if(param.description == ''){
										param.description = '<br>';
									}
									let paramHTML = '<div class="param"><div class="param-name">' + param.name + '</div> <div class="param-desc">' + param.description +'</div></div>';
									paramsDesc.push(paramHTML);
									paramsCollect.push(param.name);
								}
							})
							if(ex.module != 'Constants'){
								let paramsJoin = '';
								if(params.length > 0){
									paramsJoin = '(' + params.join(', ') + ')';
								}
								if(ex.code.length >0){
									ex.code.forEach(function(c){
										ref.innerHTML += '<div class="param-code">' + c + '</div>';
									})
								}else{
									ref.innerHTML += '<div class="param-code">' + ex.name+ methodCheck + '</div>';
								}
								// ref.innerHTML += '<div class="param-code">' + ex.name + paramsJoin + '</div>';
								// ref.innerHTML += '<div class="param-code">' + ex.code.join('<hr>') + '</div>';
							}
						}
					}else{
						ref.innerHTML += '<a href="#"><div class="param-title">← ' + ex.name + '</div></a>';
					}

					let desc = '';
					if(ex.descriptionHTML != undefined){
						desc = ex.descriptionHTML;
					}


					ref.innerHTML += '<br><div class="params"' + paramsDesc.join('') + '</div><br>' + desc;
					if(ex.examples.length > 0){
						let c = 0;
						for(let example of ex.examples){
							let exampleParse = 	example.replaceAll('  ', '  ').replace(/\n/g, '<br> ').replace('<br> ', '');
							ref.innerHTML += '<br><div class="ref-clipboard" onclick="clipboardLines(\'ref-ex-'+c+'\')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clipboard"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg></div><div class="ref-example js" type="js" style="overflow:auto; white-space: nowrap;"><div style="width:auto;">'+exampleParse+'</div></div><br><div id="ref-ex-'+c+'" style="display:none;">'+example+'</div>';
							c++;
						}

					}

					if(!exhibitMode){
						let refLink = '<br><a href="https://p5js.org/reference/p5/'+grabRef+'" target="_blank">p5.js website reference →</a>';
						ref.innerHTML += refLink;
					}

					hljs.configure({useBR: true});
					document.querySelectorAll('.ref-example').forEach((block) => {
					hljs.highlightBlock(block);
					});
				}
			}else{
				allRef();
			}
		}

		function filterRefClear(forceFocus){
			let filterInput = document.getElementById('ref-search');
			if(filterInput.value == ''){
				if(forceFocus){
					filterInput.focus();
				}
			}else{
				filterInput.value = '';
				filterRef();
			}
		}

		function filterRef(){
			let filterInput = document.getElementById('ref-search');
			let filterInputIcon = document.getElementById('ref-search-icon');
			let refFilteredItems = refHolder.getElementsByClassName('all-ref');
			let refModules = refHolder.getElementsByClassName('module');

			if(filterInput.value != ''){
				filterInputIcon.innerHTML = icon.x;
				refSearch = filterInput.value;
				refHolder.scrollTop = 0;
				for(let fi of refFilteredItems){
					fi.classList.add('ref-hide');
				}
				for(let rm of refModules){
					rm.classList.add('ref-collapse');
				}

				let filter = filterInput.value.toLowerCase().split(' ');

				// remove empty while adding another word
				filter = filter.filter(Boolean);

				for(let rfi of refFilteredItems){
					if ( filter.some((val) => rfi.getAttribute('data-name').toLowerCase().indexOf(val) !== -1)){
					// if(rfi.getAttribute('data-name').toLowerCase().indexOf(filter) > -1){
						rfi.classList.remove('ref-hide');
					}
				}
				filterInput.focus();
			}else{
				refSearch = '';
				filterInputIcon.innerHTML = icon.filter;
				for(let fi of refFilteredItems){
					fi.classList.remove('ref-hide');
				}
				for(let rm of refModules){
					rm.classList.remove('ref-collapse');
				}
			}


		}

		function randomRef(c){
			let refFilteredItems = refHolder.getElementsByClassName('all-ref');
			let refFunctions = refHolder.getElementsByClassName('ref-link');
			let refModules = refHolder.getElementsByClassName('module');
			let showAll = document.getElementById('showall');
			let rr;

			c = setInterval(function(){
				for(let fi of refFilteredItems){
					fi.classList.add('ref-hide');
				}
				for(let rm of refModules){
					rm.classList.add('ref-collapse');
				}
				rr = refFunctions[Math.floor(Math.random()*refFunctions.length)];
				rr.classList.remove('ref-hide');
			}, 50);
			setTimeout(function(){clearInterval(c);rr.classList.add('ref-pulse');setTimeout(function(){rr.click()}, 500);}, 1000);
		}

		function allRef(){
			let refValue = '';
			ref.innerHTML = '<div class="ref-sticky"><div class="ref-title">p5.js References <a onclick="randomRef(0);" class="ref-random tippy" data-title="Surprise!">'+icon.gift+'</a><br></div><div class="ref-search-holder"><span id="ref-search-icon" class="tippy-left" data-title="Filter References<br>(separate words for an <i>and</i> search)" onclick="filterRefClear(true)">'+icon.filter+'</span><input type="text" id="ref-search" placeholder="Search..." onkeyup="filterRef()" value="'+refSearch+'" onfocus="this.selectionStart = this.selectionEnd = this.value.length;" class="tippy-left" data-title="Filter References<br>(separate words for an <i>and</i> search)"></div></div>';
			let all = [];
			let grouped = groupBy(refList, (c) => c.module);
			Object.keys(grouped).forEach(function(k){
				let modHTML = '<div class="module" name="' + k + '" id="' + k + '"><div class="module-name">' + k + '</div>';
				let modAll = [];
				grouped[k].forEach(function(ci){

					let noDesc = false;
					let noParams = false;
					if(ci.description.length == 0){
						noDesc = true;
					}else if(ci.params.length == 0){
						noParams = true;
					}

					// debug single ref
					// if(ci.name == 'touchEnded'){
					// 	console.log(ci);
					// }

					if(ci.name != ''){
						let title = '';
						let desc = '';
						title += ci.code.join('<br>') + '<br>';
						let params = [];
						ci.params.forEach(function(cip){
							params.push(cip.name + ' - ' + cip.description);
						});
						title += params.join('<br>') + '<br>';
						if(ci.description != ''){
							desc = ci.description;
						}

						let methodCheck = ''
						if(ci.itemtype == 'method'){
							methodCheck = '()'
						}

						let dataName = 'data-name="' + ci.name + '"';
						if(!noDesc){
							if(noParams){
								modAll.push('<a class="all-ref ref-link tippy-left" href="#/p5/' + htmlEntities(ci.name) + '" onclick="refScroll=refHolder.scrollTop;refHolder.scrollTop=0;" '+dataName+' data-title="<div style=\'text-align:left;\'>' + htmlEntities(ci.description).trim() + '</div>">' + htmlEntities(ci.name)+methodCheck + '<br></a>');
							}else{
								modAll.push('<a class="all-ref ref-link tippy-left" href="#/p5/' + htmlEntities(ci.name) + '" onclick="refScroll=refHolder.scrollTop;refHolder.scrollTop=0;" '+dataName+' data-title="<div style=\'text-align:left;\'>' + htmlEntities(title).trim() + '</div>">' + htmlEntities(ci.name)+methodCheck + '<br></a>');
							}
						}else{
							modAll.push('<span class="all-ref ref-nolink tippy-left" '+dataName+' data-title="'+htmlEntities(ci.name)+'">' + htmlEntities(ci.name)+methodCheck + '<br></span>');
						}
					}
				});
				modHTML += modAll.join('');
				modHTML += '</div>';
				all.push(modHTML);
			});

			ref.innerHTML += '<div id="showall">' + all.join('') + '</div>';
			setTimeout(function(){loadTippy();}, 100);
			document.getElementById('ref-search').focus();

			// jump to category of viewed ref
			if(window.location.hash != undefined && window.location.hash.length > 1){
				let refPieces = window.location.hash.split('/');
				if(refPieces.length == 1){
					refHolder.scrollTop = refScroll;
					filterRef();
				}
			}

			return false;
		}

		function loadRef(){
			refList = [];
			let refPath = 'includes/p5/data.js?' + currentRevision;
			let request = new XMLHttpRequest();
			request.open('GET', refPath, true);
			request.send();
			request.addEventListener("load", function(){
				let jsonObj = JSON.parse(request.responseText.replace('referenceData = ', ''));
				let grouped = groupBy(jsonObj.classitems, (c) => c.module);
				let autoCompleteList = {'revision':currentRevision, 'version':jsonObj.project.version, 'codeKey':[{'[n]ame':'function/constant', '[p]arams':'params/module', '[t]ype':'[m]ethod'}], 'code':[]};

				// filter to own needs
				Object.keys(grouped).forEach(function(k){
					grouped[k].forEach(function(ci){
						let classItem = {};
						classItem.module = k;
						if(ci.name != undefined){
							classItem.name = ci.name;
						}else{
							classItem.name = '';
						}
						if(ci.description != undefined){
							classItem.description = ci.description.replace(/<(?:.|\n)*?>/gm, '').replace(/\n/gi, ' ');
							classItem.descriptionHTML = ci.description;
						}else{
							classItem.description = '';
						}
						if(ci.itemtype != undefined){
							classItem.itemtype = ci.itemtype;
						}else{
							classItem.itemtype = '';
						}
						let classCode = [];
						let classParams = [];
						let classExamples = [];
						let paramsCollect = [];

						if(ci.example != undefined){
							let exs = ci.example[0].match(/<code.*>(.|\n)*?<\/code>/g);
							if(exs == undefined){
								// *** temp quieting 1.3.1, until update to data.json
								//console.log(ci.name +" : "+ ci.example)
							}else{
								for(let ex of exs){
									classExamples.push(ex.replace(/<.*code?[^>]*>/g, ''));
								}
							}

						}

						// if(ci.name == 'createNumberDict'){
						// 	// console.log(ci.example[0].match(/<code>(.|\n)*?<\/code>/g));
						// 	let exs = ci.example[0].match(/<code>(.|\n)*?<\/code>/g);
						// 	for(let ex of exs){
						// 		console.log(ex.replace(/<.*code?[^>]*>/g, ''));
						// 	}
						// }

						if(ci.overloads != undefined || ci.params != undefined){
							if(ci.overloads != undefined){
								// *** fix multiple params/overloads per function to list out
								ci.overloads.forEach(function(ol){
									let params = [];
									let acParams = [];
									ol.params.forEach(function(param){
										if(param.optional){
											params.push('[' + param.name + ']');
										}else{
											params.push(param.name);
											acParams.push(param.name);
										}

										if(paramsCollect.indexOf(param.name) === -1){
											paramsCollect.push(param.name);
											let paramDesc = param.description.substring(0, param.description.length-1).replace(/<.*?[^>]*>/g, '').replace(/\n/gi, ' ');
											classParams.push({'name':param.name, 'description':paramDesc});
										}
									})
									classCode.push(ci.name + '(' + params.join(', ') + ')');

									// autoComplete list
									autoCompleteList.code.push({'n':ci.name, 'p':acParams, 't':'m'});
									if(acParams.length != params.length){
										autoCompleteList.code.push({'n':ci.name, 'p':params, 't':'m'});
									}
								})
							}else{
								let params = [];
								let acParams = [];
								ci.params.forEach(function(param){
									if(paramsCollect.indexOf(param.name) === -1){
										if(param.optional){
											params.push('[' + param.name + ']');
										}else{
											params.push(param.name);
											acParams.push(param.name);
										}
										paramsCollect.push(param.name);
										let paramDesc = param.description.substring(0, param.description.length-1).replace(/<.*?[^>]*>/g, '').replace(/\n/gi, ' ');
										classParams.push({'name':param.name, 'description':paramDesc});
									}
								})
								classCode.push(ci.name + '(' + params.join(', ') + ')');

								// autoComplete list
								autoCompleteList.code.push({'n':ci.name, 'p':acParams, 't':'m'});
								if(acParams.length != params.length){
									autoCompleteList.code.push({'n':ci.name, 'p':params, 't':'m'});
								}
							}
						}else if(ci.name != undefined && classItem.module != 'p5.sound' && classItem.module != 'Foundation'){
							let acParam = classItem.module;
							let acType = '';
							if(ci.itemtype == 'method'){
								acParam = [];
								acType = 'm';
							}
							autoCompleteList.code.push({'n':ci.name, 'p':acParam, 't':acType});
						}
						classItem.code = classCode;
						classItem.params = classParams;
						classItem.examples = classExamples;
						refList.push(classItem);

					});
				});

				// autoCompleteExport = true;
				if(autoCompleteExport){
					exportJSON(autoCompleteList, 'P5L_autocomplete'+timeStampFile()+'.json');
				}else{
					// console.log(autoCompleteList.code);
				}
				allRef();
				hideLoader();
				// display once downloaded
				refHolder.style.display = 'block';
				getRef();
			});

		}

		// group references
		function groupBy(xs, f) {
			return xs.reduce((r, v, i, a, k = f(v)) => ((r[k] || (r[k] = [])).push(v), r), {});
		}

		// clean up invalid characters
		function htmlEntities(str) {
			return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
		}



		/* iFrame magic */

		// get mouse clicks on top
		// initially inspired from here:
		// https://stackoverflow.com/a/44143731/10885535
		
		let pointerEvents = ['mousemove', 'mouseup', 'mousedown', 'pointerdown', 'pointerup', 'pointermove', 'dragend', 'dragover', 'click', 'dblclick', 'wheel']

		for(let p of pointerEvents){
			window.addEventListener(p, passPointer);
		}

		function passPointer(event, src = 'parent'){
			if((p5l.version >= 2 && event.type.includes('mouse')) || (p5l.version < 2 && event.type.includes('pointer'))){
				return
			}
			processMouse(event);
			// console.log([src, event.type]);
		};

		let mouseFields = ['altKey', 'clientX', 'clientY', 'composed', 'ctrlKey', 'isTrusted', 'layerX', 'layerY', 'metaKey', 'movementX', 'movementY', 'offsetX', 'offsetY', 'pageX', 'pageY', 'screenX', 'screenY', 'shiftKey', 'x', 'y', 'button', 'buttons', 'relatedTarget', 'region'];

		function getOpts(event, fields){
			let opts = {};
				fields.forEach(function(f) {
					if (f in event) {
						opts[f] = event[f];
					}
				});
			return opts;
		}

		function processMouse(event){
			let opts = getOpts(event, mouseFields);
			let copy = new PointerEvent(event.type, event);
			if(settings.cocoding.active && settings.cocoding.sync){
				if(settings.cocoding.level == 'admin'){
					if(p5editor.style.visibility == 'visible'){
						p5f.dispatchEvent(copy);
					}
					cocode.dispatchSyncEvent('mouse', event.type, opts);
				}
			}else{
				if(p5editor.style.visibility == 'visible'){
					p5f.dispatchEvent(copy);
				}
			}

			
			// *** disabling, too many cases that need readonly set

			// prevent drag+drop+shift of code, while mouseDragging visuals
			// if(event.type == 'mousedown' && settings.editor.lockcode){
			// 	editor.setReadOnly(true);
			// }else if(event.type == 'mouseup'){
			// 	if(!settings.cocoding.active || (settings.cocoding.active && !settings.cocoding.error && (settings.cocoding.level == 'admin' || settings.cocoding.writemode || !settings.cocoding.lockdown))){
			// 		editor.setReadOnly(false);
			// 	}
			// }

		}


		// pass keys on down
		// tips: https://stackoverflow.com/questions/596481/
		window.addEventListener('keydown', sendKey);
		window.addEventListener('keyup', sendKey);

		let keyFields = ['altKey', 'bubbles', 'cancelBubble', 'cancelable', 'charCode', 'code', 'composed', 'ctrlKey', 'isTrusted', 'key', 'keyCode', 'location', 'metaKey', 'repeat', 'returnValue', 'shiftKey', 'type', 'which'];


		function sendKey(event){
			let opts = getOpts(event, keyFields);
			let copy = new KeyboardEvent(event.type, event);

			if(p5editor.style.visibility != 'visible' || settings.editor.passEditorKeys){
				if(settings.cocoding.active && settings.cocoding.sync){
					if(settings.cocoding.level == 'admin'){
						p5f.dispatchEvent(copy);
						cocode.dispatchSyncEvent('keyboard', event.type, opts);
					}
				}else{
					p5f.dispatchEvent(copy);
				}
			}
		}



		/*	MISC */

		/* CHALKBOARD */
		function toggleChalkboard(force){
			chalkboardVisible = !chalkboardVisible;
			if(force != undefined){
				chalkboardVisible = force;
			}

			if(chalkboardVisible){
				chalkboard.style.display = 'inline';
				editor.blur();
				if(!chalkboardInit){
					let opts = new URLSearchParams(settings.chalkboard).toString();
					chalkboard.src = "includes/templates/p5live_chalkboard.html?"+currentRevision+"&"+opts;
					chalkboardFrame = chalkboard.contentWindow;
					setTimeout(function(){ chalkboardInit = true;}, 500);
				}
				// chalkboard.style.width = "calc(100vw - 250px)"; // *** add to menu/ref/settings toggle
			}else{
				chalkboard.style.display = 'none';
				editor.focus();
			}
		}

		function chalkboardSettings(param, opts){
			settings.chalkboard[param] = opts;
				updateSettings();
				//console.log("updating: "+param+" to: "+opts);

			// clearTimeout(chalkboardSettingsUpdate);
			// chalkboardSettingsUpdate = setTimeout(function(){
			// 	settings.chalkboard[param] = opts;
			// 	updateSettings();
			// 	console.log("updating: "+param+" to: "+opts);
			// }, 500);
		}


		/* IG sized popout */
		function pop720(){
			let popWindow = window.open(window.location.href, 'mywindow', 'menubar=0,resizable=0,width=720,innerHeight=720');
			setTimeout(function(){popWindow.innerHeight = 720;}, 100);
		}

		/* Stream Visuals only to another window */
		function popStream(force){
			if(exhibitMode){
				return false
			}

			if(force){
				p5popActive = true;
			}

			

			if((sketchLoaded || !useP5) && p5popActive){
				collectCans()
				p5popStream = p5lCans[p5lCanSel%p5lCans.length].captureStream()

				if(p5pop && !p5pop.closed){
					p5pop.vid.srcObject = p5popStream;
					p5pop.document.getElementById('select-cans').innerHTML = p5lCansOptions.join('')
					setTimeout(collectCans, 500)
				}else{
					// technique built upon : http://plnkr.co/edit/jDzbtPYrYItQ4peplOAN
					let popup_html = `
					<!DOCTYPE html>
					<html>
					<head>
						<title>P5LIVE - VISUALS STREAM</title>
						<style>
							body{margin:0;background:#000;background:${newBG};}
							*{outline:none;}
							input, select{background:#000;color:#fff;border:1px solid #fff;border-radius:3px;padding:2px;}
							::-webkit-media-controls {display:none !important;}
							#nav{opacity:0;transition:opacity .5s;}
							video {
							  object-fit: contain;
							}
						</style>
					</head>
					<body>
						<div id="nav" style="position:fixed;z-index:99;left:0px;top:0px;width:100vw;height:25px;padding:5px;">
							<div style="position:absolute;left:5px;">
								<select id="select-cans" onchange="changeCan(this.value)">${p5lCansOptions.join('')}</select>
								<select id="select-vidSize" onchange="setVidFit(this.value)">
									<option>Contain</option>
									<option>Cover</option>
									<option>Fill</option>
									<option>None</option>
								</select>
							</div>
							
							<div id="but" style="position:absolute;right:15px;border:none;color:#fff;font-size:16pt;cursor:pointer;opacity:.5;" onmouseenter="this.style.opacity=1;" onmouseleave="this.style.opacity=.75;" onclick="openFullscreen();" title="Fullscreen">
								${icon.maximize}
							</div>
						</div>
						<br>
						<video id="vid" playsinline autoplay muted style="position:fixed;left:0;top:0;width:100vw;height:100vh;background-color:#000;"></video>

						<script>
							var opener = window.opener;
							var nav = document.getElementById('nav')
							var navTimer
							var vid=document.getElementById("vid");

							function openFullscreen(){
								if(vid.requestFullscreen){
									vid.requestFullscreen();
								}else if(vid.mozRequestFullScreen){ 
									/* Firefox */ vid.mozRequestFullScreen();
								}else if(vid.webkitRequestFullscreen){
									/* Chrome, Safari & Opera */ 
									vid.webkitRequestFullscreen();
								}else if(vid.msRequestFullscreen){
								/* IE/Edge */ vid.msRequestFullscreen();
								}
							}

							function changeCan(val){
								//console.log(opener.document.p5lCans)
								// vid.srcObject = cans[val].captureStream()
								var p5popStream = opener.p5lCans[val].captureStream()
								vid.srcObject = p5popStream
								opener.p5lCanSel = val
							}

							function setVidFit(val){
								document.querySelector('video').style.objectFit = val
							}
						
							document.addEventListener('mousemove', ()=>{
								nav.style.opacity = 1.0
								clearTimeout(navTimer)
								navTimer = setTimeout(()=>{nav.style.opacity = 0.0}, 2000)
							})
						<\/script>
					</body>
					</html>`;
					let popup_url = URL.createObjectURL(new Blob([popup_html], {
					  type: 'text/html'
					}));
					p5pop = window.open(popup_url, "P5LIVE - VISUALS STREAM", 'left=0,top=0,width=0,height=0');
					URL.revokeObjectURL(popup_url);
					p5pop.onload = function() {
						p5pop.vid.srcObject = p5popStream;
						
						// let ctrls = p5pop.document.getElementById("controldiv");
						// ctrls.disabled="true";
					}

					var p5popTick = setInterval(function() {
				      if (p5pop.closed) {
				        p5popActive = false;
				        clearInterval(p5popTick);
				      }
				    }, 500);
				}
			}
		}

		function collectCans(){
			p5lCans = p5f.document.querySelectorAll('canvas')
			p5lCansOptions = []
			var c = 0
			Array.from(p5lCans).forEach(can =>{
				// if(can.width > 100 && can.height > 100){
					let canSel = c == p5lCanSel ? 'selected' : ''
					p5lCansOptions.push(`<option value="${c}" ${canSel}>${c} - ${can.width} x ${can.height} px</option>`)
				// }
				c++
			})

			if(p5pop){
				p5pop.document.getElementById('select-cans').innerHTML = p5lCansOptions.join('')
			}
		}

		var p5popCode
		function popCode(force){
			let url = window.location.href.split('/').slice(0, -1).join('/')
			// console.log(url);

			if(settings.themeCOLORactive){
					p5code.style.color = settings.themeCOLOR
			}else{
				p5code.style.color = 'inherit'
			}
			let popCode_html = `
			<!DOCTYPE html>
			<html>
			<head>
				<meta charset="UTF-8">
				<title>P5LIVE - CODE</title>
				<script src="${url}/includes/js/ace/src-min-noconflict/ace.js?50" type="text/javascript" charset="utf-8"><\/script>
				<link rel="stylesheet" type="text/css" media="all" href="${url}/style.css?50">
				<style type="text/css">
					body{margin:0;}
					#editor{
						width:100vw;height:100vh;
						font-size:${settings.editor.fontSize}pt;
						color:${settings.themeCOLORactive? settings.themeCOLOR : 'inherit'}
					}
					.ace_dark.ace_editor.ace_autocomplete .ace_marker-layer .ace_active-line{
						color:#fff;	
						background:rgba(150, 191, 0, .4) !important;
					}
					.ace_marker{
						position:fixed;
						background:rgba(0, 255, 255, .4);
					}
					.ace_marker-layer{
						z-index:9999!important;
					}
				</style>
			</head>
			<body>
				<div id="p5-editor">
					<div id="editor" style=""></div>
				</div>
				
				<script>
					// const url = new URL(window.location.href);
					// console.log(url.origin); // 'https://mozilla.org'
					let Range = ace.require('ace/range').Range;
					var opener = window.opener;
					var p5editor = document.getElementById('p5-editor')
					var editor = ace.edit("editor");
					editor.setTheme('${settings.theme}');
					editor.session.setMode("ace/mode/javascript");
					editor.setOptions({showPrintMargin: false,animatedScroll: true,displayIndentGuides: false,useWorker: true,showLineNumbers: false,showGutter: false,scrollPastEnd:1,tabSize: 4, useSoftTabs: false});
					editor.setReadOnly(false);
					var msgEditor = false
					
					window.addEventListener("message", function(event){
						// console.log(event.data)
						msgEditor = true
						if(event.data.type == 'replace'){
							editor.setValue(event.data.msg, -1);
						}else if(event.data.type == 'delta'){
							let delta = event.data.msg
							editor.gotoLine(delta.start.row + 1, delta.start.column, true);
							editor.session.doc.applyDelta(delta);
						}
						msgEditor = false
					});

					var pulsemarkerID = []
					function recompilePulse(s = 0, e = editor.session.getLength()){
						if(${useRecompilePulse}){
							pulsemarkerID.push({id:editor.session.addMarker(new Range(s, 0, e, 9000), "ace_marker", "text")})
							setTimeout(removePulseMarkers, 300)
						}
					}

					function removePulseMarkers(){
						for(let i=0; i < pulsemarkerID.length; i++){
							editor.session.removeMarker(pulsemarkerID[i].id);
						}
						pulsemarkerID = [];
					}

					editor.renderer.on('afterRender', function(){
						adjustLines();
					});
					
					function adjustLines(){
						let pcode = p5editor.getElementsByClassName('ace_line');
						for(let i=0; i < pcode.length; i++){
							let pitem = pcode[i];
							if(${settings.themeBGactive} && pitem.getElementsByClassName( 'ace_line_bg' ).length < 1){
								let pcontents = pitem.innerHTML;
								pitem.innerHTML = '<span class="ace_line_bg" style="background:${settings.themeBG}">' + pcontents + '</span>';
							}
						}
						
						if(${settings.themeCOLORactive}){
							p5editor.style.color = "${settings.themeCOLOR}"
						}else{
							p5editor.style.color = 'inherit'
						}

						if(${settings.themeACTIVEactive}){
							let activeLine = document.querySelector('.ace_marker-layer .ace_active-line')
							if(activeLine != null){
								activeLine.style.backgroundColor = "${settings.themeACTIVE}"
							}
						}else{
							if(document.querySelector('.ace_marker-layer .ace_active-line') !== null){
								document.querySelector('.ace_marker-layer .ace_active-line').style.backgroundColor = 'inherit'
							}
						}
					}

					editor.on('change', function(delta) {
						if(msgEditor){
							return false
						}
			    		opener.postMessage({type:'delta', msg:delta}, "*");
						
					})

					let keyMap = [];
					keyMap[16] = false;
					keyMap[17] = false;
					editor.onkeydown = function(event) {
						keyMap[event.keyCode] = event.type == 'keydown';


						if(keyMap[16] && keyMap[17] && event.keyCode == 13){
							event.preventDefault();
							opener.postMessage({type:'hardCompile', msg:''}, "*");
						}

						if(keyMap[17] && event.keyCode == 13){
							event.preventDefault();
							opener.postMessage({type:'softCompile', msg:''}, "*");
						}
					}

					editor.onkeyup = function(event) {
						keyMap[event.keyCode] = event.type == 'keydown';
					}

				<\/script>
			</body>
			</html>`;

			let popCode_url = URL.createObjectURL(new Blob([popCode_html], {
					  type: 'text/html'
					}));
			if(!p5popCode){
				p5popCode = window.open(popCode_url, "P5LIVE - CODE STREAM", 'left=0,top=0,width=0,height=0');
				URL.revokeObjectURL(popCode_url);

				p5popCode.onload = function() {
					p5popCode.postMessage({type:'replace',msg:editor.getValue()}, "*");
					
		        	editor.on('change', function(delta) {
		        		 if (p5popCode && !msgEditor) {
					    	p5popCode.postMessage({type:'delta', msg:delta}, "*");
						}
					})

		        	window.addEventListener("beforeunload", function() {
			            if (p5popCode) {
			                p5popCode.close();
			            }
			        });
				}

				var p5popCodeTick = setInterval(function() {
			      if (p5popCode.closed) {
			        p5popCode = false;
			        clearInterval(p5popCodeTick);
			      }
			    }, 500);
			}
		}

		// receive messages from popupCode editor
		var msgEditor = false
		window.addEventListener("message", function(event){
			if(event.data.type == 'delta'){
				msgEditor = true
				let delta = event.data.msg
				editor.gotoLine(delta.start.row + 1, delta.start.column);
				editor.session.doc.applyDelta(delta);
				localStorage[settings.fileName] = editor.getValue()
				msgEditor = false
			}else if(event.data.type == 'softCompile'){
				recompile();
			}else if(event.data.type == 'hardCompile'){
				recompile(true);
			}
		})

		function showLoader(){
			loader.style.display = 'flex';
		}

		function hideLoader(){
			loader.style.display = 'none';
			// loaderSub.innerHTML = '';
		}

		/* View in fullscreen */
		function openFullscreen() {
			let elem = document.documentElement;
			if (elem.requestFullscreen) {
				elem.requestFullscreen();
			} else if (elem.mozRequestFullScreen) { /* Firefox */
				elem.mozRequestFullScreen();
			} else if (elem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
				elem.webkitRequestFullscreen();
			} else if (elem.msRequestFullscreen) { /* IE/Edge */
				elem.msRequestFullscreen();
			}
		}

		/* Close fullscreen */
		function closeFullscreen() {
			if (document.exitFullscreen) {
				document.exitFullscreen();
			} else if (document.mozCancelFullScreen) { /* Firefox */
				document.mozCancelFullScreen();
			} else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */
				document.webkitExitFullscreen();
			} else if (document.msExitFullscreen) { /* IE/Edge */
				document.msExitFullscreen();
			}
		}

		function checkMenu(){
			if(menuPanel.style.marginRight == '0px'){
				return true;
			}else{
				return false;
			}
		}

		/* General Alert */
		function alertMsg(txt){
			vex.dialog.alert({
				unsafeMessage:txt,
				afterOpen: function(){
					vexClass(this.rootEl, 'vex-small')
				}
			})
		}

		function vexFocus(){
			setTimeout(function(){document.getElementsByClassName('vex-dialog-button-primary')[0].focus();}, 500);
		}

		/* Notification for settings changed by shortcut */
		function notifyMsg(txt){
			if(!settings.editMode){
				return false;
			}
			notify.innerHTML = txt;
			notify.style.display = 'block';
			notify.style.opacity = 1.0;
			if(checkMenu()){
				notify.style.right = '255px';
			}else{
				notify.style.right = '5px';
			}
			clearTimeout(notifyTimer);
			let notifyDelay = txt.length*20;
			notifyTimer = setTimeout(function(){
				notify.style.opacity = 0;
				setTimeout(function(){notify.style.display = 'none';}, 500);

			}, notifyDelay);
			showNotify = false;
		}

		/* Sketches Congrats */
		function sketchesCounter(){
			settings.statscount++;
			updateSettings();
			let txtMsg = 'P5LIVE<span class="counters">Stats</span><br><br><hr><br>';
			txtMsg += settings.statscount.toLocaleString()+'<span class="counters"> Stats Viewed</span><br>';
			txtMsg += document.querySelectorAll('.item-folder:not(.demo)').length.toLocaleString()+'<span class="counters">Folders</span><br>';
			txtMsg += document.querySelectorAll('.item-sketch:not(.demo)').length.toLocaleString()+'<span class="counters">Sketches</span><br>';

			let totalChars = 0;
			let totalLines = 0;
			let sketchStats = {long:{count:0, name:''}, short:{count:9999, name:''}};
			for(let is of document.querySelectorAll('.item-sketch:not(.demo)')){
				let grabName = is.getAttribute('data-id');
				let grabSketch = localStorage.getItem(grabName);
				if(grabSketch !== null){
					totalChars += grabSketch.replace('\n', '').replace('\t', '').length;
					totalLines += grabSketch.split('\n').length;
					if(grabSketch.split('\n').length > sketchStats.long.count){
						sketchStats.long.count = grabSketch.split('\n').length;
						sketchStats.long.name = grabName;
					}
					if(grabSketch.split('\n').length < sketchStats.short.count){
						sketchStats.short.count = grabSketch.split('\n').length;
						sketchStats.short.name = grabName;
					}
				}
			}
			txtMsg += totalChars.toLocaleString()+'<span class="counters">Characters</span><br>';
			txtMsg += totalLines.toLocaleString()+'<span class="counters">Lines</span><br>';
			txtMsg += sketchStats.short.count.toLocaleString()+'<span class="counters">Shortest ('+sketchStats.short.name+')</span><br>';
			txtMsg += sketchStats.long.count.toLocaleString()+'<span class="counters">Longest ('+sketchStats.long.name+')</span><br>';
			txtMsg += (totalChars/1000000).toLocaleString()+' / 5.0<span class="counters">Mb (localStorage limit)</span><br>';
			alertMsg(txtMsg);
		}

		// *** add to stats with GUI for cleanup, list sketches with export/trash option
		function sketchesStats(){
			let totalStats = {count:0, size:0}
			let sketchesList = []
			for(let is of document.querySelectorAll('.item-sketch:not(.demo)')){
				let grabName = is.getAttribute('data-id');
				let grabSketch = localStorage.getItem(grabName);
				if(grabSketch !== null){
					let totalChars = grabSketch.replace('\n', '').replace('\t', '').length;
					// totalLines += grabSketch.split('\n').length;
					sketchesList.push({name:grabName, size:totalChars})
					totalStats.count++
					totalStats.size += totalChars
				}
			}
			sketchesList.sort((a, b) => b.size - a.size)
			console.log(sketchesList)
			console.log(`count: ${totalStats.count}, size: ${totalStats.size/1000000}`)
		}


		/*	COCODING */
		function makeid(charCount){
			let text = '';
			for( let i=0; i < charCount; i++ )
				text += chars.charAt(Math.floor(Math.random() * chars.length));
			return text;
		}

		function cocodingInit(){
			if(settings.cocoding.active){
				vex.dialog.confirm({
					message: 'Exit COCODING?',
					callback: function (value) {
						if (value) {
							cocodingExit(loadLatest());
						}
					},
					afterOpen: function(){
						vexClass(this.rootEl, 'vex-small')
					}
				})
			}else{
				cocodingReset();
				let sessID = makeid(5);
				settings.cocoding.active = true;
				settings.cocoding.token = hashCode(sessID);
				updateSettings();
				document.location.search = 'cc=' + sessID;
			}
		}

		function hashCode(s) {
			let h;
			for(let i = 0; i < s.length; i++)
				h = Math.imul(31, h) + s.charCodeAt(i) | 0;

			return h;
		}

		function cocodingExit(sketch){
			cocodingReset();
			cocodingUnload = true;
			settings.fileName = sketch;
			updateSettings;
			// loadSketch(settings.fileName);
			window.history.replaceState(null, null, window.location.pathname);
			window.location = window.location.pathname;
		}

		function cocoding(){
			menuCocodeHolder.style.display = 'block';
			menuCocodeChatHolder.style.display = 'block';
			editor.setValue('// Loading COCODING Session: '+settings.cocoding.namespace, 1);
			syncdataConsoleClear();
			settings.syncdata.active = false;
			settings.syncdata.libs = [];
			settings.syncdata.cocodeadded = false;
			settings.cocoding.error = false;
			updateSettings();
			cocode = new CocodeApp(settings.cocoding.namespace);
			if(cocodingFirstTime){
				setTimeout(function(){
					cocode.rename();
				}, 500);
			}

			// hide recoding playback
			document.querySelectorAll('.hide-cocoding').forEach(function(elm){elm.style.display='none';})
		}

		// reset all cocoding except nick + color
		function cocodingReset(){
			Object.keys(initSettings.cocoding).forEach(function(cc){
				if(cc != 'nick' && cc != 'color'){
					settings.cocoding[cc] = initSettings.cocoding[cc];
				}
			});
			updateSettings();
		}


		/*	SyncData */

		// load presets
		function syncDataPresetLoad(jsonObj){
			syncdataPresets = [];
			for(let p of jsonObj.structure[0].contents){
				let presetName = p.name.replace('syncdata-', '');
				let presetSketch = {code:p.code, name:presetName, protected:true};
				syncdataPresets.push(presetSketch);
			}

			// load localSyncdataPresets
			for(let sdp of settings.syncdata.sketches){
				syncdataPresets.push(sdp);
			}
		}

		function syncdataWindow(){
			let editorInit = true;
			let reloadVex = false;
			let reloadAlert = 0;
			let syncdataPresetsOptions = '';
			let doneDemos = false;
			for(let sdp of syncdataPresets){
				if(sdp.protected == false && !doneDemos){
					syncdataPresetsOptions += '<option name="select-divider" value="select-divider" label="------------" disabled>';
					doneDemos = true;
				}
				syncdataPresetsOptions += '<option name="'+sdp.name+'" value="'+sdp.name+'">'+sdp.name+'</option>';
			}

			let syncdataVex = vex.dialog.confirm({
				focusFirstInput : false,
				unsafeMessage:'<div style="font-size:10pt;line-height:1.3em;font-style:italic;">Sync local data with anyone in COCODING session!<br>Code below is saved in local settings, <code>Load Preset</code> replaces it.</div><select name="Presets" onchange="syncdataPresetChange(this.value)"><option name="select" value="select">Load Preset</option>'+syncdataPresetsOptions+'Load Preset</option></select> <span id="preset-button-group"><button onclick="vex.closeAll();syncdataPresetSave();" class="tippy" data-title="Create new preset">Save Preset</button> <button id="preset-button-remove" onclick="vex.closeAll();syncdataPresetRemove(this.name);" name="" class="tippy" data-title="Remove selected preset" style="display:none;">Remove Preset</button></span><br><br><div class="syncdata-header code-header">code</div><div id="syncdata" class="vex-long popup-editor"></div><div class="syncdata-header tippy-left" style="cursor:pointer;" data-title="Click to Clear Console" onclick="syncdataConsoleClear();">console</div><textarea id="syncdata-console" readonly="readonly">'+settings.syncdata.console.join('\n')+'</textarea>',

				callback: function (value) {},
				buttons: [
				{
					type: 'close',
					text: '× CLOSE',
					click: function(){
						vex.close(syncdataVex);
					}
				},
				{
					type: 'submit',
					text: settings.syncdata.active ? '► RE-RUN' : '► RUN', // icon.play
					click: function updateCode () {
						settings.syncdata.active = true;
						updateSettings();
						syncdataButtonToggle();
						recompile(true);
						cocode.recompile();
						prepReload();
					}
				},
				settings.syncdata.active ? {
					type: 'stop',
					text: '◼ STOP',
					click: function updateCode () {
						settings.syncdata.active = false;
						settings.syncdata.libs = [];
						updateSettings();
						syncdataSend({meta:'stop'});
						syncdataButtonToggle();
						recompile(true);
						vex.close(syncdataVex);
					}
				} : {
					className: 'hide-button' // hide if unused
				},
				settings.syncdata.active && settings.cocoding.level == 'admin' && !settings.syncdata.cocodeadded ? {
					type: 'cocode',
					text: '↓ COCODE',
					click: function updateCode () {
						settings.syncdata.cocodeadded = true;
						updateSettings();
						syncdataCocode();
						vex.close(syncdataVex);
					}
				} : {
					className: 'hide-button' // hide if unused
				}

				],
				onSubmit: function(e) {
					e.preventDefault();
				},
				afterOpen: function(){
					vexClass(this.rootEl, 'vex-padding')
					syncdataEditor = ace.edit("syncdata");
					syncdataEditor.setTheme(settings.theme);
					syncdataEditor.session.setMode('ace/mode/javascript');
					syncdataEditor.setOptions({
						showPrintMargin: false,
						animatedScroll: false,
						displayIndentGuides: false,
						useWorker: true,
						showLineNumbers: true,
						showGutter: true,
						tabSize: 4, useSoftTabs: false,
					});

					syncdataEditor.setValue(settings.syncdata.code, settings.syncdata.cursor.row);

					setTimeout(function(){
						syncdataEditor.gotoLine(settings.syncdata.cursor.row, settings.syncdata.cursor.column);
						let syncdataConsole = document.getElementById('syncdata-console');
						syncdataConsole.scrollTop = syncdataConsole.scrollHeight;
					}, 100);

					syncdataEditor.getSession().on('change', function() {
						settings.syncdata.code = syncdataEditor.getValue();
					});

					syncdataEditor.getSession().selection.on('changeCursor', function(){
						if(!editorInit){
							settings.syncdata.cursor = syncdataEditor.getCursorPosition();
							updateSettings();

						}
					});

					tidyCode(syncdataEditor);
					loadTippy();
					editorInit = false;
				},
				afterClose: function(){

					if(reloadVex){
						vex.close(reloadAlert);
						syncdataWindow();
					}
				}
			})



			function prepReload(){
				reloadVex = true;

				vex.dialog.alert({
					unsafeMessage:'<div style="font-size:10pt;line-height:1.3em;font-style:italic;">Refreshing SyncData...</div>',
					buttons:[],
					afterOpen: function(){
						reloadAlert = this;
						vex.close(syncdataVex);
					}
				})
			}
		}

		function syncdataPresetCheck(){
			let presetName = document.getElementById('presetname-input').value;
			let presetNameWarning = document.getElementById('presetname-warning');
			presetNameWarning.innerHTML = '';
			for(let sdp of settings.syncdata.sketches){
				if(sdp.name == presetName){
					presetNameWarning.innerHTML = 'SAVE will replace current preset.';
				}
			}
		}

		function syncdataPresetRemove(presetVal){
			for(let i=0; i < syncdataPresets.length; i++){
				if(syncdataPresets[i].name == presetVal && syncdataPresets[i].protected || presetVal == ''){
					let thisVex = vex.dialog.alert({
						unsafeMessage:'Can\'t remove P5LIVE preset...',
					afterOpen: function(){
						vexClass(this.rootEl, 'vex-small')
					},
					afterClose: function(){
						syncdataWindow();
					}
					})
					return false;
				}
			}

			vex.dialog.confirm({
				unsafeMessage: 'Remove Preset: '+presetVal,
				callback: function (value) {
					if (value) {
						settings.syncdata.code = '// '+presetVal+' Removed!';
						for(let i=0; i < settings.syncdata.sketches.length; i++){
							if(settings.syncdata.sketches[i].name == presetVal){
								settings.syncdata.sketches.splice(i, 1);//console.log(i);
							}
						}
						for(let i=0; i < syncdataPresets.length; i++){
							if(syncdataPresets[i].name == presetVal){
								syncdataPresets.splice(i, 1);//console.log(i);
							}
						}
						updateSettings();
					}
				},
				afterOpen: function(){
					vexClass(this.rootEl, 'vex-small')
				},
				afterClose: function(){
					syncdataWindow();
				}
			})
		}

		function syncdataPresetSave(){
				let presetChange = false;
				let presetNamesFiltered = '';
				for(let sdp of settings.syncdata.sketches){
					presetNamesFiltered += '<option name="'+sdp.name+'" value="'+sdp.name+'">'+sdp.name+'</option>';
				}
				let setPresetVex = vex.dialog.confirm({
					// focusFirstInput : false,
					callback:function(){},
					unsafeMessage:'<div style="font-size:10pt;line-height:1.3em;font-style:italic;">Set preset name or use existing one to replace it.<br><br><select name="Presets" onchange="document.getElementById(\'presetname-input\').value = this.value;syncdataPresetCheck();document.getElementById(\'presetname-input\').select();"><option name="" value="">Select User Preset</option>'+presetNamesFiltered+'</select><br><input style="font-size:14pt" id="presetname-input" name="presetname-input" type="text" value="" placeholder="Preset Name..." onkeyup="syncdataPresetCheck();"><br><span id="presetname-warning"></span>',
					buttons: [
					{
						type: 'submit',
						text: 'Save',
						className: '',
						click: function () {
							let presetName = document.getElementById('presetname-input').value;
							let presetNameWarning = document.getElementById('presetname-warning');

							// check duplicate name
							let replacePreset = false;
							for(let sdp of settings.syncdata.sketches){
								if(sdp.name == presetName){
									replacePreset = true;
								}
							}

							let newPreset = {code:settings.syncdata.code, name:presetName, protected:false};
							if(replacePreset){
								// replace preset
								for(let i=0; i < settings.syncdata.sketches.length; i++){
									if(settings.syncdata.sketches[i].name == presetName){
										settings.syncdata.sketches[i].code = newPreset.code;
									}
								}
								for(let i=0; i < syncdataPresets.length; i++){
									if(syncdataPresets[i].name == presetName){
										syncdataPresets[i].code = newPreset.code;
									}
								}
							}else{
								syncdataPresets.push(newPreset);
								settings.syncdata.sketches.push(newPreset);
							}
							updateSettings();
							presetChange = true;
							vex.close(this);
						}
					}
					,{
						type: 'close',
						text: 'Cancel',
						click: function(){
							vex.close(this);
						}
					}],
					afterOpen: function(){
						vexClass(this.rootEl, 'vex-small')
						setTimeout(function(){document.getElementById('presetname-input').focus();}, 100);
					},
					afterClose: function(){
						syncdataWindow();
					}
				})
			}

		function syncdataPresetChange(presetVal, localEditor){
			if(presetVal != 'select'){
				for(let sdp of syncdataPresets){
					if(sdp.name == presetVal){
						if(!sdp.protected){
							document.getElementById('preset-button-remove').style.display = 'inline';
							document.getElementById('preset-button-group').style.display = 'inline';
						}else{
							document.getElementById('preset-button-remove').style.display = 'none';
						}
						syncdataConsoleClear()
						settings.syncdata.cursor = {row:0, column:0};
						settings.syncdata.cocodeadded = false;
						updateSettings();
						syncdataEditor.setValue(sdp.code, -1);
						document.getElementById('preset-button-remove').setAttribute('name', presetVal);
						setTimeout(function(){
							syncdataEditor.gotoLine(settings.syncdata.cursor.row, settings.syncdata.cursor.column);
						}, 100);

					}
				}
			}
		}

		function syncdataConsoleClear(){
			settings.syncdata.console = [];
			updateSettings();
			if(document.getElementById('syncdata-console')){
				document.getElementById('syncdata-console').innerHTML = '';
			}
		}

		function syncdataButtonToggle(){
			let syncdataBtn = document.getElementById('syncdata-button');
			if(settings.syncdata.active){
				syncdataBtn.style.backgroundColor = '#aaaa00';
			}else{
				syncdataBtn.style.backgroundColor = '#666';
			}
		}

		function syncdataParse(){
			if(settings.cocoding.active && settings.syncdata.active){
				syncdataButtonToggle();
				if(!settings.syncdata.active){
					return false;
				}

				// parse scripts to p5Frame
				settings.syncdata.libs = processLibs(removeComments(settings.syncdata.code));
				updateSettings();

				let scriptsCol = [];
				for(let ccll of settings.syncdata.libs){
					scriptsCol.push(ccll);
				}

				scriptsCol.push('includes/js/p5live.cocoding.js');

				let syncdataID = 'syncdata-code';
				// let scriptsColJoin = "'" + scriptsCol.join("','") + "'";
				// scriptsColJoin += ",'includes/js/p5live.cocoding.js'";
				let s = document.createElement('script');
				s.type = 'text/javascript';

				let syncdataCode = settings.syncdata.code;
				if(syncdataCode.indexOf('/* 2 - COCODE */') > -1){
					syncdataCode = syncdataCode.substr(0, syncdataCode.indexOf('/* 2 - COCODE */'));
				}

				// break infinite loops
				if(!syncdataCode.match(/(\/\/).*(no.*protect)/g)){
					try{
						syncdataCode = loopBreaker(syncdataCode).code;
					} catch (e) {
						console.log(e.description);
					  return false;
					}
				}

				// **** possible to avoid loadjs for syncdata?
				// for(let sc of scriptsCol){
				// 	let sds = document.createElement('script');
				// 	sds.type = 'text/javascript';
				// 	sds.src = sc;
				// 	// s.async = false;
				// 	// p5f.document.body.appendChild(sds);
				// }

				let sLoader = 'loadjs(' + JSON.stringify(scriptsCol) + ', {success: function() {pingReady("'+syncdataID+'", ' + JSON.stringify(syncdataCode) + '); },error: function(pathsNotFound) {},async: false});';

				s.innerHTML = sLoader;

				if(sketchLoaded){
					if(scriptsCol.length > 1){
						p5f.document.head.appendChild(s);
					}else{
						pongReady(syncdataID, syncdataCode);
					}
				}

				document.getElementById('syncdata-button').style.backgroundColor = '#008800';
			}
		}

		function syncdataCocode(){
			let cocodeBreak = '/* 2 - COCODE */';
			if(settings.syncdata.code.indexOf(cocodeBreak) == -1){
				let thisVex = vex.dialog.alert({
					unsafeMessage:'No COCODING snippet found. <br>Check it\'s preceded by:<br><pre>'+cocodeBreak+'</pre>',
				afterOpen: function(){
					vexClass(this.rootEl, 'vex-small')
				}
				})
				return false;
			}

			var cocodeClipboard = settings.syncdata.code.substr(settings.syncdata.code.indexOf(cocodeBreak) + cocodeBreak.length);
			var cocodeClipboard = cocodeClipboard.split('\n');
			for(let i = 0; i < cocodeClipboard.length; i++){
				var urlRegex =/^\/\//gm;
				cocodeClipboard[i] = cocodeClipboard[i].replace(urlRegex, '');
			}
			cocodeClipboard = cocodeClipboard.join('\n');
			let curCode = editor.getValue();
			editor.setValue(curCode +"\n"+ cocodeClipboard, 1);
			tidyCode(editor);
			editor.gotoLine(0, 1, false);
		}

		function syncdataSend(obj){
			if(settings.cocoding.lockdown){
				if(settings.cocoding.level != 'admin' && !settings.cocoding.writemode){
					return false;
				}
			}
			syncUp();
			obj.usesyncdata = settings.syncdata.active;
			cocode.socket.emit('syncData', obj);
		}

		// GUI replaced by SyncData...
		// function copyLink(elm){
		// 	let dummy = document.createElement('input'),
		// 	text = window.location.href;

		// 	document.body.appendChild(dummy);
		// 	dummy.value = text;
		// 	dummy.select();
		// 	document.execCommand('copy');
		// 	document.body.removeChild(dummy);

		// 	// share info
		// 	let oldContent = elm._tippy.props.content;
		// 	elm._tippy.setContent('Copied!');
		// 	elm._tippy.show(200);
		// 	setTimeout(function(){
		// 		elm._tippy.hide();
		// 		elm._tippy.setContent(oldContent);
		// 	}, 800);
		// }

		function toggleLockdown(){
			settings.cocoding.lockdown = !settings.cocoding.lockdown;
			updateSettings();
			cocode.lockdown(settings.cocoding.lockdown);
		}

		function updateToggleLockdown(){
			let settingsLockdown = document.getElementById('cocode-lockdown');
			let syncdataBtn = document.getElementById('syncdata-button');
			if(settings.cocoding.lockdown){
				settingsLockdown.innerHTML = icon.lock;
				if(settings.cocoding.level != 'admin'){
					syncdataBtn.setAttribute('disabled', 'disabled');
				}else if(settings.cocoding.writemode){
					syncdataBtn.removeAttribute('disabled');
				}
			}else{
				settingsLockdown.innerHTML = icon.unlock;
				syncdataBtn.removeAttribute('disabled');
			}
			toggleButtonActive(settingsLockdown, settings.cocoding.lockdown);

			if(settings.cocoding.level == 'admin'){
				let settingsSync = document.getElementById('cocode-sync');
				if(settings.cocoding.lockdown){
					settingsSync.removeAttribute('disabled');

				}else{
					settingsSync.setAttribute('disabled', 'disabled');
					settings.cocoding.sync = false;
					updateToggleSync();
				}
			}
			updateSettings();
		}

		function toggleSync(){
			settings.cocoding.sync = !settings.cocoding.sync;
			updateSettings();
			updateToggleSync();
			cocode.sync(settings.cocoding.sync);
		}

		function updateToggleSync(){
			let settingsSync = document.getElementById('cocode-sync');
			toggleButtonActive(settingsSync, settings.cocoding.sync);
		}

		function toggleButtonActive(elm, toggleMode){
			if(toggleMode){
				elm.classList.add('cocoding-active');
			}else{
				elm.classList.remove('cocoding-active');
			}
		}
	</script>
</body>
</html>
