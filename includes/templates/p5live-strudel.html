<!DOCTYPE html>
<html>
<head>
	<title>strudel-web</title>
	<script src="https://unpkg.com/@strudel/web@1"></script>
	<style type="text/css">
		canvas{
			width:100vw;
			height:100vh;
		}
	</style>

</head>
<body>
	<canvas id="pre-canvas" style="display:none;width:10px;height:10px;"></canvas>
	<script>
		const parentOfELement = document.body

		const onMutation = () => {
		  if (parentOfELement.querySelector('#test-canvas')) {
		    observer.disconnect()
			//console.log('strudel.canvas appeared!')
			if(windowParent()){
				window.parent.strudel.canvas = parent.strudel.frame.document.querySelector('#test-canvas')
				window.parent.p5f.strudel = window.parent.strudel
			}
		    
		  }
		}

		const observer = new MutationObserver(onMutation)
		observer.observe(parentOfELement, {childList: true})
	</script>
	<script>
		async function loadSamples() {
			const ds = "https://raw.githubusercontent.com/felixroos/dough-samples/main/";
	    	const ts = 'https://raw.githubusercontent.com/todepond/samples/main';
				const tc = 'https://raw.githubusercontent.com/tidalcycles/uzu-drumkit/main';

			return Promise.all([
				samples(`${ds}/tidal-drum-machines.json`),
				samples(`${ds}/piano.json`),
				samples(`${ds}/Dirt-Samples.json`),
				samples(`${ds}/vcsl.json`),
				samples(`${ds}/mridangam.json`),
				samples(`${tc}/strudel.json`),
			]);
		}
		
		async function loadP5LIVE(){

			register('p5live', (fun, x) => x.onTrigger((hap) => {
				(()=>{
				// console.log(fun)
					let funCode = fun.toString().match(/\\\{([\\s\\S]\*)\\\}/)[1].trim()
					let hapCode = `let hap = ${JSON.stringify(hap.value)}\n\n${funCode}` 
					let p5f = window.parent.p5f
					// console.log(hapCode)
					p5f.eval(hapCode)
				})()
			}, false)) // , false

		}

		// based on strudel's .draw()
		async function preloadStrudel(){
			let animationFrames = {};
			function stopAnimationFrame(id) {
			  if (animationFrames[id] !== undefined) {
			    cancelAnimationFrame(animationFrames[id]);
			    delete animationFrames[id];
			  }
			}
			function stopAllAnimations(replID) {
			  Object.keys(animationFrames).forEach((id) => (!replID || id.startsWith(replID)) && stopAnimationFrame(id));
			}		
			var memory = {};
			strudel.Pattern.prototype.drawHaps = function (fn, options) {
			  if (typeof window === 'undefined') {
			    return this;
			  }
			  let { id = 1, lookbehind = 0, lookahead = 0 } = options;
			  let __t = Math.max(getTime(), 0);
		      stopAnimationFrame(id);
			  lookbehind = Math.abs(lookbehind);
			  // init memory, clear future haps of old pattern
			  memory[id] = (memory[id] || []).filter((h) => !h.isInFuture(__t));
			  let newFuture = this.queryArc(__t, __t + lookahead).filter((h) => h.hasOnset());
			  memory[id] = memory[id].concat(newFuture);

			  let last;
			  const animate = () => {
			    const _t = getTime();
			    const t = _t + lookahead;
			    // filter out haps that are too far in the past
			    memory[id] = memory[id].filter((h) => h.isInNearPast(lookbehind, _t));
			    // begin where we left off in last frame, but max -0.1s (inactive tab throttles to 1fps)
			    let begin = Math.max(last || t, t - 1 / 10);
			    const haps = this.queryArc(begin, t).filter((h) => h.hasOnset());
			    memory[id] = memory[id].concat(haps);
			    last = t; // makes sure no haps are missed
			    fn(memory[id], _t, t, this);
			    animationFrames[id] = requestAnimationFrame(animate);
			  };
			  animationFrames[id] = requestAnimationFrame(animate);
			  return this;
			};

		}

		async function main() {
			await preloadStrudel()
			await initStrudel()
			await loadSamples()
			await loadP5LIVE()
			// await catchHaps()
			if(windowParent()){
				window.parent.strudel.init = true
			}
			
			window.addEventListener('click', async () => {
			let ctx = getAudioContext()
			if (ctx.state === 'suspended') {
			    const ctxResume = await ctx.resume()
			    if(ctxResume){
					console.log(ctx)
			    }								   
			  }
			});
			
			console.log('P5LIVE x Strudel ready!!')
		}

		main()

		function windowParent(){
			// return true
			return window.parent != undefined ? true : false
		}
	</script>
</body>
</html>